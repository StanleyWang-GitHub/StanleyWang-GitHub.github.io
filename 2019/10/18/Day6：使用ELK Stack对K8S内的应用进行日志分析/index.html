<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta property="og:type" content="article">
<meta property="og:title" content="Day6：使用ELK Stack对K8S内的应用进行日志分析">
<meta property="og:url" content="https://StanleyWang-GitHub.github.io/2019/10/18/Day6：使用ELK Stack对K8S内的应用进行日志分析/index.html">
<meta property="og:site_name" content="Stanley&#39;s Blog">
<meta property="og:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://stanleywang-github.github.io/images/jenkins-2projects.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/jenkins-tomcat.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/harbor-tomcat.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kafka-manager.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kafka-topic.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/es-logstash.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kibana.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kibana-usage.png">
<meta property="og:updated_time" content="2020-09-03T08:33:09.884Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Day6：使用ELK Stack对K8S内的应用进行日志分析">
<meta name="twitter:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta name="twitter:image" content="https://stanleywang-github.github.io/images/jenkins-2projects.png">






  <link rel="canonical" href="https://StanleyWang-GitHub.github.io/2019/10/18/Day6：使用ELK Stack对K8S内的应用进行日志分析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Day6：使用ELK Stack对K8S内的应用进行日志分析 | Stanley's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stanley's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/10/18/Day6：使用ELK Stack对K8S内的应用进行日志分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Day6：使用ELK Stack对K8S内的应用进行日志分析

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-18 17:12:56" itemprop="dateCreated datePublished" datetime="2019-10-18T17:12:56+08:00">2019-10-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">31k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">28 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="改造dubbo-demo-web项目为Tomcat启动项目"><a href="#改造dubbo-demo-web项目为Tomcat启动项目" class="headerlink" title="改造dubbo-demo-web项目为Tomcat启动项目"></a>改造dubbo-demo-web项目为Tomcat启动项目</h1><p><a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat官网</a></p>
<h2 id="准备Tomcat的镜像底包"><a href="#准备Tomcat的镜像底包" class="headerlink" title="准备Tomcat的镜像底包"></a>准备Tomcat的镜像底包</h2><h3 id="准备tomcat二进制包"><a href="#准备tomcat二进制包" class="headerlink" title="准备tomcat二进制包"></a>准备tomcat二进制包</h3><p>运维主机<code>HDSS7-200.host.com</code>上：<br><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.49/bin/apache-tomcat-8.5.49.tar.gz" target="_blank" rel="noopener">Tomcat8下载链接</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep tomcat</span><br><span class="line">-rw-r--r-- 1 root root   9690027 Apr 10 22:57 apache-tomcat-8.5.49.tar.gz</span><br><span class="line">[root@hdss7-200 src]# mkdir -p /data/dockerfile/tomcat &amp;&amp; tar xf apache-tomcat-8.5.49.tar.gz -C /data/dockerfile/tomcat</span><br><span class="line">[root@hdss7-200 src]# cd /data/dockerfile/tomcat &amp;&amp; rm -fr apache-tomcat-8.5.49/webapps/*</span><br></pre></td></tr></table></figure>

<h3 id="简单配置tomcat"><a href="#简单配置tomcat" class="headerlink" title="简单配置tomcat"></a>简单配置tomcat</h3><ol>
<li>关闭AJP端口</li>
</ol>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.49/conf/server.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt; --&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置日志</li>
</ol>
<ul>
<li>删除3manager，4host-manager的handlers</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.49/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handlers = 1catalina.org.apache.juli.AsyncFileHandler, 2localhost.org.apache.juli.AsyncFileHandler,java.util.logging.ConsoleHandler</span><br></pre></td></tr></table></figure>

<ul>
<li>日志级别改为INFO</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.49/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1catalina.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">2localhost.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">java.util.logging.ConsoleHandler.level = INFO</span><br></pre></td></tr></table></figure>

<ul>
<li>注释掉所有关于3manager，4host-manager日志的配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.49/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#3manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.prefix = manager.</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br><span class="line"></span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br></pre></td></tr></table></figure>

<h3 id="准备Dockerfile"><a href="#准备Dockerfile" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">From stanleyws/jre8:8u112</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\ </span><br><span class="line">    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line">ENV CATALINA_HOME /opt/tomcat</span><br><span class="line">ENV LANG zh_CN.UTF-8</span><br><span class="line">ADD apache-tomcat-8.5.49/ /opt/tomcat</span><br><span class="line">ADD config.yml /opt/prom/config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line">WORKDIR /opt/tomcat</span><br><span class="line">ADD entrypoint.sh /entrypoint.sh</span><br><span class="line">CMD [&quot;/entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure>

<div class="tabs" id="tomcat-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#tomcat-dockerfile-1">config.yml</a></li><li class="tab"><a href="#tomcat-dockerfile-2">jmx_javaagent-0.3.1.jar</a></li><li class="tab"><a href="#tomcat-dockerfile-3">entrypoint.sh</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tomcat-dockerfile-1"><p>vi config.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">rules:</span><br><span class="line">  - pattern: &apos;.*&apos;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tomcat-dockerfile-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tomcat-dockerfile-3"><p>vi entrypoint.sh  (不要忘了给执行权限)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">M_OPTS=&quot;-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):$&#123;M_PORT:-&quot;12346&quot;&#125;:/opt/prom/config.yml&quot;</span><br><span class="line">C_OPTS=$&#123;C_OPTS&#125;</span><br><span class="line">MIN_HEAP=$&#123;MIN_HEAP:-&quot;128m&quot;&#125;</span><br><span class="line">MAX_HEAP=$&#123;MAX_HEAP:-&quot;128m&quot;&#125;</span><br><span class="line">JAVA_OPTS=$&#123;JAVA_OPTS:-&quot;-Xmn384m -Xss256k -Duser.timezone=GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram  -Dfile.encoding=UTF8 -Dsun.jnu.encoding=UTF8&quot;&#125;</span><br><span class="line">CATALINA_OPTS=&quot;$&#123;CATALINA_OPTS&#125;&quot;</span><br><span class="line">JAVA_OPTS=&quot;$&#123;M_OPTS&#125; $&#123;C_OPTS&#125; -Xms$&#123;MIN_HEAP&#125; -Xmx$&#123;MAX_HEAP&#125; $&#123;JAVA_OPTS&#125;&quot;</span><br><span class="line">sed -i -e &quot;1a\JAVA_OPTS=\&quot;$JAVA_OPTS\&quot;&quot; -e &quot;1a\CATALINA_OPTS=\&quot;$CATALINA_OPTS\&quot;&quot; /opt/tomcat/bin/catalina.sh</span><br><span class="line"></span><br><span class="line">cd /opt/tomcat &amp;&amp; /opt/tomcat/bin/catalina.sh run 2&gt;&amp;1 &gt;&gt; /opt/tomcat/logs/stdout.log</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="制作镜像并推送"><a href="#制作镜像并推送" class="headerlink" title="制作镜像并推送"></a>制作镜像并推送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 tomcat]# docker build . -t harbor.od.com/base/tomcat:v8.5.49</span><br><span class="line">Sending build context to Docker daemon 9.502 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5da5ab0b1a48</span><br><span class="line">Step 3 : ENV CATALINA_HOME /opt/tomcat</span><br><span class="line"> ---&gt; Running in edf8f2bbeae3</span><br><span class="line"> ---&gt; 05c7b829c8ab</span><br><span class="line">Removing intermediate container edf8f2bbeae3</span><br><span class="line">Step 4 : ENV LANG zh_CN.UTF-8</span><br><span class="line"> ---&gt; Running in 50516133f65b</span><br><span class="line"> ---&gt; 421d67c4c188</span><br><span class="line">Removing intermediate container 50516133f65b</span><br><span class="line">Step 5 : ADD apache-tomcat-8.5.49/ /opt/tomcat</span><br><span class="line"> ---&gt; 460a5d0ef93b</span><br><span class="line">Removing intermediate container 0be2b4897d23</span><br><span class="line">Step 6 : ADD config.yml /opt/prom/config.yml</span><br><span class="line"> ---&gt; 04c9d4679f0d</span><br><span class="line">Removing intermediate container 0e88a4ed2088</span><br><span class="line">Step 7 : ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line"> ---&gt; 06e4a78e9cbf</span><br><span class="line">Removing intermediate container 1e6b2919be00</span><br><span class="line">Step 8 : WORKDIR /opt/tomcat</span><br><span class="line"> ---&gt; Running in a51676d15a01</span><br><span class="line"> ---&gt; e8d164847eb3</span><br><span class="line">Removing intermediate container a51676d15a01</span><br><span class="line">Step 9 : ADD entrypoint.sh /entrypoint.sh</span><br><span class="line"> ---&gt; 0522db421536</span><br><span class="line">Removing intermediate container 7f0be318fde8</span><br><span class="line">Step 10 : CMD /entrypoint.sh</span><br><span class="line"> ---&gt; Running in c2df6e511c00</span><br><span class="line"> ---&gt; 8d735515bb42</span><br><span class="line">Removing intermediate container c2df6e511c00</span><br><span class="line">Successfully built 8d735515bb42</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 tomcat8]# docker push harbor.od.com/base/tomcat:v8.5.49</span><br><span class="line">The push refers to a repository [harbor.od.com/base/tomcat]</span><br><span class="line">498eaadf86a8: Pushed </span><br><span class="line">fab679acf269: Pushed </span><br><span class="line">0e65f86c3a75: Pushed </span><br><span class="line">938c8a5617cc: Pushed </span><br><span class="line">052016a734be: Mounted from app/dubbo-demo-web </span><br><span class="line">0690f10a63a5: Mounted from app/dubbo-demo-web </span><br><span class="line">c843b2cf4e12: Mounted from app/dubbo-demo-web </span><br><span class="line">fddd8887b725: Mounted from base/jre8 </span><br><span class="line">42052a19230c: Mounted from base/jre8 </span><br><span class="line">8d4d1ab5ff74: Mounted from base/jre8 </span><br><span class="line">v8.5.49: digest: sha256:407c6abd7c4fa5119376efa71090b49637d7a52ef2fc202f4019ab4c91f6dc50 size: 2409</span><br></pre></td></tr></table></figure>

<h2 id="改造dubbo-demo-web项目"><a href="#改造dubbo-demo-web项目" class="headerlink" title="改造dubbo-demo-web项目"></a>改造dubbo-demo-web项目</h2><p>略，直接使用tomcat分支</p>
<h2 id="新建Jenkins的pipeline"><a href="#新建Jenkins的pipeline" class="headerlink" title="新建Jenkins的pipeline"></a>新建Jenkins的pipeline</h2><h3 id="配置New-job"><a href="#配置New-job" class="headerlink" title="配置New job"></a>配置New job</h3><ul>
<li><p>使用admin登录</p>
</li>
<li><p>New Item</p>
</li>
<li><p>create new jobs</p>
</li>
<li><p>Enter an item name</p>
<blockquote>
<p>tomcat-demo</p>
</blockquote>
</li>
<li><p>Pipeline -&gt; OK</p>
</li>
<li><p>Discard old builds</p>
<blockquote>
<p>Days to keep builds : 3<br>Max # of builds to keep : 30</p>
</blockquote>
</li>
<li><p>This project is parameterized</p>
</li>
</ul>
<ol>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : app_name<br>Default Value :<br>Description : project name. e.g: dubbo-demo-web</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : image_name<br>Default Value :<br>Description : project docker image name. e.g:  app/dubbo-demo-web</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_repo<br>Default Value :<br>Description : project git repository. e.g: <a href="mailto:git@gitee.com" target="_blank" rel="noopener">git@gitee.com</a>:stanleywang/dubbo-demo-web.git</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_ver<br>Default Value : tomcat<br>Description : git commit id of the project.</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : add_tag<br>Default Value :<br>Description : project docker image tag, date_timestamp recommended. e.g: 190117_1920</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_dir<br>Default Value : ./<br>Description : project maven directory. e.g: ./</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : target_dir<br>Default Value : ./dubbo-client/target<br>Description : the relative path of target file such as .jar or .war package. e.g: ./dubbo-client/target</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_cmd<br>Default Value : mvn clean package -Dmaven.test.skip=true<br>Description : maven command. e.g: mvn clean package -e -q -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : base_image<br>Default Value : </p>
<ul>
<li>base/tomcat:v7.0.94</li>
<li>base/tomcat:v8.5.49</li>
<li>base/tomcat:v9.0.17<br>Description : project base image list in harbor.od.com.</li>
</ul>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : maven<br>Default Value : </p>
<ul>
<li>3.6.1-8u212</li>
<li>3.2.5-6u025</li>
<li>2.2.1-6u025<br>Description : different maven edition.</li>
</ul>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : root_url<br>Default Value : ROOT<br>Description : webapp dir.</p>
</blockquote>
</li>
</ol>
<p><img src="/images/jenkins-2projects.png" alt="jenkins新增流水线" title="jenkins新增流水线"></p>
<h3 id="Pipeline-Script"><a href="#Pipeline-Script" class="headerlink" title="Pipeline Script"></a>Pipeline Script</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any </span><br><span class="line">    stages &#123;</span><br><span class="line">    stage(&apos;pull&apos;) &#123; //get project code from repo </span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;git clone $&#123;params.git_repo&#125; $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; git checkout $&#123;params.git_ver&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;build&apos;) &#123; //exec mvn cmd</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;  &amp;&amp; /var/jenkins_home/maven-$&#123;params.maven&#125;/bin/$&#123;params.mvn_cmd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;unzip&apos;) &#123; //unzip  target/*.war -c target/project_dir</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.target_dir&#125; &amp;&amp; mkdir project_dir &amp;&amp; unzip *.war -d ./project_dir&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;image&apos;) &#123; //build image and push to registry</span><br><span class="line">      steps &#123;</span><br><span class="line">        writeFile file: &quot;$&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;/Dockerfile&quot;, text: &quot;&quot;&quot;FROM harbor.od.com/$&#123;params.base_image&#125;</span><br><span class="line">ADD $&#123;params.target_dir&#125;/project_dir /opt/tomcat/webapps/$&#123;params.root_url&#125;&quot;&quot;&quot;</span><br><span class="line">        sh &quot;cd  $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; docker build -t harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125; . &amp;&amp; docker push harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构建应用镜像"><a href="#构建应用镜像" class="headerlink" title="构建应用镜像"></a>构建应用镜像</h2><p>使用Jenkins进行CI，并查看harbor仓库<br><img src="/images/jenkins-tomcat.png" alt="jenkins构建" title="jenkins构建"><br><img src="/images/harbor-tomcat.png" alt="harbor仓库" title="harbor仓库"></p>
<h2 id="准备k8s的资源配置清单"><a href="#准备k8s的资源配置清单" class="headerlink" title="准备k8s的资源配置清单"></a>准备k8s的资源配置清单</h2><p>不再需要单独准备资源配置清单</p>
<h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>k8s的dashboard上直接修改image的值为jenkins打包出来的镜像<br>文档里的例子是：<code>harbor.od.com/app/dubbo-demo-web:tomcat_190119_1920</code></p>
<h2 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://demo.od.com?hello=wangdao" target="_blank" rel="noopener">http://demo.od.com?hello=wangdao</a></p>
<h2 id="检查tomcat运行情况"><a href="#检查tomcat运行情况" class="headerlink" title="检查tomcat运行情况"></a>检查tomcat运行情况</h2><p>任意一台运算节点主机上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# kubectl get pods -n app</span><br><span class="line">NAME                                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">dubbo-demo-consumer-v025-htfx8                          2/2       Running   0          1h</span><br><span class="line">[root@hdss7-22 ~]# kubectl exec -ti dubbo-demo-consumer-v025-htfx8 -n app bash</span><br><span class="line">dubbo-demo-consumer-v025-htfx8:/opt/tomcat#  ls -lsr logs/</span><br><span class="line">total 16</span><br><span class="line">-rw-r----- 1 root root  435 Jan 19 19:26 catalina.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  629 Jan 19 19:26 localhost.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  249 Jan 15 19:27 localhost_access_log.2019-01-19.txt</span><br><span class="line">-rw-r----- 1 root root 7355 Jan 15 19:28 stdout.log</span><br></pre></td></tr></table></figure>

<h1 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h1><p><a href="https://www.elastic.co/" target="_blank" rel="noopener">官网</a><br><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">官方github地址</a><br><a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.3.tar.gz" target="_blank" rel="noopener">下载地址</a><br><code>HDSS7-12.host.com</code>上：</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# ls -l|grep elasticsearch-6.8.3.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  72262257 Jan 30 15:18 elasticsearch-6.8.3.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf elasticsearch-6.8.3.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/elasticsearch-6.8.3/ /opt/elasticsearch</span><br></pre></td></tr></table></figure>

<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="elasticsearch-yml"><a href="#elasticsearch-yml" class="headerlink" title="elasticsearch.yml"></a>elasticsearch.yml</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /data/elasticsearch/&#123;data,logs&#125;</span><br><span class="line">[root@hdss7-12 elasticsearch]# vi config/elasticsearch.yml</span><br><span class="line">cluster.name: es.od.com</span><br><span class="line">node.name: hdss7-12.host.com</span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 10.4.7.12</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure>

<h3 id="jvm-options"><a href="#jvm-options" class="headerlink" title="jvm.options"></a>jvm.options</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# vi config/jvm.options</span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br></pre></td></tr></table></figure>

<h3 id="创建普通用户"><a href="#创建普通用户" class="headerlink" title="创建普通用户"></a>创建普通用户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# useradd -s /bin/bash -M es</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /opt/elasticsearch-6.8.3</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /data/elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h3><figure class="highlight plain"><figcaption><span>/etc/security/limits.d/es.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">es hard nofile 65536</span><br><span class="line">es soft fsize unlimited</span><br><span class="line">es hard memlock unlimited</span><br><span class="line">es soft memlock unlimited</span><br></pre></td></tr></table></figure>

<h3 id="调整内核参数"><a href="#调整内核参数" class="headerlink" title="调整内核参数"></a>调整内核参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# sysctl -w vm.max_map_count=262144</span><br><span class="line">or</span><br><span class="line">[root@hdss7-12 elasticsearch]# echo &quot;vm.max_map_count=262144&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@hdss7-12 elasticsearch]# sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# su - es</span><br><span class="line">su: warning: cannot change directory to /home/es: No such file or directory</span><br><span class="line">-bash-4.2$ /opt/elasticsearch/bin/elasticsearch -d</span><br><span class="line">[1] 8714</span><br><span class="line">[root@hdss7-12 elasticsearch]# ps -ef|grep elastic|grep -v grep</span><br><span class="line">es        8714     1 58 10:29 pts/0    00:00:19 /usr/java/jdk/bin/java -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/opt/elasticsearch -cp /opt/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch</span><br></pre></td></tr></table></figure>

<h2 id="调整ES日志模板"><a href="#调整ES日志模板" class="headerlink" title="调整ES日志模板"></a>调整ES日志模板</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# curl -H &quot;Content-Type:application/json&quot; -XPUT http://10.4.7.12:9200/_template/k8s -d &apos;&#123;</span><br><span class="line">  &quot;template&quot; : &quot;k8s*&quot;,</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;k8s*&quot;],  </span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<h1 id="部署kafka"><a href="#部署kafka" class="headerlink" title="部署kafka"></a>部署kafka</h1><p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">官网</a><br><a href="https://github.com/apache/kafka" target="_blank" rel="noopener">官方github地址</a><br><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.2.0/kafka_2.12-2.2.0.tgz" target="_blank" rel="noopener">下载地址</a><br><code>HDSS7-11.host.com</code>上：</p>
<h2 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 src]# ls -l|grep kafka</span><br><span class="line">-rw-r--r-- 1 root root  57028557 Mar 23 08:57 kafka_2.12-2.2.0.tgz</span><br><span class="line">[root@hdss7-11 src]# tar xf kafka_2.12-2.2.0.tgz -C /opt</span><br><span class="line">[root@hdss7-11 src]# ln -s /opt/kafka_2.12-2.2.0/ /opt/kafka</span><br></pre></td></tr></table></figure>

<h2 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h2><figure class="highlight plain"><figcaption><span>/opt/kafka/config/server.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log.dirs=/data/kafka/logs</span><br><span class="line">zookeeper.connect=localhost:2181</span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">host.name=hdss7-11.host.com</span><br></pre></td></tr></table></figure>

<h2 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h2><figure class="highlight plain"><figcaption><span>/opt/kafka</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 kafka]# bin/kafka-server-start.sh -daemon config/server.properties</span><br><span class="line">[root@hdss7-11 kafka]# netstat -luntp|grep 9092</span><br><span class="line">tcp6       0      0 10.4.7.12:9092         :::*                    LISTEN      17543/java</span><br></pre></td></tr></table></figure>

<h1 id="部署kafka-manager"><a href="#部署kafka-manager" class="headerlink" title="部署kafka-manager"></a>部署kafka-manager</h1><p><a href="https://github.com/yahoo/kafka-manager" target="_blank" rel="noopener">官方github地址</a><br><a href="https://github.com/yahoo/kafka-manager/archive/2.0.0.2.tar.gz" target="_blank" rel="noopener">源码下载地址</a><br>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h2 id="方法一：自定义构建"><a href="#方法一：自定义构建" class="headerlink" title="方法一：自定义构建"></a>方法一：自定义构建</h2><h3 id="准备Dockerfile-1"><a href="#准备Dockerfile-1" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/kafka-manager/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM hseeberger/scala-sbt</span><br><span class="line"></span><br><span class="line">ENV ZK_HOSTS=10.4.7.11:2181 \</span><br><span class="line">     KM_VERSION=2.0.0.2</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /tmp &amp;&amp; \</span><br><span class="line">    cd /tmp &amp;&amp; \</span><br><span class="line">    wget https://github.com/yahoo/kafka-manager/archive/$&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    tar xxf $&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    cd /tmp/kafka-manager-$&#123;KM_VERSION&#125; &amp;&amp; \</span><br><span class="line">    sbt clean dist &amp;&amp; \</span><br><span class="line">    unzip  -d / ./target/universal/kafka-manager-$&#123;KM_VERSION&#125;.zip &amp;&amp; \</span><br><span class="line">    rm -fr /tmp/$&#123;KM_VERSION&#125; /tmp/kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">WORKDIR /kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">EXPOSE 9000</span><br><span class="line">ENTRYPOINT [&quot;./bin/kafka-manager&quot;,&quot;-Dconfig.file=conf/application.conf&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="制作docker镜像"><a href="#制作docker镜像" class="headerlink" title="制作docker镜像"></a>制作docker镜像</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/kafka-manager</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 kafka-manager]# docker build . -t harbor.od.com/infra/kafka-manager:v2.0.0.2</span><br><span class="line">(漫长的过程)</span><br></pre></td></tr></table></figure>

<h2 id="方法二：直接下载docker镜像"><a href="#方法二：直接下载docker镜像" class="headerlink" title="方法二：直接下载docker镜像"></a>方法二：直接下载docker镜像</h2><p><a href="https://hub.docker.com/r/sheepkiller/kafka-manager/tags" target="_blank" rel="noopener">镜像下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull sheepkiller/kafka-manager:stable</span><br><span class="line">[root@hdss7-200 ~]# docker tag 34627743836f harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kafka]</span><br><span class="line">ef97dbc2670b: Pushed </span><br><span class="line">ec01aa005e59: Pushed </span><br><span class="line">de05a1bdf878: Pushed </span><br><span class="line">9c553f3feafd: Pushed </span><br><span class="line">581533427a4f: Pushed </span><br><span class="line">f6b229974fdd: Pushed </span><br><span class="line">ae150883d6e2: Pushed </span><br><span class="line">3df7be729841: Pushed </span><br><span class="line">f231cc200afe: Pushed </span><br><span class="line">9752c15164a8: Pushed </span><br><span class="line">9ab7eda5c826: Pushed </span><br><span class="line">402964b3d72e: Pushed </span><br><span class="line">6b3f8ebf864c: Pushed </span><br><span class="line">stable: digest: sha256:57fd46a3751284818f1bc6c0fdf097250bc0feed03e77135fb8b0a93aa8c6cc7 size: 3056</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><div class="tabs" id="kafka-manager"><ul class="nav-tabs"><li class="tab active"><a href="#kafka-manager-1">Deployment</a></li><li class="tab"><a href="#kafka-manager-2">Service</a></li><li class="tab"><a href="#kafka-manager-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="kafka-manager-1"><p>vi /data/k8s-yaml/kafka-manager/dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kafka-manager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      app: kafka-manager</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kafka-manager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka-manager</span><br><span class="line">        image: harbor.od.com/infra/kafka-manager:v2.0.0.2</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ZK_HOSTS</span><br><span class="line">          value: zk1.od.com:2181</span><br><span class="line">        - name: APPLICATION_SECRET</span><br><span class="line">          value: letmein</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kafka-manager-2"><p>vi /data/k8s-yaml/kafka-manager/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9000</span><br><span class="line">    targetPort: 9000</span><br><span class="line">  selector: </span><br><span class="line">    app: kafka-manager</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kafka-manager-3"><p>vi /data/k8s-yaml/kafka-manager/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: km.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kafka-manager</span><br><span class="line">          servicePort: 9000</span><br></pre></td></tr></table></figure></div></div></div>
<h2 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>任意一台运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/dp.yaml </span><br><span class="line">deployment.extensions/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/svc.yaml </span><br><span class="line">service/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/ingress.yaml </span><br><span class="line">ingress.extensions/kafka-manager created</span><br></pre></td></tr></table></figure>

<h2 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h2><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">km                 A    10.4.7.10</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://km.od.com" target="_blank" rel="noopener">http://km.od.com</a></p>
<p><img src="/images/kafka-manager.png" alt="kafka-manager" title="kafka-manager"></p>
<h1 id="部署filebeat"><a href="#部署filebeat" class="headerlink" title="部署filebeat"></a>部署filebeat</h1><p><a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank" rel="noopener">官方下载地址</a><br>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h2 id="制作docker镜像-1"><a href="#制作docker镜像-1" class="headerlink" title="制作docker镜像"></a>制作docker镜像</h2><h3 id="准备Dockerfile-2"><a href="#准备Dockerfile-2" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><div class="tabs" id="filebeat-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#filebeat-dockerfile-1">Dockerfile</a></li><li class="tab"><a href="#filebeat-dockerfile-2">Entrypoint</a></li></ul><div class="tab-content"><div class="tab-pane active" id="filebeat-dockerfile-1"><p>vi /data/dockerfile/filebeat/Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FROM debian:jessie</span><br><span class="line"></span><br><span class="line">ENV FILEBEAT_VERSION=7.4.0 \</span><br><span class="line">    FILEBEAT_SHA1=c63bb1e16f7f85f71568041c78f11b57de58d497ba733e398fa4b2d071270a86dbab19d5cb35da5d3579f35cb5b5f3c46e6e08cdf840afb7c347777aae5c4e11</span><br><span class="line"></span><br><span class="line">RUN set -x &amp;&amp; \</span><br><span class="line">  apt-get update &amp;&amp; \</span><br><span class="line">  apt-get install -y wget &amp;&amp; \</span><br><span class="line">  wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-$&#123;FILEBEAT_VERSION&#125;-linux-x86_64.tar.gz -O /opt/filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  echo &quot;$&#123;FILEBEAT_SHA1&#125;  filebeat.tar.gz&quot; | sha512sum -c - &amp;&amp; \</span><br><span class="line">  tar xzvf filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd filebeat-* &amp;&amp; \</span><br><span class="line">  cp filebeat /bin &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  rm -rf filebeat* &amp;&amp; \</span><br><span class="line">  apt-get purge -y wget &amp;&amp; \</span><br><span class="line">  apt-get autoremove -y &amp;&amp; \</span><br><span class="line">  apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</span><br><span class="line"></span><br><span class="line">COPY docker-entrypoint.sh /</span><br><span class="line">ENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="filebeat-dockerfile-2"><p>vi /data/dockerfile/filebeat/docker-entrypoint.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">ENV=$&#123;ENV:-&quot;test&quot;&#125;</span><br><span class="line">PROJ_NAME=$&#123;PROJ_NAME:-&quot;no-define&quot;&#125;</span><br><span class="line">MULTILINE=$&#123;MULTILINE:-&quot;^\d&#123;2&#125;&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/filebeat.yaml &lt;&lt; EOF</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logm-$&#123;PROJ_NAME&#125;</span><br><span class="line">  paths:</span><br><span class="line">    - /logm/*.log</span><br><span class="line">    - /logm/*/*.log</span><br><span class="line">    - /logm/*/*/*.log</span><br><span class="line">    - /logm/*/*/*/*.log</span><br><span class="line">    - /logm/*/*/*/*/*.log</span><br><span class="line">  scan_frequency: 120s</span><br><span class="line">  max_bytes: 10485760</span><br><span class="line">  multiline.pattern: &apos;$MULTILINE&apos;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.max_lines: 100</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logu-$&#123;PROJ_NAME&#125;</span><br><span class="line">  paths:</span><br><span class="line">    - /logu/*.log</span><br><span class="line">    - /logu/*/*.log</span><br><span class="line">    - /logu/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*/*.log</span><br><span class="line">    - /logu/*/*/*/*/*/*.log</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [&quot;10.4.7.11:9092&quot;]</span><br><span class="line">  topic: k8s-fb-$ENV-%&#123;[topic]&#125;</span><br><span class="line">  version: 2.0.0</span><br><span class="line">  required_acks: 0</span><br><span class="line">  max_message_bytes: 10485760</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">set -xe</span><br><span class="line"></span><br><span class="line"># If user don&apos;t provide any command</span><br><span class="line"># Run filebeat</span><br><span class="line">if [[ &quot;$1&quot; == &quot;&quot; ]]; then</span><br><span class="line">     exec filebeat  -c /etc/filebeat.yaml </span><br><span class="line">else</span><br><span class="line">    # Else allow the user to run arbitrarily commands like bash</span><br><span class="line">    exec &quot;$@&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/filebeat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 filebeat]# docker build . -t harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">...</span><br><span class="line">+ apt-get autoremove -y</span><br><span class="line">Reading package lists...</span><br><span class="line">Building dependency tree...</span><br><span class="line">Reading state information...</span><br><span class="line">The following packages will be REMOVED:</span><br><span class="line">  ca-certificates libicu52 libidn11 libpsl0 libssl1.0.0 openssl</span><br><span class="line">0 upgraded, 0 newly installed, 6 to remove and 6 not upgraded.</span><br><span class="line">After this operation, 33.6 MB disk space will be freed.</span><br><span class="line">(Reading database ... 7962 files and directories currently installed.)</span><br><span class="line">Removing ca-certificates (20141019+deb8u4) ...</span><br><span class="line">Removing dangling symlinks from /etc/ssl/certs... done.</span><br><span class="line">Removing libpsl0:amd64 (0.5.1-1) ...</span><br><span class="line">Removing libicu52:amd64 (52.1-8+deb8u7) ...</span><br><span class="line">Removing libidn11:amd64 (1.29-1+deb8u3) ...</span><br><span class="line">Removing openssl (1.0.1t-1+deb8u11) ...</span><br><span class="line">Removing libssl1.0.0:amd64 (1.0.1t-1+deb8u11) ...</span><br><span class="line">Processing triggers for libc-bin (2.19-18+deb8u10) ...</span><br><span class="line">+ apt-get clean</span><br><span class="line">+ rm -rf /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release.gpg /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_main_binary-amd64_Packages.gz /var/lib/apt/lists/lock /var/lib/apt/lists/partial /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_InRelease /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_main_binary-amd64_Packages.gz /tmp/* /var/tmp/*</span><br><span class="line"> ---&gt; a78678659f2c</span><br><span class="line">Removing intermediate container 2cfff130c15c</span><br><span class="line">Step 4 : COPY docker-entrypoint.sh /</span><br><span class="line"> ---&gt; 62dc7fe5a98f</span><br><span class="line">Removing intermediate container 87e271482593</span><br><span class="line">Step 5 : ENTRYPOINT /docker-entrypoint.sh</span><br><span class="line"> ---&gt; Running in d367b6e3bb5a</span><br><span class="line"> ---&gt; 23c8fbdc088a</span><br><span class="line">Removing intermediate container d367b6e3bb5a</span><br><span class="line">Successfully built 23c8fbdc088a</span><br><span class="line">[root@hdss7-200 filebeat]# docker tag 23c8fbdc088a harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">[root@hdss7-200 filebeat]# docker push !$</span><br><span class="line">docker push harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/filebeat]</span><br><span class="line">6a765e653161: Pushed </span><br><span class="line">8e89ae5c6fc2: Pushed </span><br><span class="line">9abb3997a540: Pushed </span><br><span class="line">v7.4.0: digest: sha256:c35d7cdba29d8555388ad41ac2fc1b063ed9ec488082e33b5d0e91864b3bb35c size: 948</span><br></pre></td></tr></table></figure>

<h2 id="修改资源配置清单"><a href="#修改资源配置清单" class="headerlink" title="修改资源配置清单"></a>修改资源配置清单</h2><p><strong>使用dubbo-demo-consumer的Tomcat版镜像</strong></p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml/dubbo-demo-consumer/dp.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-web:tomcat</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=fat -Dapollo.meta=http://config.od.com</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /opt/tomcat/logs</span><br><span class="line">          name: logm</span><br><span class="line">      - name: filebeat</span><br><span class="line">        image: harbor.od.com/infra/filebeat:v7.4.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: ENV</span><br><span class="line">          value: test</span><br><span class="line">        - name: PROJ_NAME</span><br><span class="line">          value: dubbo-demo-web</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /logm</span><br><span class="line">          name: logm</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: logm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问http-km-od-com"><a href="#浏览器访问http-km-od-com" class="headerlink" title="浏览器访问http://km.od.com"></a>浏览器访问<a href="http://km.od.com" target="_blank" rel="noopener">http://km.od.com</a></h2><p>看到kafaka-manager里，topic打进来，即为成功。<br><img src="/images/kafka-topic.png" alt="kafka-topic" title="kafka-topic"></p>
<h2 id="验证数据"><a href="#验证数据" class="headerlink" title="验证数据"></a>验证数据</h2><figure class="highlight plain"><figcaption><span>/opt/kafka/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 10.4.7.11:9092 --topic k8s-fb-test-logm-dubbo-demo-web --from-beginning</span><br></pre></td></tr></table></figure>

<h1 id="部署logstash"><a href="#部署logstash" class="headerlink" title="部署logstash"></a>部署logstash</h1><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h2 id="选版本"><a href="#选版本" class="headerlink" title="选版本"></a>选版本</h2><p><a href="https://www.elastic.co/support/matrix" target="_blank" rel="noopener">logstash选型</a><br><img src="/images/es-logstash.png" alt="compatibility" title="compatibility"></p>
<h2 id="准备docker镜像"><a href="#准备docker镜像" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h2><ul>
<li>下载官方镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull logstash:6.8.3</span><br><span class="line">6.8.3: Pulling from library/logstash</span><br><span class="line">8ba884070f61: Pull complete </span><br><span class="line">063405b57b96: Pull complete </span><br><span class="line">0a0115b8825c: Pull complete </span><br><span class="line">825b124900cb: Pull complete </span><br><span class="line">ed736d9e3c41: Pull complete </span><br><span class="line">6efb3934697a: Pull complete </span><br><span class="line">c0a3a0c8ebc2: Pull complete </span><br><span class="line">f55d8adfbc3d: Pull complete </span><br><span class="line">3a6c56fbbef8: Pull complete </span><br><span class="line">ca45dc8946a2: Pull complete </span><br><span class="line">8b852a079ea9: Pull complete </span><br><span class="line">Digest: sha256:46eaff19af5e14edd9b78e1d5bf16f6abcd9ad50e0338cbaf3024f2aadb2903b</span><br><span class="line">Status: Downloaded newer image for logstash:6.8.3</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker tag 857d9a1f8221 harbor.od.com/public/logstash:v6.8.3</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/logstash:v6.8.3</span><br><span class="line">docker push harbor.od.com/public/logstash:v6.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com/public/logstash]</span><br><span class="line">c2b00f70cade: Mounted from public/filebeat </span><br><span class="line">9a2c2851596d: Mounted from public/filebeat </span><br><span class="line">86564f3ca0e2: Mounted from public/filebeat </span><br><span class="line">e9bc8faf823a: Mounted from public/filebeat </span><br><span class="line">3f3bcfa85067: Mounted from public/filebeat </span><br><span class="line">65d3b56913bd: Mounted from public/filebeat </span><br><span class="line">9b48a60607ee: Mounted from public/filebeat </span><br><span class="line">df859db41dd0: Mounted from public/filebeat </span><br><span class="line">1cbe912d7c00: Mounted from public/filebeat </span><br><span class="line">ab5fbaca7e70: Mounted from public/filebeat </span><br><span class="line">d69483a6face: Mounted from public/filebeat </span><br><span class="line">v6.8.3: digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81 size: 2823</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义Dockerfile</li>
</ul>
<div class="tabs" id="logstash"><ul class="nav-tabs"><li class="tab active"><a href="#logstash-1">Dockerfile</a></li><li class="tab"><a href="#logstash-2">logstash.yml</a></li></ul><div class="tab-content"><div class="tab-pane active" id="logstash-1"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">From harbor.od.com/public/logstash:v6.8.3</span><br><span class="line">ADD logstash.yml /usr/share/logstash/config</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="logstash-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.host: &quot;0.0.0.0&quot;</span><br><span class="line">path.config: /etc/logstash</span><br><span class="line">xpack.monitoring.enabled: false</span><br></pre></td></tr></table></figure></div></div></div>

<ul>
<li>创建自定义镜像</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/logstash</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 logstash]# docker build . -t harbor.od.com/infra/logstash:v6.8.3</span><br><span class="line">Sending build context to Docker daemon 249.3 MB</span><br><span class="line">Step 1 : FROM harbor.od.com/public/logstash:v6.8.3</span><br><span class="line">v6.8.3: Pulling from public/logstash</span><br><span class="line">e60be144a6a5: Pull complete </span><br><span class="line">6292c2b22d35: Pull complete </span><br><span class="line">1bb4586d90e7: Pull complete </span><br><span class="line">3f11f6d21132: Pull complete </span><br><span class="line">f0aaeeafebd3: Pull complete </span><br><span class="line">38c751a91f0f: Pull complete </span><br><span class="line">b80e2bad9681: Pull complete </span><br><span class="line">e3c97754ddde: Pull complete </span><br><span class="line">840f2d82a9fb: Pull complete </span><br><span class="line">32063a9aaefb: Pull complete </span><br><span class="line">e87b22bf50f5: Pull complete </span><br><span class="line">Digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81</span><br><span class="line">Status: Downloaded newer image for harbor.od.com/public/logstash:v6.8.3</span><br><span class="line"> ---&gt; 857d9a1f8221</span><br><span class="line">Step 2 : ADD logstash.yml /usr/share/logstash/config</span><br><span class="line"> ---&gt; 2ad32d3f5fef</span><br><span class="line">Removing intermediate container 1d3a1488c1b7</span><br><span class="line">Successfully built 2ad32d3f5fef</span><br><span class="line">[root@hdss7-200 logstash]# docker push harbor.od.com/infra/logstash:v6.8.3</span><br></pre></td></tr></table></figure>

<h2 id="启动docker镜像"><a href="#启动docker镜像" class="headerlink" title="启动docker镜像"></a>启动docker镜像</h2><ul>
<li>创建配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/logstash/logstash-test.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;10.4.7.11:9092&quot;</span><br><span class="line">    client_id =&gt; &quot;10.4.7.200&quot;</span><br><span class="line">    consumer_threads =&gt; 4</span><br><span class="line">    group_id =&gt; &quot;k8s_test&quot;</span><br><span class="line">    topics_pattern =&gt; &quot;k8s-fb-test-.*&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    source =&gt; &quot;message&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.4.7.12:9200&quot;]</span><br><span class="line">    index =&gt; &quot;k8s-test-%&#123;+YYYY.MM&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动logstash镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker run -d --name logstash-test -v /etc/logstash:/etc/logstash harbor.od.com/infra/logstash:v6.8.3 -f /etc/logstash/logstash-test.conf</span><br><span class="line">[root@hdss7-200 ~]# docker ps -a|grep logstash</span><br><span class="line">a5dcf56faa9a        harbor.od.com/infra/logstash:v6.8.3                                                                                &quot;/usr/local/bin/docke&quot;   8 seconds ago       Up 6 seconds                5044/tcp, 9600/tcp           jovial_swanson</span><br></pre></td></tr></table></figure>

<ul>
<li>验证ElasticSearch里的索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl http://10.4.7.12:9200/_cat/indices?v</span><br><span class="line">health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   k8s-test-2019.04 H3MY9d8WSbqQ6uL0DFhenQ   5   0         55            0    249.9kb        249.9kb</span><br></pre></td></tr></table></figure>

<h1 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h1><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h2 id="准备docker镜像-1"><a href="#准备docker镜像-1" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h2><p><a href="https://hub.docker.com/_/kibana?tab=tags" target="_blank" rel="noopener">kibana官方镜像下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kibana:6.8.3</span><br><span class="line">6.8.3: Pulling from library/kibana</span><br><span class="line"></span><br><span class="line">8014725ed6f5: Pull complete </span><br><span class="line">19b590251e94: Pull complete </span><br><span class="line">7fa3e54c0b5a: Pull complete </span><br><span class="line">60ee9811b356: Pull complete </span><br><span class="line">d18bafa420f4: Pull complete </span><br><span class="line">8cee55751899: Pull complete </span><br><span class="line">c395be470eb2: Pull complete </span><br><span class="line">Digest: sha256:71f776596244877597fd679b2fa6fb0f1fa9c5b11388199997781d1ce77b73b1</span><br><span class="line">Status: Downloaded newer image for kibana:6.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker tag 62079cf74c23 harbor.od.com/infra/kibana:v6.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kibana:v6.8.3</span><br><span class="line">docker push harbor.od.com/infra/kibana:v6.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kibana]</span><br><span class="line">be94745c5390: Pushed </span><br><span class="line">652dcbd52cdd: Pushed </span><br><span class="line">a3508a095ca7: Pushed </span><br><span class="line">56d52080e2fe: Pushed </span><br><span class="line">dbce28d91bf0: Pushed </span><br><span class="line">dcddc432ebdf: Pushed </span><br><span class="line">3e466685bf43: Pushed </span><br><span class="line">d69483a6face: Mounted from infra/logstash </span><br><span class="line">v6.8.3: digest: sha256:17dd243d6cc4e572f74f3de83eafc981e54c1710f8fe2d0bf74357b28bddaf08 size: 1991</span><br></pre></td></tr></table></figure>

<h2 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h2><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kibana             A    10.4.7.10</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><div class="tabs" id="kibana"><ul class="nav-tabs"><li class="tab active"><a href="#kibana-1">Deployment</a></li><li class="tab"><a href="#kibana-2">Service</a></li><li class="tab"><a href="#kibana-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="kibana-1"><p>vi /data/k8s-yaml/kibana/dp.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kibana</span><br><span class="line">        name: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: harbor.od.com/infra/kibana:v6.8.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ELASTICSEARCH_URL</span><br><span class="line">          value: http://10.4.7.12:9200</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kibana-2"><p>vi /data/k8s-yaml/kibana/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5601</span><br><span class="line">    targetPort: 5601</span><br><span class="line">  selector: </span><br><span class="line">    app: kibana</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kibana-3"><p>vi /data/k8s-yaml/kibana/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kibana</span><br><span class="line">          servicePort: 5601</span><br></pre></td></tr></table></figure></div></div></div>
<h2 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/kibana/dp.yaml</span><br><span class="line">deployment.extensions/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/kibana/svc.yaml</span><br><span class="line">service/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/kibana/ingress.yaml</span><br><span class="line">ingress.extensions/kibana created</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://kibana.od.com" target="_blank" rel="noopener">http://kibana.od.com</a><br><img src="/images/kibana.png" alt="kibana页面" title="kibana页面"></p>
<h1 id="kibana的使用"><a href="#kibana的使用" class="headerlink" title="kibana的使用"></a>kibana的使用</h1><p><img src="/images/kibana-usage.png" alt="kibana用法" title="kibana用法"></p>
<h2 id="选择区域"><a href="#选择区域" class="headerlink" title="选择区域"></a>选择区域</h2><ul>
<li><p>@timestamp</p>
<blockquote>
<p>对应日志的时间戳</p>
</blockquote>
</li>
<li><p>log.file.path</p>
<blockquote>
<p>对应日志文件名</p>
</blockquote>
</li>
<li><p>message</p>
<blockquote>
<p>对应日志内容</p>
</blockquote>
</li>
</ul>
<h2 id="时间选择器"><a href="#时间选择器" class="headerlink" title="时间选择器"></a>时间选择器</h2><ul>
<li>选择日志时间<blockquote>
<p>快速时间<br>绝对时间<br>相对时间</p>
</blockquote>
</li>
</ul>
<h2 id="环境选择器"><a href="#环境选择器" class="headerlink" title="环境选择器"></a>环境选择器</h2><ul>
<li>选择对应环境的日志<blockquote>
<p>k8s-test-*<br>k8s-prod-*</p>
</blockquote>
</li>
</ul>
<h2 id="项目选择器"><a href="#项目选择器" class="headerlink" title="项目选择器"></a>项目选择器</h2><ul>
<li>对应filebeat的PROJ_NAME值</li>
<li>Add a fillter</li>
<li>topic is ${PROJ_NAME}<blockquote>
<p>dubbo-demo-service<br>dubbo-demo-web</p>
</blockquote>
</li>
</ul>
<h2 id="关键字选择器"><a href="#关键字选择器" class="headerlink" title="关键字选择器"></a>关键字选择器</h2><ul>
<li>exception</li>
<li>error</li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Stanley Wang 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.2yuan.png" alt="Stanley Wang 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/18/Day7：企业级Kubernetes容器云自动化运维平台/" rel="next" title="Day7：企业级Kubernetes容器云自动化运维平台">
                <i class="fa fa-chevron-left"></i> Day7：企业级Kubernetes容器云自动化运维平台
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/18/Day5：实战新一代容器云监控Prometheus+Grafana/" rel="prev" title="Day5：实战新一代容器云监控Prometheus+Grafana">
                Day5：实战新一代容器云监控Prometheus+Grafana <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Stanley Wang">
            
              <p class="site-author-name" itemprop="name">Stanley Wang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/stanleywang" title="GitHub &rarr; https://gitee.com/stanleywang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:stanley.wang.m@qq.com" title="E-Mail &rarr; mailto:stanley.wang.m@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#改造dubbo-demo-web项目为Tomcat启动项目"><span class="nav-number">1.</span> <span class="nav-text">改造dubbo-demo-web项目为Tomcat启动项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备Tomcat的镜像底包"><span class="nav-number">1.1.</span> <span class="nav-text">准备Tomcat的镜像底包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备tomcat二进制包"><span class="nav-number">1.1.1.</span> <span class="nav-text">准备tomcat二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单配置tomcat"><span class="nav-number">1.1.2.</span> <span class="nav-text">简单配置tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备Dockerfile"><span class="nav-number">1.1.3.</span> <span class="nav-text">准备Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#制作镜像并推送"><span class="nav-number">1.1.4.</span> <span class="nav-text">制作镜像并推送</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改造dubbo-demo-web项目"><span class="nav-number">1.2.</span> <span class="nav-text">改造dubbo-demo-web项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新建Jenkins的pipeline"><span class="nav-number">1.3.</span> <span class="nav-text">新建Jenkins的pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置New-job"><span class="nav-number">1.3.1.</span> <span class="nav-text">配置New job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-Script"><span class="nav-number">1.3.2.</span> <span class="nav-text">Pipeline Script</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建应用镜像"><span class="nav-number">1.4.</span> <span class="nav-text">构建应用镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备k8s的资源配置清单"><span class="nav-number">1.5.</span> <span class="nav-text">准备k8s的资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用资源配置清单"><span class="nav-number">1.6.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器访问"><span class="nav-number">1.7.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查tomcat运行情况"><span class="nav-number">1.8.</span> <span class="nav-text">检查tomcat运行情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署ElasticSearch"><span class="nav-number">2.</span> <span class="nav-text">部署ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装"><span class="nav-number">2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置"><span class="nav-number">2.2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#elasticsearch-yml"><span class="nav-number">2.2.1.</span> <span class="nav-text">elasticsearch.yml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jvm-options"><span class="nav-number">2.2.2.</span> <span class="nav-text">jvm.options</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建普通用户"><span class="nav-number">2.2.3.</span> <span class="nav-text">创建普通用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#文件描述符"><span class="nav-number">2.2.4.</span> <span class="nav-text">文件描述符</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整内核参数"><span class="nav-number">2.2.5.</span> <span class="nav-text">调整内核参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动"><span class="nav-number">2.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调整ES日志模板"><span class="nav-number">2.4.</span> <span class="nav-text">调整ES日志模板</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署kafka"><span class="nav-number">3.</span> <span class="nav-text">部署kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装-1"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置-1"><span class="nav-number">3.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动-1"><span class="nav-number">3.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署kafka-manager"><span class="nav-number">4.</span> <span class="nav-text">部署kafka-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#方法一：自定义构建"><span class="nav-number">4.1.</span> <span class="nav-text">方法一：自定义构建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备Dockerfile-1"><span class="nav-number">4.1.1.</span> <span class="nav-text">准备Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#制作docker镜像"><span class="nav-number">4.1.2.</span> <span class="nav-text">制作docker镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#方法二：直接下载docker镜像"><span class="nav-number">4.2.</span> <span class="nav-text">方法二：直接下载docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备资源配置清单"><span class="nav-number">4.3.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用资源配置清单-1"><span class="nav-number">4.4.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析域名"><span class="nav-number">4.5.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器访问-1"><span class="nav-number">4.6.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署filebeat"><span class="nav-number">5.</span> <span class="nav-text">部署filebeat</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#制作docker镜像-1"><span class="nav-number">5.1.</span> <span class="nav-text">制作docker镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备Dockerfile-2"><span class="nav-number">5.1.1.</span> <span class="nav-text">准备Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#制作镜像"><span class="nav-number">5.1.2.</span> <span class="nav-text">制作镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改资源配置清单"><span class="nav-number">5.2.</span> <span class="nav-text">修改资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器访问http-km-od-com"><span class="nav-number">5.3.</span> <span class="nav-text">浏览器访问http://km.od.com</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#验证数据"><span class="nav-number">5.4.</span> <span class="nav-text">验证数据</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署logstash"><span class="nav-number">6.</span> <span class="nav-text">部署logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#选版本"><span class="nav-number">6.1.</span> <span class="nav-text">选版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备docker镜像"><span class="nav-number">6.2.</span> <span class="nav-text">准备docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动docker镜像"><span class="nav-number">6.3.</span> <span class="nav-text">启动docker镜像</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Kibana"><span class="nav-number">7.</span> <span class="nav-text">部署Kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备docker镜像-1"><span class="nav-number">7.1.</span> <span class="nav-text">准备docker镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解析域名-1"><span class="nav-number">7.2.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备资源配置清单-1"><span class="nav-number">7.3.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用资源配置清单-2"><span class="nav-number">7.4.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器访问-2"><span class="nav-number">7.5.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#kibana的使用"><span class="nav-number">8.</span> <span class="nav-text">kibana的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#选择区域"><span class="nav-number">8.1.</span> <span class="nav-text">选择区域</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#时间选择器"><span class="nav-number">8.2.</span> <span class="nav-text">时间选择器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境选择器"><span class="nav-number">8.3.</span> <span class="nav-text">环境选择器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#项目选择器"><span class="nav-number">8.4.</span> <span class="nav-text">项目选择器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关键字选择器"><span class="nav-number">8.5.</span> <span class="nav-text">关键字选择器</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stanley Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">890k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">13:29</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
