<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com k8s运">
<meta property="og:type" content="article">
<meta property="og:title" content="Day1：跟我一步步部署kubernetes集群（上）">
<meta property="og:url" content="https://StanleyWang-GitHub.github.io/2019/10/18/Day1：跟我一步步部署kubernetes集群（上）/index.html">
<meta property="og:site_name" content="Stanley&#39;s Blog">
<meta property="og:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com k8s运">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2020-09-03T08:33:09.877Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Day1：跟我一步步部署kubernetes集群（上）">
<meta name="twitter:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com k8s运">






  <link rel="canonical" href="https://StanleyWang-GitHub.github.io/2019/10/18/Day1：跟我一步步部署kubernetes集群（上）/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Day1：跟我一步步部署kubernetes集群（上） | Stanley's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stanley's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/10/18/Day1：跟我一步步部署kubernetes集群（上）/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Day1：跟我一步步部署kubernetes集群（上）

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-18 22:12:56" itemprop="dateCreated datePublished" datetime="2019-10-18T22:12:56+08:00">2019-10-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">68k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:02</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="实验架构"><a href="#实验架构" class="headerlink" title="实验架构"></a>实验架构</h1><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>k8s代理节点1</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>k8s代理节点2</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>k8s运算节点1</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>k8s运算节点2</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>k8s运维节点(docker仓库)</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h2 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h2><ul>
<li>5台vm，每台至少2c2g</li>
</ul>
<h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><ul>
<li>OS: CentOS Linux release 7.6.1810 (Core)</li>
<li>docker-ce: v19.03.0</li>
<li>kubernetes: v1.15.2<blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener">kubernetes官方下载地址</a></p>
</blockquote>
</li>
<li>etcd: v3.1.20<blockquote>
<p><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">etcd官方下载地址</a></p>
</blockquote>
</li>
<li>bind9: v9.9.4<blockquote>
<p><a href="https://www.isc.org/downloads/#" target="_blank" rel="noopener">bind9官方下载地址</a></p>
</blockquote>
</li>
<li>harbor: v1.8.3<blockquote>
<p><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">harbor官方下载地址</a></p>
</blockquote>
</li>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssl-json下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
<li>其他<blockquote>
<p>其他可能用到的软件，均使用操作系统自带的yum源和epel源进行安装</p>
</blockquote>
</li>
</ul>
<h1 id="实验准备工作"><a href="#实验准备工作" class="headerlink" title="实验准备工作"></a>实验准备工作</h1><h2 id="准备虚拟机"><a href="#准备虚拟机" class="headerlink" title="准备虚拟机"></a>准备虚拟机</h2><ul>
<li>5台vm，每台至少2c2g</li>
</ul>
<h2 id="调整操作系统"><a href="#调整操作系统" class="headerlink" title="调整操作系统"></a>调整操作系统</h2><p>所有主机上：</p>
<h3 id="调整yum源"><a href="#调整yum源" class="headerlink" title="调整yum源"></a>调整yum源</h3><h3 id="安装epel-release"><a href="#安装epel-release" class="headerlink" title="安装epel-release"></a>安装epel-release</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install epel-release</span><br></pre></td></tr></table></figure>

<h3 id="关闭SElinux和firewalld"><a href="#关闭SElinux和firewalld" class="headerlink" title="关闭SElinux和firewalld"></a>关闭SElinux和firewalld</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># setenforce 0</span><br><span class="line"># systemctl stop firewalld</span><br></pre></td></tr></table></figure>

<h3 id="安装必要工具"><a href="#安装必要工具" class="headerlink" title="安装必要工具"></a>安装必要工具</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install wget net-tools telnet tree nmap sysstat lrzsz dos2unix bind-utils -y</span><br></pre></td></tr></table></figure>

<h2 id="DNS服务初始化"><a href="#DNS服务初始化" class="headerlink" title="DNS服务初始化"></a>DNS服务初始化</h2><p><code>HDSS7-11.host.com</code>上：</p>
<h3 id="安装bind9软件"><a href="#安装bind9软件" class="headerlink" title="安装bind9软件"></a>安装bind9软件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# yum install bind -y</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                                       Arch                          Version                                    Repository                      Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> bind                                          x86_64                        32:9.9.4-73.el7_6                          updates                        1.8 M</span><br></pre></td></tr></table></figure>

<h3 id="配置bind9"><a href="#配置bind9" class="headerlink" title="配置bind9"></a>配置bind9</h3><h4 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h4><figure class="highlight plain"><figcaption><span>/etc/named/named.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen-on port 53 &#123; 10.4.7.11; &#125;;</span><br><span class="line">allow-query     &#123; any; &#125;;</span><br><span class="line">forwarders      &#123; 10.4.7.1; &#125;;</span><br><span class="line">dnssec-enable no;</span><br><span class="line">dnssec-validation no;</span><br></pre></td></tr></table></figure>

<h4 id="区域配置文件"><a href="#区域配置文件" class="headerlink" title="区域配置文件"></a>区域配置文件</h4><figure class="highlight plain"><figcaption><span>/etc/named/named.rfc1912.zones</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;od.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;od.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="配置区域数据文件"><a href="#配置区域数据文件" class="headerlink" title="配置区域数据文件"></a>配置区域数据文件</h4><ul>
<li>配置主机域数据文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/var/named/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2019061801 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   dns.host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br><span class="line">HDSS7-11           A    10.4.7.11</span><br><span class="line">HDSS7-12           A    10.4.7.12</span><br><span class="line">HDSS7-21           A    10.4.7.21</span><br><span class="line">HDSS7-22           A    10.4.7.22</span><br><span class="line">HDSS7-200          A    10.4.7.200</span><br></pre></td></tr></table></figure>

<ul>
<li>配置业务域数据文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN od.com.</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@   		IN SOA	dns.od.com. dnsadmin.od.com. (</span><br><span class="line">				2019061801 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">				NS   dns.od.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">dns                A    10.4.7.11</span><br></pre></td></tr></table></figure>

<h3 id="启动bind9"><a href="#启动bind9" class="headerlink" title="启动bind9"></a>启动bind9</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# named-checkconf</span><br><span class="line">[root@hdss7-11 ~]# systemctl start named</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable named</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# dig -t A hdss7-11.host.com @10.4.7.11 +short</span><br><span class="line">10.4.7.11</span><br><span class="line">[root@hdss7-11 ~]# dig -t A dns.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.11</span><br></pre></td></tr></table></figure>

<h3 id="配置DNS客户端"><a href="#配置DNS客户端" class="headerlink" title="配置DNS客户端"></a>配置DNS客户端</h3><ul>
<li>Linux主机上</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/resolv.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Generated by NetworkManager</span><br><span class="line">search host.com</span><br><span class="line">nameserver 10.4.7.11</span><br></pre></td></tr></table></figure>

<ul>
<li>Windows主机上</li>
</ul>
<blockquote>
<p>网络和共享中心-&gt;网卡设置-&gt;设置DNS服务器<br>如有必要，还应设置虚拟网卡的接口跃点数为：10</p>
</blockquote>
<h3 id="检查-1"><a href="#检查-1" class="headerlink" title="检查"></a>检查</h3><ul>
<li><p>Linux主机上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# ping hdss7-12</span><br><span class="line">PING hdss7-12.host.com (10.4.7.12) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.4.7.12 (10.4.7.12): icmp_seq=1 ttl=64 time=2.69 ms</span><br><span class="line">64 bytes from 10.4.7.12 (10.4.7.12): icmp_seq=2 ttl=64 time=10.3 ms</span><br><span class="line">64 bytes from 10.4.7.12 (10.4.7.12): icmp_seq=3 ttl=64 time=3.15 ms</span><br><span class="line">^C</span><br><span class="line">--- hdss7-12.host.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2003ms</span><br><span class="line">rtt min/avg/max/mdev = 2.696/5.390/10.319/3.490 ms</span><br></pre></td></tr></table></figure>
</li>
<li><p>Windows主机上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator&gt; ping hdss7-200.host.com</span><br><span class="line"></span><br><span class="line">正在 Ping hdss7-200.host.com [10.4.7.200] 具有 32 字节的数据:</span><br><span class="line">来自 10.4.7.200 的回复: 字节=32 时间=2ms TTL=64</span><br><span class="line">来自 10.4.7.200 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 10.4.7.200 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line">来自 10.4.7.200 的回复: 字节=32 时间&lt;1ms TTL=64</span><br><span class="line"></span><br><span class="line">10.4.7.200 的 Ping 统计信息:</span><br><span class="line">    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，</span><br><span class="line">往返行程的估计时间(以毫秒为单位):</span><br><span class="line">    最短 = 0ms，最长 = 2ms，平均 = 0ms</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="准备签发证书环境"><a href="#准备签发证书环境" class="headerlink" title="准备签发证书环境"></a>准备签发证书环境</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="安装CFSSL"><a href="#安装CFSSL" class="headerlink" title="安装CFSSL"></a>安装CFSSL</h3><ul>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssl-json下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/bin/cfssl</span><br><span class="line">[root@hdss7-200 ~]# wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/bin/cfssl-json</span><br><span class="line">[root@hdss7-200 ~]# wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 -O /usr/bin/cfssl-certinfo</span><br><span class="line">[root@hdss7-200 ~]# chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure>

<h3 id="创建生成CA证书签名请求（csr）的JSON配置文件"><a href="#创建生成CA证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成CA证书签名请求（csr）的JSON配置文件"></a>创建生成CA证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;OldboyEdu&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法<br>C: Country， 国家<br>ST: State，州，省<br>L: Locality，地区，城市<br>O: Organization Name，组织名称，公司名称<br>OU: Organization Unit Name，组织单位名称，公司部门</p>
</blockquote>
<h3 id="生成CA证书和私钥"><a href="#生成CA证书和私钥" class="headerlink" title="生成CA证书和私钥"></a>生成CA证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -initca ca-csr.json | cfssl-json -bare ca</span><br><span class="line">2019/01/18 09:31:19 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generate received request</span><br><span class="line">2019/01/18 09:31:19 [INFO] received CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 09:31:19 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] signed certificate with serial number 345276964513449660162382535043012874724976422200</span><br></pre></td></tr></table></figure>

<p>生成ca.pem、ca.csr、ca-key.pem(CA证书、私钥,需妥善保管)</p>
<figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root  332 Jan 16 11:10 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 16 11:17 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1001 Jan 16 11:17 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 16 11:17 ca.pem</span><br></pre></td></tr></table></figure>

<h2 id="部署docker环境"><a href="#部署docker环境" class="headerlink" title="部署docker环境"></a>部署docker环境</h2><p><code>HDSS7-200.host.com</code>,<code>HDSS7-21.host.com</code>,<code>HDSS7-22.host.com</code>上：</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line"># Executing docker install script, commit: 6bf300318ebaab958c4adc341a8c7bb9f3a54a1a</span><br><span class="line">+ sh -c &apos;yum install -y -q yum-utils&apos;</span><br><span class="line">+ sh -c &apos;yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo&apos;</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">adding repo from: https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">grabbing file https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">repo saved to /etc/yum.repos.d/docker-ce.repo</span><br><span class="line">+ &apos;[&apos; stable &apos;!=&apos; stable &apos;]&apos;</span><br><span class="line">+ sh -c &apos;yum makecache&apos;</span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">epel/x86_64/metalink                                                                                                      | 8.5 kB  00:00:00     </span><br><span class="line"> * epel: mirrors.tuna.tsinghua.edu.cn</span><br><span class="line">base                                                                                                                      | 3.6 kB  00:00:00     </span><br><span class="line">docker-ce-stable                                                                                                          | 3.5 kB  00:00:00     </span><br><span class="line">epel                                                                                                                      | 5.3 kB  00:00:00     </span><br><span class="line">extras                                                                                                                    | 3.4 kB  00:00:00     </span><br><span class="line">updates                                                                                                                   | 3.4 kB  00:00:00     </span><br><span class="line">(1/14): docker-ce-stable/x86_64/updateinfo                                                                                |   55 B  00:00:00     </span><br><span class="line">(2/14): docker-ce-stable/x86_64/filelists_db                                                                              |  15 kB  00:00:00     </span><br><span class="line">(3/14): docker-ce-stable/x86_64/primary_db                                                                                |  31 kB  00:00:00     </span><br><span class="line">(4/14): docker-ce-stable/x86_64/other_db                                                                                  | 112 kB  00:00:00     </span><br><span class="line">(5/14): epel/x86_64/filelists_db                                                                                          |  12 MB  00:00:05     </span><br><span class="line">(6/14): epel/x86_64/prestodelta                                                                                           | 1.7 kB  00:00:00     </span><br><span class="line">(7/14): epel/x86_64/other_db                                                                                              | 3.3 MB  00:00:01     </span><br><span class="line">(8/14): epel/x86_64/updateinfo_zck                                                                                        | 1.5 MB  00:00:00     </span><br><span class="line">(9/14): extras/7/x86_64/prestodelta                                                                                       |  65 kB  00:00:00     </span><br><span class="line">(10/14): extras/7/x86_64/other_db                                                                                         | 127 kB  00:00:00     </span><br><span class="line">(11/14): extras/7/x86_64/filelists_db                                                                                     | 246 kB  00:00:00     </span><br><span class="line">(12/14): updates/7/x86_64/prestodelta                                                                                     | 857 kB  00:00:00     </span><br><span class="line">(13/14): updates/7/x86_64/other_db                                                                                        | 672 kB  00:00:00     </span><br><span class="line">(14/14): updates/7/x86_64/filelists_db                                                                                    | 4.9 MB  00:00:02     </span><br><span class="line">Metadata Cache Created</span><br><span class="line">+ &apos;[&apos; -n &apos;&apos; &apos;]&apos;</span><br><span class="line">+ sh -c &apos;yum install -y -q docker-ce&apos;</span><br><span class="line">warning: /var/cache/yum/x86_64/7/docker-ce-stable/packages/docker-ce-19.03.0-3.el7.x86_64.rpm: Header V4 RSA/SHA512 Signature, key ID 621e9f35: NOKEY</span><br><span class="line">Public key for docker-ce-19.03.0-3.el7.x86_64.rpm is not installed</span><br><span class="line">Importing GPG key 0x621E9F35:</span><br><span class="line"> Userid     : &quot;Docker Release (CE rpm) &lt;docker@docker.com&gt;&quot;</span><br><span class="line"> Fingerprint: 060a 61c5 1b55 8a7f 742b 77aa c52f eb6b 621e 9f35</span><br><span class="line"> From       : https://mirrors.aliyun.com/docker-ce/linux/centos/gpg</span><br><span class="line">setsebool:  SELinux is disabled.</span><br><span class="line">If you would like to use Docker as a non-root user, you should now consider</span><br><span class="line">adding your user to the &quot;docker&quot; group with something like:</span><br><span class="line"></span><br><span class="line">  sudo usermod -aG docker your-user</span><br><span class="line"></span><br><span class="line">Remember that you will have to log out and back in for this to take effect!</span><br><span class="line"></span><br><span class="line">WARNING: Adding a user to the &quot;docker&quot; group will grant the ability to run</span><br><span class="line">         containers which can be used to obtain root privileges on the</span><br><span class="line">         docker host.</span><br><span class="line">         Refer to https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface</span><br><span class="line">         for more information.</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/etc/docker/daemon.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay2&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.od.com&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://q2gr04ke.mirror.aliyuncs.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里bip要根据宿主机ip变化</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker.service</span><br><span class="line"># systemctl start docker.service</span><br></pre></td></tr></table></figure>

<h2 id="部署docker镜像私有仓库harbor"><a href="#部署docker镜像私有仓库harbor" class="headerlink" title="部署docker镜像私有仓库harbor"></a>部署docker镜像私有仓库harbor</h2><p><strong><code>HDSS7-200.host.com</code>上：</strong></p>
<h3 id="下载软件二进制包并解压"><a href="#下载软件二进制包并解压" class="headerlink" title="下载软件二进制包并解压"></a>下载软件二进制包并解压</h3><p><a href="https://github.com/goharbor/harbor" target="_blank" rel="noopener">harbor官方github地址</a><br><a href="https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.8.3.tgz" target="_blank" rel="noopener">harbor下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# tar xfv harbor-offline-installer-v1.8.3.tgz -C /opt</span><br><span class="line">harbor/harbor.v1.8.3.tar.gz</span><br><span class="line">harbor/prepare</span><br><span class="line">harbor/LICENSE</span><br><span class="line">harbor/install.sh</span><br><span class="line">harbor/harbor.yml</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# mv /opt/harbor /opt/harbor-v1.8.3</span><br><span class="line">[root@hdss7-200 harbor]# ln -s /opt/harbor-v1.8.3 /opt/harbor</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/opt/harbor/harbor.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hostname = harbor.od.com</span><br><span class="line">http:</span><br><span class="line">  port: 180</span><br><span class="line">harbor_admin_password: Harbor12345</span><br><span class="line">data_volume: /data/harbor</span><br><span class="line">log:</span><br><span class="line">  level: info</span><br><span class="line">  rotate_count: 50</span><br><span class="line">  rotate_size: 200M</span><br><span class="line">  location: /data/harbor/logs</span><br></pre></td></tr></table></figure>

<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install docker-compose -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line">docker-compose-1.18.0-2.el7.noarch</span><br></pre></td></tr></table></figure>

<h3 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h3><figure class="highlight plain"><figcaption><span>/opt/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# ./install.sh</span><br></pre></td></tr></table></figure>

<h3 id="检查harbor启动情况"><a href="#检查harbor启动情况" class="headerlink" title="检查harbor启动情况"></a>检查harbor启动情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker-compose ps</span><br><span class="line">       Name                     Command               State                                 Ports                               </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-core          /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      5432/tcp                                                          </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-log           /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp                                         </span><br><span class="line">harbor-portal        nginx -g daemon off;             Up      80/tcp                                                            </span><br><span class="line">nginx                nginx -g daemon off;             Up      0.0.0.0:1443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:180-&gt;80/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      6379/tcp                                                          </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      5000/tcp                                                          </span><br><span class="line">registryctl          /harbor/start.sh                 Up</span><br></pre></td></tr></table></figure>

<h3 id="配置harbor的dns内网解析"><a href="#配置harbor的dns内网解析" class="headerlink" title="配置harbor的dns内网解析"></a>配置harbor的dns内网解析</h3><ul>
<li>配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">harbor             A    10.4.7.200</span><br></pre></td></tr></table></figure>

<ul>
<li>检查</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# dig -t A harbor.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h3 id="安装nginx并配置"><a href="#安装nginx并配置" class="headerlink" title="安装nginx并配置"></a>安装nginx并配置</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install nginx -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa nginx</span><br><span class="line">nginx-1.12.2-2.el7.x86_64</span><br></pre></td></tr></table></figure>

<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/harbor.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# systemctl start nginx</span><br><span class="line">[root@hdss7-200 harbor]# systemctl enable nginx</span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/nginx.service to /usr/lib/systemd/system/nginx.service.</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# netstat -luntp|grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6590/nginx: master</span><br></pre></td></tr></table></figure>

<h3 id="浏览器打开http-harbor-od-com"><a href="#浏览器打开http-harbor-od-com" class="headerlink" title="浏览器打开http://harbor.od.com"></a>浏览器打开<a href="http://harbor.od.com" target="_blank" rel="noopener">http://harbor.od.com</a></h3><ul>
<li>用户名：admin</li>
<li>密码： Harbor12345</li>
</ul>
<h3 id="检查-2"><a href="#检查-2" class="headerlink" title="检查"></a>检查</h3><ul>
<li>打开harbor页面，创建public项目（公开）</li>
</ul>
<h4 id="下载测试镜像"><a href="#下载测试镜像" class="headerlink" title="下载测试镜像"></a>下载测试镜像</h4><p>在运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker pull nginx:1.7.9</span><br><span class="line">1.7.9: Pulling from library/nginx</span><br><span class="line">a3ed95caeb02: Pull complete </span><br><span class="line">6f5424ebd796: Pull complete </span><br><span class="line">d15444df170a: Pull complete </span><br><span class="line">e83f073daa67: Pull complete </span><br><span class="line">a4d93e421023: Pull complete </span><br><span class="line">084adbca2647: Pull complete </span><br><span class="line">c9cec474c523: Pull complete </span><br><span class="line">Digest: sha256:e3456c851a152494c3e4ff5fcc26f240206abac0c9d794affb40e0714846c451</span><br><span class="line">Status: Downloaded newer image for nginx:1.7.9</span><br></pre></td></tr></table></figure>

<h4 id="给镜像打tag"><a href="#给镜像打tag" class="headerlink" title="给镜像打tag"></a>给镜像打tag</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# tag 84581e99d807 harbor.od.com/public/nginx:v1.7.9</span><br></pre></td></tr></table></figure>

<h4 id="登录harbor"><a href="#登录harbor" class="headerlink" title="登录harbor"></a>登录harbor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker login harbor.od.com</span><br><span class="line">Username: admin</span><br><span class="line">Password: Harbor12345 </span><br><span class="line">Login Succeeded</span><br></pre></td></tr></table></figure>

<h4 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker push harbor.od.com/public/nginx:v1.7.9</span><br></pre></td></tr></table></figure>

<h4 id="检查web页面"><a href="#检查web页面" class="headerlink" title="检查web页面"></a>检查web页面</h4><ul>
<li>观察public仓库里镜像是否存在</li>
</ul>
<h1 id="部署Master节点服务"><a href="#部署Master节点服务" class="headerlink" title="部署Master节点服务"></a>部署Master节点服务</h1><h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-12.host.com</td>
<td>etcd lead</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>etcd follow</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>etcd follow</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-12.host.com</code>主机为例，另外两台主机安装部署方法类似</p>
<h3 id="创建基于根证书的config配置文件"><a href="#创建基于根证书的config配置文件" class="headerlink" title="创建基于根证书的config配置文件"></a>创建基于根证书的config配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>证书类型<br>client certificate： 客户端使用，用于服务端认证客户端,例如etcdctl、etcd proxy、fleetctl、docker客户端<br>server certificate: 服务端使用，客户端以此验证服务端身份,例如docker服务端、kube-apiserver<br>peer certificate: 双向证书，用于etcd集群成员间通信</p>
</blockquote>
<h3 id="创建生成自签证书签名请求（csr）的JSON配置文件"><a href="#创建生成自签证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成自签证书签名请求（csr）的JSON配置文件"></a>创建生成自签证书签名请求（csr）的JSON配置文件</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/certs/etcd-peer-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成etcd证书和私钥"><a href="#生成etcd证书和私钥" class="headerlink" title="生成etcd证书和私钥"></a>生成etcd证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssl-json -bare etcd-peer</span><br><span class="line">2019/01/18 09:35:09 [INFO] generate received request</span><br><span class="line">2019/01/18 09:35:09 [INFO] received CSR</span><br><span class="line">2019/01/18 09:35:09 [INFO] generating key: rsa-2048</span><br><span class="line"></span><br><span class="line">2019/01/18 09:35:09 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:35:10 [INFO] signed certificate with serial number 324191491384928915605254764031096067872154649010</span><br><span class="line">2019/01/18 09:35:10 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h3 id="检查生成的证书、私钥"><a href="#检查生成的证书、私钥" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep etcd</span><br><span class="line">-rw-r--r-- 1 root root  387 Jan 18 12:32 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 18 12:32 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jan 18 12:32 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root 1432 Jan 18 12:32 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd用户"><a href="#创建etcd用户" class="headerlink" title="创建etcd用户"></a>创建etcd用户</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# useradd -s /sbin/nologin -M etcd</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">etcd下载地址</a><br><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# ls -l</span><br><span class="line">total 9604</span><br><span class="line">-rw-r--r-- 1 root root 9831476 Jan 18 10:45 etcd-v3.1.20-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf etcd-v3.1.20-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/etcd-v3.1.20-linux-amd64 /opt/etcd</span><br><span class="line">[root@hdss7-12 src]# ls -l /opt</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root   root   24 Jan 18 14:21 etcd -&gt; etcd-v3.1.20-linux-amd64</span><br><span class="line">drwxr-xr-x 4 478493 89939 166 Jun 16  2018 etcd-v3.1.20-linux-amd64</span><br><span class="line">drwxr-xr-x 2 root   root   45 Jan 18 14:21 src</span><br></pre></td></tr></table></figure>

<h3 id="创建目录，拷贝证书、私钥"><a href="#创建目录，拷贝证书、私钥" class="headerlink" title="创建目录，拷贝证书、私钥"></a>创建目录，拷贝证书、私钥</h3><p><code>HDSS7-12.host.com</code>上：</p>
<ul>
<li>创建目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br></pre></td></tr></table></figure>

<ul>
<li><p>拷贝证书</p>
<blockquote>
<p>将运维主机上生成的<code>ca.pem</code>、<code>etcd-peer-key.pem</code>、<code>etcd-peer.pem</code>拷贝到<code>/opt/etcd/certs</code>目录中，注意私钥文件权限600</p>
</blockquote>
</li>
<li><p>修改权限</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/etcd/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chown -R etcd.etcd /opt/etcd/certs /data/etcd /data/logs/etcd-server</span><br><span class="line">[root@hdss7-12 certs]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1354 Jan 18 14:45 ca.pem</span><br><span class="line">-rw------- 1 etcd etcd 1679 Jan 18 17:00 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1444 Jan 18 17:02 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd服务启动脚本"><a href="#创建etcd服务启动脚本" class="headerlink" title="创建etcd服务启动脚本"></a>创建etcd服务启动脚本</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd/etcd-server-startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir /data/etcd/etcd-server \</span><br><span class="line">       --listen-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \</span><br><span class="line">       --ca-file ./certs/ca.pem \</span><br><span class="line">       --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="调整权限"><a href="#调整权限" class="headerlink" title="调整权限"></a>调整权限</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod +x /opt/etcd/etcd-server-startup.sh</span><br></pre></td></tr></table></figure>

<h3 id="安装supervisor软件"><a href="#安装supervisor软件" class="headerlink" title="安装supervisor软件"></a>安装supervisor软件</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# yum install supervisor -y</span><br><span class="line">[root@hdss7-12 certs]# systemctl start supervisord</span><br><span class="line">[root@hdss7-12 certs]# systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd-server的启动配置"><a href="#创建etcd-server的启动配置" class="headerlink" title="创建etcd-server的启动配置"></a>创建etcd-server的启动配置</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/etcd-server.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                                ; kill all process in a group</span><br><span class="line">stopasgroup=true                                                ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改。</p>
<h3 id="启动etcd服务并检查"><a href="#启动etcd服务并检查" class="headerlink" title="启动etcd服务并检查"></a>启动etcd服务并检查</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# supervisorctl update</span><br><span class="line">etcd-server-7-12: started</span><br><span class="line">[root@hdss7-12 certs]# supervisorctl status   </span><br><span class="line">etcd-server-7-12                 RUNNING   pid 6692, uptime 0:00:05</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的etcd服务"><a href="#安装部署启动检查所有集群规划主机上的etcd服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的etcd服务"></a>安装部署启动检查所有集群规划主机上的etcd服务</h3><p>略</p>
<h3 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h3><p>3台均启动后，检查集群状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl cluster-health</span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl member list</span><br><span class="line">988139385f78284: name=etcd-server-7-22 peerURLs=https://10.4.7.22:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.22:2379 isLeader=false</span><br><span class="line">5a0ef2a004fc4349: name=etcd-server-7-21 peerURLs=https://10.4.7.21:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.21:2379 isLeader=false</span><br><span class="line">f4a0cb0a765574a8: name=etcd-server-7-12 peerURLs=https://10.4.7.12:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.12:2379 isLeader=true</span><br></pre></td></tr></table></figure>

<h2 id="部署kube-apiserver集群"><a href="#部署kube-apiserver集群" class="headerlink" title="部署kube-apiserver集群"></a>部署kube-apiserver集群</h2><h3 id="集群规划-1"><a href="#集群规划-1" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-11.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.12</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里<code>10.4.7.11</code>和<code>10.4.7.12</code>使用nginx做4层负载均衡器，用keepalived跑一个vip：10.4.7.10，代理两个kube-apiserver，实现高可用</p>
<p>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="下载软件，解压，做软连接-1"><a href="#下载软件，解压，做软连接-1" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code>上：<br><a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener">kubernetes官方Github地址</a><br><a href="https://dl.k8s.io/v1.15.2/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">kubernetes下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# ls -l|grep kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 16:46 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# tar xf kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-21 src]# mv /opt/kubernetes /opt/kubernetes-v1.15.2-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/kubernetes-v1.15.2-linux-amd64 /opt/kubernetes</span><br><span class="line">[root@hdss7-21 src]# mkdir /opt/kubernetes/server/bin/&#123;cert,conf&#125;</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep kubernetes</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 18 10:49 kubernetes -&gt; kubernetes-v1.15.2-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 17:40 kubernetes-v1.15.2-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="签发client证书"><a href="#签发client证书" class="headerlink" title="签发client证书"></a>签发client证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件"><a href="#创建生成证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/client-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成client证书和私钥"><a href="#生成client证书和私钥" class="headerlink" title="生成client证书和私钥"></a>生成client证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssl-json -bare client</span><br><span class="line">2019/01/18 14:02:50 [INFO] generate received request</span><br><span class="line">2019/01/18 14:02:50 [INFO] received CSR</span><br><span class="line">2019/01/18 14:02:50 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:02:51 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:02:51 [INFO] signed certificate with serial number 423108651040279300242366884100637974155370861448</span><br><span class="line">2019/01/18 14:02:51 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-1"><a href="#检查生成的证书、私钥-1" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep client</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 11:13 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  989 Jan 21 11:13 client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1367 Jan 21 11:13 client.pem</span><br></pre></td></tr></table></figure>

<h3 id="签发kube-apiserver证书"><a href="#签发kube-apiserver证书" class="headerlink" title="签发kube-apiserver证书"></a>签发kube-apiserver证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-1"><a href="#创建生成证书签名请求（csr）的JSON配置文件-1" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/apiserver-csr.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-apiserver证书和私钥"><a href="#生成kube-apiserver证书和私钥" class="headerlink" title="生成kube-apiserver证书和私钥"></a>生成kube-apiserver证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssl-json -bare apiserver </span><br><span class="line">2019/01/18 14:05:44 [INFO] generate received request</span><br><span class="line">2019/01/18 14:05:44 [INFO] received CSR</span><br><span class="line">2019/01/18 14:05:44 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:05:46 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:05:46 [INFO] signed certificate with serial number 633406650960616624590510576685608580490218676227</span><br><span class="line">2019/01/18 14:05:46 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-2"><a href="#检查生成的证书、私钥-2" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep apiserver</span><br><span class="line">total 72</span><br><span class="line">-rw-r--r-- 1 root root  406 Jan 21 14:10 apiserver-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 14:11 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1082 Jan 21 14:11 apiserver.csr</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 14:11 apiserver.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置"><a href="#拷贝证书至各运算节点，并创建配置" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600"><a href="#拷贝证书、私钥，注意私钥文件属性600" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h4><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/audit.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&apos;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&apos;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods/log&quot;, &quot;pods/status&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;/api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;/version&quot;</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>

<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-apiserver.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">./kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">  --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile ./cert/ca.pem \</span><br><span class="line">  --etcd-certfile ./cert/client.pem \</span><br><span class="line">  --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb=1024 \</span><br><span class="line">  --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">  --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">  --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">  --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">  --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整权限和目录"><a href="#调整权限和目录" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置"><a href="#创建supervisor配置" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-apiserver.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-apiserver-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                            ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                                ; kill all process in a group</span><br><span class="line">stopasgroup=true                                                ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-apiserverr: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 43765, uptime 2:09:41</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-apiserver"><a href="#安装部署启动检查所有集群规划主机上的kube-apiserver" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-apiserver"></a>安装部署启动检查所有集群规划主机上的kube-apiserver</h3><p>略</p>
<h3 id="配4层反向代理"><a href="#配4层反向代理" class="headerlink" title="配4层反向代理"></a>配4层反向代理</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h4><h5 id="check-port-sh"><a href="#check-port-sh" class="headerlink" title="check_port.sh"></a>check_port.sh</h5><figure class="highlight plain"><figcaption><span>/etc/keepalived/check_port.sh </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#&#125;</span><br><span class="line">CHK_PORT=$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS=`ss -lnt|grep $CHK_PORT|wc -l`</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h5 id="keepalived主"><a href="#keepalived主" class="headerlink" title="keepalived主"></a>keepalived主</h5><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="keepalived备"><a href="#keepalived备" class="headerlink" title="keepalived备"></a>keepalived备</h5><p><code>HDSS7-12.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">	script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 251</span><br><span class="line">	mcast_src_ip 10.4.7.12</span><br><span class="line">	priority 90</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 11111111</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		chk_nginx</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.4.7.10</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动代理并检查"><a href="#启动代理并检查" class="headerlink" title="启动代理并检查"></a>启动代理并检查</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<ul>
<li><p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-11 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-12 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-12 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-12 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    inet 10.9.7.10/32 scope global vir0</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    （空）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="部署controller-manager"><a href="#部署controller-manager" class="headerlink" title="部署controller-manager"></a>部署controller-manager</h2><h3 id="集群规划-2"><a href="#集群规划-2" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>controller-manager</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-1"><a href="#创建启动脚本-1" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-controller-manager.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --root-ca-file ./cert/ca.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录"><a href="#调整文件权限，创建目录" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-1"><a href="#创建supervisor配置-1" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-conntroller-manager.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-controller-manager-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                                                  ; kill all process in a group</span><br><span class="line">stopasgroup=true                                                                  ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controller.stdout.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-1"><a href="#启动服务并检查-1" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-controller-manager: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status   </span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 44230, uptime 2:05:01</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"><a href="#安装部署启动检查所有集群规划主机上的kube-controller-manager服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"></a>安装部署启动检查所有集群规划主机上的kube-controller-manager服务</h3><p>略</p>
<h2 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h2><h3 id="集群规划-3"><a href="#集群规划-3" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-2"><a href="#创建启动脚本-2" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-scheduler.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录-1"><a href="#调整文件权限，创建目录-1" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-2"><a href="#创建supervisor配置-2" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-scheduler.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-scheduler-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                     ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                                         ; kill all process in a group</span><br><span class="line">stopasgroup=true                                                         ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-2"><a href="#启动服务并检查-2" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-scheduler: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 44230, uptime 2:05:01</span><br><span class="line">kube-scheduler-7-21              RUNNING   pid 44779, uptime 2:02:27</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-scheduler服务"><a href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-scheduler服务"></a>安装部署启动检查所有集群规划主机上的kube-scheduler服务</h3><p>略</p>
<h2 id="检查主控节点"><a href="#检查主控节点" class="headerlink" title="检查主控节点"></a>检查主控节点</h2><p><code>HDSS7-21.host.com</code>和<code>HDSS7-22.host.com</code>上：</p>
<h3 id="给kubectl创建软连接"><a href="#给kubectl创建软连接" class="headerlink" title="给kubectl创建软连接"></a>给kubectl创建软连接</h3><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">/usr/bin/kubectl</span><br></pre></td></tr></table></figure>

<h3 id="检查主控节点-1"><a href="#检查主控节点-1" class="headerlink" title="检查主控节点"></a>检查主控节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get cs</span><br><span class="line">NAME                 STATUS    MESSAGE              ERROR</span><br><span class="line">controller-manager   Healthy   ok                   </span><br><span class="line">scheduler            Healthy   ok                   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="部署Node节点服务"><a href="#部署Node节点服务" class="headerlink" title="部署Node节点服务"></a>部署Node节点服务</h1><h2 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h2><h3 id="集群规划-4"><a href="#集群规划-4" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kubelet</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kubelet</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kubelet证书"><a href="#签发kubelet证书" class="headerlink" title="签发kubelet证书"></a>签发kubelet证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-2"><a href="#创建生成证书签名请求（csr）的JSON配置文件-2" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>kubelet-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-kubelet&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kubelet证书和私钥"><a href="#生成kubelet证书和私钥" class="headerlink" title="生成kubelet证书和私钥"></a>生成kubelet证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssl-json -bare kubelet</span><br><span class="line">2019/01/18 17:51:16 [INFO] generate received request</span><br><span class="line">2019/01/18 17:51:16 [INFO] received CSR</span><br><span class="line">2019/01/18 17:51:16 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 17:51:17 [INFO] encoded CSR</span><br><span class="line">2019/01/18 17:51:17 [INFO] signed certificate with serial number 48870268157415133698067712395152321546974943470</span><br><span class="line">2019/01/18 17:51:17 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-3"><a href="#检查生成的证书、私钥-3" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kubelet</span><br><span class="line">total 88</span><br><span class="line">-rw-r--r-- 1 root root  415 Jan 22 16:58 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1086 Jan 22 17:00 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-1"><a href="#拷贝证书至各运算节点，并创建配置-1" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-1"><a href="#拷贝证书、私钥，注意私钥文件属性600-1" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-1"><a href="#创建配置-1" class="headerlink" title="创建配置"></a>创建配置</h4><h5 id="set-cluster"><a href="#set-cluster" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials"><a href="#set-credentials" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials k8s-node \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig </span><br><span class="line"></span><br><span class="line">User &quot;k8s-node&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context"><a href="#set-context" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context"><a href="#use-context" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h5 id="k8s-node-yaml"><a href="#k8s-node-yaml" class="headerlink" title="k8s-node.yaml"></a>k8s-node.yaml</h5><ul>
<li>创建资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/k8s-node.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>

<ul>
<li>应用资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span><br></pre></td></tr></table></figure>

<ul>
<li>检查</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME           AGE</span><br><span class="line">k8s-node       3m</span><br></pre></td></tr></table></figure>

<h3 id="准备pause基础镜像"><a href="#准备pause基础镜像" class="headerlink" title="准备pause基础镜像"></a>准备pause基础镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kubernetes/pause</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from kubernetes/pause</span><br><span class="line">4f4fb700ef54: Pull complete </span><br><span class="line">b9c8ec465f6b: Pull complete </span><br><span class="line">Digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105</span><br><span class="line">Status: Downloaded newer image for kubernetes/pause:latest</span><br><span class="line">docker.io/kubernetes/pause:latest</span><br></pre></td></tr></table></figure>

<h4 id="提交至私有仓库（harbor）中"><a href="#提交至私有仓库（harbor）中" class="headerlink" title="提交至私有仓库（harbor）中"></a>提交至私有仓库（harbor）中</h4><ul>
<li>给镜像打tag</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker images|grep pause</span><br><span class="line">kubernetes/pause                   latest              f9d5de079539        5 years ago         240kB</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9d5de079539 harbor.od.com/public/pause:latest</span><br></pre></td></tr></table></figure>

<ul>
<li>push到harbor</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/pause:latest</span><br><span class="line">The push refers to repository [harbor.od.com/public/pause]</span><br><span class="line">5f70bf18a086: Mounted from public/nginx </span><br><span class="line">e16a89738269: Pushed </span><br><span class="line">latest: digest: sha256:b31bfb4d0213f254d361e0079deaaebefa4f82ba7aa76ef82e90b4935ad5b105 size: 938</span><br></pre></td></tr></table></figure>

<h3 id="创建kubelet启动脚本"><a href="#创建kubelet启动脚本" class="headerlink" title="创建kubelet启动脚本"></a>创建kubelet启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kubelet.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kubelet \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups=/systemd/system.slice \</span><br><span class="line">  --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">  --fail-swap-on=&quot;false&quot; \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --tls-cert-file ./cert/kubelet.pem \</span><br><span class="line">  --tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com/public/pause:latest \</span><br><span class="line">  --root-dir /data/kubelet</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kubelet集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kubelet.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kubelet.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-3"><a href="#创建supervisor配置-3" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-kubelet.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-kubelet-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet.sh     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              		          ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                              ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                  ; kill all process in a group</span><br><span class="line">stopasgroup=true                                  ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                       ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-3"><a href="#启动服务并检查-3" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-kubelet: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet-7-21                RUNNING   pid 14597, uptime 0:02:32</span><br><span class="line">kube-scheduler-7-21              RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="检查运算节点"><a href="#检查运算节点" class="headerlink" title="检查运算节点"></a>检查运算节点</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get node</span><br><span class="line">NAME                STATUS   ROLES    AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    &lt;none&gt;   3m   v1.15.2</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kubelet服务"><a href="#安装部署启动检查所有集群规划主机上的kubelet服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kubelet服务"></a>安装部署启动检查所有集群规划主机上的kubelet服务</h3><p>略</p>
<h3 id="检查所有运算节点"><a href="#检查所有运算节点" class="headerlink" title="检查所有运算节点"></a>检查所有运算节点</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get node</span><br><span class="line">NAME                STATUS   ROLES    AGE   VERSION</span><br><span class="line">hdss7-21.host.com   Ready    &lt;none&gt;  15m   v1.15.2</span><br><span class="line">hdss7-22.host.com   Ready    &lt;none&gt;   3m   v1.15.2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>给node打角色标签</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/master=</span><br><span class="line">node/hdss7-21.host.com labeled</span><br><span class="line">~]# kubectl label node hdss7-21.host.com node-role.kubernetes.io/node=</span><br><span class="line">node/hdss7-21.host.com labeled</span><br><span class="line">~]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/master=</span><br><span class="line">node/hdss7-22.host.com labeled</span><br><span class="line">~]# kubectl label node hdss7-22.host.com node-role.kubernetes.io/node=</span><br><span class="line">node/hdss7-22.host.com labeled</span><br></pre></td></tr></table></figure>

<blockquote>
<p>标签过的效果</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get node</span><br><span class="line">NAME                STATUS   ROLES         AGE     VERSION</span><br><span class="line">hdss7-21.host.com   Ready    master,node   10m     v1.15.4</span><br><span class="line">hdss7-22.host.com   Ready    master,node   5m44s   v1.15.4</span><br></pre></td></tr></table></figure>

<p><strong>注：</strong>删除标签用“-”</p>
<h2 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h2><h3 id="集群规划-5"><a href="#集群规划-5" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kube-proxy证书"><a href="#签发kube-proxy证书" class="headerlink" title="签发kube-proxy证书"></a>签发kube-proxy证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-3"><a href="#创建生成证书签名请求（csr）的JSON配置文件-3" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/kube-proxy-client-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-proxy证书和私钥"><a href="#生成kube-proxy证书和私钥" class="headerlink" title="生成kube-proxy证书和私钥"></a>生成kube-proxy证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-client-csr.json | cfssl-json -bare kube-proxy-client</span><br><span class="line">2019/01/18 18:14:23 [INFO] generate received request</span><br><span class="line">2019/01/18 18:14:23 [INFO] received CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 18:14:23 [INFO] encoded CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] signed certificate with serial number 375797145588654714099258750873820528127028390681</span><br><span class="line">2019/01/18 18:14:23 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-4"><a href="#检查生成的证书、私钥-4" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kube-proxy</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1005 Jan 22 17:31 kube-proxy-client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  268 Jan 22 17:23 kube-proxy-client-csr.json</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-2"><a href="#拷贝证书至各运算节点，并创建配置-2" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-2"><a href="#拷贝证书、私钥，注意私钥文件属性600-2" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1383</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-2"><a href="#创建配置-2" class="headerlink" title="创建配置"></a>创建配置</h4><h5 id="set-cluster-1"><a href="#set-cluster-1" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials-1"><a href="#set-credentials-1" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">User &quot;kube-proxy&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context-1"><a href="#set-context-1" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context-1"><a href="#use-context-1" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h3 id="创建kube-proxy启动脚本"><a href="#创建kube-proxy启动脚本" class="headerlink" title="创建kube-proxy启动脚本"></a>创建kube-proxy启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<ul>
<li>加载ipvs模块</li>
</ul>
<figure class="highlight plain"><figcaption><span>/root/ipvs.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">ipvs_mods_dir=&quot;/usr/lib/modules/$(uname -r)/kernel/net/netfilter/ipvs&quot;</span><br><span class="line">for i in $(ls $ipvs_mods_dir|grep -o &quot;^[^.]*&quot;)</span><br><span class="line">do</span><br><span class="line">  /sbin/modinfo -F filename $i &amp;&gt;/dev/null</span><br><span class="line">  if [ $? -eq 0 ];then</span><br><span class="line">    /sbin/modprobe $i</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<ul>
<li>创建启动脚本</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-proxy.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override hdss7-21.host.com \</span><br><span class="line">  --proxy-mode=ipvs \</span><br><span class="line">  --ipvs-scheduler=nq \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kube-proxy集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录-1"><a href="#检查配置，权限，创建日志目录-1" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kube-proxy.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kube-proxy.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-4"><a href="#创建supervisor配置-4" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-proxy.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-proxy-7-21]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=30                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                        ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                            ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=true                                                 ; redirect proc stderr to stdout (default false)</span><br><span class="line">killasgroup=true                                                     ; kill all process in a group</span><br><span class="line">stopasgroup=true                                                     ; stop all process in a group</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                         ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                             ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                          ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                          ; emit events on stdout writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-4"><a href="#启动服务并检查-4" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-proxy: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver-7-21              RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager-7-21     RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet-7-21                RUNNING   pid 14597, uptime 0:32:59</span><br><span class="line">kube-proxy-7-21                  RUNNING   pid 23454, uptime 0:12:51</span><br><span class="line">kube-scheduler-7-21              RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-proxy服务"><a href="#安装部署启动检查所有集群规划主机上的kube-proxy服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-proxy服务"></a>安装部署启动检查所有集群规划主机上的kube-proxy服务</h3><p>略</p>
<h1 id="验证kubernetes集群"><a href="#验证kubernetes集群" class="headerlink" title="验证kubernetes集群"></a>验证kubernetes集群</h1><h2 id="在任意一个运算节点，创建一个资源配置清单"><a href="#在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="在任意一个运算节点，创建一个资源配置清单"></a>在任意一个运算节点，创建一个资源配置清单</h2><p>这里我们选择<code>HDSS7-21.host.com</code>主机</p>
<figure class="highlight plain"><figcaption><span>/root/nginx-ds.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: harbor.od.com/public/nginx:v1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<h2 id="应用资源配置，并检查"><a href="#应用资源配置，并检查" class="headerlink" title="应用资源配置，并检查"></a>应用资源配置，并检查</h2><figure class="highlight plain"><figcaption><span>/root</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create -f nginx-ds.yaml</span><br><span class="line">daemonset.extensions/nginx-ds created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl get pods -o wide</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE   IP           NODE        NOMINATED NODE   READINESS GATES</span><br><span class="line">nginx-ds-6svt2   1/1     Running   0          10s   172.7.22.2   10.4.7.22   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">nginx-ds-ptcvx   1/1     Running   0          11s   172.7.21.2   10.4.7.21   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">[root@hdss7-21 ~]# curl 172.7.21.2</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">[root@hdss7-22 bin]# curl 172.7.22.2</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body &#123;</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href=&quot;http://nginx.org/&quot;&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=&quot;http://nginx.com/&quot;&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>


      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Stanley Wang 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.2yuan.png" alt="Stanley Wang 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/18/Day2：跟我一步步部署kubernetes集群（下）/" rel="next" title="Day2：跟我一步步部署kubernetes集群（下）">
                <i class="fa fa-chevron-left"></i> Day2：跟我一步步部署kubernetes集群（下）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/18/Day0：Docker容器入门基础/" rel="prev" title="Day0：Docker容器入门基础">
                Day0：Docker容器入门基础 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Stanley Wang">
            
              <p class="site-author-name" itemprop="name">Stanley Wang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/stanleywang" title="GitHub &rarr; https://gitee.com/stanleywang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:stanley.wang.m@qq.com" title="E-Mail &rarr; mailto:stanley.wang.m@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#实验架构"><span class="nav-number">1.</span> <span class="nav-text">实验架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#硬件环境"><span class="nav-number">1.1.</span> <span class="nav-text">硬件环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#软件环境"><span class="nav-number">1.2.</span> <span class="nav-text">软件环境</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#实验准备工作"><span class="nav-number">2.</span> <span class="nav-text">实验准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备虚拟机"><span class="nav-number">2.1.</span> <span class="nav-text">准备虚拟机</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调整操作系统"><span class="nav-number">2.2.</span> <span class="nav-text">调整操作系统</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调整yum源"><span class="nav-number">2.2.1.</span> <span class="nav-text">调整yum源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装epel-release"><span class="nav-number">2.2.2.</span> <span class="nav-text">安装epel-release</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭SElinux和firewalld"><span class="nav-number">2.2.3.</span> <span class="nav-text">关闭SElinux和firewalld</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装必要工具"><span class="nav-number">2.2.4.</span> <span class="nav-text">安装必要工具</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS服务初始化"><span class="nav-number">2.3.</span> <span class="nav-text">DNS服务初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装bind9软件"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装bind9软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置bind9"><span class="nav-number">2.3.2.</span> <span class="nav-text">配置bind9</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主配置文件"><span class="nav-number">2.3.2.1.</span> <span class="nav-text">主配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#区域配置文件"><span class="nav-number">2.3.2.2.</span> <span class="nav-text">区域配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置区域数据文件"><span class="nav-number">2.3.2.3.</span> <span class="nav-text">配置区域数据文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动bind9"><span class="nav-number">2.3.3.</span> <span class="nav-text">启动bind9</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查"><span class="nav-number">2.3.4.</span> <span class="nav-text">检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置DNS客户端"><span class="nav-number">2.3.5.</span> <span class="nav-text">配置DNS客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-1"><span class="nav-number">2.3.6.</span> <span class="nav-text">检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备签发证书环境"><span class="nav-number">2.4.</span> <span class="nav-text">准备签发证书环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装CFSSL"><span class="nav-number">2.4.1.</span> <span class="nav-text">安装CFSSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建生成CA证书签名请求（csr）的JSON配置文件"><span class="nav-number">2.4.2.</span> <span class="nav-text">创建生成CA证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成CA证书和私钥"><span class="nav-number">2.4.3.</span> <span class="nav-text">生成CA证书和私钥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署docker环境"><span class="nav-number">2.5.</span> <span class="nav-text">部署docker环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.5.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">2.5.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.5.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署docker镜像私有仓库harbor"><span class="nav-number">2.6.</span> <span class="nav-text">部署docker镜像私有仓库harbor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件二进制包并解压"><span class="nav-number">2.6.1.</span> <span class="nav-text">下载软件二进制包并解压</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-1"><span class="nav-number">2.6.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装docker-compose"><span class="nav-number">2.6.3.</span> <span class="nav-text">安装docker-compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装harbor"><span class="nav-number">2.6.4.</span> <span class="nav-text">安装harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查harbor启动情况"><span class="nav-number">2.6.5.</span> <span class="nav-text">检查harbor启动情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置harbor的dns内网解析"><span class="nav-number">2.6.6.</span> <span class="nav-text">配置harbor的dns内网解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装nginx并配置"><span class="nav-number">2.6.7.</span> <span class="nav-text">安装nginx并配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-1"><span class="nav-number">2.6.7.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-2"><span class="nav-number">2.6.7.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动-1"><span class="nav-number">2.6.7.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器打开http-harbor-od-com"><span class="nav-number">2.6.8.</span> <span class="nav-text">浏览器打开http://harbor.od.com</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查-2"><span class="nav-number">2.6.9.</span> <span class="nav-text">检查</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载测试镜像"><span class="nav-number">2.6.9.1.</span> <span class="nav-text">下载测试镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#给镜像打tag"><span class="nav-number">2.6.9.2.</span> <span class="nav-text">给镜像打tag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#登录harbor"><span class="nav-number">2.6.9.3.</span> <span class="nav-text">登录harbor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#推送镜像"><span class="nav-number">2.6.9.4.</span> <span class="nav-text">推送镜像</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查web页面"><span class="nav-number">2.6.9.5.</span> <span class="nav-text">检查web页面</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Master节点服务"><span class="nav-number">3.</span> <span class="nav-text">部署Master节点服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署etcd集群"><span class="nav-number">3.1.</span> <span class="nav-text">部署etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划"><span class="nav-number">3.1.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建基于根证书的config配置文件"><span class="nav-number">3.1.2.</span> <span class="nav-text">创建基于根证书的config配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建生成自签证书签名请求（csr）的JSON配置文件"><span class="nav-number">3.1.3.</span> <span class="nav-text">创建生成自签证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成etcd证书和私钥"><span class="nav-number">3.1.4.</span> <span class="nav-text">生成etcd证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查生成的证书、私钥"><span class="nav-number">3.1.5.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd用户"><span class="nav-number">3.1.6.</span> <span class="nav-text">创建etcd用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件，解压，做软连接"><span class="nav-number">3.1.7.</span> <span class="nav-text">下载软件，解压，做软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目录，拷贝证书、私钥"><span class="nav-number">3.1.8.</span> <span class="nav-text">创建目录，拷贝证书、私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd服务启动脚本"><span class="nav-number">3.1.9.</span> <span class="nav-text">创建etcd服务启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整权限"><span class="nav-number">3.1.10.</span> <span class="nav-text">调整权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装supervisor软件"><span class="nav-number">3.1.11.</span> <span class="nav-text">安装supervisor软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd-server的启动配置"><span class="nav-number">3.1.12.</span> <span class="nav-text">创建etcd-server的启动配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动etcd服务并检查"><span class="nav-number">3.1.13.</span> <span class="nav-text">启动etcd服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的etcd服务"><span class="nav-number">3.1.14.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的etcd服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查集群状态"><span class="nav-number">3.1.15.</span> <span class="nav-text">检查集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-apiserver集群"><span class="nav-number">3.2.</span> <span class="nav-text">部署kube-apiserver集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件，解压，做软连接-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">下载软件，解压，做软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发client证书"><span class="nav-number">3.2.3.</span> <span class="nav-text">签发client证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成client证书和私钥"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">生成client证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-1"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kube-apiserver证书"><span class="nav-number">3.2.4.</span> <span class="nav-text">签发kube-apiserver证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-1"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kube-apiserver证书和私钥"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">生成kube-apiserver证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-2"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置"><span class="nav-number">3.2.5.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600"><span class="nav-number">3.2.5.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置"><span class="nav-number">3.2.5.2.</span> <span class="nav-text">创建配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本"><span class="nav-number">3.2.6.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整权限和目录"><span class="nav-number">3.2.7.</span> <span class="nav-text">调整权限和目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置"><span class="nav-number">3.2.8.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查"><span class="nav-number">3.2.9.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-apiserver"><span class="nav-number">3.2.10.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配4层反向代理"><span class="nav-number">3.2.11.</span> <span class="nav-text">配4层反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx配置"><span class="nav-number">3.2.11.1.</span> <span class="nav-text">nginx配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keepalived配置"><span class="nav-number">3.2.11.2.</span> <span class="nav-text">keepalived配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#check-port-sh"><span class="nav-number">3.2.11.2.1.</span> <span class="nav-text">check_port.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#keepalived主"><span class="nav-number">3.2.11.2.2.</span> <span class="nav-text">keepalived主</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#keepalived备"><span class="nav-number">3.2.11.2.3.</span> <span class="nav-text">keepalived备</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动代理并检查"><span class="nav-number">3.2.12.</span> <span class="nav-text">启动代理并检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署controller-manager"><span class="nav-number">3.3.</span> <span class="nav-text">部署controller-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本-1"><span class="nav-number">3.3.2.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整文件权限，创建目录"><span class="nav-number">3.3.3.</span> <span class="nav-text">调整文件权限，创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-1"><span class="nav-number">3.3.4.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-1"><span class="nav-number">3.3.5.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-controller-manager服务"><span class="nav-number">3.3.6.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-controller-manager服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-scheduler"><span class="nav-number">3.4.</span> <span class="nav-text">部署kube-scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-3"><span class="nav-number">3.4.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整文件权限，创建目录-1"><span class="nav-number">3.4.3.</span> <span class="nav-text">调整文件权限，创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-2"><span class="nav-number">3.4.4.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-2"><span class="nav-number">3.4.5.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务"><span class="nav-number">3.4.6.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-scheduler服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查主控节点"><span class="nav-number">3.5.</span> <span class="nav-text">检查主控节点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#给kubectl创建软连接"><span class="nav-number">3.5.1.</span> <span class="nav-text">给kubectl创建软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查主控节点-1"><span class="nav-number">3.5.2.</span> <span class="nav-text">检查主控节点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Node节点服务"><span class="nav-number">4.</span> <span class="nav-text">部署Node节点服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kubelet"><span class="nav-number">4.1.</span> <span class="nav-text">部署kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-4"><span class="nav-number">4.1.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kubelet证书"><span class="nav-number">4.1.2.</span> <span class="nav-text">签发kubelet证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-2"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kubelet证书和私钥"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">生成kubelet证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-3"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置-1"><span class="nav-number">4.1.3.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600-1"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置-1"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#set-cluster"><span class="nav-number">4.1.3.2.1.</span> <span class="nav-text">set-cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-credentials"><span class="nav-number">4.1.3.2.2.</span> <span class="nav-text">set-credentials</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-context"><span class="nav-number">4.1.3.2.3.</span> <span class="nav-text">set-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#use-context"><span class="nav-number">4.1.3.2.4.</span> <span class="nav-text">use-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#k8s-node-yaml"><span class="nav-number">4.1.3.2.5.</span> <span class="nav-text">k8s-node.yaml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备pause基础镜像"><span class="nav-number">4.1.4.</span> <span class="nav-text">准备pause基础镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#提交至私有仓库（harbor）中"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">提交至私有仓库（harbor）中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kubelet启动脚本"><span class="nav-number">4.1.5.</span> <span class="nav-text">创建kubelet启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查配置，权限，创建日志目录"><span class="nav-number">4.1.6.</span> <span class="nav-text">检查配置，权限，创建日志目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-3"><span class="nav-number">4.1.7.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-3"><span class="nav-number">4.1.8.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查运算节点"><span class="nav-number">4.1.9.</span> <span class="nav-text">检查运算节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kubelet服务"><span class="nav-number">4.1.10.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kubelet服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查所有运算节点"><span class="nav-number">4.1.11.</span> <span class="nav-text">检查所有运算节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-proxy"><span class="nav-number">4.2.</span> <span class="nav-text">部署kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-5"><span class="nav-number">4.2.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kube-proxy证书"><span class="nav-number">4.2.2.</span> <span class="nav-text">签发kube-proxy证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-3"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kube-proxy证书和私钥"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">生成kube-proxy证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-4"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置-2"><span class="nav-number">4.2.3.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600-2"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置-2"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#set-cluster-1"><span class="nav-number">4.2.3.2.1.</span> <span class="nav-text">set-cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-credentials-1"><span class="nav-number">4.2.3.2.2.</span> <span class="nav-text">set-credentials</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-context-1"><span class="nav-number">4.2.3.2.3.</span> <span class="nav-text">set-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#use-context-1"><span class="nav-number">4.2.3.2.4.</span> <span class="nav-text">use-context</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kube-proxy启动脚本"><span class="nav-number">4.2.4.</span> <span class="nav-text">创建kube-proxy启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查配置，权限，创建日志目录-1"><span class="nav-number">4.2.5.</span> <span class="nav-text">检查配置，权限，创建日志目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-4"><span class="nav-number">4.2.6.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-4"><span class="nav-number">4.2.7.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-proxy服务"><span class="nav-number">4.2.8.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-proxy服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#验证kubernetes集群"><span class="nav-number">5.</span> <span class="nav-text">验证kubernetes集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#在任意一个运算节点，创建一个资源配置清单"><span class="nav-number">5.1.</span> <span class="nav-text">在任意一个运算节点，创建一个资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用资源配置，并检查"><span class="nav-number">5.2.</span> <span class="nav-text">应用资源配置，并检查</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stanley Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">890k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">13:29</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
