<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta property="og:type" content="article">
<meta property="og:title" content="实验文档4：kubernetes集群的监控和日志分析">
<meta property="og:url" content="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档4：kubernetes集群的监控和日志分析/index.html">
<meta property="og:site_name" content="Stanley&#39;s Blog">
<meta property="og:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://stanleywang-github.github.io/images/jenkins-2projects.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/jenkins-tomcat.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/harbor-tomcat.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/blackbox.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/grafana-password.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/grafana-datasource.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kafka-manager.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kafka-topic.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/es-logstash.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kibana.png">
<meta property="og:image" content="https://stanleywang-github.github.io/images/kibana-usage.png">
<meta property="og:updated_time" content="2020-09-03T08:33:09.900Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实验文档4：kubernetes集群的监控和日志分析">
<meta name="twitter:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   改造dubbo-demo-web项目为Tomcat启动项目Tomcat官网 准备Tomcat的镜像底包准备tomcat二进制包运维主机HDSS7-200.host.com上：Tomcat8下载链接 /opt/src1234[root@hdss7-200 src]# ls -l|grep tomcat-rw-r--r-">
<meta name="twitter:image" content="https://stanleywang-github.github.io/images/jenkins-2projects.png">






  <link rel="canonical" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档4：kubernetes集群的监控和日志分析/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>实验文档4：kubernetes集群的监控和日志分析 | Stanley's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stanley's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档4：kubernetes集群的监控和日志分析/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">实验文档4：kubernetes集群的监控和日志分析

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-18 19:12:56" itemprop="dateCreated datePublished" datetime="2019-01-18T19:12:56+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes容器云技术专题/" itemprop="url" rel="index"><span itemprop="name">Kubernetes容器云技术专题</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">71k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:04</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="改造dubbo-demo-web项目为Tomcat启动项目"><a href="#改造dubbo-demo-web项目为Tomcat启动项目" class="headerlink" title="改造dubbo-demo-web项目为Tomcat启动项目"></a>改造dubbo-demo-web项目为Tomcat启动项目</h1><p><a href="http://tomcat.apache.org/" target="_blank" rel="noopener">Tomcat官网</a></p>
<h2 id="准备Tomcat的镜像底包"><a href="#准备Tomcat的镜像底包" class="headerlink" title="准备Tomcat的镜像底包"></a>准备Tomcat的镜像底包</h2><h3 id="准备tomcat二进制包"><a href="#准备tomcat二进制包" class="headerlink" title="准备tomcat二进制包"></a>准备tomcat二进制包</h3><p>运维主机<code>HDSS7-200.host.com</code>上：<br><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-8/v8.5.43/bin/apache-tomcat-8.5.43.tar.gz" target="_blank" rel="noopener">Tomcat8下载链接</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep tomcat</span><br><span class="line">-rw-r--r-- 1 root root   9690027 Apr 10 22:57 apache-tomcat-8.5.43.tar.gz</span><br><span class="line">[root@hdss7-200 src]# mkdir -p /data/dockerfile/tomcat8 &amp;&amp; tar xf apache-tomcat-8.5.43.tar.gz -C /data/dockerfile/tomcat</span><br><span class="line">[root@hdss7-200 src]# cd /data/dockerfile/tomcat &amp;&amp; rm -fr apache-tomcat-8.5.43/webapps/*</span><br></pre></td></tr></table></figure>

<h3 id="简单配置tomcat"><a href="#简单配置tomcat" class="headerlink" title="简单配置tomcat"></a>简单配置tomcat</h3><ol>
<li>关闭AJP端口</li>
</ol>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.43/conf/server.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- &lt;Connector port=&quot;8009&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt; --&gt;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置日志</li>
</ol>
<ul>
<li>删除3manager，4host-manager的handlers</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.43/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">handlers = 1catalina.org.apache.juli.AsyncFileHandler, 2localhost.org.apache.juli.AsyncFileHandler,java.util.logging.ConsoleHandler</span><br></pre></td></tr></table></figure>

<ul>
<li>日志级别改为INFO</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.43/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1catalina.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">2localhost.org.apache.juli.AsyncFileHandler.level = INFO</span><br><span class="line">java.util.logging.ConsoleHandler.level = INFO</span><br></pre></td></tr></table></figure>

<ul>
<li>注释掉所有关于3manager，4host-manager日志的配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/apache-tomcat-8.5.43/conf/logging.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#3manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.prefix = manager.</span><br><span class="line">#3manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br><span class="line"></span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.level = FINE</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.directory = $&#123;catalina.base&#125;/logs</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.prefix = host-manager.</span><br><span class="line">#4host-manager.org.apache.juli.AsyncFileHandler.encoding = UTF-8</span><br></pre></td></tr></table></figure>

<h3 id="准备Dockerfile"><a href="#准备Dockerfile" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/tomcat/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">From stanleyws/jre8:8u112</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\ </span><br><span class="line">    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line">ENV CATALINA_HOME /opt/tomcat</span><br><span class="line">ENV LANG zh_CN.UTF-8</span><br><span class="line">ADD apache-tomcat-8.5.43/ /opt/tomcat</span><br><span class="line">ADD config.yml /opt/prom/config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line">WORKDIR /opt/tomcat</span><br><span class="line">ADD entrypoint.sh /entrypoint.sh</span><br><span class="line">CMD [&quot;/entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure>

<div class="tabs" id="tomcat-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#tomcat-dockerfile-1">config.yml</a></li><li class="tab"><a href="#tomcat-dockerfile-2">jmx_javaagent-0.3.1.jar</a></li><li class="tab"><a href="#tomcat-dockerfile-3">entrypoint.sh</a></li></ul><div class="tab-content"><div class="tab-pane active" id="tomcat-dockerfile-1"><p>vi config.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">rules:</span><br><span class="line">  - pattern: &apos;.*&apos;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tomcat-dockerfile-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="tomcat-dockerfile-3"><p>vi entrypoint.sh  (不要忘了给执行权限)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">M_OPTS=&quot;-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):$&#123;M_PORT:-&quot;12346&quot;&#125;:/opt/prom/config.yml&quot;</span><br><span class="line">C_OPTS=$&#123;C_OPTS&#125;</span><br><span class="line">MIN_HEAP=$&#123;MIN_HEAP:-&quot;128m&quot;&#125;</span><br><span class="line">MAX_HEAP=$&#123;MAX_HEAP:-&quot;128m&quot;&#125;</span><br><span class="line">JAVA_OPTS=$&#123;JAVA_OPTS:-&quot;-Xmn384m -Xss256k -Duser.timezone=GMT+08  -XX:+DisableExplicitGC -XX:+UseConcMarkSweepGC -XX:+UseParNewGC -XX:+CMSParallelRemarkEnabled -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=0 -XX:+CMSClassUnloadingEnabled -XX:LargePageSizeInBytes=128m -XX:+UseFastAccessorMethods -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=80 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+PrintClassHistogram  -Dfile.encoding=UTF8 -Dsun.jnu.encoding=UTF8&quot;&#125;</span><br><span class="line">CATALINA_OPTS=&quot;$&#123;CATALINA_OPTS&#125;&quot;</span><br><span class="line">JAVA_OPTS=&quot;$&#123;M_OPTS&#125; $&#123;C_OPTS&#125; -Xms$&#123;MIN_HEAP&#125; -Xmx$&#123;MAX_HEAP&#125; $&#123;JAVA_OPTS&#125;&quot;</span><br><span class="line">sed -i -e &quot;1a\JAVA_OPTS=\&quot;$JAVA_OPTS\&quot;&quot; -e &quot;1a\CATALINA_OPTS=\&quot;$CATALINA_OPTS\&quot;&quot; /opt/tomcat/bin/catalina.sh</span><br><span class="line"></span><br><span class="line">cd /opt/tomcat &amp;&amp; /opt/tomcat/bin/catalina.sh run 2&gt;&amp;1 &gt;&gt; /opt/tomcat/logs/stdout.log</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="制作镜像并推送"><a href="#制作镜像并推送" class="headerlink" title="制作镜像并推送"></a>制作镜像并推送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 tomcat]# docker build . -t harbor.od.com/base/tomcat:v8.5.43</span><br><span class="line">Sending build context to Docker daemon 9.502 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5da5ab0b1a48</span><br><span class="line">Step 3 : ENV CATALINA_HOME /opt/tomcat</span><br><span class="line"> ---&gt; Running in edf8f2bbeae3</span><br><span class="line"> ---&gt; 05c7b829c8ab</span><br><span class="line">Removing intermediate container edf8f2bbeae3</span><br><span class="line">Step 4 : ENV LANG zh_CN.UTF-8</span><br><span class="line"> ---&gt; Running in 50516133f65b</span><br><span class="line"> ---&gt; 421d67c4c188</span><br><span class="line">Removing intermediate container 50516133f65b</span><br><span class="line">Step 5 : ADD apache-tomcat-8.5.43/ /opt/tomcat</span><br><span class="line"> ---&gt; 460a5d0ef93b</span><br><span class="line">Removing intermediate container 0be2b4897d23</span><br><span class="line">Step 6 : ADD config.yml /opt/prom/config.yml</span><br><span class="line"> ---&gt; 04c9d4679f0d</span><br><span class="line">Removing intermediate container 0e88a4ed2088</span><br><span class="line">Step 7 : ADD jmx_javaagent-0.3.1.jar /opt/prom/jmx_javaagent-0.3.1.jar</span><br><span class="line"> ---&gt; 06e4a78e9cbf</span><br><span class="line">Removing intermediate container 1e6b2919be00</span><br><span class="line">Step 8 : WORKDIR /opt/tomcat</span><br><span class="line"> ---&gt; Running in a51676d15a01</span><br><span class="line"> ---&gt; e8d164847eb3</span><br><span class="line">Removing intermediate container a51676d15a01</span><br><span class="line">Step 9 : ADD entrypoint.sh /entrypoint.sh</span><br><span class="line"> ---&gt; 0522db421536</span><br><span class="line">Removing intermediate container 7f0be318fde8</span><br><span class="line">Step 10 : CMD /entrypoint.sh</span><br><span class="line"> ---&gt; Running in c2df6e511c00</span><br><span class="line"> ---&gt; 8d735515bb42</span><br><span class="line">Removing intermediate container c2df6e511c00</span><br><span class="line">Successfully built 8d735515bb42</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 tomcat8]# docker push harbor.od.com/base/tomcat:v8.5.43</span><br><span class="line">The push refers to a repository [harbor.od.com/base/tomcat]</span><br><span class="line">498eaadf86a8: Pushed </span><br><span class="line">fab679acf269: Pushed </span><br><span class="line">0e65f86c3a75: Pushed </span><br><span class="line">938c8a5617cc: Pushed </span><br><span class="line">052016a734be: Mounted from app/dubbo-demo-web </span><br><span class="line">0690f10a63a5: Mounted from app/dubbo-demo-web </span><br><span class="line">c843b2cf4e12: Mounted from app/dubbo-demo-web </span><br><span class="line">fddd8887b725: Mounted from base/jre8 </span><br><span class="line">42052a19230c: Mounted from base/jre8 </span><br><span class="line">8d4d1ab5ff74: Mounted from base/jre8 </span><br><span class="line">v8.5.43: digest: sha256:407c6abd7c4fa5119376efa71090b49637d7a52ef2fc202f4019ab4c91f6dc50 size: 2409</span><br></pre></td></tr></table></figure>

<h2 id="改造dubbo-demo-web项目"><a href="#改造dubbo-demo-web项目" class="headerlink" title="改造dubbo-demo-web项目"></a>改造dubbo-demo-web项目</h2><h3 id="修改dubbo-client-pom-xml"><a href="#修改dubbo-client-pom-xml" class="headerlink" title="修改dubbo-client/pom.xml"></a>修改dubbo-client/pom.xml</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-web/dubbo-client/pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;packaging&gt;war&lt;/packaging&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">  &lt;exclusions&gt;</span><br><span class="line">    &lt;exclusion&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;</span><br><span class="line">    &lt;/exclusion&gt;</span><br><span class="line">  &lt;/exclusions&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; </span><br><span class="line">  &lt;artifactId&gt;tomcat-servlet-api&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;8.0.36&lt;/version&gt;</span><br><span class="line">  &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修改Application-java"><a href="#修改Application-java" class="headerlink" title="修改Application.java"></a>修改Application.java</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-web/dubbo-client/src/main/java/com/od/dubbotest/Application.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import org.springframework.boot.autoconfigure.EnableAutoConfiguration;</span><br><span class="line">import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;</span><br><span class="line">import org.springframework.context.annotation.ImportResource;</span><br><span class="line"></span><br><span class="line">@ImportResource(value=&#123;&quot;classpath*:spring-config.xml&quot;&#125;)</span><br><span class="line">@EnableAutoConfiguration(exclude=&#123;DataSourceAutoConfiguration.class&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="创建ServletInitializer-java"><a href="#创建ServletInitializer-java" class="headerlink" title="创建ServletInitializer.java"></a>创建ServletInitializer.java</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-web/dubbo-client/src/main/java/com/od/dubbotest/ServletInitializer.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package com.od.dubbotest;</span><br><span class="line"></span><br><span class="line">import org.springframework.boot.SpringApplication;</span><br><span class="line">import org.springframework.boot.builder.SpringApplicationBuilder;</span><br><span class="line">import org.springframework.boot.context.web.SpringBootServletInitializer;</span><br><span class="line">import com.od.dubbotest.Application;</span><br><span class="line"></span><br><span class="line">public class ServletInitializer extends SpringBootServletInitializer &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) &#123;</span><br><span class="line">        return builder.sources(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="新建Jenkins的pipeline"><a href="#新建Jenkins的pipeline" class="headerlink" title="新建Jenkins的pipeline"></a>新建Jenkins的pipeline</h2><h3 id="配置New-job"><a href="#配置New-job" class="headerlink" title="配置New job"></a>配置New job</h3><ul>
<li><p>使用admin登录</p>
</li>
<li><p>New Item</p>
</li>
<li><p>create new jobs</p>
</li>
<li><p>Enter an item name</p>
<blockquote>
<p>tomcat-demo</p>
</blockquote>
</li>
<li><p>Pipeline -&gt; OK</p>
</li>
<li><p>Discard old builds</p>
<blockquote>
<p>Days to keep builds : 3<br>Max # of builds to keep : 30</p>
</blockquote>
</li>
<li><p>This project is parameterized</p>
</li>
</ul>
<ol>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : app_name<br>Default Value :<br>Description : project name. e.g: dubbo-demo-web</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : image_name<br>Default Value :<br>Description : project docker image name. e.g:  app/dubbo-demo-web</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_repo<br>Default Value :<br>Description : project git repository. e.g: <a href="mailto:git@gitee.com" target="_blank" rel="noopener">git@gitee.com</a>:stanleywang/dubbo-demo-web.git</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_ver<br>Default Value : tomcat<br>Description : git commit id of the project.</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : add_tag<br>Default Value :<br>Description : project docker image tag, date_timestamp recommended. e.g: 190117_1920</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_dir<br>Default Value : ./<br>Description : project maven directory. e.g: ./</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : target_dir<br>Default Value : ./dubbo-client/target<br>Description : the relative path of target file such as .jar or .war package. e.g: ./dubbo-client/target</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_cmd<br>Default Value : mvn clean package -Dmaven.test.skip=true<br>Description : maven command. e.g: mvn clean package -e -q -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : base_image<br>Default Value : </p>
<ul>
<li>base/tomcat:v7.0.94</li>
<li>base/tomcat:v8.5.43</li>
<li>base/tomcat:v9.0.17<br>Description : project base image list in harbor.od.com.</li>
</ul>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : maven<br>Default Value : </p>
<ul>
<li>3.6.0-8u181</li>
<li>3.2.5-6u025</li>
<li>2.2.1-6u025<br>Description : different maven edition.</li>
</ul>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : root_url<br>Default Value : ROOT<br>Description : webapp dir.</p>
</blockquote>
</li>
</ol>
<p><img src="/images/jenkins-2projects.png" alt="jenkins新增流水线" title="jenkins新增流水线"></p>
<h3 id="Pipeline-Script"><a href="#Pipeline-Script" class="headerlink" title="Pipeline Script"></a>Pipeline Script</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any </span><br><span class="line">    stages &#123;</span><br><span class="line">    stage(&apos;pull&apos;) &#123; //get project code from repo </span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;git clone $&#123;params.git_repo&#125; $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; git checkout $&#123;params.git_ver&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;build&apos;) &#123; //exec mvn cmd</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;  &amp;&amp; /var/jenkins_home/maven-$&#123;params.maven&#125;/bin/$&#123;params.mvn_cmd&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;unzip&apos;) &#123; //unzip  target/*.war -c target/project_dir</span><br><span class="line">      steps &#123;</span><br><span class="line">        sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.target_dir&#125; &amp;&amp; mkdir project_dir &amp;&amp; unzip *.war -d ./project_dir&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(&apos;image&apos;) &#123; //build image and push to registry</span><br><span class="line">      steps &#123;</span><br><span class="line">        writeFile file: &quot;$&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;/Dockerfile&quot;, text: &quot;&quot;&quot;FROM harbor.od.com/$&#123;params.base_image&#125;</span><br><span class="line">ADD $&#123;params.target_dir&#125;/project_dir /opt/tomcat/webapps/$&#123;params.root_url&#125;&quot;&quot;&quot;</span><br><span class="line">        sh &quot;cd  $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; docker build -t harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125; . &amp;&amp; docker push harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构建应用镜像"><a href="#构建应用镜像" class="headerlink" title="构建应用镜像"></a>构建应用镜像</h2><p>使用Jenkins进行CI，并查看harbor仓库<br><img src="/images/jenkins-tomcat.png" alt="jenkins构建" title="jenkins构建"><br><img src="/images/harbor-tomcat.png" alt="harbor仓库" title="harbor仓库"></p>
<h2 id="准备k8s的资源配置清单"><a href="#准备k8s的资源配置清单" class="headerlink" title="准备k8s的资源配置清单"></a>准备k8s的资源配置清单</h2><p>不再需要单独准备资源配置清单</p>
<h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>k8s的dashboard上直接修改image的值为jenkins打包出来的镜像<br>文档里的例子是：<code>harbor.od.com/app/dubbo-demo-web:tomcat_190119_1920</code></p>
<h2 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://demo.od.com?hello=wangdao" target="_blank" rel="noopener">http://demo.od.com?hello=wangdao</a></p>
<h2 id="检查tomcat运行情况"><a href="#检查tomcat运行情况" class="headerlink" title="检查tomcat运行情况"></a>检查tomcat运行情况</h2><p>任意一台运算节点主机上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# kubectl get pods -n app</span><br><span class="line">NAME                                                    READY     STATUS    RESTARTS   AGE</span><br><span class="line">dubbo-demo-consumer-v025-htfx8                          2/2       Running   0          1h</span><br><span class="line">[root@hdss7-22 ~]# kubectl exec -ti dubbo-demo-consumer-v025-htfx8 -n app bash</span><br><span class="line">dubbo-demo-consumer-v025-htfx8:/opt/tomcat#  ls -lsr logs/</span><br><span class="line">total 16</span><br><span class="line">-rw-r----- 1 root root 7435 Jan 19 19:26 catalina.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  629 Jan 19 19:26 localhost.2019-01-19.log</span><br><span class="line">-rw-r----- 1 root root  249 Jan 15 19:27 localhost_access_log.2019-01-19.txt</span><br></pre></td></tr></table></figure>

<h1 id="使用Prometheus和Grafana监控kubernetes集群"><a href="#使用Prometheus和Grafana监控kubernetes集群" class="headerlink" title="使用Prometheus和Grafana监控kubernetes集群"></a>使用Prometheus和Grafana监控kubernetes集群</h1><h2 id="部署kube-state-metrics"><a href="#部署kube-state-metrics" class="headerlink" title="部署kube-state-metrics"></a>部署kube-state-metrics</h2><p>运维主机<code>HDSS7-200.host.com</code></p>
<h3 id="准备kube-state-metrics镜像"><a href="#准备kube-state-metrics镜像" class="headerlink" title="准备kube-state-metrics镜像"></a>准备kube-state-metrics镜像</h3><p><a href="https://quay.io/repository/coreos/kube-state-metrics?tab=info" target="_blank" rel="noopener">kube-state-metrics官方quay.io地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull quay.io/coreos/kube-state-metrics:v1.5.0</span><br><span class="line">v1.5.0: Pulling from coreos/kube-state-metrics</span><br><span class="line">cd784148e348: Pull complete </span><br><span class="line">f622528a393e: Pull complete </span><br><span class="line">Digest: sha256:b7a3143bd1eb7130759c9259073b9f239d0eeda09f5210f1cd31f1a530599ea1</span><br><span class="line">Status: Downloaded newer image for quay.io/coreos/kube-state-metrics:v1.5.0</span><br><span class="line">[root@hdss7-200 ~]# docker tag 91599517197a harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">docker push harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">The push refers to a repository [harbor.od.com/public/kube-state-metrics]</span><br><span class="line">5b3c36501a0a: Pushed </span><br><span class="line">7bff100f35cb: Pushed </span><br><span class="line">v1.5.0: digest: sha256:0d9bea882f25586543254d9ceeb54703eb6f8f94c0dd88875df216b6a0f60589 size: 739</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="kube-state-metrics"><ul class="nav-tabs"><li class="tab active"><a href="#kube-state-metrics-1">RBAC</a></li><li class="tab"><a href="#kube-state-metrics-2">Deployment</a></li></ul><div class="tab-content"><div class="tab-pane active" id="kube-state-metrics-1"><p>vi /data/k8s-yaml/kube-state-metrics/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\-\--</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - extensions</span><br><span class="line">  resources:</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - batch</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - jobs</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - autoscaling</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">-\--</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kube-state-metrics-2"><p>vi /data/k8s-yaml/kube-state-metrics/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: &quot;2&quot;</span><br><span class="line">  labels:</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 25%</span><br><span class="line">      maxUnavailable: 25%</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      creationTimestamp: null</span><br><span class="line">      labels:</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/public/kube-state-metrics:v1.5.0</span><br><span class="line">        name: kube-state-metrics</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-metrics</span><br><span class="line">          protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccount: kube-state-metrics</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意一台运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/rbac.yaml </span><br><span class="line">serviceaccount/kube-state-metrics created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/kube-state-metrics created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/kube-state-metrics/deployment.yaml </span><br><span class="line">deployment.extensions/kube-state-metrics created</span><br></pre></td></tr></table></figure>

<h3 id="检查启动情况"><a href="#检查启动情况" class="headerlink" title="检查启动情况"></a>检查启动情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get pods -n kube-system|grep kube-state-metrics</span><br><span class="line">kube-state-metrics-645bd94c55-wdtqh      1/1     Running   0          94s</span><br></pre></td></tr></table></figure>

<h2 id="部署node-exporter"><a href="#部署node-exporter" class="headerlink" title="部署node-exporter"></a>部署node-exporter</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备node-exporter镜像"><a href="#准备node-exporter镜像" class="headerlink" title="准备node-exporter镜像"></a>准备node-exporter镜像</h3><p><a href="https://hub.docker.com/r/prom/node-exporter" target="_blank" rel="noopener">node-exporter官方dockerhub地址</a><br><a href="https://github.com/prometheus/node_exporter" target="_blank" rel="noopener">node-expoerer官方github地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull prom/node-exporter:v0.15.0</span><br><span class="line">v0.15.0: Pulling from prom/node-exporter</span><br><span class="line">0de338cf4258: Pull complete </span><br><span class="line">f508012419d8: Pull complete </span><br><span class="line">d764f7880123: Pull complete </span><br><span class="line">Digest: sha256:c390c8fea4cd362a28ad5070aedd6515aacdfdffd21de6db42ead05e332be5a9</span><br><span class="line">Status: Downloaded newer image for prom/node-exporter:v0.15.0</span><br><span class="line">[root@hdss7-200 ~]# docker tag b3e7f67a1480 harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">docker push harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">The push refers to a repository [harbor.od.com/public/node-exporter]</span><br><span class="line">0bf893ee7433: Pushed </span><br><span class="line">17ab2671f87e: Pushed </span><br><span class="line">b8873621dfbc: Pushed </span><br><span class="line">v0.15.0: digest: sha256:4e13dd75f00a6114675ea3e62e61dbd79dcb2205e8f3bbe1f8f8ef2fd3e28113 size: 949</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><figure class="highlight plain"><figcaption><span>/data/k8s-yaml/node-exporter/node-exporter-ds.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">kind: DaemonSet</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    daemon: &quot;node-exporter&quot;</span><br><span class="line">    grafanak8sapp: &quot;true&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      daemon: &quot;node-exporter&quot;</span><br><span class="line">      grafanak8sapp: &quot;true&quot;</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      name: node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        daemon: &quot;node-exporter&quot;</span><br><span class="line">        grafanak8sapp: &quot;true&quot;</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: proc</span><br><span class="line">        hostPath: </span><br><span class="line">          path: /proc</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">          type: &quot;&quot;</span><br><span class="line">      containers:</span><br><span class="line">      - name: node-exporter</span><br><span class="line">        image: harbor.od.com/public/node-exporter:v0.15.0</span><br><span class="line">        args:</span><br><span class="line">        - --path.procfs=/host_proc</span><br><span class="line">        - --path.sysfs=/host_sys</span><br><span class="line">        ports:</span><br><span class="line">        - name: node-exporter</span><br><span class="line">          hostPort: 9100</span><br><span class="line">          containerPort: 9100</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: sys</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: /host_sys</span><br><span class="line">        - name: proc</span><br><span class="line">          readOnly: true</span><br><span class="line">          mountPath: /host_proc</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      hostNetwork: true</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/node-exporter/node-exporter-ds.yaml</span><br><span class="line">daemonset.extensions/node-exporter created</span><br></pre></td></tr></table></figure>

<h2 id="部署cadvisor"><a href="#部署cadvisor" class="headerlink" title="部署cadvisor"></a>部署cadvisor</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备cadvisor镜像"><a href="#准备cadvisor镜像" class="headerlink" title="准备cadvisor镜像"></a>准备cadvisor镜像</h3><p><a href="https://hub.docker.com/r/google/cadvisor" target="_blank" rel="noopener">cadvisor官方dockerhub地址</a><br><a href="https://github.com/google/cadvisor" target="_blank" rel="noopener">cadvisor官方github地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull google/cadvisor:v0.28.3</span><br><span class="line">v0.28.3: Pulling from google/cadvisor</span><br><span class="line">49388a8c9c86: Pull complete </span><br><span class="line">21c698e54ae5: Pull complete </span><br><span class="line">fafc7cbc1edf: Pull complete </span><br><span class="line">Digest: sha256:09c8d73c9b799d30777763b7029cfd8624b8a1bd33af652ec3b51a6b827d492a</span><br><span class="line">Status: Downloaded newer image for google/cadvisor:v0.28.3</span><br><span class="line">[root@hdss7-200 ~]# docker tag d60fd8aeb74c harbor.od.com/public/cadvisor:v0.28.3</span><br><span class="line">[root@hdss7-200 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com/public/cadvisor:v0.28.3</span><br><span class="line">The push refers to a repository [harbor.od.com/public/cadvisor]</span><br><span class="line">daab541dbbf0: Pushed </span><br><span class="line">ba67c95cca3d: Pushed </span><br><span class="line">ef763da74d91: Pushed </span><br><span class="line">v0.28.3: digest: sha256:319812db86e7677767bf6a51ea63b5bdb17dc18ffa576eb6c8a667e899d1329d size: 951</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="cadvisor"><ul class="nav-tabs"><li class="tab active"><a href="#cadvisor-1">DaemonSet</a></li></ul><div class="tab-content"><div class="tab-pane active" id="cadvisor-1"><p>vi /data/k8s-yaml/cadvisor/daemonset.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: cadvisor</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: cadvisor</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: cadvisor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: cadvisor</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: node-role.kubernetes.io/master</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">        key: enabledDiskSchedule</span><br><span class="line">        value: &quot;true&quot;</span><br><span class="line">        effect: NoSchedule</span><br><span class="line">      containers:</span><br><span class="line">      - name: cadvisor</span><br><span class="line">        image: harbor.od.com/public/cadvisor:v0.28.3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: rootfs</span><br><span class="line">          mountPath: /rootfs</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: var-run</span><br><span class="line">          mountPath: /var/run</span><br><span class="line">        - name: sys</span><br><span class="line">          mountPath: /sys</span><br><span class="line">          readOnly: true</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: /var/lib/docker</span><br><span class="line">          readOnly: true</span><br><span class="line">        ports:</span><br><span class="line">          - name: http</span><br><span class="line">            containerPort: 4194</span><br><span class="line">            protocol: TCP</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 4194</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">        args:</span><br><span class="line">          - -\-housekeeping_interval=10s</span><br><span class="line">          - -\-port=4194</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: rootfs</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /</span><br><span class="line">      - name: var-run</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /var/run</span><br><span class="line">      - name: sys</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /data/docker</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="修改运算节点软连接"><a href="#修改运算节点软连接" class="headerlink" title="修改运算节点软连接"></a>修改运算节点软连接</h3><p>所有运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# mount -o remount,rw /sys/fs/cgroup/</span><br><span class="line">[root@hdss7-21 ~]# ln -s /sys/fs/cgroup/cpu,cpuacct/ /sys/fs/cgroup/cpuacct,cpu</span><br><span class="line">[root@hdss7-21 ~]# ll /sys/fs/cgroup/ | grep cpu</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 11 Jan 28 22:41 cpu -&gt; cpu,cpuacct</span><br><span class="line">lrwxrwxrwx 1 root root 11 Jan 28 22:41 cpuacct -&gt; cpu,cpuacct</span><br><span class="line">lrwxrwxrwx 1 root root 27 May  5 11:15 cpuacct,cpu -&gt; /sys/fs/cgroup/cpu,cpuacct/</span><br><span class="line">drwxr-xr-x 8 root root  0 Apr 26 11:06 cpu,cpuacct</span><br><span class="line">drwxr-xr-x 7 root root  0 Jan 28 22:41 cpuset</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-3"><a href="#应用资源配置清单-3" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/cadvisor/deamon.yaml</span><br><span class="line">daemonset.apps/cadvisor created</span><br><span class="line">[root@hdss7-21 ~]# netstat -luntp|grep 4194</span><br><span class="line">tcp6       0      0 :::4194                 :::*                    LISTEN      49153/cadvisor</span><br></pre></td></tr></table></figure>

<h2 id="部署blackbox-exporter"><a href="#部署blackbox-exporter" class="headerlink" title="部署blackbox-exporter"></a>部署blackbox-exporter</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备blackbox-exporter镜像"><a href="#准备blackbox-exporter镜像" class="headerlink" title="准备blackbox-exporter镜像"></a>准备blackbox-exporter镜像</h3><p><a href="https://hub.docker.com/r/prom/blackbox-exporter" target="_blank" rel="noopener">blackbox-exporter官方dockerhub地址</a><br><a href="https://github.com/prometheus/blackbox_exporter" target="_blank" rel="noopener">blackbox-exporter官方github地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull prom/blackbox-exporter:v0.14.0</span><br><span class="line">v0.14.0: Pulling from prom/blackbox-exporter</span><br><span class="line">697743189b6d: Pull complete </span><br><span class="line">f1989cfd335b: Pull complete </span><br><span class="line">8918f7b8f34f: Pull complete </span><br><span class="line">a128dce6256a: Pull complete </span><br><span class="line">Digest: sha256:c20445e0cc628fa4b227fe2f694c22a314beb43fd8297095b6ee6cbc67161336</span><br><span class="line">Status: Downloaded newer image for prom/blackbox-exporter:v0.14.0</span><br><span class="line">[root@hdss7-200 ~]# docker tag d3a00aea3a01 harbor.od.com/public/blackbox-exporter:v0.14.0</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/blackbox-exporter:v0.14.0</span><br><span class="line">docker push harbor.od.com/public/blackbox-exporter:v0.14.0</span><br><span class="line">The push refers to a repository [harbor.od.com/public/blackbox-exporter]</span><br><span class="line">256c4aa8ebe5: Pushed </span><br><span class="line">4b6cc55de649: Pushed </span><br><span class="line">986894c42222: Mounted from infra/prometheus </span><br><span class="line">adab5d09ba79: Mounted from infra/prometheus </span><br><span class="line">v0.14.0: digest: sha256:b127897cf0f67c47496d5cbb7ecb86c001312bddd04192f6319d09292e880a5f size: 1155</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="blackbox-exporter"><ul class="nav-tabs"><li class="tab active"><a href="#blackbox-exporter-1">ConfigMap</a></li><li class="tab"><a href="#blackbox-exporter-2">Deployment</a></li><li class="tab"><a href="#blackbox-exporter-3">Service</a></li><li class="tab"><a href="#blackbox-exporter-4">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="blackbox-exporter-1"><p>vi /data/k8s-yaml/blackbox-exporter/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  blackbox.yml: |-</span><br><span class="line">    modules:</span><br><span class="line">      http_2xx:</span><br><span class="line">        prober: http</span><br><span class="line">        timeout: 2s</span><br><span class="line">        http:</span><br><span class="line">          valid_http_versions: [&quot;HTTP/1.1&quot;, &quot;HTTP/2&quot;]</span><br><span class="line">          valid_status_codes: [200,301,302]</span><br><span class="line">          method: GET</span><br><span class="line">          preferred_ip_protocol: &quot;ip4&quot;</span><br><span class="line">      tcp_connect:</span><br><span class="line">        prober: tcp</span><br><span class="line">        timeout: 2s</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="blackbox-exporter-2"><p>vi /data/k8s-yaml/blackbox-exporter/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: 1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: blackbox-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: blackbox-exporter</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: config</span><br><span class="line">        configMap:</span><br><span class="line">          name: blackbox-exporter</span><br><span class="line">          defaultMode: 420</span><br><span class="line">      containers:</span><br><span class="line">      - name: blackbox-exporter</span><br><span class="line">        image: harbor.od.com/public/blackbox-exporter:v0.14.0</span><br><span class="line">        args:</span><br><span class="line">        - -\-config.file=/etc/blackbox_exporter/blackbox.yml</span><br><span class="line">        - -\-log.level=debug</span><br><span class="line">        - -\-web.listen-address=:9115</span><br><span class="line">        ports:</span><br><span class="line">        - name: blackbox-port</span><br><span class="line">          containerPort: 9115</span><br><span class="line">          protocol: TCP</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 256Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 50Mi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config</span><br><span class="line">          mountPath: /etc/blackbox_exporter</span><br><span class="line">        readinessProbe:</span><br><span class="line">          tcpSocket:</span><br><span class="line">            port: 9115</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          periodSeconds: 10</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 3</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="blackbox-exporter-3"><p>vi /data/k8s-yaml/blackbox-exporter/service.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: blackbox-exporter</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 9115</span><br><span class="line">      name: http</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="blackbox-exporter-4"><p>vi /data/k8s-yaml/blackbox-exporter/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: blackbox-exporter</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: blackbox.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: blackbox-exporter</span><br><span class="line">          servicePort: 9115</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blackbox	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-4"><a href="#应用资源配置清单-4" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/blackbox-exporter/configmap.yaml</span><br><span class="line">configmap/blackbox-exporter created</span><br><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/blackbox-exporter/deployment.yaml</span><br><span class="line">deployment.extensions/blackbox-exporter created</span><br><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/blackbox-exporter/service.yaml</span><br><span class="line">service/blackbox-exporter created</span><br><span class="line">[root@hdss7-21 ~]# kubectl -f http://k8s-yaml.od.com/blackbox-exporter/ingress.yaml</span><br><span class="line">ingress.extensions/blackbox-exporter created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://blackbox.od.com" target="_blank" rel="noopener">http://blackbox.od.com</a></p>
<p><img src="/images/blackbox.png" alt="blackbox-exporter" title="blackbox-exporter"></p>
<h2 id="部署prometheus"><a href="#部署prometheus" class="headerlink" title="部署prometheus"></a>部署prometheus</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备prometheus镜像"><a href="#准备prometheus镜像" class="headerlink" title="准备prometheus镜像"></a>准备prometheus镜像</h3><p><a href="https://hub.docker.com/r/prom/prometheus" target="_blank" rel="noopener">prometheus官方dockerhub地址</a><br><a href="https://github.com/prometheus/prometheus" target="_blank" rel="noopener">prometheus官方github地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull prom/prometheus:v2.9.1</span><br><span class="line">v2.9.1: Pulling from prom/prometheus</span><br><span class="line">697743189b6d: Pull complete </span><br><span class="line">f1989cfd335b: Pull complete </span><br><span class="line">b60c2f039ea7: Pull complete </span><br><span class="line">6a189f2c500c: Pull complete </span><br><span class="line">bd6be4aea906: Pull complete </span><br><span class="line">81b69caae2b5: Pull complete </span><br><span class="line">5e7226eda004: Pull complete </span><br><span class="line">564568254ec8: Pull complete </span><br><span class="line">9bd07902fc4b: Pull complete </span><br><span class="line">Digest: sha256:e02bb3dec47631b4d31cede2d35ff901d892b57f33144406ee7994e8c94fb2d7</span><br><span class="line">Status: Downloaded newer image for prom/prometheus:v2.9.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag 4737a2d79d1a harbor.od.com/infra/prometheus:v2.9.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/prometheus:v2.9.1</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/prometheus]</span><br><span class="line">a67e5326fa35: Pushed </span><br><span class="line">02c0c0b3065f: Pushed </span><br><span class="line">b7b1f5015c12: Pushed </span><br><span class="line">38be466f60e1: Pushed </span><br><span class="line">9c3fb6c27da7: Pushed </span><br><span class="line">a06c616e78e9: Pushed </span><br><span class="line">05c0d5c2ae72: Pushed </span><br><span class="line">986894c42222: Pushed </span><br><span class="line">adab5d09ba79: Pushed </span><br><span class="line">v2.9.1: digest: sha256:2357e59541f5596dd90d9f4218deddecd9b4880c1e417a42592b00b30b47b0a9 size: 2198</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-4"><a href="#准备资源配置清单-4" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 k8s-yaml]# mkdir /data/k8s-yaml/prometheus &amp;&amp; mkdir -p /data/nfs-volume/prometheus/etc &amp;&amp; cd /data/k8s-yaml/prometheus</span><br></pre></td></tr></table></figure>

<div class="tabs" id="prometheus"><ul class="nav-tabs"><li class="tab active"><a href="#prometheus-1">RBAC</a></li><li class="tab"><a href="#prometheus-2">Deployment</a></li><li class="tab"><a href="#prometheus-3">Service</a></li><li class="tab"><a href="#prometheus-4">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="prometheus-1"><p>vi /data/k8s-yaml/prometheus/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">-\--</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">- nonResourceURLs:</span><br><span class="line">  - /metrics</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">-\--</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="prometheus-2"><p>vi /data/k8s-yaml/prometheus/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    deployment.kubernetes.io/revision: &quot;5&quot;</span><br><span class="line">  labels:</span><br><span class="line">    name: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: prometheus</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/infra/prometheus:v2.9.1</span><br><span class="line">        args:</span><br><span class="line">        - -\-config.file=/data/etc/prometheus.yml</span><br><span class="line">        - -\-storage.tsdb.path=/data/prom-db</span><br><span class="line">        - -\-storage.tsdb.retention=72h</span><br><span class="line">        command:</span><br><span class="line">        - /bin/prometheus</span><br><span class="line">        name: prometheus</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9090</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /data</span><br><span class="line">          name: data</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      dnsPolicy: ClusterFirst</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      serviceAccount: prometheus</span><br><span class="line">      serviceAccountName: prometheus</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: /data/nfs-volume/prometheus</span><br><span class="line"></span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="prometheus-3"><p>vi /data/k8s-yaml/prometheus/service.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    name: prometheus</span><br><span class="line">  selector:</span><br><span class="line">    app: prometheus</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="prometheus-4"><p>vi /data/k8s-yaml/prometheus/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: prometheus.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: prometheus</span><br><span class="line">          servicePort: 9090</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="准备prometheus的配置文件"><a href="#准备prometheus的配置文件" class="headerlink" title="准备prometheus的配置文件"></a>准备prometheus的配置文件</h3><p>运算节点<code>HDSS7-21.host.com</code>上：</p>
<ul>
<li>拷贝证书</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# mkdir -pv /data/nfs-volume/prometheus/&#123;etc,prom-db&#125;</span><br><span class="line">mkdir: created directory ‘/data/nfs-volume/prometheus/etc’</span><br><span class="line">mkdir: created directory ‘/data/nfs-volume/prometheus/prom-db’</span><br><span class="line">[root@hdss7-21 ~]# cd /data/nfs-volume/prometheus/etc</span><br><span class="line">[root@hdss7-21 ~]# scp root@10.4.7.200:/opt/certs/ca.pem .</span><br><span class="line">[root@hdss7-21 ~]# scp root@10.4.7.200:/opt/certs/client.pem .</span><br><span class="line">[root@hdss7-21 ~]# scp root@10.4.7.200:/opt/certs/client-key.pem .</span><br></pre></td></tr></table></figure>

<ul>
<li>准备配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/nfs-volume/prometheus/etc/prometheus.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s</span><br><span class="line">  evaluation_interval: 15s</span><br><span class="line">scrape_configs:</span><br><span class="line">- job_name: &apos;etcd&apos;</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /data/etc/ca.pem</span><br><span class="line">    cert_file: /data/etc/client.pem</span><br><span class="line">    key_file: /data/etc/client-key.pem</span><br><span class="line">  scheme: https</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets:</span><br><span class="line">    - &apos;10.4.7.12:2379&apos;</span><br><span class="line">    - &apos;10.4.7.21:2379&apos;</span><br><span class="line">    - &apos;10.4.7.22:2379&apos;</span><br><span class="line">- job_name: &apos;kubernetes-apiservers&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: endpoints</span><br><span class="line">  scheme: https</span><br><span class="line">  tls_config:</span><br><span class="line">    ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line">  bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: default;kubernetes;https</span><br><span class="line">- job_name: &apos;kubernetes-pods&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: true</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &apos;kubernetes-kubelet&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:10255</span><br><span class="line">- job_name: &apos;kubernetes-cadvisor&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: node</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_node_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_node_name]</span><br><span class="line">    regex: (.+)</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: $&#123;1&#125;:4194</span><br><span class="line">- job_name: &apos;kubernetes-kube-state&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_label_grafanak8sapp]</span><br><span class="line">    regex: .*true.*</span><br><span class="line">    action: keep</span><br><span class="line">  - source_labels: [&apos;__meta_kubernetes_pod_label_daemon&apos;, &apos;__meta_kubernetes_pod_node_name&apos;]</span><br><span class="line">    regex: &apos;node-exporter;(.*)&apos;</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: nodename</span><br><span class="line">- job_name: &apos;blackbox_http_pod_probe&apos;</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [http_2xx]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: http</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port,  __meta_kubernetes_pod_annotation_blackbox_path]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+);(.+)</span><br><span class="line">    replacement: $1:$2$3</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &apos;blackbox_tcp_pod_probe&apos;</span><br><span class="line">  metrics_path: /probe</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  params:</span><br><span class="line">    module: [tcp_connect]</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_blackbox_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: tcp</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_blackbox_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __param_target</span><br><span class="line">  - action: replace</span><br><span class="line">    target_label: __address__</span><br><span class="line">    replacement: blackbox-exporter.kube-system:9115</span><br><span class="line">  - source_labels: [__param_target]</span><br><span class="line">    target_label: instance</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br><span class="line">- job_name: &apos;traefik&apos;</span><br><span class="line">  kubernetes_sd_configs:</span><br><span class="line">  - role: pod</span><br><span class="line">  relabel_configs:</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]</span><br><span class="line">    action: keep</span><br><span class="line">    regex: traefik</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: __metrics_path__</span><br><span class="line">    regex: (.+)</span><br><span class="line">  - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]</span><br><span class="line">    action: replace</span><br><span class="line">    regex: ([^:]+)(?::\d+)?;(\d+)</span><br><span class="line">    replacement: $1:$2</span><br><span class="line">    target_label: __address__</span><br><span class="line">  - action: labelmap</span><br><span class="line">    regex: __meta_kubernetes_pod_label_(.+)</span><br><span class="line">  - source_labels: [__meta_kubernetes_namespace]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_namespace</span><br><span class="line">  - source_labels: [__meta_kubernetes_pod_name]</span><br><span class="line">    action: replace</span><br><span class="line">    target_label: kubernetes_pod_name</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-5"><a href="#应用资源配置清单-5" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/rbac.yaml</span><br><span class="line">serviceaccount/prometheus created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/deployment.yaml</span><br><span class="line">deployment.extensions/prometheus created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/service.yaml</span><br><span class="line">service/prometheus created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/prometheus/ingress.yaml</span><br><span class="line">ingress.extensions/prometheus created</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prometheus	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://prometheus.od.com" target="_blank" rel="noopener">http://prometheus.od.com</a></p>
<h3 id="Prometheus监控内容"><a href="#Prometheus监控内容" class="headerlink" title="Prometheus监控内容"></a>Prometheus监控内容</h3><p>Targets（jobs）</p>
<h4 id="etcd"><a href="#etcd" class="headerlink" title="etcd"></a>etcd</h4><blockquote>
<p>监控etcd服务</p>
</blockquote>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>etcd_server_has_leader</td>
<td>1</td>
</tr>
<tr>
<td>etcd_http_failed_total</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<h4 id="kubernetes-apiserver"><a href="#kubernetes-apiserver" class="headerlink" title="kubernetes-apiserver"></a>kubernetes-apiserver</h4><blockquote>
<p>监控apiserver服务</p>
</blockquote>
<h4 id="kubernetes-kubelet"><a href="#kubernetes-kubelet" class="headerlink" title="kubernetes-kubelet"></a>kubernetes-kubelet</h4><blockquote>
<p>监控kubelet服务</p>
</blockquote>
<h4 id="kubernetes-kube-state"><a href="#kubernetes-kube-state" class="headerlink" title="kubernetes-kube-state"></a>kubernetes-kube-state</h4><p>监控基本信息</p>
<ul>
<li><p>node-exporter</p>
<blockquote>
<p>监控Node节点信息</p>
</blockquote>
</li>
<li><p>kube-state-metrics</p>
<blockquote>
<p>监控pod信息</p>
</blockquote>
</li>
</ul>
<h4 id="traefik"><a href="#traefik" class="headerlink" title="traefik"></a>traefik</h4><blockquote>
<p>监控traefik-ingress-controller</p>
</blockquote>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>traefik_entrypoint_requests_total{code=”200”,entrypoint=”http”,method=”PUT”,protocol=”http”}</td>
<td>138</td>
</tr>
<tr>
<td>traefik_entrypoint_requests_total{code=”200”,entrypoint=”http”,method=”GET”,protocol=”http”}</td>
<td>285</td>
</tr>
<tr>
<td>traefik_entrypoint_open_connections{entrypoint=”http”,method=”PUT”,protocol=”http”}</td>
<td>1</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p><strong>注意：在traefik的pod控制器上加annotations，并重启pod，监控生效</strong><br>配置范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scheme&quot;: &quot;traefik&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/metrics&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;8080&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="blackbox"><a href="#blackbox" class="headerlink" title="blackbox*"></a>blackbox*</h4><p>监控服务是否存活</p>
<ul>
<li>blackbox_tcp_pod_porbe<blockquote>
<p>监控tcp协议服务是否存活</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>probe_success</td>
<td>1</td>
</tr>
<tr>
<td>probe_ip_protocol</td>
<td>4</td>
</tr>
<tr>
<td>probe_failed_due_to_regex</td>
<td>0</td>
</tr>
<tr>
<td>probe_duration_seconds</td>
<td>0.000597546</td>
</tr>
<tr>
<td>probe_dns_lookup_time_seconds</td>
<td>0.00010898</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong><br>配置范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;20880&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;tcp&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>blackbox_http_pod_probe<blockquote>
<p>监控http协议服务是否存活</p>
</blockquote>
</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>probe_success</td>
<td>1</td>
</tr>
<tr>
<td>probe_ip_protocol</td>
<td>4</td>
</tr>
<tr>
<td>probe_http_version</td>
<td>1.1</td>
</tr>
<tr>
<td>probe_http_status_code</td>
<td>200</td>
</tr>
<tr>
<td>probe_http_ssl</td>
<td>0</td>
</tr>
<tr>
<td>probe_http_redirects</td>
<td>1</td>
</tr>
<tr>
<td>probe_http_last_modified_timestamp_seconds</td>
<td>1.553861888e+09</td>
</tr>
<tr>
<td>probe_http_duration_seconds{phase=”transfer”}</td>
<td>0.000238343</td>
</tr>
<tr>
<td>probe_http_duration_seconds{phase=”tls”}</td>
<td>0</td>
</tr>
<tr>
<td>probe_http_duration_seconds{phase=”resolve”}</td>
<td>5.4095e-05</td>
</tr>
<tr>
<td>probe_http_duration_seconds{phase=”processing”}</td>
<td>0.000966104</td>
</tr>
<tr>
<td>probe_http_duration_seconds{phase=”connect”}</td>
<td>0.000520821</td>
</tr>
<tr>
<td>probe_http_content_length</td>
<td>716</td>
</tr>
<tr>
<td>probe_failed_due_to_regex</td>
<td>0</td>
</tr>
<tr>
<td>probe_duration_seconds</td>
<td>0.00272609</td>
</tr>
<tr>
<td>probe_dns_lookup_time_seconds</td>
<td>5.4095e-05</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong><br>配置范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;blackbox_path&quot;: &quot;/&quot;,</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;8080&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;http&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="kubernetes-pods"><a href="#kubernetes-pods" class="headerlink" title="kubernetes-pods*"></a>kubernetes-pods*</h4><blockquote>
<p>监控JVM信息</p>
</blockquote>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>jvm_info{version=”1.7.0_80-b15”,vendor=”Oracle Corporation”,runtime=”Java(TM) SE Runtime Environment”,}</td>
<td>1.0</td>
</tr>
<tr>
<td>jmx_config_reload_success_total</td>
<td>0.0</td>
</tr>
<tr>
<td>process_resident_memory_bytes</td>
<td>4.693897216E9</td>
</tr>
<tr>
<td>process_virtual_memory_bytes</td>
<td>1.2138840064E10</td>
</tr>
<tr>
<td>process_max_fds</td>
<td>65536.0</td>
</tr>
<tr>
<td>process_open_fds</td>
<td>123.0</td>
</tr>
<tr>
<td>process_start_time_seconds</td>
<td>1.54331073249E9</td>
</tr>
<tr>
<td>process_cpu_seconds_total</td>
<td>196465.74</td>
</tr>
<tr>
<td>jvm_buffer_pool_used_buffers{pool=”mapped”,}</td>
<td>0.0</td>
</tr>
<tr>
<td>jvm_buffer_pool_used_buffers{pool=”direct”,}</td>
<td>150.0</td>
</tr>
<tr>
<td>jvm_buffer_pool_capacity_bytes{pool=”mapped”,}</td>
<td>0.0</td>
</tr>
<tr>
<td>jvm_buffer_pool_capacity_bytes{pool=”direct”,}</td>
<td>6216688.0</td>
</tr>
<tr>
<td>jvm_buffer_pool_used_bytes{pool=”mapped”,}</td>
<td>0.0</td>
</tr>
<tr>
<td>jvm_buffer_pool_used_bytes{pool=”direct”,}</td>
<td>6216688.0</td>
</tr>
<tr>
<td>jvm_gc_collection_seconds_sum{gc=”PS MarkSweep”,}</td>
<td>1.867</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p><strong>注意：在pod控制器上加annotations，并重启pod，监控生效</strong><br>配置范例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scrape&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;12346&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改traefik服务接入prometheus监控"><a href="#修改traefik服务接入prometheus监控" class="headerlink" title="修改traefik服务接入prometheus监控"></a>修改traefik服务接入prometheus监控</h3><p><code>dashboard</code>上：<br>kube-system名称空间-&gt;daemonset-&gt;traefik-ingress-controller-&gt;spec-&gt;template-&gt;metadata下，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scheme&quot;: &quot;traefik&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/metrics&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;8080&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<p>继续添加blackbox监控配置项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scheme&quot;: &quot;traefik&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/metrics&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;8080&quot;,</span><br><span class="line">  &quot;blackbox_path&quot;: &quot;/&quot;,</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;8080&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;http&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改dubbo-service服务接入prometheus监控"><a href="#修改dubbo-service服务接入prometheus监控" class="headerlink" title="修改dubbo-service服务接入prometheus监控"></a>修改dubbo-service服务接入prometheus监控</h3><p><code>dashboard</code>上：<br>app名称空间-&gt;deployment-&gt;dubbo-demo-service-&gt;spec-&gt;template=&gt;metadata下，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scrape&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;12346&quot;,</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;20880&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;tcp&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<h3 id="修改dubbo-consumer服务接入prometheus监控"><a href="#修改dubbo-consumer服务接入prometheus监控" class="headerlink" title="修改dubbo-consumer服务接入prometheus监控"></a>修改dubbo-consumer服务接入prometheus监控</h3><p>app名称空间-&gt;deployment-&gt;dubbo-demo-consumer-&gt;spec-&gt;template-&gt;metadata下，添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;annotations&quot;: &#123;</span><br><span class="line">  &quot;prometheus_io_scrape&quot;: &quot;true&quot;,</span><br><span class="line">  &quot;prometheus_io_path&quot;: &quot;/&quot;,</span><br><span class="line">  &quot;prometheus_io_port&quot;: &quot;12346&quot;,</span><br><span class="line">  &quot;blackbox_path&quot;: &quot;/hello&quot;,</span><br><span class="line">  &quot;blackbox_port&quot;: &quot;8080&quot;,</span><br><span class="line">  &quot;blackbox_scheme&quot;: &quot;http&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除pod，重启traefik，观察监控</p>
<h2 id="部署Grafana"><a href="#部署Grafana" class="headerlink" title="部署Grafana"></a>部署Grafana</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备grafana镜像"><a href="#准备grafana镜像" class="headerlink" title="准备grafana镜像"></a>准备grafana镜像</h3><p><a href="https://hub.docker.com/r/grafana/grafana" target="_blank" rel="noopener">grafana官方dockerhub地址</a><br><a href="https://github.com/grafana/grafana" target="_blank" rel="noopener">grafana官方github地址</a><br><a href="https://grafana.com/" target="_blank" rel="noopener">grafana官网</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull grafana/grafana:6.1.4</span><br><span class="line">6.1.4: Pulling from grafana/grafana</span><br><span class="line">27833a3ba0a5: Pull complete </span><br><span class="line">9412d126b236: Pull complete </span><br><span class="line">1b7d6aaa6217: Pull complete </span><br><span class="line">530d1110a8c8: Pull complete </span><br><span class="line">fdcf73917f64: Pull complete </span><br><span class="line">f5009e3ea28a: Pull complete </span><br><span class="line">Digest: sha256:c2100550937e7aa0f3e33c2fc46a8c9668c3b5f2f71a8885e304d35de9fea009</span><br><span class="line">Status: Downloaded newer image for grafana/grafana:6.1.4</span><br><span class="line">[root@hdss7-200 ~]# docker tag d9bdb6044027 harbor.od.com/infra/grafana:v6.1.4</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/grafana:v6.1.4</span><br><span class="line">docker push harbor.od.com/infra/grafana:v6.1.4</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/grafana]</span><br><span class="line">b57e9e94fc2d: Pushed </span><br><span class="line">3d4e16e25cba: Pushed </span><br><span class="line">9642e67d431a: Pushed </span><br><span class="line">af52591a894f: Pushed </span><br><span class="line">0a8c2d04bf65: Pushed </span><br><span class="line">5dacd731af1b: Pushed </span><br><span class="line">v6.1.4: digest: sha256:db87ab263f90bdae66be744ac7935f6980c4bbd30c9756308e7382e00d4eeae8 size: 1576</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-5"><a href="#准备资源配置清单-5" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="grafana"><ul class="nav-tabs"><li class="tab active"><a href="#grafana-1">RBAC</a></li><li class="tab"><a href="#grafana-2">Deployment</a></li><li class="tab"><a href="#grafana-3">Service</a></li><li class="tab"><a href="#grafana-4">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="grafana-1"><p>vi /data/k8s-yaml/grafana/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - namespaces</span><br><span class="line">  - deployments</span><br><span class="line">  - pods</span><br><span class="line">  verbs:</span><br><span class="line">  - get</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">-\--</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">  name: grafana</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: grafana</span><br><span class="line">subjects:</span><br><span class="line">- kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="grafana-2"><p>vi /data/k8s-yaml/grafana/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">    name: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  progressDeadlineSeconds: 600</span><br><span class="line">  replicas: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: grafana</span><br><span class="line">  strategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxSurge: 1</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">        name: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/infra/grafana:v6.1.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: grafana</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/lib/grafana</span><br><span class="line">          name: data</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      nodeName: 10.4.7.21</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      volumes:</span><br><span class="line">      - nfs:</span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: /data/nfs-volume/grafana</span><br><span class="line">        name: data</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="grafana-3"><p>vi /data/k8s-yaml/grafana/service.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 3000</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">  type: ClusterIP</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="grafana-4"><p>vi /data/k8s-yaml/grafana/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: grafana.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend:</span><br><span class="line">          serviceName: grafana</span><br><span class="line">          servicePort: 3000</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-6"><a href="#应用资源配置清单-6" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/deployment.yaml </span><br><span class="line">deployment.extensions/grafana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/service.yaml </span><br><span class="line">service/grafana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/grafana/ingress.yaml </span><br><span class="line">ingress.extensions/grafana created</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-2"><a href="#解析域名-2" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-3"><a href="#浏览器访问-3" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://grafana.od.com" target="_blank" rel="noopener">http://grafana.od.com</a></p>
<ul>
<li>用户名：admin</li>
<li>密  码：admin</li>
</ul>
<p>登录后需要修改管理员密码<br><img src="/images/grafana-password.png" alt="grafana首次登录" title="修改管理员密码"></p>
<h3 id="配置grafana页面"><a href="#配置grafana页面" class="headerlink" title="配置grafana页面"></a>配置grafana页面</h3><h4 id="外观"><a href="#外观" class="headerlink" title="外观"></a>外观</h4><p>Configuration -&gt; Preferences</p>
<ul>
<li><p>UI Theme</p>
<blockquote>
<p>Light</p>
</blockquote>
</li>
<li><p>Home Dashboard</p>
<blockquote>
<p>Default</p>
</blockquote>
</li>
<li><p>Timezone</p>
<blockquote>
<p>Local browser time</p>
</blockquote>
</li>
</ul>
<p>save</p>
<h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>Configuration -&gt; Plugins</p>
<ul>
<li>Kubernetes App</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-kubernetes-app</span><br></pre></td></tr></table></figure>

<p>安装方法二：<br><a href="https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download" target="_blank" rel="noopener">下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/data/nfs-volume/grafana/plugins</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 plugins]# wget https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download -O grafana-kubernetes-app.zip</span><br><span class="line">--2019-04-28 16:15:33--  https://grafana.com/api/plugins/grafana-kubernetes-app/versions/1.0.1/download</span><br><span class="line">Resolving grafana.com (grafana.com)... 35.241.23.245</span><br><span class="line">Connecting to grafana.com (grafana.com)|35.241.23.245|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://codeload.github.com/grafana/kubernetes-app/legacy.zip/31da38addc1d0ce5dfb154737c9da56e3b6692fc [following]</span><br><span class="line">--2019-04-28 16:15:37--  https://codeload.github.com/grafana/kubernetes-app/legacy.zip/31da38addc1d0ce5dfb154737c9da56e3b6692fc</span><br><span class="line">Resolving codeload.github.com (codeload.github.com)... 13.229.189.0, 13.250.162.133, 54.251.140.56</span><br><span class="line">Connecting to codeload.github.com (codeload.github.com)|13.229.189.0|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 3084524 (2.9M) [application/zip]</span><br><span class="line">Saving to: ‘grafana-kubernetes-app.zip’</span><br><span class="line"></span><br><span class="line">100%[===================================================================================================================&gt;] 3,084,524    116KB/s   in 12s    </span><br><span class="line"></span><br><span class="line">2019-04-28 16:15:51 (250 KB/s) - ‘grafana-kubernetes-app.zip’ saved [3084524/3084524]</span><br><span class="line">[root@hdss7-200 plugins]# unzip grafana-kubernetes-app.zip</span><br></pre></td></tr></table></figure>

<ul>
<li>Clock Pannel</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-clock-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：<br><a href="https://grafana.com/api/plugins/grafana-clock-panel/versions/1.0.2/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>Pie Chart</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：<br><a href="https://grafana.com/api/plugins/grafana-piechart-panel/versions/1.3.6/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>D3 Gauge</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install briangann-gauge-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：<br><a href="https://grafana.com/api/plugins/briangann-gauge-panel/versions/0.0.6/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li>Discrete</li>
</ul>
<p>安装方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grafana-cli plugins install natel-discrete-panel</span><br></pre></td></tr></table></figure>

<p>安装方法二：<br><a href="https://grafana.com/api/plugins/natel-discrete-panel/versions/0.0.9/download" target="_blank" rel="noopener">下载地址</a></p>
<ul>
<li><p>重启grafana的pod</p>
</li>
<li><p>依次enable插件</p>
</li>
</ul>
<h3 id="配置grafana数据源"><a href="#配置grafana数据源" class="headerlink" title="配置grafana数据源"></a>配置grafana数据源</h3><p>Configuration -&gt; Data Sources<br>选择prometheus</p>
<ul>
<li>HTTP</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>URL</td>
<td><a href="http://prometheus.od.com" target="_blank" rel="noopener">http://prometheus.od.com</a></td>
</tr>
<tr>
<td>Access</td>
<td>Server(Default)</td>
</tr>
</tbody></table>
<ul>
<li>Save &amp; Test</li>
</ul>
<p><img src="/images/grafana-datasource.png" alt="Grafana数据源" title="grafana数据源"></p>
<h3 id="配置Kubernetes集群Dashboard"><a href="#配置Kubernetes集群Dashboard" class="headerlink" title="配置Kubernetes集群Dashboard"></a>配置Kubernetes集群Dashboard</h3><p>kubernetes -&gt; +New Cluster</p>
<ul>
<li>Add a new cluster</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>Name</td>
<td>myk8s</td>
</tr>
</tbody></table>
<ul>
<li>HTTP</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>URL</td>
<td><a href="https://10.4.7.10:7443" target="_blank" rel="noopener">https://10.4.7.10:7443</a></td>
</tr>
<tr>
<td>Access</td>
<td>Server(Default)</td>
</tr>
</tbody></table>
<ul>
<li>Auth</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>TLS Client Auth</td>
<td>勾选</td>
</tr>
<tr>
<td>With Ca Cert</td>
<td>勾选</td>
</tr>
</tbody></table>
<p>将ca.pem、client.pem和client-key.pem粘贴至文本框内</p>
<ul>
<li>Prometheus Read</li>
</ul>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>Datasource</td>
<td>Prometheus</td>
</tr>
</tbody></table>
<ul>
<li>Save</li>
</ul>
<p><strong>注意：</strong></p>
<ul>
<li>K8S Container中，所有Pannel的<blockquote>
<p>pod_name -&gt; container_label_io_kubernetes_pod_name</p>
</blockquote>
</li>
</ul>
<div class="tabs" id="k8s-dashboard"><ul class="nav-tabs"><li class="tab active"><a href="#k8s-dashboard-1">K8S-Cluster</a></li><li class="tab"><a href="#k8s-dashboard-2">K8S-Node</a></li><li class="tab"><a href="#k8s-dashboard-3">K8S-Deployment</a></li><li class="tab"><a href="#k8s-dashboard-4">K8S-Container</a></li></ul><div class="tab-content"><div class="tab-pane active" id="k8s-dashboard-1"><p>见附件</p></div><div class="tab-pane" id="k8s-dashboard-2"><p>见附件</p></div><div class="tab-pane" id="k8s-dashboard-3"><p>见附件</p></div><div class="tab-pane" id="k8s-dashboard-4"><p>见附件</p></div></div></div>

<h3 id="配置自定义dashboard"><a href="#配置自定义dashboard" class="headerlink" title="配置自定义dashboard"></a>配置自定义dashboard</h3><p>根据Prometheus数据源里的数据，配置如下dashboard：</p>
<ul>
<li>etcd dashboard</li>
<li>traefik dashboard</li>
<li>generic dashboard</li>
<li>JMX dashboard</li>
<li>blackbox dashboard</li>
</ul>
<div class="tabs" id="grafana-dashboard"><ul class="nav-tabs"><li class="tab active"><a href="#grafana-dashboard-1">ETCD</a></li><li class="tab"><a href="#grafana-dashboard-2">TRAEFIK</a></li><li class="tab"><a href="#grafana-dashboard-3">GENERIC</a></li><li class="tab"><a href="#grafana-dashboard-4">JMX</a></li><li class="tab"><a href="#grafana-dashboard-5">BlackBox</a></li></ul><div class="tab-content"><div class="tab-pane active" id="grafana-dashboard-1"><p>见附件</p></div><div class="tab-pane" id="grafana-dashboard-2"><p>见附件</p></div><div class="tab-pane" id="grafana-dashboard-3"><p>见附件</p></div><div class="tab-pane" id="grafana-dashboard-4"><p>见附件</p></div><div class="tab-pane" id="grafana-dashboard-5"><p>见附件</p></div></div></div>


<h1 id="使用ELK-Stack收集kubernetes集群内的应用日志"><a href="#使用ELK-Stack收集kubernetes集群内的应用日志" class="headerlink" title="使用ELK Stack收集kubernetes集群内的应用日志"></a>使用ELK Stack收集kubernetes集群内的应用日志</h1><h2 id="部署ElasticSearch"><a href="#部署ElasticSearch" class="headerlink" title="部署ElasticSearch"></a>部署ElasticSearch</h2><p><a href="https://www.elastic.co/" target="_blank" rel="noopener">官网</a><br><a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">官方github地址</a><br><a href="https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.1.tar.gz" target="_blank" rel="noopener">下载地址</a><br><code>HDSS7-12.host.com</code>上：</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# ls -l|grep elasticsearch-6.8.1.tar.gz</span><br><span class="line">-rw-r--r-- 1 root root  72262257 Jan 30 15:18 elasticsearch-6.8.1.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf elasticsearch-6.8.1.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/elasticsearch-6.8.1/ /opt/elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><h4 id="elasticsearch-yml"><a href="#elasticsearch-yml" class="headerlink" title="elasticsearch.yml"></a>elasticsearch.yml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /data/elasticsearch/&#123;data,logs&#125;</span><br><span class="line">[root@hdss7-12 elasticsearch]# vi config/elasticsearch.yml</span><br><span class="line">cluster.name: es.od.com</span><br><span class="line">node.name: hdss7-12.host.com</span><br><span class="line">path.data: /data/elasticsearch/data</span><br><span class="line">path.logs: /data/elasticsearch/logs</span><br><span class="line">bootstrap.memory_lock: true</span><br><span class="line">network.host: 10.4.7.12</span><br><span class="line">http.port: 9200</span><br></pre></td></tr></table></figure>

<h4 id="jvm-options"><a href="#jvm-options" class="headerlink" title="jvm.options"></a>jvm.options</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# vi config/jvm.options</span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br></pre></td></tr></table></figure>

<h4 id="创建普通用户"><a href="#创建普通用户" class="headerlink" title="创建普通用户"></a>创建普通用户</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# useradd -s /bin/bash -M es</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /opt/elasticsearch-6.8.1</span><br><span class="line">[root@hdss7-12 elasticsearch]# chown -R es.es /data/elasticsearch</span><br></pre></td></tr></table></figure>

<h4 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h4><figure class="highlight plain"><figcaption><span>/etc/security/limits.d/es.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">es hard nofile 65536</span><br><span class="line">es soft fsize unlimited</span><br><span class="line">es hard memlock unlimited</span><br><span class="line">es soft memlock unlimited</span><br></pre></td></tr></table></figure>

<h4 id="调整内核参数"><a href="#调整内核参数" class="headerlink" title="调整内核参数"></a>调整内核参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# sysctl -w vm.max_map_count=262144</span><br><span class="line">or</span><br><span class="line">[root@hdss7-12 elasticsearch]# echo &quot;vm.max_map_count=262144&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">[root@hdss7-12 elasticsearch]# sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# su - es</span><br><span class="line">su: warning: cannot change directory to /home/es: No such file or directory</span><br><span class="line">-bash-4.2$ /opt/elasticsearch/bin/elasticsearch &amp;</span><br><span class="line">[1] 8714</span><br><span class="line">[root@hdss7-12 elasticsearch]# ps -ef|grep elastic|grep -v grep</span><br><span class="line">es        8714     1 58 10:29 pts/0    00:00:19 /usr/java/jdk/bin/java -Xms512m -Xmx512m -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -Des.path.home=/opt/elasticsearch -cp /opt/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch</span><br></pre></td></tr></table></figure>

<h3 id="调整ES日志模板"><a href="#调整ES日志模板" class="headerlink" title="调整ES日志模板"></a>调整ES日志模板</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 elasticsearch]# curl -H &quot;Content-Type:application/json&quot; -XPUT http://10.4.7.12:9200/_template/k8s -d &apos;&#123;</span><br><span class="line">  &quot;template&quot; : &quot;k8s*&quot;,</span><br><span class="line">  &quot;index_patterns&quot;: [&quot;k8s*&quot;],  </span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 5,</span><br><span class="line">    &quot;number_of_replicas&quot;: 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>

<h2 id="部署kafka"><a href="#部署kafka" class="headerlink" title="部署kafka"></a>部署kafka</h2><p><a href="http://kafka.apache.org/" target="_blank" rel="noopener">官网</a><br><a href="https://github.com/apache/kafka" target="_blank" rel="noopener">官方github地址</a><br><a href="http://mirrors.tuna.tsinghua.edu.cn/apache/kafka/2.1.1/kafka_2.12-2.1.1.tgz" target="_blank" rel="noopener">下载地址</a><br><code>HDSS7-11.host.com</code>上：</p>
<h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 src]# ls -l|grep kafka</span><br><span class="line">-rw-r--r-- 1 root root  57028557 Mar 23 08:57 kafka_2.12-2.2.0.tgz</span><br><span class="line">[root@hdss7-11 src]# tar xf kafka_2.12-2.1.1.tgz -C /opt</span><br><span class="line">[root@hdss7-11 src]# ln -s /opt/kafka_2.12-2.1.1/ /opt/kafka</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/opt/kafka/config/server.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">log.dirs=/data/kafka/logs</span><br><span class="line">zookeeper.connect=localhost:2181</span><br><span class="line">log.flush.interval.messages=10000</span><br><span class="line">log.flush.interval.ms=1000</span><br><span class="line">delete.topic.enable=true</span><br><span class="line">host.name=hdss7-11.host.com</span><br></pre></td></tr></table></figure>

<h3 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><figcaption><span>/opt/kafka</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 kafka]# bin/kafka-server-start.sh -daemon config/server.properties</span><br><span class="line">[root@hdss7-11 kafka]# netstat -luntp|grep 9092</span><br><span class="line">tcp6       0      0 10.4.7.12:9092         :::*                    LISTEN      17543/java</span><br></pre></td></tr></table></figure>

<h2 id="部署kafka-manager"><a href="#部署kafka-manager" class="headerlink" title="部署kafka-manager"></a>部署kafka-manager</h2><p><a href="https://github.com/yahoo/kafka-manager" target="_blank" rel="noopener">官方github地址</a><br><a href="https://github.com/yahoo/kafka-manager/archive/2.0.0.2.tar.gz" target="_blank" rel="noopener">源码下载地址</a><br>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="方法一：1、准备Dockerfile"><a href="#方法一：1、准备Dockerfile" class="headerlink" title="方法一：1、准备Dockerfile"></a>方法一：1、准备Dockerfile</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/kafka-manager/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">FROM hseeberger/scala-sbt</span><br><span class="line"></span><br><span class="line">ENV ZK_HOSTS=10.4.7.11:2181 \</span><br><span class="line">     KM_VERSION=2.0.0.2</span><br><span class="line"></span><br><span class="line">RUN mkdir -p /tmp &amp;&amp; \</span><br><span class="line">    cd /tmp &amp;&amp; \</span><br><span class="line">    wget https://github.com/yahoo/kafka-manager/archive/$&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    tar xxf $&#123;KM_VERSION&#125;.tar.gz &amp;&amp; \</span><br><span class="line">    cd /tmp/kafka-manager-$&#123;KM_VERSION&#125; &amp;&amp; \</span><br><span class="line">    sbt clean dist &amp;&amp; \</span><br><span class="line">    unzip  -d / ./target/universal/kafka-manager-$&#123;KM_VERSION&#125;.zip &amp;&amp; \</span><br><span class="line">    rm -fr /tmp/$&#123;KM_VERSION&#125; /tmp/kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">WORKDIR /kafka-manager-$&#123;KM_VERSION&#125;</span><br><span class="line"></span><br><span class="line">EXPOSE 9000</span><br><span class="line">ENTRYPOINT [&quot;./bin/kafka-manager&quot;,&quot;-Dconfig.file=conf/application.conf&quot;]</span><br></pre></td></tr></table></figure>

<h3 id="方法一：2、制作docker镜像"><a href="#方法一：2、制作docker镜像" class="headerlink" title="方法一：2、制作docker镜像"></a>方法一：2、制作docker镜像</h3><figure class="highlight plain"><figcaption><span>/data/dockerfile/kafka-manager</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 kafka-manager]# docker build . -t harbor.od.com/infra/kafka-manager:v2.0.0.2</span><br><span class="line">(漫长的过程)</span><br></pre></td></tr></table></figure>

<h3 id="方法二：直接下载docker镜像"><a href="#方法二：直接下载docker镜像" class="headerlink" title="方法二：直接下载docker镜像"></a>方法二：直接下载docker镜像</h3><p><a href="https://hub.docker.com/r/sheepkiller/kafka-manager/tags" target="_blank" rel="noopener">镜像下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull sheepkiller/kafka-manager:stable</span><br><span class="line">[root@hdss7-200 ~]# docker tag 34627743836f harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">docker push harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kafka]</span><br><span class="line">ef97dbc2670b: Pushed </span><br><span class="line">ec01aa005e59: Pushed </span><br><span class="line">de05a1bdf878: Pushed </span><br><span class="line">9c553f3feafd: Pushed </span><br><span class="line">581533427a4f: Pushed </span><br><span class="line">f6b229974fdd: Pushed </span><br><span class="line">ae150883d6e2: Pushed </span><br><span class="line">3df7be729841: Pushed </span><br><span class="line">f231cc200afe: Pushed </span><br><span class="line">9752c15164a8: Pushed </span><br><span class="line">9ab7eda5c826: Pushed </span><br><span class="line">402964b3d72e: Pushed </span><br><span class="line">6b3f8ebf864c: Pushed </span><br><span class="line">stable: digest: sha256:57fd46a3751284818f1bc6c0fdf097250bc0feed03e77135fb8b0a93aa8c6cc7 size: 3056</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-6"><a href="#准备资源配置清单-6" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="kafka-manager"><ul class="nav-tabs"><li class="tab active"><a href="#kafka-manager-1">Deployment</a></li><li class="tab"><a href="#kafka-manager-2">Service</a></li><li class="tab"><a href="#kafka-manager-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="kafka-manager-1"><p>vi /data/k8s-yaml/kafka-manager/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kafka-manager</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kafka-manager</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kafka-manager</span><br><span class="line">        name: kafka-manager</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka-manager</span><br><span class="line">        image: harbor.od.com/infra/kafka-manager:stable</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ZK_HOSTS</span><br><span class="line">          value: zk1.od.com:2181</span><br><span class="line">        - name: APPLICATION_SECRET</span><br><span class="line">          value: letmein</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kafka-manager-2"><p>vi /data/k8s-yaml/kafka-manager/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 9000</span><br><span class="line">    targetPort: 9000</span><br><span class="line">  selector: </span><br><span class="line">    app: kafka-manager</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kafka-manager-3"><p>vi /data/k8s-yaml/kafka-manager/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kafka-manager</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: km.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kafka-manager</span><br><span class="line">          servicePort: 9000</span><br></pre></td></tr></table></figure></div></div></div>
<h3 id="应用资源配置清单-7"><a href="#应用资源配置清单-7" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意一台运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/deployment.yaml </span><br><span class="line">deployment.extensions/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/svc.yaml </span><br><span class="line">service/kafka-manager created</span><br><span class="line">[root@hdss7-21 kafka-manager]# kubectl apply -f http://k8s-yaml.od.com/kafka-manager/ingress.yaml </span><br><span class="line">ingress.extensions/kafka-manager created</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-3"><a href="#解析域名-3" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">km	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-4"><a href="#浏览器访问-4" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://km.od.com" target="_blank" rel="noopener">http://km.od.com</a></p>
<p><img src="/images/kafka-manager.png" alt="kafka-manager" title="kafka-manager"></p>
<h2 id="部署filebeat"><a href="#部署filebeat" class="headerlink" title="部署filebeat"></a>部署filebeat</h2><p><a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank" rel="noopener">官方下载地址</a><br>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="制作docker镜像"><a href="#制作docker镜像" class="headerlink" title="制作docker镜像"></a>制作docker镜像</h3><h4 id="准备Dockerfile-1"><a href="#准备Dockerfile-1" class="headerlink" title="准备Dockerfile"></a>准备Dockerfile</h4><div class="tabs" id="filebeat-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#filebeat-dockerfile-1">Dockerfile</a></li><li class="tab"><a href="#filebeat-dockerfile-2">Entrypoint</a></li></ul><div class="tab-content"><div class="tab-pane active" id="filebeat-dockerfile-1"><p>vi /data/dockerfile/filebeat/Dockerfile</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">FROM debian:jessie</span><br><span class="line"></span><br><span class="line">ENV FILEBEAT_VERSION=7.2.0 \</span><br><span class="line">    FILEBEAT_SHA1=fdddfa32a7d9db5ac4504b34499e6259e09b86205bac842f78fddd45e8ee00c3cb76419af2313659fd23db4fcbcc29f7568a3663c5d3c52ac0fc9e641d0ae8b1</span><br><span class="line"></span><br><span class="line">RUN set -x &amp;&amp; \</span><br><span class="line">  apt-get update &amp;&amp; \</span><br><span class="line">  apt-get install -y wget &amp;&amp; \</span><br><span class="line">  wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-$&#123;FILEBEAT_VERSION&#125;-linux-x86_64.tar.gz -O /opt/filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  echo &quot;$&#123;FILEBEAT_SHA1&#125;  filebeat.tar.gz&quot; | sha512sum -c - &amp;&amp; \</span><br><span class="line">  tar xzvf filebeat.tar.gz &amp;&amp; \</span><br><span class="line">  cd filebeat-\* &amp;&amp; \</span><br><span class="line">  cp filebeat /bin &amp;&amp; \</span><br><span class="line">  cd /opt &amp;&amp; \</span><br><span class="line">  rm -rf filebeat\* &amp;&amp; \</span><br><span class="line">  apt-get purge -y wget &amp;&amp; \</span><br><span class="line">  apt-get autoremove -y &amp;&amp; \</span><br><span class="line">  apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/\* /tmp/\* /var/tmp/\*</span><br><span class="line"></span><br><span class="line">COPY docker-entrypoint.sh /</span><br><span class="line">ENTRYPOINT [&quot;/docker-entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="filebeat-dockerfile-2"><p>vi /data/dockerfile/filebeat/docker-entrypoint.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">ENV=$&#123;ENV:-&quot;test&quot;&#125;</span><br><span class="line">PROJ_NAME=$&#123;PROJ_NAME:-&quot;no-define&quot;&#125;</span><br><span class="line">MULTILINE=$&#123;MULTILINE:-&quot;^\d&#123;2&#125;&quot;&#125;</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/filebeat.yaml &lt;&lt; EOF</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logm-$&#123;PROJ_NAME&#125;</span><br><span class="line">  paths:</span><br><span class="line">    - /logm/\*.log</span><br><span class="line">    - /logm/\*/\*.log</span><br><span class="line">    - /logm/\*/\*/\*.log</span><br><span class="line">    - /logm/\*/\*/\*/\*.log</span><br><span class="line">    - /logm/\*/\*/\*/\*/\*.log</span><br><span class="line">  scan_frequency: 120s</span><br><span class="line">  max_bytes: 10485760</span><br><span class="line">  multiline.pattern: &apos;$MULTILINE&apos;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  multiline.max_lines: 100</span><br><span class="line">- type: log</span><br><span class="line">  fields_under_root: true</span><br><span class="line">  fields:</span><br><span class="line">    topic: logu-$&#123;PROJ_NAME&#125;</span><br><span class="line">  paths:</span><br><span class="line">    - /logu/\*.log</span><br><span class="line">    - /logu/\*/\*.log</span><br><span class="line">    - /logu/\*/\*/\*.log</span><br><span class="line">    - /logu/\*/\*/\*/\*.log</span><br><span class="line">    - /logu/\*/\*/\*/\*/\*.log</span><br><span class="line">    - /logu/\*/\*/\*/\*/\*/\*.log</span><br><span class="line">output.kafka:</span><br><span class="line">  hosts: [&quot;10.4.7.11:9092&quot;]</span><br><span class="line">  topic: k8s-fb-$ENV-%&#123;[topic]&#125;</span><br><span class="line">  version: 2.0.0</span><br><span class="line">  required_acks: 0</span><br><span class="line">  max_message_bytes: 10485760</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">set -xe</span><br><span class="line"></span><br><span class="line"># If user don&apos;t provide any command</span><br><span class="line"># Run filebeat</span><br><span class="line">if [[ &quot;$1&quot; == &quot;&quot; ]]; then</span><br><span class="line">     exec filebeat  -c /etc/filebeat.yaml </span><br><span class="line">else</span><br><span class="line">    # Else allow the user to run arbitrarily commands like bash</span><br><span class="line">    exec &quot;$@&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br></pre></td></tr></table></figure></div></div></div>

<h4 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h4><figure class="highlight plain"><figcaption><span>/data/dockerfile/filebeat</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 filebeat]# docker build . -t harbor.od.com/infra/filebeat:v7.2.0</span><br><span class="line">...</span><br><span class="line">+ apt-get autoremove -y</span><br><span class="line">Reading package lists...</span><br><span class="line">Building dependency tree...</span><br><span class="line">Reading state information...</span><br><span class="line">The following packages will be REMOVED:</span><br><span class="line">  ca-certificates libicu52 libidn11 libpsl0 libssl1.0.0 openssl</span><br><span class="line">0 upgraded, 0 newly installed, 6 to remove and 6 not upgraded.</span><br><span class="line">After this operation, 33.6 MB disk space will be freed.</span><br><span class="line">(Reading database ... 7962 files and directories currently installed.)</span><br><span class="line">Removing ca-certificates (20141019+deb8u4) ...</span><br><span class="line">Removing dangling symlinks from /etc/ssl/certs... done.</span><br><span class="line">Removing libpsl0:amd64 (0.5.1-1) ...</span><br><span class="line">Removing libicu52:amd64 (52.1-8+deb8u7) ...</span><br><span class="line">Removing libidn11:amd64 (1.29-1+deb8u3) ...</span><br><span class="line">Removing openssl (1.0.1t-1+deb8u11) ...</span><br><span class="line">Removing libssl1.0.0:amd64 (1.0.1t-1+deb8u11) ...</span><br><span class="line">Processing triggers for libc-bin (2.19-18+deb8u10) ...</span><br><span class="line">+ apt-get clean</span><br><span class="line">+ rm -rf /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_Release.gpg /var/lib/apt/lists/deb.debian.org_debian_dists_jessie_main_binary-amd64_Packages.gz /var/lib/apt/lists/lock /var/lib/apt/lists/partial /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_InRelease /var/lib/apt/lists/security.debian.org_debian-security_dists_jessie_updates_main_binary-amd64_Packages.gz /tmp/* /var/tmp/*</span><br><span class="line"> ---&gt; a78678659f2c</span><br><span class="line">Removing intermediate container 2cfff130c15c</span><br><span class="line">Step 4 : COPY docker-entrypoint.sh /</span><br><span class="line"> ---&gt; 62dc7fe5a98f</span><br><span class="line">Removing intermediate container 87e271482593</span><br><span class="line">Step 5 : ENTRYPOINT /docker-entrypoint.sh</span><br><span class="line"> ---&gt; Running in d367b6e3bb5a</span><br><span class="line"> ---&gt; 23c8fbdc088a</span><br><span class="line">Removing intermediate container d367b6e3bb5a</span><br><span class="line">Successfully built 23c8fbdc088a</span><br><span class="line">[root@hdss7-200 filebeat]# docker tag 23c8fbdc088a harbor.od.com/infra/filebeat:v7.2.0</span><br><span class="line">[root@hdss7-200 filebeat]# docker push !$</span><br><span class="line">docker push harbor.od.com/infra/filebeat:v7.2.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/filebeat]</span><br><span class="line">6a765e653161: Pushed </span><br><span class="line">8e89ae5c6fc2: Pushed </span><br><span class="line">9abb3997a540: Pushed </span><br><span class="line">v7.2.0: digest: sha256:c35d7cdba29d8555388ad41ac2fc1b063ed9ec488082e33b5d0e91864b3bb35c size: 948</span><br></pre></td></tr></table></figure>

<h3 id="修改资源配置清单"><a href="#修改资源配置清单" class="headerlink" title="修改资源配置清单"></a>修改资源配置清单</h3><p><strong>使用dubbo-demo-consumer的Tomcat版镜像</strong></p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml/dubbo-demo-consumer/deployment.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: test</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-web:tomcat</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=fat -Dapollo.meta=http://config.od.com</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /opt/tomcat/logs</span><br><span class="line">          name: logm</span><br><span class="line">      - name: filebeat</span><br><span class="line">        image: harbor.od.com/infra/filebeat:v7.2.0</span><br><span class="line">        env:</span><br><span class="line">        - name: ENV</span><br><span class="line">          value: test</span><br><span class="line">        - name: PROJ_NAME</span><br><span class="line">          value: dubbo-demo-web</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /logm</span><br><span class="line">          name: logm</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: logm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问http-km-od-com"><a href="#浏览器访问http-km-od-com" class="headerlink" title="浏览器访问http://km.od.com"></a>浏览器访问<a href="http://km.od.com" target="_blank" rel="noopener">http://km.od.com</a></h3><p>看到kafaka-manager里，topic打进来，即为成功。<br><img src="/images/kafka-topic.png" alt="kafka-topic" title="kafka-topic"></p>
<h3 id="验证数据"><a href="#验证数据" class="headerlink" title="验证数据"></a>验证数据</h3><figure class="highlight plain"><figcaption><span>/opt/kafka/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kafka-console-consumer.sh --bootstrap-server 10.4.7.11:9092 --topic k8s-fb-test-logm-dubbo-demo-web --from-beginning</span><br></pre></td></tr></table></figure>

<h2 id="部署logstash"><a href="#部署logstash" class="headerlink" title="部署logstash"></a>部署logstash</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="选版本"><a href="#选版本" class="headerlink" title="选版本"></a>选版本</h3><p><a href="https://www.elastic.co/support/matrix" target="_blank" rel="noopener">logstash选型</a><br><img src="/images/es-logstash.png" alt="compatibility" title="compatibility"></p>
<h3 id="准备docker镜像"><a href="#准备docker镜像" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><ul>
<li>下载官方镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull logstash:6.7.2</span><br><span class="line">6.7.2: Pulling from library/logstash</span><br><span class="line">8ba884070f61: Pull complete </span><br><span class="line">063405b57b96: Pull complete </span><br><span class="line">0a0115b8825c: Pull complete </span><br><span class="line">825b124900cb: Pull complete </span><br><span class="line">ed736d9e3c41: Pull complete </span><br><span class="line">6efb3934697a: Pull complete </span><br><span class="line">c0a3a0c8ebc2: Pull complete </span><br><span class="line">f55d8adfbc3d: Pull complete </span><br><span class="line">3a6c56fbbef8: Pull complete </span><br><span class="line">ca45dc8946a2: Pull complete </span><br><span class="line">8b852a079ea9: Pull complete </span><br><span class="line">Digest: sha256:46eaff19af5e14edd9b78e1d5bf16f6abcd9ad50e0338cbaf3024f2aadb2903b</span><br><span class="line">Status: Downloaded newer image for logstash:6.7.2</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker tag 857d9a1f8221 harbor.od.com/public/logstash:v6.7.2</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">docker push harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">The push refers to a repository [harbor.od.com/public/logstash]</span><br><span class="line">c2b00f70cade: Mounted from public/filebeat </span><br><span class="line">9a2c2851596d: Mounted from public/filebeat </span><br><span class="line">86564f3ca0e2: Mounted from public/filebeat </span><br><span class="line">e9bc8faf823a: Mounted from public/filebeat </span><br><span class="line">3f3bcfa85067: Mounted from public/filebeat </span><br><span class="line">65d3b56913bd: Mounted from public/filebeat </span><br><span class="line">9b48a60607ee: Mounted from public/filebeat </span><br><span class="line">df859db41dd0: Mounted from public/filebeat </span><br><span class="line">1cbe912d7c00: Mounted from public/filebeat </span><br><span class="line">ab5fbaca7e70: Mounted from public/filebeat </span><br><span class="line">d69483a6face: Mounted from public/filebeat </span><br><span class="line">v6.7.2: digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81 size: 2823</span><br></pre></td></tr></table></figure>

<ul>
<li>自定义Dockerfile</li>
</ul>
<div class="tabs" id="logstash"><ul class="nav-tabs"><li class="tab active"><a href="#logstash-1">Dockerfile</a></li><li class="tab"><a href="#logstash-2">logstash.yml</a></li></ul><div class="tab-content"><div class="tab-pane active" id="logstash-1"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">From harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">ADD logstash.yml /usr/share/logstash/config</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="logstash-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.host: &quot;0.0.0.0&quot;</span><br><span class="line">path.config: /etc/logstash</span><br><span class="line">xpack.monitoring.enabled: false</span><br></pre></td></tr></table></figure></div></div></div>

<ul>
<li>创建自定义镜像</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/logstash</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 logstash]# docker build . -t harbor.od.com/infra/logstash:v6.7.2</span><br><span class="line">Sending build context to Docker daemon 249.3 MB</span><br><span class="line">Step 1 : FROM harbor.od.com/public/logstash:v6.7.2</span><br><span class="line">v6.7.2: Pulling from public/logstash</span><br><span class="line">e60be144a6a5: Pull complete </span><br><span class="line">6292c2b22d35: Pull complete </span><br><span class="line">1bb4586d90e7: Pull complete </span><br><span class="line">3f11f6d21132: Pull complete </span><br><span class="line">f0aaeeafebd3: Pull complete </span><br><span class="line">38c751a91f0f: Pull complete </span><br><span class="line">b80e2bad9681: Pull complete </span><br><span class="line">e3c97754ddde: Pull complete </span><br><span class="line">840f2d82a9fb: Pull complete </span><br><span class="line">32063a9aaefb: Pull complete </span><br><span class="line">e87b22bf50f5: Pull complete </span><br><span class="line">Digest: sha256:6aacf97dfbcc5c64c2f1a12f43ee48a8dadb98657b9b8d4149d0fee0ec18be81</span><br><span class="line">Status: Downloaded newer image for harbor.od.com/public/logstash:v6.7.2</span><br><span class="line"> ---&gt; 857d9a1f8221</span><br><span class="line">Step 2 : ADD logstash.yml /usr/share/logstash/config</span><br><span class="line"> ---&gt; 2ad32d3f5fef</span><br><span class="line">Removing intermediate container 1d3a1488c1b7</span><br><span class="line">Successfully built 2ad32d3f5fef</span><br><span class="line">[root@hdss7-200 logstash]# docker push harbor.od.com/infra/logstash:v6.7.2</span><br></pre></td></tr></table></figure>

<h3 id="启动docker镜像"><a href="#启动docker镜像" class="headerlink" title="启动docker镜像"></a>启动docker镜像</h3><ul>
<li>创建配置</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/logstash/logstash-test.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; &quot;10.4.7.11:9092&quot;</span><br><span class="line">    client_id =&gt; &quot;10.4.7.200&quot;</span><br><span class="line">    consumer_threads =&gt; 4</span><br><span class="line">    group_id =&gt; &quot;k8s_test&quot;</span><br><span class="line">    topics_pattern =&gt; &quot;k8s-fb-test-.*&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">  json &#123;</span><br><span class="line">    source =&gt; &quot;message&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [&quot;10.4.7.12:9200&quot;]</span><br><span class="line">    index =&gt; &quot;k8s-test-%&#123;+YYYY.MM&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动logstash镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker run -d --name logstash-test -v /etc/logstash:/etc/logstash harbor.od.com/infra/logstash:v6.7.2 -f /etc/logstash/logstash-test.conf</span><br><span class="line">[root@hdss7-200 ~]# docker ps -a|grep logstash</span><br><span class="line">a5dcf56faa9a        harbor.od.com/infra/logstash:v6.7.2                                                                                &quot;/usr/local/bin/docke&quot;   8 seconds ago       Up 6 seconds                5044/tcp, 9600/tcp           jovial_swanson</span><br></pre></td></tr></table></figure>

<ul>
<li>验证ElasticSearch里的索引</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl http://10.4.7.12:9200/_cat/indices?v</span><br><span class="line">health status index            uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   k8s-test-2019.04 H3MY9d8WSbqQ6uL0DFhenQ   5   0         55            0    249.9kb        249.9kb</span><br></pre></td></tr></table></figure>

<h2 id="部署Kibana"><a href="#部署Kibana" class="headerlink" title="部署Kibana"></a>部署Kibana</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="准备docker镜像-1"><a href="#准备docker镜像-1" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><p><a href="https://hub.docker.com/_/kibana?tab=tags" target="_blank" rel="noopener">kibana官方镜像下载地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull kibana:6.8.1</span><br><span class="line">6.8.1: Pulling from library/kibana</span><br><span class="line"></span><br><span class="line">8014725ed6f5: Pull complete </span><br><span class="line">19b590251e94: Pull complete </span><br><span class="line">7fa3e54c0b5a: Pull complete </span><br><span class="line">60ee9811b356: Pull complete </span><br><span class="line">d18bafa420f4: Pull complete </span><br><span class="line">8cee55751899: Pull complete </span><br><span class="line">c395be470eb2: Pull complete </span><br><span class="line">Digest: sha256:71f776596244877597fd679b2fa6fb0f1fa9c5b11388199997781d1ce77b73b1</span><br><span class="line">Status: Downloaded newer image for kibana:6.8.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag 62079cf74c23 harbor.od.com/infra/kibana:v6.8.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/infra/kibana:v6.8.1</span><br><span class="line">docker push harbor.od.com/infra/kibana:v6.8.1</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/kibana]</span><br><span class="line">be94745c5390: Pushed </span><br><span class="line">652dcbd52cdd: Pushed </span><br><span class="line">a3508a095ca7: Pushed </span><br><span class="line">56d52080e2fe: Pushed </span><br><span class="line">dbce28d91bf0: Pushed </span><br><span class="line">dcddc432ebdf: Pushed </span><br><span class="line">3e466685bf43: Pushed </span><br><span class="line">d69483a6face: Mounted from infra/logstash </span><br><span class="line">v6.8.1: digest: sha256:17dd243d6cc4e572f74f3de83eafc981e54c1710f8fe2d0bf74357b28bddaf08 size: 1991</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-4"><a href="#解析域名-4" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kibana	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-7"><a href="#准备资源配置清单-7" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="kibana"><ul class="nav-tabs"><li class="tab active"><a href="#kibana-1">Deployment</a></li><li class="tab"><a href="#kibana-2">Service</a></li><li class="tab"><a href="#kibana-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="kibana-1"><p>vi /data/k8s-yaml/kibana/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: kibana</span><br><span class="line">        name: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: harbor.od.com/infra/kibana:v6.8.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: ELASTICSEARCH_URL</span><br><span class="line">          value: http://10.4.7.12:9200</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kibana-2"><p>vi /data/k8s-yaml/kibana/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 5601</span><br><span class="line">    targetPort: 5601</span><br><span class="line">  selector: </span><br><span class="line">    app: kibana</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="kibana-3"><p>vi /data/k8s-yaml/kibana/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: kibana.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: kibana</span><br><span class="line">          servicePort: 5601</span><br></pre></td></tr></table></figure></div></div></div>
<h3 id="应用资源配置清单-8"><a href="#应用资源配置清单-8" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f deployment.yaml </span><br><span class="line">deployment.extensions/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f svc.yaml </span><br><span class="line">service/kibana created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f ingress.yaml </span><br><span class="line">ingress.extensions/kibana created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-5"><a href="#浏览器访问-5" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://kibana.od.com" target="_blank" rel="noopener">http://kibana.od.com</a><br><img src="/images/kibana.png" alt="kibana页面" title="kibana页面"></p>
<h2 id="kibana的使用"><a href="#kibana的使用" class="headerlink" title="kibana的使用"></a>kibana的使用</h2><p><img src="/images/kibana-usage.png" alt="kibana用法" title="kibana用法"></p>
<h3 id="选择区域"><a href="#选择区域" class="headerlink" title="选择区域"></a>选择区域</h3><ul>
<li><p>@timestamp</p>
<blockquote>
<p>对应日志的时间戳</p>
</blockquote>
</li>
<li><p>log.file.path</p>
<blockquote>
<p>对应日志文件名</p>
</blockquote>
</li>
<li><p>message</p>
<blockquote>
<p>对应日志内容</p>
</blockquote>
</li>
</ul>
<h3 id="时间选择器"><a href="#时间选择器" class="headerlink" title="时间选择器"></a>时间选择器</h3><ul>
<li>选择日志时间<blockquote>
<p>快速时间<br>绝对时间<br>相对时间</p>
</blockquote>
</li>
</ul>
<h3 id="环境选择器"><a href="#环境选择器" class="headerlink" title="环境选择器"></a>环境选择器</h3><ul>
<li>选择对应环境的日志<blockquote>
<p>k8s-test-*<br>k8s-prod-*</p>
</blockquote>
</li>
</ul>
<h3 id="项目选择器"><a href="#项目选择器" class="headerlink" title="项目选择器"></a>项目选择器</h3><ul>
<li>对应filebeat的PROJ_NAME值</li>
<li>Add a fillter</li>
<li>topic is ${PROJ_NAME}<blockquote>
<p>dubbo-demo-service<br>dubbo-demo-web</p>
</blockquote>
</li>
</ul>
<h3 id="关键字选择器"><a href="#关键字选择器" class="headerlink" title="关键字选择器"></a>关键字选择器</h3><ul>
<li>exception</li>
<li>error</li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Stanley Wang 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.2yuan.png" alt="Stanley Wang 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/18/实验文档5：企业级Kubernetes容器云自动化运维平台/" rel="next" title="实验文档5：企业级kubernetes容器云自动化运维平台">
                <i class="fa fa-chevron-left"></i> 实验文档5：企业级kubernetes容器云自动化运维平台
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/18/实验文档3：在kubernetes集群里集成Apollo配置中心/" rel="prev" title="实验文档3：在kubernetes集群里集成Apollo配置中心">
                实验文档3：在kubernetes集群里集成Apollo配置中心 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Stanley Wang">
            
              <p class="site-author-name" itemprop="name">Stanley Wang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/stanleywang" title="GitHub &rarr; https://gitee.com/stanleywang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:stanley.wang.m@qq.com" title="E-Mail &rarr; mailto:stanley.wang.m@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#改造dubbo-demo-web项目为Tomcat启动项目"><span class="nav-number">1.</span> <span class="nav-text">改造dubbo-demo-web项目为Tomcat启动项目</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#准备Tomcat的镜像底包"><span class="nav-number">1.1.</span> <span class="nav-text">准备Tomcat的镜像底包</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备tomcat二进制包"><span class="nav-number">1.1.1.</span> <span class="nav-text">准备tomcat二进制包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单配置tomcat"><span class="nav-number">1.1.2.</span> <span class="nav-text">简单配置tomcat</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备Dockerfile"><span class="nav-number">1.1.3.</span> <span class="nav-text">准备Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#制作镜像并推送"><span class="nav-number">1.1.4.</span> <span class="nav-text">制作镜像并推送</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#改造dubbo-demo-web项目"><span class="nav-number">1.2.</span> <span class="nav-text">改造dubbo-demo-web项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改dubbo-client-pom-xml"><span class="nav-number">1.2.1.</span> <span class="nav-text">修改dubbo-client/pom.xml</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改Application-java"><span class="nav-number">1.2.2.</span> <span class="nav-text">修改Application.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建ServletInitializer-java"><span class="nav-number">1.2.3.</span> <span class="nav-text">创建ServletInitializer.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#新建Jenkins的pipeline"><span class="nav-number">1.3.</span> <span class="nav-text">新建Jenkins的pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置New-job"><span class="nav-number">1.3.1.</span> <span class="nav-text">配置New job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pipeline-Script"><span class="nav-number">1.3.2.</span> <span class="nav-text">Pipeline Script</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#构建应用镜像"><span class="nav-number">1.4.</span> <span class="nav-text">构建应用镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备k8s的资源配置清单"><span class="nav-number">1.5.</span> <span class="nav-text">准备k8s的资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用资源配置清单"><span class="nav-number">1.6.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#浏览器访问"><span class="nav-number">1.7.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#检查tomcat运行情况"><span class="nav-number">1.8.</span> <span class="nav-text">检查tomcat运行情况</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用Prometheus和Grafana监控kubernetes集群"><span class="nav-number">2.</span> <span class="nav-text">使用Prometheus和Grafana监控kubernetes集群</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-state-metrics"><span class="nav-number">2.1.</span> <span class="nav-text">部署kube-state-metrics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备kube-state-metrics镜像"><span class="nav-number">2.1.1.</span> <span class="nav-text">准备kube-state-metrics镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单"><span class="nav-number">2.1.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-1"><span class="nav-number">2.1.3.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查启动情况"><span class="nav-number">2.1.4.</span> <span class="nav-text">检查启动情况</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署node-exporter"><span class="nav-number">2.2.</span> <span class="nav-text">部署node-exporter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备node-exporter镜像"><span class="nav-number">2.2.1.</span> <span class="nav-text">准备node-exporter镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-1"><span class="nav-number">2.2.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-2"><span class="nav-number">2.2.3.</span> <span class="nav-text">应用资源配置清单</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署cadvisor"><span class="nav-number">2.3.</span> <span class="nav-text">部署cadvisor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备cadvisor镜像"><span class="nav-number">2.3.1.</span> <span class="nav-text">准备cadvisor镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-2"><span class="nav-number">2.3.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改运算节点软连接"><span class="nav-number">2.3.3.</span> <span class="nav-text">修改运算节点软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-3"><span class="nav-number">2.3.4.</span> <span class="nav-text">应用资源配置清单</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署blackbox-exporter"><span class="nav-number">2.4.</span> <span class="nav-text">部署blackbox-exporter</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备blackbox-exporter镜像"><span class="nav-number">2.4.1.</span> <span class="nav-text">准备blackbox-exporter镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-3"><span class="nav-number">2.4.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名"><span class="nav-number">2.4.3.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-4"><span class="nav-number">2.4.4.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-1"><span class="nav-number">2.4.5.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署prometheus"><span class="nav-number">2.5.</span> <span class="nav-text">部署prometheus</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备prometheus镜像"><span class="nav-number">2.5.1.</span> <span class="nav-text">准备prometheus镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-4"><span class="nav-number">2.5.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备prometheus的配置文件"><span class="nav-number">2.5.3.</span> <span class="nav-text">准备prometheus的配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-5"><span class="nav-number">2.5.4.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名-1"><span class="nav-number">2.5.5.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-2"><span class="nav-number">2.5.6.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Prometheus监控内容"><span class="nav-number">2.5.7.</span> <span class="nav-text">Prometheus监控内容</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#etcd"><span class="nav-number">2.5.7.1.</span> <span class="nav-text">etcd</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-apiserver"><span class="nav-number">2.5.7.2.</span> <span class="nav-text">kubernetes-apiserver</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-kubelet"><span class="nav-number">2.5.7.3.</span> <span class="nav-text">kubernetes-kubelet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-kube-state"><span class="nav-number">2.5.7.4.</span> <span class="nav-text">kubernetes-kube-state</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#traefik"><span class="nav-number">2.5.7.5.</span> <span class="nav-text">traefik</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#blackbox"><span class="nav-number">2.5.7.6.</span> <span class="nav-text">blackbox*</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#kubernetes-pods"><span class="nav-number">2.5.7.7.</span> <span class="nav-text">kubernetes-pods*</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改traefik服务接入prometheus监控"><span class="nav-number">2.5.8.</span> <span class="nav-text">修改traefik服务接入prometheus监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改dubbo-service服务接入prometheus监控"><span class="nav-number">2.5.9.</span> <span class="nav-text">修改dubbo-service服务接入prometheus监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改dubbo-consumer服务接入prometheus监控"><span class="nav-number">2.5.10.</span> <span class="nav-text">修改dubbo-consumer服务接入prometheus监控</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Grafana"><span class="nav-number">2.6.</span> <span class="nav-text">部署Grafana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备grafana镜像"><span class="nav-number">2.6.1.</span> <span class="nav-text">准备grafana镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-5"><span class="nav-number">2.6.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-6"><span class="nav-number">2.6.3.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名-2"><span class="nav-number">2.6.4.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-3"><span class="nav-number">2.6.5.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置grafana页面"><span class="nav-number">2.6.6.</span> <span class="nav-text">配置grafana页面</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#外观"><span class="nav-number">2.6.6.1.</span> <span class="nav-text">外观</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#插件"><span class="nav-number">2.6.6.2.</span> <span class="nav-text">插件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置grafana数据源"><span class="nav-number">2.6.7.</span> <span class="nav-text">配置grafana数据源</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置Kubernetes集群Dashboard"><span class="nav-number">2.6.8.</span> <span class="nav-text">配置Kubernetes集群Dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置自定义dashboard"><span class="nav-number">2.6.9.</span> <span class="nav-text">配置自定义dashboard</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用ELK-Stack收集kubernetes集群内的应用日志"><span class="nav-number">3.</span> <span class="nav-text">使用ELK Stack收集kubernetes集群内的应用日志</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署ElasticSearch"><span class="nav-number">3.1.</span> <span class="nav-text">部署ElasticSearch</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">3.1.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">3.1.2.</span> <span class="nav-text">配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#elasticsearch-yml"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">elasticsearch.yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jvm-options"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">jvm.options</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建普通用户"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">创建普通用户</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#文件描述符"><span class="nav-number">3.1.2.4.</span> <span class="nav-text">文件描述符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调整内核参数"><span class="nav-number">3.1.2.5.</span> <span class="nav-text">调整内核参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">3.1.3.</span> <span class="nav-text">启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整ES日志模板"><span class="nav-number">3.1.4.</span> <span class="nav-text">调整ES日志模板</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kafka"><span class="nav-number">3.2.</span> <span class="nav-text">部署kafka</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kafka-manager"><span class="nav-number">3.3.</span> <span class="nav-text">部署kafka-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方法一：1、准备Dockerfile"><span class="nav-number">3.3.1.</span> <span class="nav-text">方法一：1、准备Dockerfile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法一：2、制作docker镜像"><span class="nav-number">3.3.2.</span> <span class="nav-text">方法一：2、制作docker镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法二：直接下载docker镜像"><span class="nav-number">3.3.3.</span> <span class="nav-text">方法二：直接下载docker镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-6"><span class="nav-number">3.3.4.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-7"><span class="nav-number">3.3.5.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名-3"><span class="nav-number">3.3.6.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-4"><span class="nav-number">3.3.7.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署filebeat"><span class="nav-number">3.4.</span> <span class="nav-text">部署filebeat</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#制作docker镜像"><span class="nav-number">3.4.1.</span> <span class="nav-text">制作docker镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#准备Dockerfile-1"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">准备Dockerfile</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#制作镜像"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">制作镜像</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改资源配置清单"><span class="nav-number">3.4.2.</span> <span class="nav-text">修改资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问http-km-od-com"><span class="nav-number">3.4.3.</span> <span class="nav-text">浏览器访问http://km.od.com</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证数据"><span class="nav-number">3.4.4.</span> <span class="nav-text">验证数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署logstash"><span class="nav-number">3.5.</span> <span class="nav-text">部署logstash</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选版本"><span class="nav-number">3.5.1.</span> <span class="nav-text">选版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备docker镜像"><span class="nav-number">3.5.2.</span> <span class="nav-text">准备docker镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动docker镜像"><span class="nav-number">3.5.3.</span> <span class="nav-text">启动docker镜像</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署Kibana"><span class="nav-number">3.6.</span> <span class="nav-text">部署Kibana</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备docker镜像-1"><span class="nav-number">3.6.1.</span> <span class="nav-text">准备docker镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名-4"><span class="nav-number">3.6.2.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-7"><span class="nav-number">3.6.3.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单-8"><span class="nav-number">3.6.4.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-5"><span class="nav-number">3.6.5.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kibana的使用"><span class="nav-number">3.7.</span> <span class="nav-text">kibana的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选择区域"><span class="nav-number">3.7.1.</span> <span class="nav-text">选择区域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间选择器"><span class="nav-number">3.7.2.</span> <span class="nav-text">时间选择器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境选择器"><span class="nav-number">3.7.3.</span> <span class="nav-text">环境选择器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#项目选择器"><span class="nav-number">3.7.4.</span> <span class="nav-text">项目选择器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关键字选择器"><span class="nav-number">3.7.5.</span> <span class="nav-text">关键字选择器</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stanley Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">890k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">13:29</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
