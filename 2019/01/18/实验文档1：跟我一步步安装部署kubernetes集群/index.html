<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验环境基础架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com">
<meta property="og:type" content="article">
<meta property="og:title" content="实验文档1：跟我一步步安装部署kubernetes集群">
<meta property="og:url" content="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档1：跟我一步步安装部署kubernetes集群/index.html">
<meta property="og:site_name" content="Stanley&#39;s Blog">
<meta property="og:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验环境基础架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://stanleywang-github.github.io/images/heapster.png">
<meta property="og:updated_time" content="2020-09-03T08:33:09.893Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实验文档1：跟我一步步安装部署kubernetes集群">
<meta name="twitter:description" content="欢迎加入王导的VIP学习qq群：==&amp;gt;932194668&amp;lt;==   实验环境基础架构   主机名 角色 ip    HDSS7-11.host.com k8s代理节点1 10.4.7.11   HDSS7-12.host.com k8s代理节点2 10.4.7.12   HDSS7-21.host.com k8s运算节点1 10.4.7.21   HDSS7-22.host.com">
<meta name="twitter:image" content="https://stanleywang-github.github.io/images/heapster.png">






  <link rel="canonical" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档1：跟我一步步安装部署kubernetes集群/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>实验文档1：跟我一步步安装部署kubernetes集群 | Stanley's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stanley's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档1：跟我一步步安装部署kubernetes集群/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">实验文档1：跟我一步步安装部署kubernetes集群

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-18 22:12:56" itemprop="dateCreated datePublished" datetime="2019-01-18T22:12:56+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes容器云技术专题/" itemprop="url" rel="index"><span itemprop="name">Kubernetes容器云技术专题</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">89k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:21</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><h2 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>k8s代理节点1</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>k8s代理节点2</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>k8s运算节点1</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>k8s运算节点2</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>k8s运维节点(docker仓库)</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h2 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h2><ul>
<li>5台vm，每台至少2c2g</li>
</ul>
<h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><ul>
<li>OS: CentOS Linux release 7.6.1810 (Core)</li>
<li>docker: v1.12.6<blockquote>
<p><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">docker引擎官方下载地址</a><br><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">docker引擎官方selinux包</a></p>
</blockquote>
</li>
<li>kubernetes: v1.13.2<blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener">kubernetes官方下载地址</a></p>
</blockquote>
</li>
<li>etcd: v3.1.18<blockquote>
<p><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">etcd官方下载地址</a></p>
</blockquote>
</li>
<li>flannel: v0.10.0<blockquote>
<p><a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">flannel官方下载地址</a></p>
</blockquote>
</li>
<li>bind9: v9.9.4<blockquote>
<p><a href="https://www.isc.org/downloads/#" target="_blank" rel="noopener">bind9官方下载地址</a></p>
</blockquote>
</li>
<li>harbor: v1.7.1<blockquote>
<p><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">harbor官方下载地址</a></p>
</blockquote>
</li>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssljson下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
<li>其他<blockquote>
<p>其他可能用到的软件，均使用操作系统自带的yum源和epel源进行安装</p>
</blockquote>
</li>
</ul>
<h1 id="前置准备工作"><a href="#前置准备工作" class="headerlink" title="前置准备工作"></a>前置准备工作</h1><h2 id="DNS服务安装部署"><a href="#DNS服务安装部署" class="headerlink" title="DNS服务安装部署"></a>DNS服务安装部署</h2><ul>
<li>创建主机域host.com</li>
<li>创建业务域od.com</li>
<li>主辅同步(10.4.7.11主、10.4.7.12辅)</li>
<li>客户端配置指向自建DNS</li>
</ul>
<p>略</p>
<h2 id="准备签发证书环境"><a href="#准备签发证书环境" class="headerlink" title="准备签发证书环境"></a>准备签发证书环境</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="安装CFSSL"><a href="#安装CFSSL" class="headerlink" title="安装CFSSL"></a>安装CFSSL</h3><ul>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssljson下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure>

<h3 id="创建生成CA证书的JSON配置文件"><a href="#创建生成CA证书的JSON配置文件" class="headerlink" title="创建生成CA证书的JSON配置文件"></a>创建生成CA证书的JSON配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>证书类型<br>client certificate： 客户端使用，用于服务端认证客户端,例如etcdctl、etcd proxy、fleetctl、docker客户端<br>server certificate: 服务端使用，客户端以此验证服务端身份,例如docker服务端、kube-apiserver<br>peer certificate: 双向证书，用于etcd集群成员间通信</p>
</blockquote>
<h3 id="创建生成CA证书签名请求（csr）的JSON配置文件"><a href="#创建生成CA证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成CA证书签名请求（csr）的JSON配置文件"></a>创建生成CA证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes-ca&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法<br>C: Country， 国家<br>ST: State，州，省<br>L: Locality，地区，城市<br>O: Organization Name，组织名称，公司名称<br>OU: Organization Unit Name，组织单位名称，公司部门</p>
</blockquote>
<h3 id="生成CA证书和私钥"><a href="#生成CA证书和私钥" class="headerlink" title="生成CA证书和私钥"></a>生成CA证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca - </span><br><span class="line">2019/01/18 09:31:19 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generate received request</span><br><span class="line">2019/01/18 09:31:19 [INFO] received CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 09:31:19 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] signed certificate with serial number 345276964513449660162382535043012874724976422200</span><br></pre></td></tr></table></figure>

<p>生成ca.pem、ca.csr、ca-key.pem(CA私钥,需妥善保管)</p>
<figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root  836 Jan 16 11:04 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  332 Jan 16 11:10 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 16 11:17 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1001 Jan 16 11:17 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 16 11:17 ca.pem</span><br></pre></td></tr></table></figure>

<h2 id="部署docker环境"><a href="#部署docker环境" class="headerlink" title="部署docker环境"></a>部署docker环境</h2><p><code>HDSS7-200.host.com</code>,<code>HDSS7-21.host.com</code>,<code>HDSS7-22.host.com</code>上：</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>docker: v1.12.6<blockquote>
<p><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">docker引擎官方下载地址</a><br><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">docker引擎官方selinux包</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ls -l|grep docker-engine</span><br><span class="line">-rw-r--r--  1 root root  20013304 Jan 16 18:16 docker-engine-1.12.6-1.el7.centos.x86_64.rpm</span><br><span class="line">-rw-r--r--  1 root root     29112 Jan 16 18:15 docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm</span><br><span class="line"># yum localinstall *.rpm</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/etc/docker/daemon.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.od.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里bip要根据宿主机ip变化</p>
<h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><figure class="highlight plain"><figcaption><span>/usr/lib/systemd/system/docker.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">#TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker.service</span><br><span class="line"># systemctl start docker.service</span><br></pre></td></tr></table></figure>

<h2 id="部署docker镜像私有仓库harbor"><a href="#部署docker镜像私有仓库harbor" class="headerlink" title="部署docker镜像私有仓库harbor"></a>部署docker镜像私有仓库harbor</h2><p><strong><code>HDSS7-200.host.com</code>上：</strong></p>
<h3 id="下载软件二进制包并解压"><a href="#下载软件二进制包并解压" class="headerlink" title="下载软件二进制包并解压"></a>下载软件二进制包并解压</h3><p><a href="https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz" target="_blank" rel="noopener">harbor下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# tar xf harbor-offline-installer-v1.7.1.tgz -C /opt</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# ll</span><br><span class="line">total 583848</span><br><span class="line">drwxr-xr-x 3 root root       242 Jan 23 15:28 harbor</span><br><span class="line">-rw-r--r-- 1 root root 597857483 Jan 17 14:58 harbor-offline-installer-v1.7.1.tgz</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/opt/harbor/harbor.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostname = harbor.od.com</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/opt/harbor/docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ports:</span><br><span class="line">  - 180:80</span><br><span class="line">  - 1443:443</span><br><span class="line">  - 4443:4443</span><br></pre></td></tr></table></figure>

<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install docker-compose -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line">docker-compose-1.18.0-2.el7.noarch</span><br></pre></td></tr></table></figure>

<h3 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h3><figure class="highlight plain"><figcaption><span>/opt/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# ./install.sh</span><br></pre></td></tr></table></figure>

<h3 id="检查harbor启动情况"><a href="#检查harbor启动情况" class="headerlink" title="检查harbor启动情况"></a>检查harbor启动情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker-compose ps</span><br><span class="line">       Name                     Command               State                                 Ports                               </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-core          /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      5432/tcp                                                          </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-log           /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp                                         </span><br><span class="line">harbor-portal        nginx -g daemon off;             Up      80/tcp                                                            </span><br><span class="line">nginx                nginx -g daemon off;             Up      0.0.0.0:1443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:180-&gt;80/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      6379/tcp                                                          </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      5000/tcp                                                          </span><br><span class="line">registryctl          /harbor/start.sh                 Up</span><br></pre></td></tr></table></figure>

<h3 id="配置harbor的dns内网解析"><a href="#配置harbor的dns内网解析" class="headerlink" title="配置harbor的dns内网解析"></a>配置harbor的dns内网解析</h3><figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">harbor	60 IN A 10.4.7.200</span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# dig -t A harbor.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h3 id="安装nginx并配置"><a href="#安装nginx并配置" class="headerlink" title="安装nginx并配置"></a>安装nginx并配置</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install nginx -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa nginx</span><br><span class="line">nginx-1.12.2-2.el7.x86_64</span><br></pre></td></tr></table></figure>

<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/harbor.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs/harbor.od.com.pem&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs/harbor.od.com-key.pem&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里需要自签ssl证书，自签过程略</p>
<blockquote>
<p>(umask 077; openssl genrsa -out od.key 2048)<br>openssl req -new -key od.key -out od.csr -subj “/CN=*.od.com/ST=Beijing/L=beijing/O=od/OU=ops”<br>openssl x509 -req -in od.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out od.crt -days 365</p>
</blockquote>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# nginx</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# netstat -luntp|grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6590/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      6590/nginx: master</span><br></pre></td></tr></table></figure>

<h3 id="浏览器打开http-harbor-od-com"><a href="#浏览器打开http-harbor-od-com" class="headerlink" title="浏览器打开http://harbor.od.com"></a>浏览器打开<a href="http://harbor.od.com" target="_blank" rel="noopener">http://harbor.od.com</a></h3><ul>
<li>用户名：admin</li>
<li>密码： Harbor12345</li>
</ul>
<h1 id="部署Master节点服务"><a href="#部署Master节点服务" class="headerlink" title="部署Master节点服务"></a>部署Master节点服务</h1><h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-12.host.com</td>
<td>etcd lead</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>etcd follow</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>etcd follow</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-12.host.com</code>主机为例，另外两台主机安装部署方法类似</p>
<h3 id="创建生成证书签名请求（csr）的JSON配置文件"><a href="#创建生成证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/certs/etcd-peer-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd-peer&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成etcd证书和私钥"><a href="#生成etcd证书和私钥" class="headerlink" title="生成etcd证书和私钥"></a>生成etcd证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer</span><br><span class="line">2019/01/18 09:35:09 [INFO] generate received request</span><br><span class="line">2019/01/18 09:35:09 [INFO] received CSR</span><br><span class="line">2019/01/18 09:35:09 [INFO] generating key: rsa-2048</span><br><span class="line"></span><br><span class="line">2019/01/18 09:35:09 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:35:10 [INFO] signed certificate with serial number 324191491384928915605254764031096067872154649010</span><br><span class="line">2019/01/18 09:35:10 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h3 id="检查生成的证书、私钥"><a href="#检查生成的证书、私钥" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep etcd</span><br><span class="line">-rw-r--r-- 1 root root  387 Jan 18 12:32 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 18 12:32 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jan 18 12:32 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root 1432 Jan 18 12:32 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd用户"><a href="#创建etcd用户" class="headerlink" title="创建etcd用户"></a>创建etcd用户</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# useradd -s /sbin/nologin -M etcd</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><a href="https://github.com/etcd-io/etcd/releases/download/v3.1.8/etcd-v3.1.8-linux-amd64.tar.gz" target="_blank" rel="noopener">etcd下载地址</a><br><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# ls -l</span><br><span class="line">total 9604</span><br><span class="line">-rw-r--r-- 1 root root 9831476 Jan 18 10:45 etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf etcd-v3.1.18-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/etcd-v3.1.18-linux-amd64 /opt/etcd</span><br><span class="line">[root@hdss7-12 src]# ls -l /opt</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root   root   24 Jan 18 14:21 etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">drwxr-xr-x 4 478493 89939 166 Jun 16  2018 etcd-v3.1.18-linux-amd64</span><br><span class="line">drwxr-xr-x 2 root   root   45 Jan 18 14:21 src</span><br></pre></td></tr></table></figure>

<h3 id="创建目录，拷贝证书、私钥"><a href="#创建目录，拷贝证书、私钥" class="headerlink" title="创建目录，拷贝证书、私钥"></a>创建目录，拷贝证书、私钥</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /data/etcd /data/logs/etcd-server </span><br><span class="line">[root@hdss7-12 src]# chown -R etcd.etcd /data/etcd /data/logs/etcd-server/</span><br><span class="line">[root@hdss7-12 src]# mkdir -p /opt/etcd/certs</span><br></pre></td></tr></table></figure>

<p>将运维主机上生成的<code>ca.pem</code>、<code>etcd-peer-key.pem</code>、<code>etcd-peer.pem</code>拷贝到<code>/opt/etcd/certs</code>目录中，注意私钥文件权限600</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod 600 etcd-peer-key.pem</span><br><span class="line">[root@hdss7-12 certs]# chown -R etcd.etcd /opt/etcd/certs/</span><br><span class="line">[root@hdss7-12 certs]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1354 Jan 18 14:45 ca.pem</span><br><span class="line">-rw------- 1 etcd etcd 1679 Jan 18 17:00 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1444 Jan 18 17:02 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd服务启动脚本"><a href="#创建etcd服务启动脚本" class="headerlink" title="创建etcd服务启动脚本"></a>创建etcd服务启动脚本</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd/etcd-server-startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir /data/etcd/etcd-server \</span><br><span class="line">       --listen-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \</span><br><span class="line">       --ca-file ./certs/ca.pem \</span><br><span class="line">       --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="调整权限和目录"><a href="#调整权限和目录" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod +x /opt/etcd/etcd-server-startup.sh</span><br><span class="line">[root@hdss7-12 certs]# mkdir -p /data/logs/etcd-server</span><br></pre></td></tr></table></figure>

<h3 id="安装supervisor软件"><a href="#安装supervisor软件" class="headerlink" title="安装supervisor软件"></a>安装supervisor软件</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# yum install supervisor -y</span><br><span class="line">[root@hdss7-12 certs]# systemctl start supervisord</span><br><span class="line">[root@hdss7-12 certs]# systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd-server的启动配置"><a href="#创建etcd-server的启动配置" class="headerlink" title="创建etcd-server的启动配置"></a>创建etcd-server的启动配置</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/etcd-server.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/etcd-server/etcd.stderr.log           ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                     ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改。</p>
<h3 id="启动etcd服务并检查"><a href="#启动etcd服务并检查" class="headerlink" title="启动etcd服务并检查"></a>启动etcd服务并检查</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# supervisorctl start all</span><br><span class="line">etcd-server-7-12: started</span><br><span class="line">[root@hdss7-12 certs]# supervisorctl status   </span><br><span class="line">etcd-server-7-12                 RUNNING   pid 6692, uptime 0:00:05</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的etcd服务"><a href="#安装部署启动检查所有集群规划主机上的etcd服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的etcd服务"></a>安装部署启动检查所有集群规划主机上的etcd服务</h3><p>略</p>
<h3 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h3><p>3台均启动后，检查集群状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl cluster-health</span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl member list</span><br><span class="line">988139385f78284: name=etcd-server-7-22 peerURLs=https://10.4.7.22:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.22:2379 isLeader=false</span><br><span class="line">5a0ef2a004fc4349: name=etcd-server-7-21 peerURLs=https://10.4.7.21:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.21:2379 isLeader=false</span><br><span class="line">f4a0cb0a765574a8: name=etcd-server-7-12 peerURLs=https://10.4.7.12:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.12:2379 isLeader=true</span><br></pre></td></tr></table></figure>

<h2 id="部署kube-apiserver集群"><a href="#部署kube-apiserver集群" class="headerlink" title="部署kube-apiserver集群"></a>部署kube-apiserver集群</h2><h3 id="集群规划-1"><a href="#集群规划-1" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-11.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td><strong>注意：</strong>这里<code>10.4.7.11</code>和<code>10.4.7.12</code>使用nginx做4层负载均衡器，用keepalived跑一个vip：10.4.7.10，代理两个kube-apiserver，实现高可用</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="下载软件，解压，做软连接-1"><a href="#下载软件，解压，做软连接-1" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code>上：<br><a href="https://dl.k8s.io/v1.13.5/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">kubernetes下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# ls -l|grep kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 16:46 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# tar xf kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-21 src]# mv /opt/kubernetes /opt/kubernetes-v1.13.2-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/kubernetes-v1.13.2-linux-amd64 /opt/kubernetes</span><br><span class="line">[root@hdss7-21 src]# mkdir /opt/kubernetes/server/bin/&#123;cert,conf&#125;</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep kubernetes</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 18 10:49 kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 17:40 kubernetes-v1.13.2-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="签发client证书"><a href="#签发client证书" class="headerlink" title="签发client证书"></a>签发client证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-1"><a href="#创建生成证书签名请求（csr）的JSON配置文件-1" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/client-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成client证书和私钥"><a href="#生成client证书和私钥" class="headerlink" title="生成client证书和私钥"></a>生成client证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssljson -bare client</span><br><span class="line">2019/01/18 14:02:50 [INFO] generate received request</span><br><span class="line">2019/01/18 14:02:50 [INFO] received CSR</span><br><span class="line">2019/01/18 14:02:50 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:02:51 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:02:51 [INFO] signed certificate with serial number 423108651040279300242366884100637974155370861448</span><br><span class="line">2019/01/18 14:02:51 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-1"><a href="#检查生成的证书、私钥-1" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep client</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 11:13 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  989 Jan 21 11:13 client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1367 Jan 21 11:13 client.pem</span><br></pre></td></tr></table></figure>

<h3 id="签发kube-apiserver证书"><a href="#签发kube-apiserver证书" class="headerlink" title="签发kube-apiserver证书"></a>签发kube-apiserver证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-2"><a href="#创建生成证书签名请求（csr）的JSON配置文件-2" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/apiserver-csr.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;,</span><br><span class="line">        &quot;10.4.7.23&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-apiserver证书和私钥"><a href="#生成kube-apiserver证书和私钥" class="headerlink" title="生成kube-apiserver证书和私钥"></a>生成kube-apiserver证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver </span><br><span class="line">2019/01/18 14:05:44 [INFO] generate received request</span><br><span class="line">2019/01/18 14:05:44 [INFO] received CSR</span><br><span class="line">2019/01/18 14:05:44 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:05:46 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:05:46 [INFO] signed certificate with serial number 633406650960616624590510576685608580490218676227</span><br><span class="line">2019/01/18 14:05:46 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-2"><a href="#检查生成的证书、私钥-2" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep apiserver</span><br><span class="line">total 72</span><br><span class="line">-rw-r--r-- 1 root root  406 Jan 21 14:10 apiserver-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 14:11 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1082 Jan 21 14:11 apiserver.csr</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 14:11 apiserver.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置"><a href="#拷贝证书至各运算节点，并创建配置" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600"><a href="#拷贝证书、私钥，注意私钥文件属性600" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h4><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/audit.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&apos;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&apos;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods/log&quot;, &quot;pods/status&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;/api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;/version&quot;</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>

<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-apiserver.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">./kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">  --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile ./cert/ca.pem \</span><br><span class="line">  --etcd-certfile ./cert/client.pem \</span><br><span class="line">  --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb=1024 \</span><br><span class="line">  --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">  --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">  --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">  --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">  --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整权限和目录-1"><a href="#调整权限和目录-1" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置"><a href="#创建supervisor配置" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-apiserver.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-apiserver]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stderr.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                     ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-apiserverr: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-apiserver"><a href="#安装部署启动检查所有集群规划主机上的kube-apiserver" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-apiserver"></a>安装部署启动检查所有集群规划主机上的kube-apiserver</h3><p>略</p>
<h3 id="配4层反向代理"><a href="#配4层反向代理" class="headerlink" title="配4层反向代理"></a>配4层反向代理</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h4><h5 id="check-port-sh"><a href="#check-port-sh" class="headerlink" title="check_port.sh"></a>check_port.sh</h5><figure class="highlight plain"><figcaption><span>/etc/keepalived/check_port.sh </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#&#125;</span><br><span class="line">CHK_PORT=$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS=`ss -lt|grep $CHK_PORT|wc -l`</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h5 id="keepalived主"><a href="#keepalived主" class="headerlink" title="keepalived主"></a>keepalived主</h5><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="keepalived备"><a href="#keepalived备" class="headerlink" title="keepalived备"></a>keepalived备</h5><p><code>HDSS7-12.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">	script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 251</span><br><span class="line">	mcast_src_ip 10.4.7.12</span><br><span class="line">	priority 90</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 11111111</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		chk_nginx</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.4.7.10</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动代理并检查"><a href="#启动代理并检查" class="headerlink" title="启动代理并检查"></a>启动代理并检查</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<ul>
<li><p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-11 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-12 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-12 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-12 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    inet 10.9.7.10/32 scope global vir0</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    （空）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="部署controller-manager"><a href="#部署controller-manager" class="headerlink" title="部署controller-manager"></a>部署controller-manager</h2><h3 id="集群规划-2"><a href="#集群规划-2" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>controller-manager</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-1"><a href="#创建启动脚本-1" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-controller-manager.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --root-ca-file ./cert/ca.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录"><a href="#调整文件权限，创建目录" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-1"><a href="#创建supervisor配置-1" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-conntroller-manager.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-controller-manager]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                                             ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controll.stdout.log  ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-controller-manager/controll.stderr.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                                          ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                                       ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-1"><a href="#启动服务并检查-1" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-controller-manager: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status   </span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"><a href="#安装部署启动检查所有集群规划主机上的kube-controller-manager服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"></a>安装部署启动检查所有集群规划主机上的kube-controller-manager服务</h3><p>略</p>
<h2 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h2><h3 id="集群规划-3"><a href="#集群规划-3" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-2"><a href="#创建启动脚本-2" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-scheduler.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录-1"><a href="#调整文件权限，创建目录-1" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-2"><a href="#创建supervisor配置-2" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-scheduler.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-scheduler]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                                    ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stderr.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                                 ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                              ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                              ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-2"><a href="#启动服务并检查-2" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-scheduler: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br><span class="line">kube-scheduler                   RUNNING   pid 44779, uptime 2:02:27</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-scheduler服务"><a href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-scheduler服务"></a>安装部署启动检查所有集群规划主机上的kube-scheduler服务</h3><p>略</p>
<h1 id="部署Node节点服务"><a href="#部署Node节点服务" class="headerlink" title="部署Node节点服务"></a>部署Node节点服务</h1><h2 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h2><h3 id="集群规划-4"><a href="#集群规划-4" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kubelet</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kubelet</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kubelet证书"><a href="#签发kubelet证书" class="headerlink" title="签发kubelet证书"></a>签发kubelet证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-3"><a href="#创建生成证书签名请求（csr）的JSON配置文件-3" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>kubelet-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubelet-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kubelet证书和私钥"><a href="#生成kubelet证书和私钥" class="headerlink" title="生成kubelet证书和私钥"></a>生成kubelet证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssljson -bare kubelet</span><br><span class="line">2019/01/18 17:51:16 [INFO] generate received request</span><br><span class="line">2019/01/18 17:51:16 [INFO] received CSR</span><br><span class="line">2019/01/18 17:51:16 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 17:51:17 [INFO] encoded CSR</span><br><span class="line">2019/01/18 17:51:17 [INFO] signed certificate with serial number 48870268157415133698067712395152321546974943470</span><br><span class="line">2019/01/18 17:51:17 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-3"><a href="#检查生成的证书、私钥-3" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kubelet</span><br><span class="line">total 88</span><br><span class="line">-rw-r--r-- 1 root root  415 Jan 22 16:58 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1086 Jan 22 17:00 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-1"><a href="#拷贝证书至各运算节点，并创建配置-1" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-1"><a href="#拷贝证书、私钥，注意私钥文件属性600-1" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-1"><a href="#创建配置-1" class="headerlink" title="创建配置"></a>创建配置</h4><p><code>HDSS7-21.host.com</code>上：</p>
<h5 id="给kubectl创建软连接"><a href="#给kubectl创建软连接" class="headerlink" title="给kubectl创建软连接"></a>给kubectl创建软连接</h5><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">/usr/bin/kubectl</span><br></pre></td></tr></table></figure>

<h5 id="set-cluster"><a href="#set-cluster" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials"><a href="#set-credentials" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials k8s-node --client-certificate=/opt/kubernetes/server/bin/cert/client.pem --client-key=/opt/kubernetes/server/bin/cert/client-key.pem --embed-certs=true --kubeconfig=kubelet.kubeconfig </span><br><span class="line"></span><br><span class="line">User &quot;k8s-node&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context"><a href="#set-context" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context"><a href="#use-context" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h5 id="k8s-node-yaml"><a href="#k8s-node-yaml" class="headerlink" title="k8s-node.yaml"></a>k8s-node.yaml</h5><ul>
<li>创建资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/k8s-node.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>

<ul>
<li>应用资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span><br></pre></td></tr></table></figure>

<ul>
<li>检查</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME           AGE</span><br><span class="line">k8s-node       3m</span><br></pre></td></tr></table></figure>

<h3 id="准备infra-pod基础镜像"><a href="#准备infra-pod基础镜像" class="headerlink" title="准备infra_pod基础镜像"></a>准备infra_pod基础镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull xplenty/rhel7-pod-infrastructure:v3.4</span><br><span class="line">Trying to pull repository docker.io/xplenty/rhel7-pod-infrastructure ... </span><br><span class="line">sha256:9314554780673b821cb7113d8c048a90d15077c6e7bfeebddb92a054a1f84843: Pulling from docker.io/xplenty/rhel7-pod-infrastructure</span><br><span class="line">615bc035f9f8: Pull complete </span><br><span class="line">1c5fd9dfeaa8: Pull complete </span><br><span class="line">7653a8c7f937: Pull complete </span><br><span class="line">Digest: sha256:9314554780673b821cb7113d8c048a90d15077c6e7bfeebddb92a054a1f84843</span><br><span class="line">Status: Downloaded newer image for docker.io/xplenty/rhel7-pod-infrastructure:v3.4</span><br></pre></td></tr></table></figure>

<h4 id="提交至私有仓库（harbor）中"><a href="#提交至私有仓库（harbor）中" class="headerlink" title="提交至私有仓库（harbor）中"></a>提交至私有仓库（harbor）中</h4><ul>
<li>配置主机登录私有仓库</li>
</ul>
<figure class="highlight plain"><figcaption><span>/root/.docker/config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;auths&quot;: &#123;</span><br><span class="line">		&quot;harbor.od.com&quot;: &#123;</span><br><span class="line">			&quot;auth&quot;: &quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里代表：用户名admin，密码Harbor12345<br>[root@hdss7-200 ~]# echo YWRtaW46SGFyYm9yMTIzNDU=|base64 -d<br>admin:Harbor12345</p>
</blockquote>
<p><strong>注意：</strong>也可以在各运算节点使用docker login harbor.od.com，输入用户名，密码</p>
<ul>
<li>给镜像打tag</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker images|grep v3.4</span><br><span class="line">xplenty/rhel7-pod-infrastructure   v3.4                34d3450d733b        2 years ago         205 MB</span><br><span class="line">[root@hdss7-200 ~]# docker tag 34d3450d733b harbor.od.com/k8s/pod:v3.4</span><br></pre></td></tr></table></figure>

<ul>
<li>push到harbor</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/pod:v3.4</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/pod]</span><br><span class="line">ba3d4cbbb261: Pushed </span><br><span class="line">0a081b45cb84: Pushed </span><br><span class="line">df9d2808b9a9: Pushed </span><br><span class="line">v3.4: digest: sha256:73cc48728e707b74f99d17b4e802d836e22d373aee901fdcaa781b056cdabf5c size: 948</span><br></pre></td></tr></table></figure>

<h3 id="创建kubelet启动脚本"><a href="#创建kubelet启动脚本" class="headerlink" title="创建kubelet启动脚本"></a>创建kubelet启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kubelet-721.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kubelet \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">  --fail-swap-on=&quot;false&quot; \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --tls-cert-file ./cert/kubelet.pem \</span><br><span class="line">  --tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">  --hostname-override 10.4.7.21 \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com/k8s/pod:v3.4 \</span><br><span class="line">  --root-dir /data/kubelet</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kubelet集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kubelet.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kubelet-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-3"><a href="#创建supervisor配置-3" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-kubelet.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-kubelet]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet-721.sh                 ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              									  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                  									  ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                									  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                 									  ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT               									  ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10               									  ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                             ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                       ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stderr.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                          ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB   									  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false   									  ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-3"><a href="#启动服务并检查-3" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-kubelet: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="检查运算节点"><a href="#检查运算节点" class="headerlink" title="检查运算节点"></a>检查运算节点</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get node</span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">10.4.7.21   Ready    &lt;none&gt;   3m   v1.13.2</span><br></pre></td></tr></table></figure>

<p><strong>非常重要！</strong></p>
<h3 id="安装部署启动检查所有集群规划主机上的kubelet服务"><a href="#安装部署启动检查所有集群规划主机上的kubelet服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kubelet服务"></a>安装部署启动检查所有集群规划主机上的kubelet服务</h3><p>略</p>
<h2 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h2><h3 id="集群规划-5"><a href="#集群规划-5" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kube-proxy证书"><a href="#签发kube-proxy证书" class="headerlink" title="签发kube-proxy证书"></a>签发kube-proxy证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-4"><a href="#创建生成证书签名请求（csr）的JSON配置文件-4" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/kube-proxy-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-proxy证书和私钥"><a href="#生成kube-proxy证书和私钥" class="headerlink" title="生成kube-proxy证书和私钥"></a>生成kube-proxy证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json | cfssljson -bare kube-proxy-client</span><br><span class="line">2019/01/18 18:14:23 [INFO] generate received request</span><br><span class="line">2019/01/18 18:14:23 [INFO] received CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 18:14:23 [INFO] encoded CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] signed certificate with serial number 375797145588654714099258750873820528127028390681</span><br><span class="line">2019/01/18 18:14:23 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-4"><a href="#检查生成的证书、私钥-4" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kube-proxy</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1005 Jan 22 17:31 kube-proxy-client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  268 Jan 22 17:23 kube-proxy-csr.json</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-2"><a href="#拷贝证书至各运算节点，并创建配置-2" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-2"><a href="#拷贝证书、私钥，注意私钥文件属性600-2" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1383</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-2"><a href="#创建配置-2" class="headerlink" title="创建配置"></a>创建配置</h4><h5 id="set-cluster-1"><a href="#set-cluster-1" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials-1"><a href="#set-credentials-1" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">User &quot;kube-proxy&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context-1"><a href="#set-context-1" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context-1"><a href="#use-context-1" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h3 id="创建kube-proxy启动脚本"><a href="#创建kube-proxy启动脚本" class="headerlink" title="创建kube-proxy启动脚本"></a>创建kube-proxy启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-proxy-721.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override 10.4.7.21 \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kube-proxy集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录-1"><a href="#检查配置，权限，创建日志目录-1" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kube-proxy.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kube-proxy-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-4"><a href="#创建supervisor配置-4" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-proxy.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-proxy]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy-721.sh                 ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                        ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                		         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           		 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    		 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        		 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     		 ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     		 ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-proxy/proxy.stderr.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    		 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        		 ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB   						                           ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false   						                           ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-4"><a href="#启动服务并检查-4" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-proxy: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     RUNNING   pid 14597, uptime 0:32:59</span><br><span class="line">kube-proxy                       STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-proxy服务"><a href="#安装部署启动检查所有集群规划主机上的kube-proxy服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-proxy服务"></a>安装部署启动检查所有集群规划主机上的kube-proxy服务</h3><p>略</p>
<h1 id="部署addons插件"><a href="#部署addons插件" class="headerlink" title="部署addons插件"></a>部署addons插件</h1><h2 id="验证kubernetes集群"><a href="#验证kubernetes集群" class="headerlink" title="验证kubernetes集群"></a>验证kubernetes集群</h2><h3 id="在任意一个运算节点，创建一个资源配置清单"><a href="#在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="在任意一个运算节点，创建一个资源配置清单"></a>在任意一个运算节点，创建一个资源配置清单</h3><p>这里我们选择<code>HDSS7-21.host.com</code>主机</p>
<figure class="highlight plain"><figcaption><span>/root/nginx-ds.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置，并检查"><a href="#应用资源配置，并检查" class="headerlink" title="应用资源配置，并检查"></a>应用资源配置，并检查</h3><figure class="highlight plain"><figcaption><span>/root</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create -f nginx-ds.yaml</span><br><span class="line">[root@hdss7-21 ~]# kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-6hnc7   1/1     Running   0          99m</span><br><span class="line">nginx-ds-m5q6j   1/1     Running   0          18h</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>补</p>
<h2 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h2><h3 id="集群规划-6"><a href="#集群规划-6" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>flannel</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>flannel</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="在各运算节点上增加iptables规则"><a href="#在各运算节点上增加iptables规则" class="headerlink" title="在各运算节点上增加iptables规则"></a>在各运算节点上增加iptables规则</h3><p><strong>注意：</strong>iptables规则各主机的略有不同，其他运算节点上执行时注意修改。</p>
<ul>
<li>优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line"># iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>10.4.7.21主机上的，来源是172.7.21.0/24段的docker的ip，目标ip不是172.7.0.0/16段，网络发包不从docker0桥设备出站的，才进行SNAT转换</p>
</blockquote>
<h3 id="各运算节点保存iptables规则"><a href="#各运算节点保存iptables规则" class="headerlink" title="各运算节点保存iptables规则"></a>各运算节点保存iptables规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接-2"><a href="#下载软件，解压，做软连接-2" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# ls -l|grep flannel</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 18:46 flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# mkdir -p /opt/flannel-v0.10.0-linux-amd64/cert</span><br><span class="line">[root@hdss7-21 src]# tar xf flannel-v0.10.0-linux-amd64.tar.gz -C /opt/flannel-v0.10.0-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/flannel-v0.10.0-linux-amd64 /opt/flannel</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep flannel</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 17 18:49 flannel -&gt; flannel-v0.10.0-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 18:47 flannel-v0.10.0-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="最终目录结构"><a href="#最终目录结构" class="headerlink" title="最终目录结构"></a>最终目录结构</h3><figure class="highlight plain"><figcaption><span>/opt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 opt]# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">|-- etcd-v3.1.18-linux-amd64</span><br><span class="line">|   |-- Documentation</span><br><span class="line">|   |-- README-etcdctl.md</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- READMEv2-etcdctl.md</span><br><span class="line">|   |-- certs</span><br><span class="line">|   |-- etcd</span><br><span class="line">|   |-- etcd-server-startup.sh</span><br><span class="line">|   `-- etcdctl</span><br><span class="line">|-- flannel -&gt; flannel-v0.10.0/</span><br><span class="line">|-- flannel-v0.10.0</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- cert</span><br><span class="line">|   |-- flanneld</span><br><span class="line">|   `-- mk-docker-opts.sh</span><br><span class="line">|-- kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">|-- kubernetes-v1.13.2-linux-amd64</span><br><span class="line">|   |-- LICENSES</span><br><span class="line">|   |-- addons</span><br><span class="line">|   `-- server</span><br><span class="line">`-- src</span><br><span class="line">    |-- etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">    |-- flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">    `-- kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="操作etcd，增加host-gw"><a href="#操作etcd，增加host-gw" class="headerlink" title="操作etcd，增加host-gw"></a>操作etcd，增加host-gw</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 etcd]# ./etcdctl set /coreos.com/network/config &apos;&#123;&quot;Network&quot;: &quot;172.7.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;&apos;</span><br><span class="line">&#123;&quot;Network&quot;: &quot;172.7.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建配置-3"><a href="#创建配置-3" class="headerlink" title="创建配置"></a>创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel/subnet.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FLANNEL_NETWORK=172.7.0.0/16</span><br><span class="line">FLANNEL_SUBNET=172.7.21.1/24</span><br><span class="line">FLANNEL_MTU=1500</span><br><span class="line">FLANNEL_IPMASQ=false</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel集群各主机的配置略有不同，部署其他节点时注意修改。</p>
<h3 id="创建启动脚本-3"><a href="#创建启动脚本-3" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel/flanneld.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./flanneld \</span><br><span class="line">  --public-ip=10.4.7.21 \</span><br><span class="line">  --etcd-endpoints=https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile=./cert/client-key.pem \</span><br><span class="line">  --etcd-certfile=./cert/client.pem \</span><br><span class="line">  --etcd-cafile=./cert/ca.pem \</span><br><span class="line">  --iface=eth0 \</span><br><span class="line">  --subnet-file=./subnet.env \</span><br><span class="line">  --healthz-port=2401</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录-2"><a href="#检查配置，权限，创建日志目录-2" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flannel]# chmod +x /opt/flannel/flanneld.sh </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 flannel]# mkdir -p /data/logs/flanneld</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-5"><a href="#创建supervisor配置-5" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/flanneld.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:flanneld]</span><br><span class="line">command=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                   ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3     				     ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2      				     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT    				     ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10    				     ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                        ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                  ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/flanneld/flanneld.stderr.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                     ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                  ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-5"><a href="#启动服务并检查-5" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flanneld]# supervisorctl update</span><br><span class="line">flanneld: added process group</span><br><span class="line">[root@hdss7-21 flanneld]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 1 day, 20:35:42</span><br><span class="line">flanneld                         STARTING  </span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 1 day, 19:01:43</span><br><span class="line">kube-controller-manager          RUNNING   pid 37646, uptime 0:58:48</span><br><span class="line">kube-kubelet                     RUNNING   pid 32640, uptime 17:16:36</span><br><span class="line">kube-proxy                       RUNNING   pid 15097, uptime 17:55:36</span><br><span class="line">kube-scheduler                   RUNNING   pid 37803, uptime 0:55:47</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的flannel服务"><a href="#安装部署启动检查所有集群规划主机上的flannel服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的flannel服务"></a>安装部署启动检查所有集群规划主机上的flannel服务</h3><p>略</p>
<h3 id="再次验证集群"><a href="#再次验证集群" class="headerlink" title="再次验证集群"></a>再次验证集群</h3><h2 id="部署k8s资源配置清单的内网http服务"><a href="#部署k8s资源配置清单的内网http服务" class="headerlink" title="部署k8s资源配置清单的内网http服务"></a>部署k8s资源配置清单的内网http服务</h2><h3 id="在运维主机HDSS7-200-host-com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口"><a href="#在运维主机HDSS7-200-host-com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口" class="headerlink" title="在运维主机HDSS7-200.host.com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口"></a>在运维主机<code>HDSS7-200.host.com</code>上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口</h3><figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/k8s-yaml.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.od.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        root /data/k8s-yaml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置内网DNS解析"><a href="#配置内网DNS解析" class="headerlink" title="配置内网DNS解析"></a>配置内网DNS解析</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8s-yaml	60 IN A 10.4.7.200</span><br></pre></td></tr></table></figure>

<p>以后所有的资源配置清单统一放置在运维主机的<code>/data/k8s-yaml</code>目录下即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="部署kube-dns-coredns"><a href="#部署kube-dns-coredns" class="headerlink" title="部署kube-dns(coredns)"></a>部署kube-dns(coredns)</h2><h3 id="准备coredns-v1-3-1镜像"><a href="#准备coredns-v1-3-1镜像" class="headerlink" title="准备coredns-v1.3.1镜像"></a>准备coredns-v1.3.1镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull coredns/coredns:1.3.1</span><br><span class="line">1.3.1: Pulling from coredns/coredns</span><br><span class="line">e0daa8927b68: Pull complete </span><br><span class="line">3928e47de029: Pull complete </span><br><span class="line">Digest: sha256:02382353821b12c21b062c59184e227e001079bb13ebd01f9d3270ba0fcbf1e4</span><br><span class="line">Status: Downloaded newer image for coredns/coredns:1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag eb516548c180 harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/coredns]</span><br><span class="line">c6a5fc8a3f01: Pushed </span><br><span class="line">fb61a074724d: Pushed </span><br><span class="line">v1.3.1: digest: sha256:e077b9680c32be06fc9652d57f64aa54770dd6554eb87e7a00b97cf8e9431fda size: 739</span><br></pre></td></tr></table></figure>

<p>任意一台运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 --docker-email=stanley.wang.m@qq.com -n kube-system</span><br></pre></td></tr></table></figure>

<h4 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h4><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/coredns &amp;&amp; cd /data/k8s-yaml/coredns</span><br></pre></td></tr></table></figure>

<div class="tabs" id="coredns"><ul class="nav-tabs"><li class="tab active"><a href="#coredns-1">RBAC</a></li><li class="tab"><a href="#coredns-2">ConfigMap</a></li><li class="tab"><a href="#coredns-3">Deployment</a></li><li class="tab"><a href="#coredns-4">Service</a></li></ul><div class="tab-content"><div class="tab-pane active" id="coredns-1"><p>vi /data/k8s-yaml/coredns/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-2"><p>vi /data/k8s-yaml/coredns/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local 192.168.0.0/16</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-3"><p>vi /data/k8s-yaml/coredns/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-4"><p>vi /data/k8s-yaml/coredns/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 192.168.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="依次执行创建"><a href="#依次执行创建" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/coredns" target="_blank" rel="noopener">http://k8s-yaml.od.com/coredns</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点上应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/configmap.yaml</span><br><span class="line">configmap/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/deployment.yaml</span><br><span class="line">deployment.extensions/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span><br><span class="line">service/coredns created</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7ccccdf57c-5b9ch   1/1     Running   0          3m4s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 coredns]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53/UDP,53/TCP   29s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# dig -t A nginx-ds.default.svc.cluster.local. @192.168.0.2 +short</span><br><span class="line">192.168.0.3</span><br></pre></td></tr></table></figure>

<h2 id="部署traefik（ingress）"><a href="#部署traefik（ingress）" class="headerlink" title="部署traefik（ingress）"></a>部署traefik（ingress）</h2><h3 id="准备traefik镜像"><a href="#准备traefik镜像" class="headerlink" title="准备traefik镜像"></a>准备traefik镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull traefik:v1.7-alpine</span><br><span class="line">v1.7-alpine: Pulling from library/traefik</span><br><span class="line">bdf0201b3a05: Pull complete </span><br><span class="line">9dfd896cc066: Pull complete </span><br><span class="line">de06b5685128: Pull complete </span><br><span class="line">c4d82a21fa27: Pull complete </span><br><span class="line">Digest: sha256:0531581bde9da0670fc2c7a4e419e1cc38abff74e7ba06410bf2b1b55c70ef15</span><br><span class="line">Status: Downloaded newer image for traefik:v1.7-alpine</span><br><span class="line">[root@hdss7-200 ~]# docker tag 1930b7508541 harbor.od.com/k8s/traefik:v1.7       </span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/traefik:v1.7</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/traefik]</span><br><span class="line">a3e3d574f6ae: Pushed </span><br><span class="line">a7c355c1a104: Pushed </span><br><span class="line">e89059911fc9: Pushed </span><br><span class="line">a464c54f93a9: Mounted from infra/apollo-portal </span><br><span class="line">v1.7: digest: sha256:8f92899f5feb08db600c89d3016145e838fa7ff0d316ee21ecd63d9623643410 size: 1157</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/traefik &amp;&amp; cd /data/k8s-yaml/traefik</span><br></pre></td></tr></table></figure>

<div class="tabs" id="traefik"><ul class="nav-tabs"><li class="tab active"><a href="#traefik-1">RBAC</a></li><li class="tab"><a href="#traefik-2">DaemonSet</a></li><li class="tab"><a href="#traefik-3">Service</a></li><li class="tab"><a href="#traefik-4">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="traefik-1"><p>vi /data/k8s-yaml/traefik/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">\--\-</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-2"><p>vi /data/k8s-yaml/traefik/daemonset.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/k8s/traefik:v1.7</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - -\-api</span><br><span class="line">        - -\-kubernetes</span><br><span class="line">        - -\-logLevel=INFO</span><br><span class="line">        - -\-insecureskipverify=true</span><br><span class="line">        - -\-kubernetes.endpoint=https://10.4.7.10:7443</span><br><span class="line">        - -\-accesslog</span><br><span class="line">        - -\-accesslog.filepath=/var/log/traefik_access.log</span><br><span class="line">        - -\-traefiklog</span><br><span class="line">        - -\-traefiklog.filepath=/var/log/traefik.log</span><br><span class="line">        - -\-metrics.prometheus</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-3"><p>vi /data/k8s-yaml/traefik/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: web</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-4"><p>vi /data/k8s-yaml/traefik/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">traefik	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-1"><a href="#依次执行创建-1" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/traefik" target="_blank" rel="noopener">http://k8s-yaml.od.com/traefik</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml </span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/daemonset.yaml </span><br><span class="line">daemonset.extensions/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml </span><br><span class="line">service/traefik-ingress-service created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml </span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure>

<h3 id="配置反代"><a href="#配置反代" class="headerlink" title="配置反代"></a>配置反代</h3><p><code>HDSS7-11.host.com</code>和<code>HDSS7-12.host.com</code>两台主机上的nginx均需要配置，这里可以考虑使用saltstack或者ansible进行统一配置管理</p>
<figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 10.4.7.21:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.od.com;</span><br><span class="line">  </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://traefik.od.com" target="_blank" rel="noopener">http://traefik.od.com</a></p>
<h2 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h2><h3 id="准备dashboard镜像"><a href="#准备dashboard镜像" class="headerlink" title="准备dashboard镜像"></a>准备dashboard镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull k8scn/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">v1.8.3: Pulling from k8scn/kubernetes-dashboard-amd64</span><br><span class="line">a4026007c47e: Pull complete </span><br><span class="line">Digest: sha256:ebc993303f8a42c301592639770bd1944d80c88be8036e2d4d0aa116148264ff</span><br><span class="line">Status: Downloaded newer image for k8scn/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker tag 0c60bcf89900 harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">docker push harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/dashboard]</span><br><span class="line">23ddb8cbb75a: Pushed </span><br><span class="line">v1.8.3: digest: sha256:e76c5fe6886c99873898e4c8c0945261709024c4bea773fc477629455631e472 size: 529</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/dashboard &amp;&amp; cd /data/k8s-yaml/dashboard</span><br></pre></td></tr></table></figure>

<div class="tabs" id="dashboard"><ul class="nav-tabs"><li class="tab active"><a href="#dashboard-1">RBAC</a></li><li class="tab"><a href="#dashboard-2">Secret</a></li><li class="tab"><a href="#dashboard-3">ConfigMap</a></li><li class="tab"><a href="#dashboard-4">Service</a></li><li class="tab"><a href="#dashboard-5">Ingress</a></li><li class="tab"><a href="#dashboard-6">Deployment</a></li></ul><div class="tab-content"><div class="tab-pane active" id="dashboard-1"><p>vi /data/k8s-yaml/dashboard/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-2"><p>vi /data/k8s-yaml/dashboard/secret.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-key-holder</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-3"><p>vi /data/k8s-yaml/dashboard/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-settings</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-4"><p>vi /data/k8s-yaml/dashboard/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-5"><p>vi /data/k8s-yaml/dashboard/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-6"><p>vi /data/k8s-yaml/dashboard/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: &apos;&apos;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - -\-auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          mountPath: /certs</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: /</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kubernetes-dashboard-certs</span><br><span class="line">        secret:</span><br><span class="line">          secretName: kubernetes-dashboard-certs</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">        operator: &quot;Exists&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-2"><a href="#依次执行创建-2" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/dashboard" target="_blank" rel="noopener">http://k8s-yaml.od.com/dashboard</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml </span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/secret.yaml </span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/configmap.yaml </span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml </span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml </span><br><span class="line">ingress.extensions/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/deployment.yaml </span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://dashboard.od.com" target="_blank" rel="noopener">http://dashboard.od.com</a></p>
<h3 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h3><ul>
<li>下载新版dashboard</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull hexun/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9aed6605b81 harbor.od.com/k8s/dashboard:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.10.1</span><br></pre></td></tr></table></figure>

<ul>
<li><p>应用新版dashboard</p>
</li>
<li><p>修改nginx配置，走https</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/dashboard.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs/dashboard.od.com.crt&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs/dashboard.od.com.key&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">	      proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取token</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdsss7-21 ~]# kubectl describe secret kubernetes-dashboard-admin-token-rhr62 -n kube-system</span><br><span class="line">Name:         kubernetes-dashboard-admin-token-rhr62</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: cdd3c552-856d-11e9-ae34-782bcb321c07</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1354 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1yaHI2MiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNkZDNjNTUyLTg1NmQtMTFlOS1hZTM0LTc4MmJjYjMyMWMwNyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.72OcJZCm_3I-7QZcEJTRPyIJSxQwSwZfVsB6Bx_RAZRJLOv3-BXy88PclYgxRy2dDqeX6cpjvFPBrmNOGQoxT9oD8_H49pvBnqdCdNuoJbXK7aBIZdkZxATzXd-63zmhHhUBsM3Ybgwy5XxD3vj8VUYfux5c5Mr4TzU_rnGLCj1H5mq_JJ3hNabv0rwil-ZAV-3HLikOMiIRhEK7RdMs1bfXF2yvse4VOabe9xv47TvbEYns97S4OlZvsurmOk0B8dD85OSaREEtqa8n_ND9GrHeeL4CcALqWYJHLrr7vLfndXi1QHDVrUzFKvgkAeYpDVAzGwIWL7rgHwp3sQguGA</span><br></pre></td></tr></table></figure>

<h2 id="部署heapster"><a href="#部署heapster" class="headerlink" title="部署heapster"></a>部署heapster</h2><p><a href="https://github.com/kubernetes-retired/heapster" target="_blank" rel="noopener">heapster官方github地址</a></p>
<h3 id="准备heapster镜像"><a href="#准备heapster镜像" class="headerlink" title="准备heapster镜像"></a>准备heapster镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull quay.io/bitnami/heapster:1.5.4</span><br><span class="line">1.5.4: Pulling from bitnami/heapster</span><br><span class="line">4018396ca1ba: Pull complete </span><br><span class="line">0e4723f815c4: Pull complete </span><br><span class="line">d8569f30adeb: Pull complete </span><br><span class="line">Digest: sha256:6d891479611ca06a5502bc36e280802cbf9e0426ce4c008dd2919c2294ce0324</span><br><span class="line">Status: Downloaded newer image for quay.io/bitnami/heapster:1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker tag c359b95ad38b harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/heapster]</span><br><span class="line">20d37d828804: Pushed </span><br><span class="line">b9b192015e25: Pushed </span><br><span class="line">b76dba5a0109: Pushed </span><br><span class="line">v1.5.4: digest: sha256:1203b49f2b2b07e02e77263bce8bb30563a91e1d7ee7c6742e9d125abcb3abe6 size: 952</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="heapster"><ul class="nav-tabs"><li class="tab active"><a href="#heapster-1">RBAC</a></li><li class="tab"><a href="#heapster-2">Deployment</a></li><li class="tab"><a href="#heapster-3">Service</a></li></ul><div class="tab-content"><div class="tab-pane active" id="heapster-1"><p>vi /data/k8s-yaml/dashboard/heapster/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:heapster</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="heapster-2"><p>vi /data/k8s-yaml/dashboard/heapster/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bitnami/heapster/bin/heapster</span><br><span class="line">        - \--source=kubernetes:https://kubernetes.default</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="heapster-3"><p>vi /data/k8s-yaml/dashboard/heapster/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: &apos;true&apos;</span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml </span><br><span class="line">serviceaccount/heapster created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/deployment.yaml </span><br><span class="line">deployment.extensions/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml </span><br><span class="line">service/heapster created</span><br></pre></td></tr></table></figure>

<h3 id="重启dashboard"><a href="#重启dashboard" class="headerlink" title="重启dashboard"></a>重启dashboard</h3><p>浏览器访问：<a href="http://dashboard.od.com" target="_blank" rel="noopener">http://dashboard.od.com</a><br><img src="/images/heapster.png" alt="加入heapster插件的dashboard" title="加入heapster插件的dashboard"></p>
<h3 id="排错专用命令"><a href="#排错专用命令" class="headerlink" title="排错专用命令"></a>排错专用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for j in `kubectl get ns|sed &apos;1d&apos;|awk &apos;&#123;print $1&#125;&apos;`;do for i in `kubectl get pods -n $j|grep -iv running|sed &apos;1d&apos;|awk &apos;&#123;print $1&#125;&apos;`;do kubectl delete pods $i -n $j --force --grace-period=0;done;done</span><br></pre></td></tr></table></figure>
      
    </div>

    

    
    
    

    

    
      
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创技术分享，您的支持将鼓励我继续创作！</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById(&quot;QR&quot;); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechat.png" alt="Stanley Wang 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.2yuan.png" alt="Stanley Wang 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/01/18/实验文档2：实战交付一套dubbo微服务到kubernetes集群/" rel="next" title="实验文档2：实战交付一套dubbo微服务到kubernetes集群">
                <i class="fa fa-chevron-left"></i> 实验文档2：实战交付一套dubbo微服务到kubernetes集群
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/02/13/基于ITIL的IT运维管理/" rel="prev" title="基于ITIL的IT运维管理">
                基于ITIL的IT运维管理 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Stanley Wang">
            
              <p class="site-author-name" itemprop="name">Stanley Wang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/stanleywang" title="GitHub &rarr; https://gitee.com/stanleywang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:stanley.wang.m@qq.com" title="E-Mail &rarr; mailto:stanley.wang.m@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#实验环境"><span class="nav-number">1.</span> <span class="nav-text">实验环境</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础架构"><span class="nav-number">1.1.</span> <span class="nav-text">基础架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#硬件环境"><span class="nav-number">1.2.</span> <span class="nav-text">硬件环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#软件环境"><span class="nav-number">1.3.</span> <span class="nav-text">软件环境</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#前置准备工作"><span class="nav-number">2.</span> <span class="nav-text">前置准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DNS服务安装部署"><span class="nav-number">2.1.</span> <span class="nav-text">DNS服务安装部署</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备签发证书环境"><span class="nav-number">2.2.</span> <span class="nav-text">准备签发证书环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装CFSSL"><span class="nav-number">2.2.1.</span> <span class="nav-text">安装CFSSL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建生成CA证书的JSON配置文件"><span class="nav-number">2.2.2.</span> <span class="nav-text">创建生成CA证书的JSON配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建生成CA证书签名请求（csr）的JSON配置文件"><span class="nav-number">2.2.3.</span> <span class="nav-text">创建生成CA证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成CA证书和私钥"><span class="nav-number">2.2.4.</span> <span class="nav-text">生成CA证书和私钥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署docker环境"><span class="nav-number">2.3.</span> <span class="nav-text">部署docker环境</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">2.3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置"><span class="nav-number">2.3.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动脚本"><span class="nav-number">2.3.3.</span> <span class="nav-text">启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">2.3.4.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署docker镜像私有仓库harbor"><span class="nav-number">2.4.</span> <span class="nav-text">部署docker镜像私有仓库harbor</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件二进制包并解压"><span class="nav-number">2.4.1.</span> <span class="nav-text">下载软件二进制包并解压</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置-1"><span class="nav-number">2.4.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装docker-compose"><span class="nav-number">2.4.3.</span> <span class="nav-text">安装docker-compose</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装harbor"><span class="nav-number">2.4.4.</span> <span class="nav-text">安装harbor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查harbor启动情况"><span class="nav-number">2.4.5.</span> <span class="nav-text">检查harbor启动情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置harbor的dns内网解析"><span class="nav-number">2.4.6.</span> <span class="nav-text">配置harbor的dns内网解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装nginx并配置"><span class="nav-number">2.4.7.</span> <span class="nav-text">安装nginx并配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#安装-1"><span class="nav-number">2.4.7.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-2"><span class="nav-number">2.4.7.2.</span> <span class="nav-text">配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#启动-1"><span class="nav-number">2.4.7.3.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器打开http-harbor-od-com"><span class="nav-number">2.4.8.</span> <span class="nav-text">浏览器打开http://harbor.od.com</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Master节点服务"><span class="nav-number">3.</span> <span class="nav-text">部署Master节点服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署etcd集群"><span class="nav-number">3.1.</span> <span class="nav-text">部署etcd集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划"><span class="nav-number">3.1.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件"><span class="nav-number">3.1.2.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成etcd证书和私钥"><span class="nav-number">3.1.3.</span> <span class="nav-text">生成etcd证书和私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查生成的证书、私钥"><span class="nav-number">3.1.4.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd用户"><span class="nav-number">3.1.5.</span> <span class="nav-text">创建etcd用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件，解压，做软连接"><span class="nav-number">3.1.6.</span> <span class="nav-text">下载软件，解压，做软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建目录，拷贝证书、私钥"><span class="nav-number">3.1.7.</span> <span class="nav-text">创建目录，拷贝证书、私钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd服务启动脚本"><span class="nav-number">3.1.8.</span> <span class="nav-text">创建etcd服务启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整权限和目录"><span class="nav-number">3.1.9.</span> <span class="nav-text">调整权限和目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装supervisor软件"><span class="nav-number">3.1.10.</span> <span class="nav-text">安装supervisor软件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建etcd-server的启动配置"><span class="nav-number">3.1.11.</span> <span class="nav-text">创建etcd-server的启动配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动etcd服务并检查"><span class="nav-number">3.1.12.</span> <span class="nav-text">启动etcd服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的etcd服务"><span class="nav-number">3.1.13.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的etcd服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查集群状态"><span class="nav-number">3.1.14.</span> <span class="nav-text">检查集群状态</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-apiserver集群"><span class="nav-number">3.2.</span> <span class="nav-text">部署kube-apiserver集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件，解压，做软连接-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">下载软件，解压，做软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发client证书"><span class="nav-number">3.2.3.</span> <span class="nav-text">签发client证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-1"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成client证书和私钥"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">生成client证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-1"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kube-apiserver证书"><span class="nav-number">3.2.4.</span> <span class="nav-text">签发kube-apiserver证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-2"><span class="nav-number">3.2.4.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kube-apiserver证书和私钥"><span class="nav-number">3.2.4.2.</span> <span class="nav-text">生成kube-apiserver证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-2"><span class="nav-number">3.2.4.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置"><span class="nav-number">3.2.5.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600"><span class="nav-number">3.2.5.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置"><span class="nav-number">3.2.5.2.</span> <span class="nav-text">创建配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本"><span class="nav-number">3.2.6.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整权限和目录-1"><span class="nav-number">3.2.7.</span> <span class="nav-text">调整权限和目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置"><span class="nav-number">3.2.8.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查"><span class="nav-number">3.2.9.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-apiserver"><span class="nav-number">3.2.10.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-apiserver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配4层反向代理"><span class="nav-number">3.2.11.</span> <span class="nav-text">配4层反向代理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#nginx配置"><span class="nav-number">3.2.11.1.</span> <span class="nav-text">nginx配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#keepalived配置"><span class="nav-number">3.2.11.2.</span> <span class="nav-text">keepalived配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#check-port-sh"><span class="nav-number">3.2.11.2.1.</span> <span class="nav-text">check_port.sh</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#keepalived主"><span class="nav-number">3.2.11.2.2.</span> <span class="nav-text">keepalived主</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#keepalived备"><span class="nav-number">3.2.11.2.3.</span> <span class="nav-text">keepalived备</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动代理并检查"><span class="nav-number">3.2.12.</span> <span class="nav-text">启动代理并检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署controller-manager"><span class="nav-number">3.3.</span> <span class="nav-text">部署controller-manager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本-1"><span class="nav-number">3.3.2.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整文件权限，创建目录"><span class="nav-number">3.3.3.</span> <span class="nav-text">调整文件权限，创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-1"><span class="nav-number">3.3.4.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-1"><span class="nav-number">3.3.5.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-controller-manager服务"><span class="nav-number">3.3.6.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-controller-manager服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-scheduler"><span class="nav-number">3.4.</span> <span class="nav-text">部署kube-scheduler</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-3"><span class="nav-number">3.4.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调整文件权限，创建目录-1"><span class="nav-number">3.4.3.</span> <span class="nav-text">调整文件权限，创建目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-2"><span class="nav-number">3.4.4.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-2"><span class="nav-number">3.4.5.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务"><span class="nav-number">3.4.6.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-scheduler服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署Node节点服务"><span class="nav-number">4.</span> <span class="nav-text">部署Node节点服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kubelet"><span class="nav-number">4.1.</span> <span class="nav-text">部署kubelet</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-4"><span class="nav-number">4.1.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kubelet证书"><span class="nav-number">4.1.2.</span> <span class="nav-text">签发kubelet证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-3"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kubelet证书和私钥"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">生成kubelet证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-3"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置-1"><span class="nav-number">4.1.3.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600-1"><span class="nav-number">4.1.3.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置-1"><span class="nav-number">4.1.3.2.</span> <span class="nav-text">创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#给kubectl创建软连接"><span class="nav-number">4.1.3.2.1.</span> <span class="nav-text">给kubectl创建软连接</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-cluster"><span class="nav-number">4.1.3.2.2.</span> <span class="nav-text">set-cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-credentials"><span class="nav-number">4.1.3.2.3.</span> <span class="nav-text">set-credentials</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-context"><span class="nav-number">4.1.3.2.4.</span> <span class="nav-text">set-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#use-context"><span class="nav-number">4.1.3.2.5.</span> <span class="nav-text">use-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#k8s-node-yaml"><span class="nav-number">4.1.3.2.6.</span> <span class="nav-text">k8s-node.yaml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备infra-pod基础镜像"><span class="nav-number">4.1.4.</span> <span class="nav-text">准备infra_pod基础镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#下载"><span class="nav-number">4.1.4.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#提交至私有仓库（harbor）中"><span class="nav-number">4.1.4.2.</span> <span class="nav-text">提交至私有仓库（harbor）中</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kubelet启动脚本"><span class="nav-number">4.1.5.</span> <span class="nav-text">创建kubelet启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查配置，权限，创建日志目录"><span class="nav-number">4.1.6.</span> <span class="nav-text">检查配置，权限，创建日志目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-3"><span class="nav-number">4.1.7.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-3"><span class="nav-number">4.1.8.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查运算节点"><span class="nav-number">4.1.9.</span> <span class="nav-text">检查运算节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kubelet服务"><span class="nav-number">4.1.10.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kubelet服务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-proxy"><span class="nav-number">4.2.</span> <span class="nav-text">部署kube-proxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-5"><span class="nav-number">4.2.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签发kube-proxy证书"><span class="nav-number">4.2.2.</span> <span class="nav-text">签发kube-proxy证书</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建生成证书签名请求（csr）的JSON配置文件-4"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">创建生成证书签名请求（csr）的JSON配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成kube-proxy证书和私钥"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">生成kube-proxy证书和私钥</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检查生成的证书、私钥-4"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">检查生成的证书、私钥</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#拷贝证书至各运算节点，并创建配置-2"><span class="nav-number">4.2.3.</span> <span class="nav-text">拷贝证书至各运算节点，并创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#拷贝证书、私钥，注意私钥文件属性600-2"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">拷贝证书、私钥，注意私钥文件属性600</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建配置-2"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">创建配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#set-cluster-1"><span class="nav-number">4.2.3.2.1.</span> <span class="nav-text">set-cluster</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-credentials-1"><span class="nav-number">4.2.3.2.2.</span> <span class="nav-text">set-credentials</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#set-context-1"><span class="nav-number">4.2.3.2.3.</span> <span class="nav-text">set-context</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#use-context-1"><span class="nav-number">4.2.3.2.4.</span> <span class="nav-text">use-context</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建kube-proxy启动脚本"><span class="nav-number">4.2.4.</span> <span class="nav-text">创建kube-proxy启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查配置，权限，创建日志目录-1"><span class="nav-number">4.2.5.</span> <span class="nav-text">检查配置，权限，创建日志目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-4"><span class="nav-number">4.2.6.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-4"><span class="nav-number">4.2.7.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的kube-proxy服务"><span class="nav-number">4.2.8.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的kube-proxy服务</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#部署addons插件"><span class="nav-number">5.</span> <span class="nav-text">部署addons插件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#验证kubernetes集群"><span class="nav-number">5.1.</span> <span class="nav-text">验证kubernetes集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在任意一个运算节点，创建一个资源配置清单"><span class="nav-number">5.1.1.</span> <span class="nav-text">在任意一个运算节点，创建一个资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置，并检查"><span class="nav-number">5.1.2.</span> <span class="nav-text">应用资源配置，并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证"><span class="nav-number">5.1.3.</span> <span class="nav-text">验证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署flannel"><span class="nav-number">5.2.</span> <span class="nav-text">部署flannel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#集群规划-6"><span class="nav-number">5.2.1.</span> <span class="nav-text">集群规划</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在各运算节点上增加iptables规则"><span class="nav-number">5.2.2.</span> <span class="nav-text">在各运算节点上增加iptables规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#各运算节点保存iptables规则"><span class="nav-number">5.2.3.</span> <span class="nav-text">各运算节点保存iptables规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#下载软件，解压，做软连接-2"><span class="nav-number">5.2.4.</span> <span class="nav-text">下载软件，解压，做软连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#最终目录结构"><span class="nav-number">5.2.5.</span> <span class="nav-text">最终目录结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#操作etcd，增加host-gw"><span class="nav-number">5.2.6.</span> <span class="nav-text">操作etcd，增加host-gw</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建配置-3"><span class="nav-number">5.2.7.</span> <span class="nav-text">创建配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建启动脚本-3"><span class="nav-number">5.2.8.</span> <span class="nav-text">创建启动脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查配置，权限，创建日志目录-2"><span class="nav-number">5.2.9.</span> <span class="nav-text">检查配置，权限，创建日志目录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建supervisor配置-5"><span class="nav-number">5.2.10.</span> <span class="nav-text">创建supervisor配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动服务并检查-5"><span class="nav-number">5.2.11.</span> <span class="nav-text">启动服务并检查</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装部署启动检查所有集群规划主机上的flannel服务"><span class="nav-number">5.2.12.</span> <span class="nav-text">安装部署启动检查所有集群规划主机上的flannel服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#再次验证集群"><span class="nav-number">5.2.13.</span> <span class="nav-text">再次验证集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署k8s资源配置清单的内网http服务"><span class="nav-number">5.3.</span> <span class="nav-text">部署k8s资源配置清单的内网http服务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在运维主机HDSS7-200-host-com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口"><span class="nav-number">5.3.1.</span> <span class="nav-text">在运维主机HDSS7-200.host.com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置内网DNS解析"><span class="nav-number">5.3.2.</span> <span class="nav-text">配置内网DNS解析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署kube-dns-coredns"><span class="nav-number">5.4.</span> <span class="nav-text">部署kube-dns(coredns)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备coredns-v1-3-1镜像"><span class="nav-number">5.4.1.</span> <span class="nav-text">准备coredns-v1.3.1镜像</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#准备资源配置清单"><span class="nav-number">5.4.1.1.</span> <span class="nav-text">准备资源配置清单</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依次执行创建"><span class="nav-number">5.4.2.</span> <span class="nav-text">依次执行创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#检查"><span class="nav-number">5.4.3.</span> <span class="nav-text">检查</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署traefik（ingress）"><span class="nav-number">5.5.</span> <span class="nav-text">部署traefik（ingress）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备traefik镜像"><span class="nav-number">5.5.1.</span> <span class="nav-text">准备traefik镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-1"><span class="nav-number">5.5.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名"><span class="nav-number">5.5.3.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依次执行创建-1"><span class="nav-number">5.5.4.</span> <span class="nav-text">依次执行创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置反代"><span class="nav-number">5.5.5.</span> <span class="nav-text">配置反代</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问"><span class="nav-number">5.5.6.</span> <span class="nav-text">浏览器访问</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署dashboard"><span class="nav-number">5.6.</span> <span class="nav-text">部署dashboard</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备dashboard镜像"><span class="nav-number">5.6.1.</span> <span class="nav-text">准备dashboard镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-2"><span class="nav-number">5.6.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解析域名-1"><span class="nav-number">5.6.3.</span> <span class="nav-text">解析域名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依次执行创建-2"><span class="nav-number">5.6.4.</span> <span class="nav-text">依次执行创建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#浏览器访问-1"><span class="nav-number">5.6.5.</span> <span class="nav-text">浏览器访问</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置认证"><span class="nav-number">5.6.6.</span> <span class="nav-text">配置认证</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署heapster"><span class="nav-number">5.7.</span> <span class="nav-text">部署heapster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备heapster镜像"><span class="nav-number">5.7.1.</span> <span class="nav-text">准备heapster镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#准备资源配置清单-3"><span class="nav-number">5.7.2.</span> <span class="nav-text">准备资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用资源配置清单"><span class="nav-number">5.7.3.</span> <span class="nav-text">应用资源配置清单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#重启dashboard"><span class="nav-number">5.7.4.</span> <span class="nav-text">重启dashboard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排错专用命令"><span class="nav-number">5.7.5.</span> <span class="nav-text">排错专用命令</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stanley Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">278k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">4:13</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  


  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
