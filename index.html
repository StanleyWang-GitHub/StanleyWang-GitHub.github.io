<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon32.ico?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon16.ico?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Stanley&#39;s Blog">
<meta property="og:url" content="https://StanleyWang-GitHub.github.io/index.html">
<meta property="og:site_name" content="Stanley&#39;s Blog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stanley&#39;s Blog">






  <link rel="canonical" href="https://StanleyWang-GitHub.github.io/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Stanley's Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stanley's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/02/14/OSI网络参考模型/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/14/OSI网络参考模型/" class="post-title-link" itemprop="url">OSI网络参考模型</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-14 15:27:57" itemprop="dateCreated datePublished" datetime="2019-02-14T15:27:57+08:00">2019-02-14</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Linux基础/" itemprop="url" rel="index"><span itemprop="name">Linux基础</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.3k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="OSI七层模型"><a href="#OSI七层模型" class="headerlink" title="OSI七层模型"></a>OSI七层模型</h1><p><code>OSI模型（Open System Interconnection Model）是一个由ISO提出得到概念模型，试图提供一个使各种不同的的计算机和网络在世界范围内实现互联的标准框架。</code></p>
<h2 id="分层结构"><a href="#分层结构" class="headerlink" title="分层结构"></a>分层结构</h2><p>OSI参考模型采用分层结构，如图所示。 不得不说，这张图真的超经典呀。一张图搞定你你不懂的一切。<br><img src="/images/ios%E4%B8%83%E5%B1%82%E6%A8%A1%E5%9E%8B%E5%9B%BE.jpeg" alt="OSI七层模型"><br>主要分为以下七层（从下至上）：物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。</p>
<h2 id="各层功能"><a href="#各层功能" class="headerlink" title="各层功能"></a>各层功能</h2><ul>
<li><strong>物理层</strong><br>简单的说，物理层（Physical Layer）确保原始的数据可在各种物理媒体上传输。在这一层上面规定了激活、维持、关闭通信端点之间的机械特性、电气特性、功能特性以及过程特性，为上层协议提供了一个传输数据的物理媒体。这一层传输的是bit流。</li>
<li><strong>数据链路层</strong><br>数据链路层（Data Link Layer）在不可靠的物理介质上提供可靠的传输。该层的作用包括：物理地址寻址、数据的成帧、流量控制、数据的检错、重发等。这一层中将bit流封装成frame帧。</li>
<li><strong>网络层</strong><br>网络层（Network Layer）负责对子网间的数据包进行路由选择。此外，网络层还可以实现拥塞控制、网际互连等功能。在这一层，数据的单位称为数据包（packet）。</li>
<li><strong>传输层</strong><br>传输层是第一个端到端，即主机到主机的层次。传输层负责将上层数据分段并提供端到端的、可靠的或不可靠的传输。此外，传输层还要处理端到端的差错控制和流量控制问题。在这一层，数据的单位称为数据段（segment）。</li>
<li><strong>会话层</strong><br>这一层管理主机之间的会话进程，即负责建立、管理、终止进程之间的会话。会话层还利用在数据中插入校验点来实现数据的同步，访问验证和会话管理在内的建立和维护应用之间通信的机制。如服务器验证用户登录便是由会话层完成的。使通信会话在通信失效时从校验点继续恢复通信。</li>
<li><strong>表示层</strong><br>这一层主要解决用户信息的语法表示问题。它将欲交换的数据从适合于某一用户的抽象语法，转换为适合于OSI系统内部使用的传送语法。即提供格式化的表示和转换数据服务。数据的压缩和解压缩， 加密和解密等工作都由表示层负责。</li>
<li><strong>应用层</strong><br>这一层为操作系统或网络应用程序提供访问网络服务的接口。</li>
</ul>
<h1 id="各层传输协议、传输单元、主要功能性设备比较"><a href="#各层传输协议、传输单元、主要功能性设备比较" class="headerlink" title="各层传输协议、传输单元、主要功能性设备比较"></a>各层传输协议、传输单元、主要功能性设备比较</h1><table>
<thead>
<tr>
<th>名称</th>
<th>传输协议</th>
<th>主要功能设备/接口</th>
<th>主要功能设备/接口</th>
</tr>
</thead>
<tbody><tr>
<td>物理层</td>
<td>IEEE 802.1A、IEEE 802.2</td>
<td>bit-flow</td>
<td>比特流    光纤、双绞线、中继器和集线器 &amp; RJ-45(网线接口)</td>
</tr>
<tr>
<td>数据链路层</td>
<td>ARP、MAC、 FDDI、Ethernet、Arpanet、PPP、PDN</td>
<td>frame 帧</td>
<td>网桥、二层交换机</td>
</tr>
<tr>
<td>网络层</td>
<td>IP、ICMP、ARP、RARP</td>
<td>数据包（packet）</td>
<td>路由器、三层交换机</td>
</tr>
<tr>
<td>传输层</td>
<td>TCP、UDP</td>
<td>Segment/Datagram</td>
<td>四层交换机</td>
</tr>
<tr>
<td>会话层</td>
<td>SMTP、DNS</td>
<td>报文</td>
<td>QoS</td>
</tr>
<tr>
<td>表示层</td>
<td>Telnet、SNMP</td>
<td>报文</td>
<td>-</td>
</tr>
<tr>
<td>应用层</td>
<td>FTP、TFTP、Telnet、HTTP、DNS</td>
<td>报文</td>
<td>-</td>
</tr>
</tbody></table>
<h1 id="关于协议你应该知道这些"><a href="#关于协议你应该知道这些" class="headerlink" title="关于协议你应该知道这些"></a>关于协议你应该知道这些</h1><p>以上通过图表、文字向大家阐述了七层模型每一层的具体功能及其相关协议，但知道了这些还不够，你还要知道以下这些。</p>
<blockquote>
<h2 id="TCP-UDP"><a href="#TCP-UDP" class="headerlink" title="TCP/UDP"></a>TCP/UDP</h2><ul>
<li><strong>TCP/UDP是什么？</strong><br>TCP — Transmission Control Protocol，传输控制协议。<br>UDP — User Data Protocol，用户数据报协议。</li>
<li><strong>TCP/UDP的区别（优缺点）？</strong><br>(1)、TCP是面向连接的，UDP是面向无连接的。TCP在通信之前必须通过三次握手机制与对方建立连接，而UDP通信不必与对方建立连接，不管对方的状态就直接把数据发送给对方<br>(2)、TCP连接过程耗时，UDP不耗时<br>(3)、TCP连接过程中出现的延时增加了被攻击的可能，安全性不高，而UDP不需要连接，安全性较高<br>(4)、TCP是可靠的，保证数据传输的正确性，不易丢包;UDP是不可靠的，易丢包<br>(5)、tcp传输速率较慢，实时性差，udp传输速率较快。tcp建立连接需要耗时，并且tcp首部信息太多，每次传输的有用信息较少，实时性差。<br>(6)、tcp是流模式，udp是数据包模式。tcp只要不超过缓冲区的大小就可以连续发送数据到缓冲区上，接收端只要缓冲区上有数据就可以读取，可以一次读取多个数据包，而udp一次只能读取一个数据包，数据包之间独立</li>
<li><strong>TCP三次握手过程</strong></li>
</ul>
<p><strong>STEP 1：</strong> 主机A通过向主机B发送一个含有同步序列号的标志位的数据段给主机B，向主机B请求建立连接,通过这个数据段，主机A告诉主机B两件事:我想要和你通信；你可以用哪个序列号作为起始数据段来回应我。<br><strong>STEP 2：</strong> 主机B收到主机A的请求后,用一个带有确认应答(ACK)和同步序列号(SYN)标志位的数据段响应主机A，也告诉主机A两件事：我已经收到你的请求了，你可以传输数据了；你要用哪佧序列号作为起始数据段来回应我。<br><strong>STEP 3：</strong> 主机A收到这个数据段后，再发送一个确认应答，确认已收到主机B的数据段：”我已收到回复，我现在要开始传输实际数据了。这样3次握手就完成了，主机A和主机B就可以传输数据了。</p>
<ul>
<li><strong>注意</strong><br>此时需要注意的是，<code>TCP建立连接要进行3次握手，而断开连接要进行4次。</code></li>
<li><strong>名词解释</strong></li>
</ul>
<p><strong>ACK：</strong> TCP报头的控制位之一，对数据进行确认，确认由目的端发出，用它来告诉发送端这个序列号之前的数据段都收到了。比如，确认号为X，则表示前X-1个数据段都收到了，只有当ACK=1时，确认号才有效，当ACK=0时，确认号无效，这时会要求重传数据，保证数据的完整性。<br><strong>SYN：</strong> 同步序列号，TCP建立连接时将这个位置1。<br><strong>FIN ：</strong> 发送端完成发送任务位，当TCP完成数据传输需要断开时，提出断开连接的一方将这位置1。</p>
<ul>
<li><strong>TCP可靠性的四大手段</strong><br>(1)、顺序编号： tcp在传输文件的时候，会将文件拆分为多个tcp数据包，每个装满的数据包大小大约在1k左右，tcp协议为保证可靠传输，会将这些数据包顺序编号<br>(2)、确认机制： 当数据包成功的被发送方发送给接收方，接收方会根据tcp协议反馈给发送方一个成功接收的ACK信号，信号中包含了当前包的序号<br>(3)、超时重传： 当发送方发送数据包给接收方时，会为每一个数据包设置一个定时器，当在设定的时间内，发送方仍没有收到接收方的ACK信号，会再次发送该数据包，直到收到接收方的ACK信号或者连接已断开<br>(4)、校验信息： tcp首部校验信息较多，udp首部校验信息较少。<h2 id="上文部分协议简单讲"><a href="#上文部分协议简单讲" class="headerlink" title="上文部分协议简单讲"></a>上文部分协议简单讲</h2></li>
<li><strong>IEEE 802.1A、IEEE 802.2</strong><br>IEEE是英文Institute of Electrical and Electronics Engineers的简称，其中文译名是电气和电子工程师协会。IEEE 802规范定义了网卡如何访问传输介质（如光缆、双绞线、无线等），以及如何在传输介质上传输数据的方法，还定义了传输信息的网络设备之间连接建立、维护和拆除的途径。遵循IEEE 802标准的产品包括网卡、桥接器、路由器以及其他一些用来建立局域网络的组件。<br>IEEE802.1A —— 局域网体系结构<br>IEEE802.2 ——- 逻辑链路控制(LLC)</li>
<li><strong>FDDI</strong><br>光纤分布式数据接口（Fiber Distributed Data Interface）</li>
<li><strong>PPP</strong><br>点对点协议（Point to Point Protocol），为在点对点连接上传输多协议数据包提供了一个标准方法。</li>
<li><strong>IP</strong><br>互联网协议（Internet Protocol），为计算机网络相互连接进行通信而设计的协议。任何厂家生产的计算机系统，只要遵守IP协议就可以与因特网互连互通。IP地址具有唯一性，根据用户性质的不同，可以分为5类。</li>
<li><strong>ICMP</strong><br>控制报文协议（Internet Control Message Protocol）。TCP/IP设计了ICMP协议，当某个网关发现传输错误时，立即向信源主机发送ICMP报文，报告出错信息，让信源主机采取相应处理措施，它是一种差错和控制报文协议，不仅用于传输差错报文，还传输控制报文。</li>
<li><strong>ARP/RARP</strong><br>ARP (Address Resolution Protocol) 地址解析协议<br>RARP (Reverse Address Resolution Protocol) 反向地址解析协议</li>
<li><strong>SMTP</strong><br>简单邮件传输协议（Simple Mail Transfer Protocol），它是一组用于由源地址到目的地址传送邮件的规则，由它来控制信件的中转方式。SMTP协议属于TCP/IP协议簇，它帮助每台计算机在发送或中转信件时找到下一个目的地。通过SMTP协议所指定的服务器,就可以把E-mail寄到收信人的服务器上了。</li>
<li><strong>SNMP</strong><br>简单网络管理协议（Simple Network Management Protocol ），该协议能够支持网络管理系统，用以监测连接到网络上的设备是否有任何引起管理上关注的情况。</li>
<li><strong>DNS</strong><br>域名系统（Domain Name System），因特网上作为域名和IP地址相互映射的一个分布式数据库，能够使用户更方便的访问互联网，而不用去记住能够被机器直接读取的IP数串。通过主机名，最终得到该主机名对应的IP地址的过程叫做域名解析(或主机名解析)。DNS协议运行在UDP协议之上，使用端口号53。</li>
<li><strong>FTP</strong><br>文本传输协议（File Transfer Protocol），用于Internet上的控制文件的双向传输。同时，它也是一个应用程序Application）。基于不同的操作系统有不同的FTP应用程序，而所有这些应用程序都遵守该协议以传输文件。在FTP的使用当中，用户经常“下载”（Download）和“上载”（Upload）。“下载”文件就是从远程主机拷贝文件至自己的计算机上；“上载”文件就是将文件从自己的计算机中拷贝至远程主机上。</li>
<li><strong>HTTP</strong><br>超文本传输协议（HyperText Transfer Protocol），是互联网上应用最为广泛的一种网络协议。所有的WWW文件都必须遵守这个标准。它可以使浏览器更加高效，使网络传输减少。它不仅保证计算机正确快速地传输超文本文档，还确定传输文档中的哪一部分，以及哪部分内容首先显示(如文本先于图形)等。HTTP是一个应用层协议，由请求和响应构成，是一个标准的客户端服务器模型，是一个无状态的协议。</li>
</ul>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/02/13/运维安全管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/13/运维安全管理/" class="post-title-link" itemprop="url">运维安全管理</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-13 15:27:57" itemprop="dateCreated datePublished" datetime="2019-02-13T15:27:57+08:00">2019-02-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/运维技术管理/" itemprop="url" rel="index"><span itemprop="name">运维技术管理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1.7k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="运维安全的四个层次"><a href="#运维安全的四个层次" class="headerlink" title="运维安全的四个层次"></a>运维安全的四个层次</h1><h2 id="网络安全"><a href="#网络安全" class="headerlink" title="网络安全"></a>网络安全</h2><h3 id="网络设备的安全"><a href="#网络设备的安全" class="headerlink" title="网络设备的安全"></a>网络设备的安全</h3><ul>
<li>思科、华为等网络设备定期升级，修复bug和曝出的漏洞</li>
<li>公网防火墙，核心交换机等核心网络设备的管理</li>
</ul>
<h3 id="外网安全策略"><a href="#外网安全策略" class="headerlink" title="外网安全策略"></a>外网安全策略</h3><ul>
<li>IDC，防火墙策略，严把上行端口开放</li>
<li>公网上下行流量监控</li>
<li>对DDos攻击提高警惕，提前准备应急预案<ul>
<li>临时提高流量，硬抗</li>
<li>启动流量清洗，将攻击流量引入黑洞，有可能误杀正常用户</li>
</ul>
</li>
</ul>
<h3 id="专线安全策略"><a href="#专线安全策略" class="headerlink" title="专线安全策略"></a>专线安全策略</h3><ul>
<li>对涉及金融、支付等项目设立专线</li>
</ul>
<h3 id="VPN安全策略"><a href="#VPN安全策略" class="headerlink" title="VPN安全策略"></a>VPN安全策略</h3><ul>
<li>IPsec VPN：site to site</li>
<li>OpenVPN： peer to site</li>
<li>摒弃PPTP等不含加密算法的vpn服务</li>
<li>端口全禁止，需要通信的申请审批后，再由管理员开放</li>
</ul>
<h2 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h2><h3 id="数据库用户权限"><a href="#数据库用户权限" class="headerlink" title="数据库用户权限"></a>数据库用户权限</h3><ul>
<li>管理员权限限定，不允许远程root</li>
<li>定期更换管理员密码</li>
<li>应用权限最小化，专人管理</li>
<li>手动查询权限可审计</li>
</ul>
<h3 id="数据库审计设备"><a href="#数据库审计设备" class="headerlink" title="数据库审计设备"></a>数据库审计设备</h3><ul>
<li>数据库主库不能开一般查询日志（为了性能）</li>
<li>交换机上镜像流量，接入审计设备，实现实时审计</li>
<li>不要设计串行在系统里，形成单点和瓶颈</li>
</ul>
<h3 id="数据库脱敏"><a href="#数据库脱敏" class="headerlink" title="数据库脱敏"></a>数据库脱敏</h3><ul>
<li>姓名、身份证、手机号、银行卡号等敏感信息应脱敏处理</li>
<li>对程序脱敏协同系统架构部共同出规范</li>
<li>对手动查询权限脱敏，按列授权，录屏</li>
</ul>
<h3 id="备份策略"><a href="#备份策略" class="headerlink" title="备份策略"></a>备份策略</h3><ul>
<li>每周全备，每天增备</li>
<li>备份文件要每天利用内网流量低谷时间，推送到远程主机，有条件的应跨机房备份</li>
<li>一定要规划定期恢复测试，保证备份的可用性</li>
</ul>
<h2 id="应用安全"><a href="#应用安全" class="headerlink" title="应用安全"></a>应用安全</h2><h3 id="操作系统安全"><a href="#操作系统安全" class="headerlink" title="操作系统安全"></a>操作系统安全</h3><ul>
<li>系统基础优化（内核优化，优化工具）</li>
<li>日期，时区同步</li>
<li>root密码复杂度足够高，需要在操作系统里做定时过期策略</li>
<li>每三个月使用脚本更新服务器的root密码和iDrac密码，并将更换后的密码加密打包发送给指定管理员邮箱，同时提交gitlab</li>
<li>对系统关键文件进行md5监控，例如/etc/passwd，~/.ssh/authorized_keys文件等，如有变更，触发报警</li>
<li>定期查毒，漏扫，定期安排更新操作系统</li>
<li>/etc/ssh/sshd_config里配置：<ul>
<li>PasswordAuthentication no</li>
<li>PermitRootLogin without-password</li>
</ul>
</li>
<li>使用saltstack等批量管理软件进行特权命令执行和备份脚本执行（避开ssh协议）</li>
</ul>
<h3 id="应用系统安全"><a href="#应用系统安全" class="headerlink" title="应用系统安全"></a>应用系统安全</h3><h4 id="WEB应用防火墙（WAF）"><a href="#WEB应用防火墙（WAF）" class="headerlink" title="WEB应用防火墙（WAF）"></a>WEB应用防火墙（WAF）</h4><ul>
<li>防SQL注入</li>
<li>防CC攻击</li>
<li>防XSS跨站脚本</li>
</ul>
<h4 id="应用系统漏洞"><a href="#应用系统漏洞" class="headerlink" title="应用系统漏洞"></a>应用系统漏洞</h4><ul>
<li>关注0day漏洞新闻</li>
<li>及时整改并上线投产</li>
<li>组织技术力量测试，复现</li>
</ul>
<h4 id="日志收集和分析"><a href="#日志收集和分析" class="headerlink" title="日志收集和分析"></a>日志收集和分析</h4><ul>
<li>完善日志收集方案，集中转储</li>
<li>通过应用系统日志分析，进行安全预警</li>
</ul>
<h4 id="DNS劫持"><a href="#DNS劫持" class="headerlink" title="DNS劫持"></a>DNS劫持</h4><ul>
<li>全站https，购买泛域名证书</li>
<li>有条件的可以自己维护公网DNS，上dnssec数字签名</li>
<li>采购基调、听云等第三方拨测服务，分布式监控网站质量</li>
<li>向ISP投诉，工信部举报</li>
</ul>
<h4 id="Basic-Auth"><a href="#Basic-Auth" class="headerlink" title="Basic Auth"></a>Basic Auth</h4><ul>
<li>在nginx上做，非常简单</li>
<li>对防脚本攻击有奇效</li>
</ul>
<h3 id="企业邮箱服务器安全"><a href="#企业邮箱服务器安全" class="headerlink" title="企业邮箱服务器安全"></a>企业邮箱服务器安全</h3><h4 id="推荐使用微软的Exchange"><a href="#推荐使用微软的Exchange" class="headerlink" title="推荐使用微软的Exchange"></a>推荐使用微软的Exchange</h4><p>功能强大，维护相对简单</p>
<h4 id="投产反垃圾邮件网关"><a href="#投产反垃圾邮件网关" class="headerlink" title="投产反垃圾邮件网关"></a>投产反垃圾邮件网关</h4><p>投产梭子鱼反垃圾邮件网关，防伪造发信人</p>
<h4 id="群发审核管控"><a href="#群发审核管控" class="headerlink" title="群发审核管控"></a>群发审核管控</h4><h4 id="用好邮件组"><a href="#用好邮件组" class="headerlink" title="用好邮件组"></a>用好邮件组</h4><h4 id="接入AD域控"><a href="#接入AD域控" class="headerlink" title="接入AD域控"></a>接入AD域控</h4><h3 id="域名安全管理"><a href="#域名安全管理" class="headerlink" title="域名安全管理"></a>域名安全管理</h3><h4 id="做好ICP备案"><a href="#做好ICP备案" class="headerlink" title="做好ICP备案"></a>做好ICP备案</h4><ul>
<li>域名证书</li>
<li>域名实名认证（公司模板）</li>
<li>接入商处蓝色幕布拍照</li>
<li>法人身份证、管理员身份证</li>
<li>网站真实性核验单</li>
</ul>
<h4 id="公网解析"><a href="#公网解析" class="headerlink" title="公网解析"></a>公网解析</h4><ul>
<li>专人管理，邮件申请，审批</li>
<li>将业务解析至不同公网IP出口，双活机房</li>
<li>智能解析，解析至不同线路</li>
<li>如有条件，可购买公网解析套餐服务，安全服务等</li>
</ul>
<h2 id="内网安全"><a href="#内网安全" class="headerlink" title="内网安全"></a>内网安全</h2><p>80%以上的企业IT安全问题出自内网安全</p>
<h3 id="堡垒机"><a href="#堡垒机" class="headerlink" title="堡垒机"></a>堡垒机</h3><ul>
<li>一定要强制使用堡垒机登录服务器</li>
<li>ssh私钥通行短语机制，避免密钥失窃</li>
<li>定期审计堡垒机操作日志</li>
<li>如果有必要，可以上2FA（双因子验证）</li>
</ul>
<h3 id="AD域控"><a href="#AD域控" class="headerlink" title="AD域控"></a>AD域控</h3><p>有条件一定要接入windows域控，要求密码复杂度和定期过期</p>
<ul>
<li>邮箱</li>
<li>wifi</li>
<li>vpn账号密码</li>
<li>内网系统账号</li>
<li>业务系统账号</li>
<li>网络设备等</li>
</ul>
<h3 id="办公网安全"><a href="#办公网安全" class="headerlink" title="办公网安全"></a>办公网安全</h3><ul>
<li>专业的HelpDesk团队</li>
<li>企业级杀毒软件</li>
<li>办公电脑接入域控</li>
<li>上网行为管理</li>
<li>流量监控，mac地址绑定</li>
<li>有条件的可以在办公环境上一个小型的业务机房</li>
<li>wifi管控，单做guest接入点，不能访问业务核心网络</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/02/13/基于ITIL的IT运维管理/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/02/13/基于ITIL的IT运维管理/" class="post-title-link" itemprop="url">基于ITIL的IT运维管理</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-02-13 15:27:57" itemprop="dateCreated datePublished" datetime="2019-02-13T15:27:57+08:00">2019-02-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/运维技术管理/" itemprop="url" rel="index"><span itemprop="name">运维技术管理</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="IT管理中的PPT"><a href="#IT管理中的PPT" class="headerlink" title="IT管理中的PPT"></a>IT管理中的PPT</h1><ul>
<li>人，流程，技术</li>
</ul>
<h1 id="服务是什么？"><a href="#服务是什么？" class="headerlink" title="服务是什么？"></a>服务是什么？</h1><ul>
<li>服务是向客户提供价值的一种手段，使客户不用承担特定的成本和风险就可以获得所期望的结果。</li>
</ul>
<h1 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h1><ul>
<li>服务管理是一套特定的组织能力，以服务的形式为客户提供价值。</li>
</ul>
<h1 id="ITIL简介"><a href="#ITIL简介" class="headerlink" title="ITIL简介"></a>ITIL简介</h1><h2 id="是什么？"><a href="#是什么？" class="headerlink" title="是什么？"></a>是什么？</h2><ul>
<li>Information Technology Infrastructure Library<blockquote>
<p>IT基础架构库，一个可以直接使用的标准，已于2005年12月15日被ISO接受为国际标准 – ISO20000</p>
</blockquote>
</li>
</ul>
<h2 id="与ISO20000的区别"><a href="#与ISO20000的区别" class="headerlink" title="与ISO20000的区别"></a>与ISO20000的区别</h2><table>
<thead>
<tr>
<th>ITIL</th>
<th>ISO20000</th>
</tr>
</thead>
<tbody><tr>
<td>提供最佳实践指导</td>
<td>提供衡量ITSM的指标</td>
</tr>
<tr>
<td>没有固定的能力衡量指标</td>
<td>全球统一</td>
</tr>
<tr>
<td>对人员</td>
<td>对机构</td>
</tr>
</tbody></table>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><ul>
<li>将IT管理工作标准化、模式化，减少人为误操作带来的隐患</li>
<li>通过服务目录，服务报告，告诉业务部门，我们可以做什么，做了什么</li>
<li>通过系列流程，知识库减轻对英雄式工程师的依赖。把经验积累下来</li>
<li>通过对流程的管控，减少成本，降低风险，提供客户满意度</li>
</ul>
<h2 id="IT-Service-CMM"><a href="#IT-Service-CMM" class="headerlink" title="IT Service CMM"></a>IT Service CMM</h2><h3 id="初始级"><a href="#初始级" class="headerlink" title="初始级"></a>初始级</h3><p>个人英雄式工程师</p>
<h3 id="可重复级"><a href="#可重复级" class="headerlink" title="可重复级"></a>可重复级</h3><p>潜规则</p>
<h3 id="定义级"><a href="#定义级" class="headerlink" title="定义级"></a>定义级</h3><ul>
<li>已将IT服务过程文档话，标准化，并综合成标准服务过程</li>
<li>根据客户需求调整服务产品和服务战略</li>
<li>适当的工具和信息报告</li>
</ul>
<h3 id="管理级"><a href="#管理级" class="headerlink" title="管理级"></a>管理级</h3><ul>
<li>受监督、可测量的IT服务体系</li>
<li>根据业务战略调整服务体系</li>
</ul>
<h3 id="优化级"><a href="#优化级" class="headerlink" title="优化级"></a>优化级</h3><ul>
<li>持续改进的IT服务体系</li>
<li>IT与业务指标建立关系</li>
<li>IT与业务协作改进流程</li>
</ul>
<h2 id="ITIL-v3"><a href="#ITIL-v3" class="headerlink" title="ITIL v3"></a>ITIL v3</h2><h3 id="服务战略"><a href="#服务战略" class="headerlink" title="服务战略"></a>服务战略</h3><p>从组织能力和战略资产两个角度出发，为组织进行服务战略方面的决策和战略设计提供了一套结构化的方法</p>
<ul>
<li>我们的业务是什么？</li>
<li>我们的客户是谁？</li>
<li>客户重视什么？</li>
<li>谁依赖我们的服务？</li>
<li>他们怎样使用我们的服务？</li>
<li>服务为什么对他们有价值？</li>
</ul>
<h3 id="4P"><a href="#4P" class="headerlink" title="4P"></a>4P</h3><h4 id="观念"><a href="#观念" class="headerlink" title="观念"></a>观念</h4><p>面向其目标客户的业务定位或服务提供方式</p>
<h4 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h4><p>描述了采纳和中立场的决策</p>
<h4 id="计划"><a href="#计划" class="headerlink" title="计划"></a>计划</h4><p>描述了将蓝图转化为现实的手段</p>
<h4 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h4><p>描述了一系列的稳定的决策和行动</p>
<h3 id="服务设计"><a href="#服务设计" class="headerlink" title="服务设计"></a>服务设计</h3><p>对服务及服务管理流程设计和开发的指导</p>
<h4 id="服务目录管理"><a href="#服务目录管理" class="headerlink" title="服务目录管理"></a>服务目录管理</h4><h4 id="服务级别管理"><a href="#服务级别管理" class="headerlink" title="服务级别管理"></a>服务级别管理</h4><h4 id="容量管理"><a href="#容量管理" class="headerlink" title="容量管理"></a>容量管理</h4><h5 id="商业容量管理：吞吐量"><a href="#商业容量管理：吞吐量" class="headerlink" title="商业容量管理：吞吐量"></a>商业容量管理：吞吐量</h5><h5 id="服务容量管理：响应时间"><a href="#服务容量管理：响应时间" class="headerlink" title="服务容量管理：响应时间"></a>服务容量管理：响应时间</h5><h5 id="资源容量管理：CPU"><a href="#资源容量管理：CPU" class="headerlink" title="资源容量管理：CPU"></a>资源容量管理：CPU</h5><h4 id="可用性管理"><a href="#可用性管理" class="headerlink" title="可用性管理"></a>可用性管理</h4><p>正常运行时间、宕机时间</p>
<h4 id="IT服务持续性管理"><a href="#IT服务持续性管理" class="headerlink" title="IT服务持续性管理"></a>IT服务持续性管理</h4><p>灾备</p>
<h4 id="信息安全管理"><a href="#信息安全管理" class="headerlink" title="信息安全管理"></a>信息安全管理</h4><h3 id="服务转换"><a href="#服务转换" class="headerlink" title="服务转换"></a>服务转换</h3><h3 id="服务运营"><a href="#服务运营" class="headerlink" title="服务运营"></a>服务运营</h3><h3 id="持续服务改进"><a href="#持续服务改进" class="headerlink" title="持续服务改进"></a>持续服务改进</h3><h2 id="RACI模型"><a href="#RACI模型" class="headerlink" title="RACI模型"></a>RACI模型</h2><p>谁负责，谁批准，咨询谁，通知谁</p>
<h2 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h2><ul>
<li>服务所有者</li>
<li>流程所有者</li>
</ul>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><ul>
<li>简单问题复杂化，多元化 </li>
<li>效率、成本、质量、风险、稳定性、可持续性、用户体验</li>
</ul>
<h3 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h3><p>临时性</p>
<h3 id="运营"><a href="#运营" class="headerlink" title="运营"></a>运营</h3><p>持续性</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档1：跟我一步步安装部署kubernetes集群/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/18/实验文档1：跟我一步步安装部署kubernetes集群/" class="post-title-link" itemprop="url">实验文档1：跟我一步步安装部署kubernetes集群</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-18 22:12:56" itemprop="dateCreated datePublished" datetime="2019-01-18T22:12:56+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes容器云技术专题/" itemprop="url" rel="index"><span itemprop="name">Kubernetes容器云技术专题</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">89k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1:21</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="实验环境"><a href="#实验环境" class="headerlink" title="实验环境"></a>实验环境</h1><h2 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>k8s代理节点1</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>k8s代理节点2</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>k8s运算节点1</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>k8s运算节点2</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>k8s运维节点(docker仓库)</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h2 id="硬件环境"><a href="#硬件环境" class="headerlink" title="硬件环境"></a>硬件环境</h2><ul>
<li>5台vm，每台至少2c2g</li>
</ul>
<h2 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h2><ul>
<li>OS: CentOS Linux release 7.6.1810 (Core)</li>
<li>docker: v1.12.6<blockquote>
<p><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">docker引擎官方下载地址</a><br><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">docker引擎官方selinux包</a></p>
</blockquote>
</li>
<li>kubernetes: v1.13.2<blockquote>
<p><a href="https://github.com/kubernetes/kubernetes/releases" target="_blank" rel="noopener">kubernetes官方下载地址</a></p>
</blockquote>
</li>
<li>etcd: v3.1.18<blockquote>
<p><a href="https://github.com/etcd-io/etcd/releases" target="_blank" rel="noopener">etcd官方下载地址</a></p>
</blockquote>
</li>
<li>flannel: v0.10.0<blockquote>
<p><a href="https://github.com/coreos/flannel/releases" target="_blank" rel="noopener">flannel官方下载地址</a></p>
</blockquote>
</li>
<li>bind9: v9.9.4<blockquote>
<p><a href="https://www.isc.org/downloads/#" target="_blank" rel="noopener">bind9官方下载地址</a></p>
</blockquote>
</li>
<li>harbor: v1.7.1<blockquote>
<p><a href="https://github.com/goharbor/harbor/releases" target="_blank" rel="noopener">harbor官方下载地址</a></p>
</blockquote>
</li>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssljson下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
<li>其他<blockquote>
<p>其他可能用到的软件，均使用操作系统自带的yum源和epel源进行安装</p>
</blockquote>
</li>
</ul>
<h1 id="前置准备工作"><a href="#前置准备工作" class="headerlink" title="前置准备工作"></a>前置准备工作</h1><h2 id="DNS服务安装部署"><a href="#DNS服务安装部署" class="headerlink" title="DNS服务安装部署"></a>DNS服务安装部署</h2><ul>
<li>创建主机域host.com</li>
<li>创建业务域od.com</li>
<li>主辅同步(10.4.7.11主、10.4.7.12辅)</li>
<li>客户端配置指向自建DNS</li>
</ul>
<p>略</p>
<h2 id="准备签发证书环境"><a href="#准备签发证书环境" class="headerlink" title="准备签发证书环境"></a>准备签发证书环境</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h3 id="安装CFSSL"><a href="#安装CFSSL" class="headerlink" title="安装CFSSL"></a>安装CFSSL</h3><ul>
<li>证书签发工具CFSSL: R1.2<blockquote>
<p><a href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64" target="_blank" rel="noopener">cfssl下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64" target="_blank" rel="noopener">cfssljson下载地址</a><br><a href="https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64" target="_blank" rel="noopener">cfssl-certinfo下载地址</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssljson https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# curl -s -L -o /usr/bin/cfssl-certinfo https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64 </span><br><span class="line">[root@hdss7-200 ~]# chmod +x /usr/bin/cfssl*</span><br></pre></td></tr></table></figure>

<h3 id="创建生成CA证书的JSON配置文件"><a href="#创建生成CA证书的JSON配置文件" class="headerlink" title="创建生成CA证书的JSON配置文件"></a>创建生成CA证书的JSON配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;server&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;client&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;peer&quot;: &#123;</span><br><span class="line">                &quot;expiry&quot;: &quot;175200h&quot;,</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>证书类型<br>client certificate： 客户端使用，用于服务端认证客户端,例如etcdctl、etcd proxy、fleetctl、docker客户端<br>server certificate: 服务端使用，客户端以此验证服务端身份,例如docker服务端、kube-apiserver<br>peer certificate: 双向证书，用于etcd集群成员间通信</p>
</blockquote>
<h3 id="创建生成CA证书签名请求（csr）的JSON配置文件"><a href="#创建生成CA证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成CA证书签名请求（csr）的JSON配置文件"></a>创建生成CA证书签名请求（csr）的JSON配置文件</h3><figure class="highlight plain"><figcaption><span>/opt/certs/ca-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes-ca&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;175200h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>CN: Common Name，浏览器使用该字段验证网站是否合法，一般写的是域名。非常重要。浏览器使用该字段验证网站是否合法<br>C: Country， 国家<br>ST: State，州，省<br>L: Locality，地区，城市<br>O: Organization Name，组织名称，公司名称<br>OU: Organization Unit Name，组织单位名称，公司部门</p>
</blockquote>
<h3 id="生成CA证书和私钥"><a href="#生成CA证书和私钥" class="headerlink" title="生成CA证书和私钥"></a>生成CA证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca - </span><br><span class="line">2019/01/18 09:31:19 [INFO] generating a new CA key and certificate from CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generate received request</span><br><span class="line">2019/01/18 09:31:19 [INFO] received CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 09:31:19 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:31:19 [INFO] signed certificate with serial number 345276964513449660162382535043012874724976422200</span><br></pre></td></tr></table></figure>

<p>生成ca.pem、ca.csr、ca-key.pem(CA私钥,需妥善保管)</p>
<figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l</span><br><span class="line">-rw-r--r-- 1 root root  836 Jan 16 11:04 ca-config.json</span><br><span class="line">-rw-r--r-- 1 root root  332 Jan 16 11:10 ca-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 16 11:17 ca-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1001 Jan 16 11:17 ca.csr</span><br><span class="line">-rw-r--r-- 1 root root 1354 Jan 16 11:17 ca.pem</span><br></pre></td></tr></table></figure>

<h2 id="部署docker环境"><a href="#部署docker环境" class="headerlink" title="部署docker环境"></a>部署docker环境</h2><p><code>HDSS7-200.host.com</code>,<code>HDSS7-21.host.com</code>,<code>HDSS7-22.host.com</code>上：</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ul>
<li>docker: v1.12.6<blockquote>
<p><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-1.12.6-1.el7.centos.x86_64.rpm" target="_blank" rel="noopener">docker引擎官方下载地址</a><br><a href="https://yum.dockerproject.org/repo/main/centos/7/Packages/docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm" target="_blank" rel="noopener">docker引擎官方selinux包</a></p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># ls -l|grep docker-engine</span><br><span class="line">-rw-r--r--  1 root root  20013304 Jan 16 18:16 docker-engine-1.12.6-1.el7.centos.x86_64.rpm</span><br><span class="line">-rw-r--r--  1 root root     29112 Jan 16 18:15 docker-engine-selinux-1.12.6-1.el7.centos.noarch.rpm</span><br><span class="line"># yum localinstall *.rpm</span><br></pre></td></tr></table></figure>

<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/etc/docker/daemon.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># vi /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;graph&quot;: &quot;/data/docker&quot;,</span><br><span class="line">  &quot;storage-driver&quot;: &quot;overlay&quot;,</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;registry.access.redhat.com&quot;,&quot;quay.io&quot;,&quot;harbor.od.com&quot;],</span><br><span class="line">  &quot;bip&quot;: &quot;172.7.21.1/24&quot;,</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;live-restore&quot;: true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里bip要根据宿主机ip变化</p>
<h3 id="启动脚本"><a href="#启动脚本" class="headerlink" title="启动脚本"></a>启动脚本</h3><figure class="highlight plain"><figcaption><span>/usr/lib/systemd/system/docker.service</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line"># the default is not to use systemd for cgroups because the delegate issues still</span><br><span class="line"># exists and systemd currently does not support the cgroup feature set required</span><br><span class="line"># for containers run by docker</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line"># Having non-zero Limit*s causes performance problems due to accounting overhead</span><br><span class="line"># in the kernel. We recommend using cgroups to do container-local accounting.</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line"># Uncomment TasksMax if your systemd version supports it.</span><br><span class="line"># Only systemd 226 and above support this version.</span><br><span class="line">#TasksMax=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line"># set delegate yes so that systemd does not reset the cgroups of docker containers</span><br><span class="line">Delegate=yes</span><br><span class="line"># kill only the docker process, not all processes in the cgroup</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># systemctl enable docker.service</span><br><span class="line"># systemctl start docker.service</span><br></pre></td></tr></table></figure>

<h2 id="部署docker镜像私有仓库harbor"><a href="#部署docker镜像私有仓库harbor" class="headerlink" title="部署docker镜像私有仓库harbor"></a>部署docker镜像私有仓库harbor</h2><p><strong><code>HDSS7-200.host.com</code>上：</strong></p>
<h3 id="下载软件二进制包并解压"><a href="#下载软件二进制包并解压" class="headerlink" title="下载软件二进制包并解压"></a>下载软件二进制包并解压</h3><p><a href="https://storage.googleapis.com/harbor-releases/release-1.7.0/harbor-offline-installer-v1.7.1.tgz" target="_blank" rel="noopener">harbor下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# tar xf harbor-offline-installer-v1.7.1.tgz -C /opt</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# ll</span><br><span class="line">total 583848</span><br><span class="line">drwxr-xr-x 3 root root       242 Jan 23 15:28 harbor</span><br><span class="line">-rw-r--r-- 1 root root 597857483 Jan 17 14:58 harbor-offline-installer-v1.7.1.tgz</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><figcaption><span>/opt/harbor/harbor.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hostname = harbor.od.com</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/opt/harbor/docker-compose.yml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ports:</span><br><span class="line">  - 180:80</span><br><span class="line">  - 1443:443</span><br><span class="line">  - 4443:4443</span><br></pre></td></tr></table></figure>

<h3 id="安装docker-compose"><a href="#安装docker-compose" class="headerlink" title="安装docker-compose"></a>安装docker-compose</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install docker-compose -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa docker-compose</span><br><span class="line">docker-compose-1.18.0-2.el7.noarch</span><br></pre></td></tr></table></figure>

<h3 id="安装harbor"><a href="#安装harbor" class="headerlink" title="安装harbor"></a>安装harbor</h3><figure class="highlight plain"><figcaption><span>/opt/harbor</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# ./install.sh</span><br></pre></td></tr></table></figure>

<h3 id="检查harbor启动情况"><a href="#检查harbor启动情况" class="headerlink" title="检查harbor启动情况"></a>检查harbor启动情况</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# docker-compose ps</span><br><span class="line">       Name                     Command               State                                 Ports                               </span><br><span class="line">--------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">harbor-adminserver   /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-core          /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-db            /entrypoint.sh postgres          Up      5432/tcp                                                          </span><br><span class="line">harbor-jobservice    /harbor/start.sh                 Up                                                                        </span><br><span class="line">harbor-log           /bin/sh -c /usr/local/bin/ ...   Up      127.0.0.1:1514-&gt;10514/tcp                                         </span><br><span class="line">harbor-portal        nginx -g daemon off;             Up      80/tcp                                                            </span><br><span class="line">nginx                nginx -g daemon off;             Up      0.0.0.0:1443-&gt;443/tcp, 0.0.0.0:4443-&gt;4443/tcp, 0.0.0.0:180-&gt;80/tcp</span><br><span class="line">redis                docker-entrypoint.sh redis ...   Up      6379/tcp                                                          </span><br><span class="line">registry             /entrypoint.sh /etc/regist ...   Up      5000/tcp                                                          </span><br><span class="line">registryctl          /harbor/start.sh                 Up</span><br></pre></td></tr></table></figure>

<h3 id="配置harbor的dns内网解析"><a href="#配置harbor的dns内网解析" class="headerlink" title="配置harbor的dns内网解析"></a>配置harbor的dns内网解析</h3><figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">harbor	60 IN A 10.4.7.200</span><br></pre></td></tr></table></figure>

<p>检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# dig -t A harbor.od.com @10.4.7.11 +short</span><br><span class="line">10.4.7.200</span><br></pre></td></tr></table></figure>

<h3 id="安装nginx并配置"><a href="#安装nginx并配置" class="headerlink" title="安装nginx并配置"></a>安装nginx并配置</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# yum install nginx -y</span><br><span class="line">[root@hdss7-200 harbor]# rpm -qa nginx</span><br><span class="line">nginx-1.12.2-2.el7.x86_64</span><br></pre></td></tr></table></figure>

<h4 id="配置-2"><a href="#配置-2" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/harbor.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  harbor.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs/harbor.od.com.pem&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs/harbor.od.com-key.pem&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    client_max_body_size 1000m;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://127.0.0.1:180;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>这里需要自签ssl证书，自签过程略</p>
<blockquote>
<p>(umask 077; openssl genrsa -out od.key 2048)<br>openssl req -new -key od.key -out od.csr -subj “/CN=*.od.com/ST=Beijing/L=beijing/O=od/OU=ops”<br>openssl x509 -req -in od.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out od.crt -days 365</p>
</blockquote>
<h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 harbor]# nginx</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 harbor]# netstat -luntp|grep nginx</span><br><span class="line">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      6590/nginx: master  </span><br><span class="line">tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      6590/nginx: master</span><br></pre></td></tr></table></figure>

<h3 id="浏览器打开http-harbor-od-com"><a href="#浏览器打开http-harbor-od-com" class="headerlink" title="浏览器打开http://harbor.od.com"></a>浏览器打开<a href="http://harbor.od.com" target="_blank" rel="noopener">http://harbor.od.com</a></h3><ul>
<li>用户名：admin</li>
<li>密码： Harbor12345</li>
</ul>
<h1 id="部署Master节点服务"><a href="#部署Master节点服务" class="headerlink" title="部署Master节点服务"></a>部署Master节点服务</h1><h2 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h2><h3 id="集群规划"><a href="#集群规划" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-12.host.com</td>
<td>etcd lead</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>etcd follow</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>etcd follow</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-12.host.com</code>主机为例，另外两台主机安装部署方法类似</p>
<h3 id="创建生成证书签名请求（csr）的JSON配置文件"><a href="#创建生成证书签名请求（csr）的JSON配置文件" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/certs/etcd-peer-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd-peer&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;10.4.7.11&quot;,</span><br><span class="line">        &quot;10.4.7.12&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="生成etcd证书和私钥"><a href="#生成etcd证书和私钥" class="headerlink" title="生成etcd证书和私钥"></a>生成etcd证书和私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=peer etcd-peer-csr.json | cfssljson -bare etcd-peer</span><br><span class="line">2019/01/18 09:35:09 [INFO] generate received request</span><br><span class="line">2019/01/18 09:35:09 [INFO] received CSR</span><br><span class="line">2019/01/18 09:35:09 [INFO] generating key: rsa-2048</span><br><span class="line"></span><br><span class="line">2019/01/18 09:35:09 [INFO] encoded CSR</span><br><span class="line">2019/01/18 09:35:10 [INFO] signed certificate with serial number 324191491384928915605254764031096067872154649010</span><br><span class="line">2019/01/18 09:35:10 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h3 id="检查生成的证书、私钥"><a href="#检查生成的证书、私钥" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h3><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep etcd</span><br><span class="line">-rw-r--r-- 1 root root  387 Jan 18 12:32 etcd-peer-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 18 12:32 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1074 Jan 18 12:32 etcd-peer.csr</span><br><span class="line">-rw-r--r-- 1 root root 1432 Jan 18 12:32 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd用户"><a href="#创建etcd用户" class="headerlink" title="创建etcd用户"></a>创建etcd用户</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# useradd -s /sbin/nologin -M etcd</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接"><a href="#下载软件，解压，做软连接" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><a href="https://github.com/etcd-io/etcd/releases/download/v3.1.8/etcd-v3.1.8-linux-amd64.tar.gz" target="_blank" rel="noopener">etcd下载地址</a><br><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# ls -l</span><br><span class="line">total 9604</span><br><span class="line">-rw-r--r-- 1 root root 9831476 Jan 18 10:45 etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-12 src]# tar xf etcd-v3.1.18-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-12 src]# ln -s /opt/etcd-v3.1.18-linux-amd64 /opt/etcd</span><br><span class="line">[root@hdss7-12 src]# ls -l /opt</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root   root   24 Jan 18 14:21 etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">drwxr-xr-x 4 478493 89939 166 Jun 16  2018 etcd-v3.1.18-linux-amd64</span><br><span class="line">drwxr-xr-x 2 root   root   45 Jan 18 14:21 src</span><br></pre></td></tr></table></figure>

<h3 id="创建目录，拷贝证书、私钥"><a href="#创建目录，拷贝证书、私钥" class="headerlink" title="创建目录，拷贝证书、私钥"></a>创建目录，拷贝证书、私钥</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 src]# mkdir -p /data/etcd /data/logs/etcd-server </span><br><span class="line">[root@hdss7-12 src]# chown -R etcd.etcd /data/etcd /data/logs/etcd-server/</span><br><span class="line">[root@hdss7-12 src]# mkdir -p /opt/etcd/certs</span><br></pre></td></tr></table></figure>

<p>将运维主机上生成的<code>ca.pem</code>、<code>etcd-peer-key.pem</code>、<code>etcd-peer.pem</code>拷贝到<code>/opt/etcd/certs</code>目录中，注意私钥文件权限600</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod 600 etcd-peer-key.pem</span><br><span class="line">[root@hdss7-12 certs]# chown -R etcd.etcd /opt/etcd/certs/</span><br><span class="line">[root@hdss7-12 certs]# ls -l</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1354 Jan 18 14:45 ca.pem</span><br><span class="line">-rw------- 1 etcd etcd 1679 Jan 18 17:00 etcd-peer-key.pem</span><br><span class="line">-rw-r--r-- 1 etcd etcd 1444 Jan 18 17:02 etcd-peer.pem</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd服务启动脚本"><a href="#创建etcd服务启动脚本" class="headerlink" title="创建etcd服务启动脚本"></a>创建etcd服务启动脚本</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd/etcd-server-startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./etcd --name etcd-server-7-12 \</span><br><span class="line">       --data-dir /data/etcd/etcd-server \</span><br><span class="line">       --listen-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --listen-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --quota-backend-bytes 8000000000 \</span><br><span class="line">       --initial-advertise-peer-urls https://10.4.7.12:2380 \</span><br><span class="line">       --advertise-client-urls https://10.4.7.12:2379,http://127.0.0.1:2379 \</span><br><span class="line">       --initial-cluster  etcd-server-7-12=https://10.4.7.12:2380,etcd-server-7-21=https://10.4.7.21:2380,etcd-server-7-22=https://10.4.7.22:2380 \</span><br><span class="line">       --ca-file ./certs/ca.pem \</span><br><span class="line">       --cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --client-cert-auth  \</span><br><span class="line">       --trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-ca-file ./certs/ca.pem \</span><br><span class="line">       --peer-cert-file ./certs/etcd-peer.pem \</span><br><span class="line">       --peer-key-file ./certs/etcd-peer-key.pem \</span><br><span class="line">       --peer-client-cert-auth \</span><br><span class="line">       --peer-trusted-ca-file ./certs/ca.pem \</span><br><span class="line">       --log-output stdout</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="调整权限和目录"><a href="#调整权限和目录" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# chmod +x /opt/etcd/etcd-server-startup.sh</span><br><span class="line">[root@hdss7-12 certs]# mkdir -p /data/logs/etcd-server</span><br></pre></td></tr></table></figure>

<h3 id="安装supervisor软件"><a href="#安装supervisor软件" class="headerlink" title="安装supervisor软件"></a>安装supervisor软件</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# yum install supervisor -y</span><br><span class="line">[root@hdss7-12 certs]# systemctl start supervisord</span><br><span class="line">[root@hdss7-12 certs]# systemctl enable supervisord</span><br></pre></td></tr></table></figure>

<h3 id="创建etcd-server的启动配置"><a href="#创建etcd-server的启动配置" class="headerlink" title="创建etcd-server的启动配置"></a>创建etcd-server的启动配置</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/etcd-server.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:etcd-server-7-12]</span><br><span class="line">command=/opt/etcd/etcd-server-startup.sh                        ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/etcd                                             ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=etcd                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/etcd-server/etcd.stdout.log           ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/etcd-server/etcd.stderr.log           ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                     ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>etcd集群各主机启动配置略有不同，配置其他节点时注意修改。</p>
<h3 id="启动etcd服务并检查"><a href="#启动etcd服务并检查" class="headerlink" title="启动etcd服务并检查"></a>启动etcd服务并检查</h3><p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 certs]# supervisorctl start all</span><br><span class="line">etcd-server-7-12: started</span><br><span class="line">[root@hdss7-12 certs]# supervisorctl status   </span><br><span class="line">etcd-server-7-12                 RUNNING   pid 6692, uptime 0:00:05</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的etcd服务"><a href="#安装部署启动检查所有集群规划主机上的etcd服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的etcd服务"></a>安装部署启动检查所有集群规划主机上的etcd服务</h3><p>略</p>
<h3 id="检查集群状态"><a href="#检查集群状态" class="headerlink" title="检查集群状态"></a>检查集群状态</h3><p>3台均启动后，检查集群状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl cluster-health</span><br><span class="line">member 988139385f78284 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member 5a0ef2a004fc4349 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">member f4a0cb0a765574a8 is healthy: got healthy result from http://127.0.0.1:2379</span><br><span class="line">cluster is healthy</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# /opt/etcd/etcdctl member list</span><br><span class="line">988139385f78284: name=etcd-server-7-22 peerURLs=https://10.4.7.22:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.22:2379 isLeader=false</span><br><span class="line">5a0ef2a004fc4349: name=etcd-server-7-21 peerURLs=https://10.4.7.21:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.21:2379 isLeader=false</span><br><span class="line">f4a0cb0a765574a8: name=etcd-server-7-12 peerURLs=https://10.4.7.12:2380 clientURLs=http://127.0.0.1:2379,https://10.4.7.12:2379 isLeader=true</span><br></pre></td></tr></table></figure>

<h2 id="部署kube-apiserver集群"><a href="#部署kube-apiserver集群" class="headerlink" title="部署kube-apiserver集群"></a>部署kube-apiserver集群</h2><h3 id="集群规划-1"><a href="#集群规划-1" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-apiserver</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-11.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>4层负载均衡</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td><strong>注意：</strong>这里<code>10.4.7.11</code>和<code>10.4.7.12</code>使用nginx做4层负载均衡器，用keepalived跑一个vip：10.4.7.10，代理两个kube-apiserver，实现高可用</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="下载软件，解压，做软连接-1"><a href="#下载软件，解压，做软连接-1" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code>上：<br><a href="https://dl.k8s.io/v1.13.5/kubernetes-server-linux-amd64.tar.gz" target="_blank" rel="noopener">kubernetes下载地址</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# ls -l|grep kubernetes</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 16:46 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# tar xf kubernetes-server-linux-amd64.tar.gz -C /opt</span><br><span class="line">[root@hdss7-21 src]# mv /opt/kubernetes /opt/kubernetes-v1.13.2-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/kubernetes-v1.13.2-linux-amd64 /opt/kubernetes</span><br><span class="line">[root@hdss7-21 src]# mkdir /opt/kubernetes/server/bin/&#123;cert,conf&#125;</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep kubernetes</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 18 10:49 kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 17:40 kubernetes-v1.13.2-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="签发client证书"><a href="#签发client证书" class="headerlink" title="签发client证书"></a>签发client证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-1"><a href="#创建生成证书签名请求（csr）的JSON配置文件-1" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/client-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;k8s-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成client证书和私钥"><a href="#生成client证书和私钥" class="headerlink" title="生成client证书和私钥"></a>生成client证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client client-csr.json | cfssljson -bare client</span><br><span class="line">2019/01/18 14:02:50 [INFO] generate received request</span><br><span class="line">2019/01/18 14:02:50 [INFO] received CSR</span><br><span class="line">2019/01/18 14:02:50 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:02:51 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:02:51 [INFO] signed certificate with serial number 423108651040279300242366884100637974155370861448</span><br><span class="line">2019/01/18 14:02:51 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-1"><a href="#检查生成的证书、私钥-1" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep client</span><br><span class="line">-rw------- 1 root root 1679 Jan 21 11:13 client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root  989 Jan 21 11:13 client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1367 Jan 21 11:13 client.pem</span><br></pre></td></tr></table></figure>

<h3 id="签发kube-apiserver证书"><a href="#签发kube-apiserver证书" class="headerlink" title="签发kube-apiserver证书"></a>签发kube-apiserver证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-2"><a href="#创建生成证书签名请求（csr）的JSON配置文件-2" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/apiserver-csr.json </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;apiserver&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.0.1&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;,</span><br><span class="line">        &quot;10.4.7.10&quot;,</span><br><span class="line">        &quot;10.4.7.21&quot;,</span><br><span class="line">        &quot;10.4.7.22&quot;,</span><br><span class="line">        &quot;10.4.7.23&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-apiserver证书和私钥"><a href="#生成kube-apiserver证书和私钥" class="headerlink" title="生成kube-apiserver证书和私钥"></a>生成kube-apiserver证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server apiserver-csr.json | cfssljson -bare apiserver </span><br><span class="line">2019/01/18 14:05:44 [INFO] generate received request</span><br><span class="line">2019/01/18 14:05:44 [INFO] received CSR</span><br><span class="line">2019/01/18 14:05:44 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 14:05:46 [INFO] encoded CSR</span><br><span class="line">2019/01/18 14:05:46 [INFO] signed certificate with serial number 633406650960616624590510576685608580490218676227</span><br><span class="line">2019/01/18 14:05:46 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-2"><a href="#检查生成的证书、私钥-2" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep apiserver</span><br><span class="line">total 72</span><br><span class="line">-rw-r--r-- 1 root root  406 Jan 21 14:10 apiserver-csr.json</span><br><span class="line">-rw------- 1 root root 1675 Jan 21 14:11 apiserver-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1082 Jan 21 14:11 apiserver.csr</span><br><span class="line">-rw-r--r-- 1 root root 1599 Jan 21 14:11 apiserver.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置"><a href="#拷贝证书至各运算节点，并创建配置" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600"><a href="#拷贝证书、私钥，注意私钥文件属性600" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置"><a href="#创建配置" class="headerlink" title="创建配置"></a>创建配置</h4><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/audit.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: audit.k8s.io/v1beta1 # This is required.</span><br><span class="line">kind: Policy</span><br><span class="line"># Don&apos;t generate audit events for all requests in RequestReceived stage.</span><br><span class="line">omitStages:</span><br><span class="line">  - &quot;RequestReceived&quot;</span><br><span class="line">rules:</span><br><span class="line">  # Log pod changes at RequestResponse level</span><br><span class="line">  - level: RequestResponse</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      # Resource &quot;pods&quot; doesn&apos;t match requests to any subresource of pods,</span><br><span class="line">      # which is consistent with the RBAC policy.</span><br><span class="line">      resources: [&quot;pods&quot;]</span><br><span class="line">  # Log &quot;pods/log&quot;, &quot;pods/status&quot; at Metadata level</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;pods/log&quot;, &quot;pods/status&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log requests to a configmap called &quot;controller-leader&quot;</span><br><span class="line">  - level: None</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot;</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">      resourceNames: [&quot;controller-leader&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log watch requests by the &quot;system:kube-proxy&quot; on endpoints or services</span><br><span class="line">  - level: None</span><br><span class="line">    users: [&quot;system:kube-proxy&quot;]</span><br><span class="line">    verbs: [&quot;watch&quot;]</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;endpoints&quot;, &quot;services&quot;]</span><br><span class="line"></span><br><span class="line">  # Don&apos;t log authenticated requests to certain non-resource URL paths.</span><br><span class="line">  - level: None</span><br><span class="line">    userGroups: [&quot;system:authenticated&quot;]</span><br><span class="line">    nonResourceURLs:</span><br><span class="line">    - &quot;/api*&quot; # Wildcard matching.</span><br><span class="line">    - &quot;/version&quot;</span><br><span class="line"></span><br><span class="line">  # Log the request body of configmap changes in kube-system.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;configmaps&quot;]</span><br><span class="line">    # This rule only applies to resources in the &quot;kube-system&quot; namespace.</span><br><span class="line">    # The empty string &quot;&quot; can be used to select non-namespaced resources.</span><br><span class="line">    namespaces: [&quot;kube-system&quot;]</span><br><span class="line"></span><br><span class="line">  # Log configmap and secret changes in all other namespaces at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">      resources: [&quot;secrets&quot;, &quot;configmaps&quot;]</span><br><span class="line"></span><br><span class="line">  # Log all other resources in core and extensions at the Request level.</span><br><span class="line">  - level: Request</span><br><span class="line">    resources:</span><br><span class="line">    - group: &quot;&quot; # core API group</span><br><span class="line">    - group: &quot;extensions&quot; # Version of group should NOT be included.</span><br><span class="line"></span><br><span class="line">  # A catch-all rule to log all other requests at the Metadata level.</span><br><span class="line">  - level: Metadata</span><br><span class="line">    # Long-running requests like watches that fall under this rule will not</span><br><span class="line">    # generate an audit event in RequestReceived.</span><br><span class="line">    omitStages:</span><br><span class="line">      - &quot;RequestReceived&quot;</span><br></pre></td></tr></table></figure>

<h3 id="创建启动脚本"><a href="#创建启动脚本" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-apiserver.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">./kube-apiserver \</span><br><span class="line">  --apiserver-count 2 \</span><br><span class="line">  --audit-log-path /data/logs/kubernetes/kube-apiserver/audit-log \</span><br><span class="line">  --audit-policy-file ./conf/audit.yaml \</span><br><span class="line">  --authorization-mode RBAC \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --requestheader-client-ca-file ./cert/ca.pem \</span><br><span class="line">  --enable-admission-plugins NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,ResourceQuota \</span><br><span class="line">  --etcd-cafile ./cert/ca.pem \</span><br><span class="line">  --etcd-certfile ./cert/client.pem \</span><br><span class="line">  --etcd-keyfile ./cert/client-key.pem \</span><br><span class="line">  --etcd-servers https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --service-account-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --service-node-port-range 3000-29999 \</span><br><span class="line">  --target-ram-mb=1024 \</span><br><span class="line">  --kubelet-client-certificate ./cert/client.pem \</span><br><span class="line">  --kubelet-client-key ./cert/client-key.pem \</span><br><span class="line">  --log-dir  /data/logs/kubernetes/kube-apiserver \</span><br><span class="line">  --tls-cert-file ./cert/apiserver.pem \</span><br><span class="line">  --tls-private-key-file ./cert/apiserver-key.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整权限和目录-1"><a href="#调整权限和目录-1" class="headerlink" title="调整权限和目录"></a>调整权限和目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-apiserver.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-apiserver</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置"><a href="#创建supervisor配置" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-apiserver.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-apiserver]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-apiserver.sh            ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                      ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                            ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                  ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                    ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                   ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                 ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                 ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                       ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stdout.log        ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-apiserver/apiserver.stderr.log        ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                     ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                     ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查"><a href="#启动服务并检查" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-apiserverr: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-apiserver"><a href="#安装部署启动检查所有集群规划主机上的kube-apiserver" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-apiserver"></a>安装部署启动检查所有集群规划主机上的kube-apiserver</h3><p>略</p>
<h3 id="配4层反向代理"><a href="#配4层反向代理" class="headerlink" title="配4层反向代理"></a>配4层反向代理</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<h4 id="nginx配置"><a href="#nginx配置" class="headerlink" title="nginx配置"></a>nginx配置</h4><figure class="highlight plain"><figcaption><span>/etc/nginx/nginx.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">    upstream kube-apiserver &#123;</span><br><span class="line">        server 10.4.7.21:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 10.4.7.22:6443     max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 7443;</span><br><span class="line">        proxy_connect_timeout 2s;</span><br><span class="line">        proxy_timeout 900s;</span><br><span class="line">        proxy_pass kube-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="keepalived配置"><a href="#keepalived配置" class="headerlink" title="keepalived配置"></a>keepalived配置</h4><h5 id="check-port-sh"><a href="#check-port-sh" class="headerlink" title="check_port.sh"></a>check_port.sh</h5><figure class="highlight plain"><figcaption><span>/etc/keepalived/check_port.sh </span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#keepalived 监控端口脚本</span><br><span class="line">#使用方法：</span><br><span class="line">#在keepalived的配置文件中</span><br><span class="line">#vrrp_script check_port &#123;#创建一个vrrp_script脚本,检查配置</span><br><span class="line">#    script &quot;/etc/keepalived/check_port.sh 6379&quot; #配置监听的端口</span><br><span class="line">#    interval 2 #检查脚本的频率,单位（秒）</span><br><span class="line">#&#125;</span><br><span class="line">CHK_PORT=$1</span><br><span class="line">if [ -n &quot;$CHK_PORT&quot; ];then</span><br><span class="line">        PORT_PROCESS=`ss -lt|grep $CHK_PORT|wc -l`</span><br><span class="line">        if [ $PORT_PROCESS -eq 0 ];then</span><br><span class="line">                echo &quot;Port $CHK_PORT Is Not Used,End.&quot;</span><br><span class="line">                exit 1</span><br><span class="line">        fi</span><br><span class="line">else</span><br><span class="line">        echo &quot;Check Port Cant Be Empty!&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<h5 id="keepalived主"><a href="#keepalived主" class="headerlink" title="keepalived主"></a>keepalived主</h5><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id 10.4.7.11</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">    interval 2</span><br><span class="line">    weight -20</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 251</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    mcast_src_ip 10.4.7.11</span><br><span class="line">    nopreempt</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">         chk_nginx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.4.7.10</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="keepalived备"><a href="#keepalived备" class="headerlink" title="keepalived备"></a>keepalived备</h5><p><code>HDSS7-12.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# rpm -qa keepalived</span><br><span class="line">keepalived-1.3.5-6.el7.x86_64</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><figcaption><span>/etc/keepalived/keepalived.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line">global_defs &#123;</span><br><span class="line">	router_id 10.4.7.12</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_nginx &#123;</span><br><span class="line">	script &quot;/etc/keepalived/check_port.sh 7443&quot;</span><br><span class="line">	interval 2</span><br><span class="line">	weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state BACKUP</span><br><span class="line">	interface eth0</span><br><span class="line">	virtual_router_id 251</span><br><span class="line">	mcast_src_ip 10.4.7.12</span><br><span class="line">	priority 90</span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 11111111</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		chk_nginx</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		10.4.7.10</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动代理并检查"><a href="#启动代理并检查" class="headerlink" title="启动代理并检查"></a>启动代理并检查</h3><p><code>HDSS7-11.host.com</code>,<code>HDSS7-12.host.com</code>上：</p>
<ul>
<li><p>启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-11 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-11 ~]# nginx -s reload</span><br><span class="line"></span><br><span class="line">[root@hdss7-12 ~]# systemctl start keepalived</span><br><span class="line">[root@hdss7-12 ~]# systemctl enable keepalived</span><br><span class="line">[root@hdss7-12 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>检查</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-12 ~]## netstat -luntp|grep 7443</span><br><span class="line">tcp        0      0 0.0.0.0:7443            0.0.0.0:*               LISTEN      17970/nginx: master</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    inet 10.9.7.10/32 scope global vir0</span><br><span class="line">[root@hdss7-11 ~]# ip add|grep 10.4.9.10</span><br><span class="line">    （空）</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="部署controller-manager"><a href="#部署controller-manager" class="headerlink" title="部署controller-manager"></a>部署controller-manager</h2><h3 id="集群规划-2"><a href="#集群规划-2" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>controller-manager</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>controller-manager</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-1"><a href="#创建启动脚本-1" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-controller-manager.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-controller-manager \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --leader-elect true \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-controller-manager \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --service-account-private-key-file ./cert/ca-key.pem \</span><br><span class="line">  --service-cluster-ip-range 192.168.0.0/16 \</span><br><span class="line">  --root-ca-file ./cert/ca.pem \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录"><a href="#调整文件权限，创建目录" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-controller-manager.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-controller-manager</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-1"><a href="#创建supervisor配置-1" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-conntroller-manager.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-controller-manager]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-controller-manager.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                                  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                                      ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                                    ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                                     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                                   ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                                   ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                                             ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-controller-manager/controll.stdout.log  ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                                       ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-controller-manager/controll.stderr.log  ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                                          ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                                       ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-1"><a href="#启动服务并检查-1" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-controller-manager: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status   </span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"><a href="#安装部署启动检查所有集群规划主机上的kube-controller-manager服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-controller-manager服务"></a>安装部署启动检查所有集群规划主机上的kube-controller-manager服务</h3><p>略</p>
<h2 id="部署kube-scheduler"><a href="#部署kube-scheduler" class="headerlink" title="部署kube-scheduler"></a>部署kube-scheduler</h2><h3 id="集群规划-3"><a href="#集群规划-3" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-scheduler</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="创建启动脚本-2"><a href="#创建启动脚本-2" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-scheduler.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-scheduler \</span><br><span class="line">  --leader-elect  \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-scheduler \</span><br><span class="line">  --master http://127.0.0.1:8080 \</span><br><span class="line">  --v 2</span><br></pre></td></tr></table></figure>

<h3 id="调整文件权限，创建目录-1"><a href="#调整文件权限，创建目录-1" class="headerlink" title="调整文件权限，创建目录"></a>调整文件权限，创建目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# chmod +x /opt/kubernetes/server/bin/kube-scheduler.sh</span><br><span class="line">[root@hdss7-21 bin]# mkdir -p /data/logs/kubernetes/kube-scheduler</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-2"><a href="#创建supervisor配置-2" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-scheduler.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-scheduler]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-scheduler.sh                     ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                               ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                     ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                           ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                         ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                             ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                           ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                            ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                          ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                          ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                                ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                                    ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stdout.log ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                                 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                              ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                              ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-scheduler/scheduler.stderr.log ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                             ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                                 ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                              ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                              ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-2"><a href="#启动服务并检查-2" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-scheduler: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 6661, uptime 1 day, 8:41:13</span><br><span class="line">kube-apiserver                   RUNNING   pid 43765, uptime 2:09:41</span><br><span class="line">kube-controller-manager          RUNNING   pid 44230, uptime 2:05:01</span><br><span class="line">kube-scheduler                   RUNNING   pid 44779, uptime 2:02:27</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-scheduler服务"><a href="#安装部署启动检查所有集群规划主机上的kube-scheduler服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-scheduler服务"></a>安装部署启动检查所有集群规划主机上的kube-scheduler服务</h3><p>略</p>
<h1 id="部署Node节点服务"><a href="#部署Node节点服务" class="headerlink" title="部署Node节点服务"></a>部署Node节点服务</h1><h2 id="部署kubelet"><a href="#部署kubelet" class="headerlink" title="部署kubelet"></a>部署kubelet</h2><h3 id="集群规划-4"><a href="#集群规划-4" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kubelet</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kubelet</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kubelet证书"><a href="#签发kubelet证书" class="headerlink" title="签发kubelet证书"></a>签发kubelet证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-3"><a href="#创建生成证书签名请求（csr）的JSON配置文件-3" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>kubelet-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubelet-node&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;10.4.7.10&quot;,</span><br><span class="line">    &quot;10.4.7.21&quot;,</span><br><span class="line">    &quot;10.4.7.22&quot;,</span><br><span class="line">    &quot;10.4.7.23&quot;,</span><br><span class="line">    &quot;10.4.7.24&quot;,</span><br><span class="line">    &quot;10.4.7.25&quot;,</span><br><span class="line">    &quot;10.4.7.26&quot;,</span><br><span class="line">    &quot;10.4.7.27&quot;,</span><br><span class="line">    &quot;10.4.7.28&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kubelet证书和私钥"><a href="#生成kubelet证书和私钥" class="headerlink" title="生成kubelet证书和私钥"></a>生成kubelet证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=server kubelet-csr.json | cfssljson -bare kubelet</span><br><span class="line">2019/01/18 17:51:16 [INFO] generate received request</span><br><span class="line">2019/01/18 17:51:16 [INFO] received CSR</span><br><span class="line">2019/01/18 17:51:16 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 17:51:17 [INFO] encoded CSR</span><br><span class="line">2019/01/18 17:51:17 [INFO] signed certificate with serial number 48870268157415133698067712395152321546974943470</span><br><span class="line">2019/01/18 17:51:17 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-3"><a href="#检查生成的证书、私钥-3" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kubelet</span><br><span class="line">total 88</span><br><span class="line">-rw-r--r-- 1 root root  415 Jan 22 16:58 kubelet-csr.json</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:00 kubelet-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1086 Jan 22 17:00 kubelet.csr</span><br><span class="line">-rw-r--r-- 1 root root 1456 Jan 22 17:00 kubelet.pem</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-1"><a href="#拷贝证书至各运算节点，并创建配置-1" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-1"><a href="#拷贝证书、私钥，注意私钥文件属性600-1" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-1"><a href="#创建配置-1" class="headerlink" title="创建配置"></a>创建配置</h4><p><code>HDSS7-21.host.com</code>上：</p>
<h5 id="给kubectl创建软连接"><a href="#给kubectl创建软连接" class="headerlink" title="给kubectl创建软连接"></a>给kubectl创建软连接</h5><figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# ln -s /opt/kubernetes/server/bin/kubectl /usr/bin/kubectl</span><br><span class="line">[root@hdss7-21 bin]# which kubectl</span><br><span class="line">/usr/bin/kubectl</span><br></pre></td></tr></table></figure>

<h5 id="set-cluster"><a href="#set-cluster" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials"><a href="#set-credentials" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials k8s-node --client-certificate=/opt/kubernetes/server/bin/cert/client.pem --client-key=/opt/kubernetes/server/bin/cert/client-key.pem --embed-certs=true --kubeconfig=kubelet.kubeconfig </span><br><span class="line"></span><br><span class="line">User &quot;k8s-node&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context"><a href="#set-context" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=k8s-node \</span><br><span class="line">  --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context"><a href="#use-context" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h5 id="k8s-node-yaml"><a href="#k8s-node-yaml" class="headerlink" title="k8s-node.yaml"></a>k8s-node.yaml</h5><ul>
<li>创建资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf/k8s-node.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: k8s-node</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:node</span><br><span class="line">subjects:</span><br><span class="line">- apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: User</span><br><span class="line">  name: k8s-node</span><br></pre></td></tr></table></figure>

<ul>
<li>应用资源配置文件</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl create -f k8s-node.yaml</span><br><span class="line"></span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/k8s-node created</span><br></pre></td></tr></table></figure>

<ul>
<li>检查</li>
</ul>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl get clusterrolebinding k8s-node</span><br><span class="line">NAME           AGE</span><br><span class="line">k8s-node       3m</span><br></pre></td></tr></table></figure>

<h3 id="准备infra-pod基础镜像"><a href="#准备infra-pod基础镜像" class="headerlink" title="准备infra_pod基础镜像"></a>准备infra_pod基础镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull xplenty/rhel7-pod-infrastructure:v3.4</span><br><span class="line">Trying to pull repository docker.io/xplenty/rhel7-pod-infrastructure ... </span><br><span class="line">sha256:9314554780673b821cb7113d8c048a90d15077c6e7bfeebddb92a054a1f84843: Pulling from docker.io/xplenty/rhel7-pod-infrastructure</span><br><span class="line">615bc035f9f8: Pull complete </span><br><span class="line">1c5fd9dfeaa8: Pull complete </span><br><span class="line">7653a8c7f937: Pull complete </span><br><span class="line">Digest: sha256:9314554780673b821cb7113d8c048a90d15077c6e7bfeebddb92a054a1f84843</span><br><span class="line">Status: Downloaded newer image for docker.io/xplenty/rhel7-pod-infrastructure:v3.4</span><br></pre></td></tr></table></figure>

<h4 id="提交至私有仓库（harbor）中"><a href="#提交至私有仓库（harbor）中" class="headerlink" title="提交至私有仓库（harbor）中"></a>提交至私有仓库（harbor）中</h4><ul>
<li>配置主机登录私有仓库</li>
</ul>
<figure class="highlight plain"><figcaption><span>/root/.docker/config.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;auths&quot;: &#123;</span><br><span class="line">		&quot;harbor.od.com&quot;: &#123;</span><br><span class="line">			&quot;auth&quot;: &quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这里代表：用户名admin，密码Harbor12345<br>[root@hdss7-200 ~]# echo YWRtaW46SGFyYm9yMTIzNDU=|base64 -d<br>admin:Harbor12345</p>
</blockquote>
<p><strong>注意：</strong>也可以在各运算节点使用docker login harbor.od.com，输入用户名，密码</p>
<ul>
<li>给镜像打tag</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker images|grep v3.4</span><br><span class="line">xplenty/rhel7-pod-infrastructure   v3.4                34d3450d733b        2 years ago         205 MB</span><br><span class="line">[root@hdss7-200 ~]# docker tag 34d3450d733b harbor.od.com/k8s/pod:v3.4</span><br></pre></td></tr></table></figure>

<ul>
<li>push到harbor</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/pod:v3.4</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/pod]</span><br><span class="line">ba3d4cbbb261: Pushed </span><br><span class="line">0a081b45cb84: Pushed </span><br><span class="line">df9d2808b9a9: Pushed </span><br><span class="line">v3.4: digest: sha256:73cc48728e707b74f99d17b4e802d836e22d373aee901fdcaa781b056cdabf5c size: 948</span><br></pre></td></tr></table></figure>

<h3 id="创建kubelet启动脚本"><a href="#创建kubelet启动脚本" class="headerlink" title="创建kubelet启动脚本"></a>创建kubelet启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kubelet-721.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kubelet \</span><br><span class="line">  --anonymous-auth=false \</span><br><span class="line">  --cgroup-driver systemd \</span><br><span class="line">  --cluster-dns 192.168.0.2 \</span><br><span class="line">  --cluster-domain cluster.local \</span><br><span class="line">  --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice \</span><br><span class="line">  --fail-swap-on=&quot;false&quot; \</span><br><span class="line">  --client-ca-file ./cert/ca.pem \</span><br><span class="line">  --tls-cert-file ./cert/kubelet.pem \</span><br><span class="line">  --tls-private-key-file ./cert/kubelet-key.pem \</span><br><span class="line">  --hostname-override 10.4.7.21 \</span><br><span class="line">  --image-gc-high-threshold 20 \</span><br><span class="line">  --image-gc-low-threshold 10 \</span><br><span class="line">  --kubeconfig ./conf/kubelet.kubeconfig \</span><br><span class="line">  --log-dir /data/logs/kubernetes/kube-kubelet \</span><br><span class="line">  --pod-infra-container-image harbor.od.com/k8s/pod:v3.4 \</span><br><span class="line">  --root-dir /data/kubelet</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kubelet集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录"><a href="#检查配置，权限，创建日志目录" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kubelet.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kubelet.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kubelet-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-kubelet /data/kubelet</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-3"><a href="#创建supervisor配置-3" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-kubelet.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-kubelet]</span><br><span class="line">command=/opt/kubernetes/server/bin/kubelet-721.sh                 ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                        ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                              ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                    ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true              									  ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                  									  ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                									  ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                 									  ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT               									  ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10               									  ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                             ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stdout.log   ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                          ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                       ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                       ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-kubelet/kubelet.stderr.log   ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                      ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                          ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB   									  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false   									  ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-3"><a href="#启动服务并检查-3" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-kubelet: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="检查运算节点"><a href="#检查运算节点" class="headerlink" title="检查运算节点"></a>检查运算节点</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# kubectl get node</span><br><span class="line">NAME        STATUS   ROLES    AGE   VERSION</span><br><span class="line">10.4.7.21   Ready    &lt;none&gt;   3m   v1.13.2</span><br></pre></td></tr></table></figure>

<p><strong>非常重要！</strong></p>
<h3 id="安装部署启动检查所有集群规划主机上的kubelet服务"><a href="#安装部署启动检查所有集群规划主机上的kubelet服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kubelet服务"></a>安装部署启动检查所有集群规划主机上的kubelet服务</h3><p>略</p>
<h2 id="部署kube-proxy"><a href="#部署kube-proxy" class="headerlink" title="部署kube-proxy"></a>部署kube-proxy</h2><h3 id="集群规划-5"><a href="#集群规划-5" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kube-proxy</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="签发kube-proxy证书"><a href="#签发kube-proxy证书" class="headerlink" title="签发kube-proxy证书"></a>签发kube-proxy证书</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<h4 id="创建生成证书签名请求（csr）的JSON配置文件-4"><a href="#创建生成证书签名请求（csr）的JSON配置文件-4" class="headerlink" title="创建生成证书签名请求（csr）的JSON配置文件"></a>创建生成证书签名请求（csr）的JSON配置文件</h4><figure class="highlight plain"><figcaption><span>/opt/certs/kube-proxy-csr.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;beijing&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;od&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;ops&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="生成kube-proxy证书和私钥"><a href="#生成kube-proxy证书和私钥" class="headerlink" title="生成kube-proxy证书和私钥"></a>生成kube-proxy证书和私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=client kube-proxy-csr.json | cfssljson -bare kube-proxy-client</span><br><span class="line">2019/01/18 18:14:23 [INFO] generate received request</span><br><span class="line">2019/01/18 18:14:23 [INFO] received CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] generating key: rsa-2048</span><br><span class="line">2019/01/18 18:14:23 [INFO] encoded CSR</span><br><span class="line">2019/01/18 18:14:23 [INFO] signed certificate with serial number 375797145588654714099258750873820528127028390681</span><br><span class="line">2019/01/18 18:14:23 [WARNING] This certificate lacks a &quot;hosts&quot; field. This makes it unsuitable for</span><br><span class="line">websites. For more information see the Baseline Requirements for the Issuance and Management</span><br><span class="line">of Publicly-Trusted Certificates, v.1.1.6, from the CA/Browser Forum (https://cabforum.org);</span><br><span class="line">specifically, section 10.2.3 (&quot;Information Requirements&quot;).</span><br></pre></td></tr></table></figure>

<h4 id="检查生成的证书、私钥-4"><a href="#检查生成的证书、私钥-4" class="headerlink" title="检查生成的证书、私钥"></a>检查生成的证书、私钥</h4><figure class="highlight plain"><figcaption><span>/opt/certs</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 certs]# ls -l|grep kube-proxy</span><br><span class="line">-rw------- 1 root root 1679 Jan 22 17:31 kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- 1 root root 1005 Jan 22 17:31 kube-proxy-client.csr</span><br><span class="line">-rw-r--r-- 1 root root 1383 Jan 22 17:31 kube-proxy-client.pem</span><br><span class="line">-rw-r--r-- 1 root root  268 Jan 22 17:23 kube-proxy-csr.json</span><br></pre></td></tr></table></figure>

<h3 id="拷贝证书至各运算节点，并创建配置-2"><a href="#拷贝证书至各运算节点，并创建配置-2" class="headerlink" title="拷贝证书至各运算节点，并创建配置"></a>拷贝证书至各运算节点，并创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<h4 id="拷贝证书、私钥，注意私钥文件属性600-2"><a href="#拷贝证书、私钥，注意私钥文件属性600-2" class="headerlink" title="拷贝证书、私钥，注意私钥文件属性600"></a>拷贝证书、私钥，注意私钥文件属性600</h4><figure class="highlight ls"><figcaption><span>/opt/kubernetes/server/bin/cert</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 cert]<span class="comment"># ls -l /opt/kubernetes/server/bin/cert</span></span><br><span class="line">total <span class="number">40</span></span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1676</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">39</span> apiserver-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1599</span> Jan <span class="number">21</span> <span class="number">16</span>:<span class="number">36</span> apiserver.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1675</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">55</span> ca-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1354</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">50</span> ca.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1368</span> Jan <span class="number">21</span> <span class="number">13</span>:<span class="number">53</span> client.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1456</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">00</span> kubelet.pem</span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">1679</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client-key.pem</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">1383</span> Jan <span class="number">22</span> <span class="number">17</span>:<span class="number">31</span> kube-proxy-client.pem</span><br></pre></td></tr></table></figure>

<h4 id="创建配置-2"><a href="#创建配置-2" class="headerlink" title="创建配置"></a>创建配置</h4><h5 id="set-cluster-1"><a href="#set-cluster-1" class="headerlink" title="set-cluster"></a>set-cluster</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-cluster myk8s \</span><br><span class="line">  --certificate-authority=/opt/kubernetes/server/bin/cert/ca.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --server=https://10.4.7.10:7443 \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Cluster &quot;myk8s&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-credentials-1"><a href="#set-credentials-1" class="headerlink" title="set-credentials"></a>set-credentials</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-credentials kube-proxy \</span><br><span class="line">  --client-certificate=/opt/kubernetes/server/bin/cert/kube-proxy-client.pem \</span><br><span class="line">  --client-key=/opt/kubernetes/server/bin/cert/kube-proxy-client-key.pem \</span><br><span class="line">  --embed-certs=true \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">User &quot;kube-proxy&quot; set.</span><br></pre></td></tr></table></figure>

<h5 id="set-context-1"><a href="#set-context-1" class="headerlink" title="set-context"></a>set-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config set-context myk8s-context \</span><br><span class="line">  --cluster=myk8s \</span><br><span class="line">  --user=kube-proxy \</span><br><span class="line">  --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Context &quot;myk8s-context&quot; created.</span><br></pre></td></tr></table></figure>

<h5 id="use-context-1"><a href="#use-context-1" class="headerlink" title="use-context"></a>use-context</h5><p><strong>注意：</strong>在conf目录下</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# kubectl config use-context myk8s-context --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">Switched to context &quot;myk8s-context&quot;.</span><br></pre></td></tr></table></figure>

<h3 id="创建kube-proxy启动脚本"><a href="#创建kube-proxy启动脚本" class="headerlink" title="创建kube-proxy启动脚本"></a>创建kube-proxy启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/bin/kube-proxy-721.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./kube-proxy \</span><br><span class="line">  --cluster-cidr 172.7.0.0/16 \</span><br><span class="line">  --hostname-override 10.4.7.21 \</span><br><span class="line">  --kubeconfig ./conf/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>kube-proxy集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录-1"><a href="#检查配置，权限，创建日志目录-1" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/kubernetes/server/conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 conf]# ls -l|grep kube-proxy.kubeconfig </span><br><span class="line">-rw------- 1 root root 6471 Jan 22 17:33 kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 conf]# chmod +x /opt/kubernetes/server/bin/kube-proxy-721.sh</span><br><span class="line">[root@hdss7-21 conf]# mkdir -p /data/logs/kubernetes/kube-proxy</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-4"><a href="#创建supervisor配置-4" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/kube-proxy.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:kube-proxy]</span><br><span class="line">command=/opt/kubernetes/server/bin/kube-proxy-721.sh                 ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                           ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/kubernetes/server/bin                                 ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                                       ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                                     ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                                                         ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3                                                       ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2                                                        ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT                                                      ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10                                                      ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                		         ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                           		 ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/kubernetes/kube-proxy/proxy.stdout.log     ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                    		 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                        		 ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                     		 ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                     		 ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/kubernetes/kube-proxy/proxy.stderr.log     ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                    		 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                        		 ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB   						                           ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false   						                           ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-4"><a href="#启动服务并检查-4" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 bin]# supervisorctl update</span><br><span class="line">kube-proxy: added process group</span><br><span class="line">[root@hdss7-21 bin]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 22:44:48</span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 21:10:49</span><br><span class="line">kube-controller-manager          RUNNING   pid 10048, uptime 18:22:10</span><br><span class="line">kube-kubelet                     RUNNING   pid 14597, uptime 0:32:59</span><br><span class="line">kube-proxy                       STARTING  </span><br><span class="line">kube-scheduler                   RUNNING   pid 10041, uptime 18:22:13</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的kube-proxy服务"><a href="#安装部署启动检查所有集群规划主机上的kube-proxy服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的kube-proxy服务"></a>安装部署启动检查所有集群规划主机上的kube-proxy服务</h3><p>略</p>
<h1 id="部署addons插件"><a href="#部署addons插件" class="headerlink" title="部署addons插件"></a>部署addons插件</h1><h2 id="验证kubernetes集群"><a href="#验证kubernetes集群" class="headerlink" title="验证kubernetes集群"></a>验证kubernetes集群</h2><h3 id="在任意一个运算节点，创建一个资源配置清单"><a href="#在任意一个运算节点，创建一个资源配置清单" class="headerlink" title="在任意一个运算节点，创建一个资源配置清单"></a>在任意一个运算节点，创建一个资源配置清单</h3><p>这里我们选择<code>HDSS7-21.host.com</code>主机</p>
<figure class="highlight plain"><figcaption><span>/root/nginx-ds.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-ds</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-ds</span><br><span class="line">  labels:</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-ds</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: my-nginx</span><br><span class="line">        image: nginx:1.7.9</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置，并检查"><a href="#应用资源配置，并检查" class="headerlink" title="应用资源配置，并检查"></a>应用资源配置，并检查</h3><figure class="highlight plain"><figcaption><span>/root</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create -f nginx-ds.yaml</span><br><span class="line">[root@hdss7-21 ~]# kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-ds-6hnc7   1/1     Running   0          99m</span><br><span class="line">nginx-ds-m5q6j   1/1     Running   0          18h</span><br></pre></td></tr></table></figure>

<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>补</p>
<h2 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h2><h3 id="集群规划-6"><a href="#集群规划-6" class="headerlink" title="集群规划"></a>集群规划</h3><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-21.host.com</td>
<td>flannel</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>flannel</td>
<td>10.4.7.22</td>
</tr>
</tbody></table>
<p><strong>注意：</strong>这里部署文档以<code>HDSS7-21.host.com</code>主机为例，另外一台运算节点安装部署方法类似</p>
<h3 id="在各运算节点上增加iptables规则"><a href="#在各运算节点上增加iptables规则" class="headerlink" title="在各运算节点上增加iptables规则"></a>在各运算节点上增加iptables规则</h3><p><strong>注意：</strong>iptables规则各主机的略有不同，其他运算节点上执行时注意修改。</p>
<ul>
<li>优化SNAT规则，各运算节点之间的各POD之间的网络通信不再出网</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># iptables -t nat -D POSTROUTING -s 172.7.21.0/24 ! -o docker0 -j MASQUERADE</span><br><span class="line"># iptables -t nat -I POSTROUTING -s 172.7.21.0/24 ! -d 172.7.0.0/16 ! -o docker0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

<blockquote>
<p>10.4.7.21主机上的，来源是172.7.21.0/24段的docker的ip，目标ip不是172.7.0.0/16段，网络发包不从docker0桥设备出站的，才进行SNAT转换</p>
</blockquote>
<h3 id="各运算节点保存iptables规则"><a href="#各运算节点保存iptables规则" class="headerlink" title="各运算节点保存iptables规则"></a>各运算节点保存iptables规则</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# iptables-save &gt; /etc/sysconfig/iptables</span><br></pre></td></tr></table></figure>

<h3 id="下载软件，解压，做软连接-2"><a href="#下载软件，解压，做软连接-2" class="headerlink" title="下载软件，解压，做软连接"></a>下载软件，解压，做软连接</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 src]# ls -l|grep flannel</span><br><span class="line">-rw-r--r-- 1 root root 417761204 Jan 17 18:46 flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">[root@hdss7-21 src]# mkdir -p /opt/flannel-v0.10.0-linux-amd64/cert</span><br><span class="line">[root@hdss7-21 src]# tar xf flannel-v0.10.0-linux-amd64.tar.gz -C /opt/flannel-v0.10.0-linux-amd64</span><br><span class="line">[root@hdss7-21 src]# ln -s /opt/flannel-v0.10.0-linux-amd64 /opt/flannel</span><br><span class="line">[root@hdss7-21 src]# ls -l /opt|grep flannel</span><br><span class="line">lrwxrwxrwx 1 root   root         31 Jan 17 18:49 flannel -&gt; flannel-v0.10.0-linux-amd64/</span><br><span class="line">drwxr-xr-x 4 root   root         50 Jan 17 18:47 flannel-v0.10.0-linux-amd64</span><br></pre></td></tr></table></figure>

<h3 id="最终目录结构"><a href="#最终目录结构" class="headerlink" title="最终目录结构"></a>最终目录结构</h3><figure class="highlight plain"><figcaption><span>/opt</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 opt]# tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- etcd -&gt; etcd-v3.1.18-linux-amd64</span><br><span class="line">|-- etcd-v3.1.18-linux-amd64</span><br><span class="line">|   |-- Documentation</span><br><span class="line">|   |-- README-etcdctl.md</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- READMEv2-etcdctl.md</span><br><span class="line">|   |-- certs</span><br><span class="line">|   |-- etcd</span><br><span class="line">|   |-- etcd-server-startup.sh</span><br><span class="line">|   `-- etcdctl</span><br><span class="line">|-- flannel -&gt; flannel-v0.10.0/</span><br><span class="line">|-- flannel-v0.10.0</span><br><span class="line">|   |-- README.md</span><br><span class="line">|   |-- cert</span><br><span class="line">|   |-- flanneld</span><br><span class="line">|   `-- mk-docker-opts.sh</span><br><span class="line">|-- kubernetes -&gt; kubernetes-v1.13.2-linux-amd64/</span><br><span class="line">|-- kubernetes-v1.13.2-linux-amd64</span><br><span class="line">|   |-- LICENSES</span><br><span class="line">|   |-- addons</span><br><span class="line">|   `-- server</span><br><span class="line">`-- src</span><br><span class="line">    |-- etcd-v3.1.18-linux-amd64.tar.gz</span><br><span class="line">    |-- flannel-v0.10.0-linux-amd64.tar.gz</span><br><span class="line">    `-- kubernetes-server-linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<h3 id="操作etcd，增加host-gw"><a href="#操作etcd，增加host-gw" class="headerlink" title="操作etcd，增加host-gw"></a>操作etcd，增加host-gw</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/etcd</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 etcd]# ./etcdctl set /coreos.com/network/config &apos;&#123;&quot;Network&quot;: &quot;172.7.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;&apos;</span><br><span class="line">&#123;&quot;Network&quot;: &quot;172.7.0.0/16&quot;, &quot;Backend&quot;: &#123;&quot;Type&quot;: &quot;host-gw&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="创建配置-3"><a href="#创建配置-3" class="headerlink" title="创建配置"></a>创建配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel/subnet.env</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FLANNEL_NETWORK=172.7.0.0/16</span><br><span class="line">FLANNEL_SUBNET=172.7.21.1/24</span><br><span class="line">FLANNEL_MTU=1500</span><br><span class="line">FLANNEL_IPMASQ=false</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel集群各主机的配置略有不同，部署其他节点时注意修改。</p>
<h3 id="创建启动脚本-3"><a href="#创建启动脚本-3" class="headerlink" title="创建启动脚本"></a>创建启动脚本</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel/flanneld.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">./flanneld \</span><br><span class="line">  --public-ip=10.4.7.21 \</span><br><span class="line">  --etcd-endpoints=https://10.4.7.12:2379,https://10.4.7.21:2379,https://10.4.7.22:2379 \</span><br><span class="line">  --etcd-keyfile=./cert/client-key.pem \</span><br><span class="line">  --etcd-certfile=./cert/client.pem \</span><br><span class="line">  --etcd-cafile=./cert/ca.pem \</span><br><span class="line">  --iface=eth0 \</span><br><span class="line">  --subnet-file=./subnet.env \</span><br><span class="line">  --healthz-port=2401</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>flannel集群各主机的启动脚本略有不同，部署其他节点时注意修改。</p>
<h3 id="检查配置，权限，创建日志目录-2"><a href="#检查配置，权限，创建日志目录-2" class="headerlink" title="检查配置，权限，创建日志目录"></a>检查配置，权限，创建日志目录</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/flannel</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flannel]# chmod +x /opt/flannel/flanneld.sh </span><br><span class="line"></span><br><span class="line">[root@hdss7-21 flannel]# mkdir -p /data/logs/flanneld</span><br></pre></td></tr></table></figure>

<h3 id="创建supervisor配置-5"><a href="#创建supervisor配置-5" class="headerlink" title="创建supervisor配置"></a>创建supervisor配置</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/supervisord.d/flanneld.ini</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[program:flanneld]</span><br><span class="line">command=/opt/flannel/flanneld.sh                             ; the program (relative uses PATH, can take args)</span><br><span class="line">numprocs=1                                                   ; number of processes copies to start (def 1)</span><br><span class="line">directory=/opt/flannel                                       ; directory to cwd to before exec (def no cwd)</span><br><span class="line">autostart=true                                               ; start at supervisord start (default: true)</span><br><span class="line">autorestart=true                                             ; retstart at unexpected quit (default: true)</span><br><span class="line">startsecs=22                   ; number of secs prog must stay running (def. 1)</span><br><span class="line">startretries=3     				     ; max # of serial start failures (default 3)</span><br><span class="line">exitcodes=0,2      				     ; &apos;expected&apos; exit codes for process (default 0,2)</span><br><span class="line">stopsignal=QUIT    				     ; signal used to kill process (default TERM)</span><br><span class="line">stopwaitsecs=10    				     ; max num secs to wait b4 SIGKILL (default 10)</span><br><span class="line">user=root                                                    ; setuid to this UNIX account to run the program</span><br><span class="line">redirect_stderr=false                                        ; redirect proc stderr to stdout (default false)</span><br><span class="line">stdout_logfile=/data/logs/flanneld/flanneld.stdout.log       ; stdout log path, NONE for none; default AUTO</span><br><span class="line">stdout_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stdout_logfile_backups=4                                     ; # of stdout logfile backups (default 10)</span><br><span class="line">stdout_capture_maxbytes=1MB                                  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stdout_events_enabled=false                                  ; emit events on stdout writes (default false)</span><br><span class="line">stderr_logfile=/data/logs/flanneld/flanneld.stderr.log       ; stderr log path, NONE for none; default AUTO</span><br><span class="line">stderr_logfile_maxbytes=64MB                                 ; max # logfile bytes b4 rotation (default 50MB)</span><br><span class="line">stderr_logfile_backups=4                                     ; # of stderr logfile backups (default 10)</span><br><span class="line">stderr_capture_maxbytes=1MB                                  ; number of bytes in &apos;capturemode&apos; (default 0)</span><br><span class="line">stderr_events_enabled=false                                  ; emit events on stderr writes (default false)</span><br></pre></td></tr></table></figure>

<h3 id="启动服务并检查-5"><a href="#启动服务并检查-5" class="headerlink" title="启动服务并检查"></a>启动服务并检查</h3><p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 flanneld]# supervisorctl update</span><br><span class="line">flanneld: added process group</span><br><span class="line">[root@hdss7-21 flanneld]# supervisorctl status</span><br><span class="line">etcd-server-7-21                 RUNNING   pid 9507, uptime 1 day, 20:35:42</span><br><span class="line">flanneld                         STARTING  </span><br><span class="line">kube-apiserver                   RUNNING   pid 9770, uptime 1 day, 19:01:43</span><br><span class="line">kube-controller-manager          RUNNING   pid 37646, uptime 0:58:48</span><br><span class="line">kube-kubelet                     RUNNING   pid 32640, uptime 17:16:36</span><br><span class="line">kube-proxy                       RUNNING   pid 15097, uptime 17:55:36</span><br><span class="line">kube-scheduler                   RUNNING   pid 37803, uptime 0:55:47</span><br></pre></td></tr></table></figure>

<h3 id="安装部署启动检查所有集群规划主机上的flannel服务"><a href="#安装部署启动检查所有集群规划主机上的flannel服务" class="headerlink" title="安装部署启动检查所有集群规划主机上的flannel服务"></a>安装部署启动检查所有集群规划主机上的flannel服务</h3><p>略</p>
<h3 id="再次验证集群"><a href="#再次验证集群" class="headerlink" title="再次验证集群"></a>再次验证集群</h3><h2 id="部署k8s资源配置清单的内网http服务"><a href="#部署k8s资源配置清单的内网http服务" class="headerlink" title="部署k8s资源配置清单的内网http服务"></a>部署k8s资源配置清单的内网http服务</h2><h3 id="在运维主机HDSS7-200-host-com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口"><a href="#在运维主机HDSS7-200-host-com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口" class="headerlink" title="在运维主机HDSS7-200.host.com上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口"></a>在运维主机<code>HDSS7-200.host.com</code>上，配置一个nginx虚拟主机，用以提供k8s统一的资源配置清单访问入口</h3><figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/k8s-yaml.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  k8s-yaml.od.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        autoindex on;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        root /data/k8s-yaml;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置内网DNS解析"><a href="#配置内网DNS解析" class="headerlink" title="配置内网DNS解析"></a>配置内网DNS解析</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8s-yaml	60 IN A 10.4.7.200</span><br></pre></td></tr></table></figure>

<p>以后所有的资源配置清单统一放置在运维主机的<code>/data/k8s-yaml</code>目录下即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# nginx -s reload</span><br></pre></td></tr></table></figure>

<h2 id="部署kube-dns-coredns"><a href="#部署kube-dns-coredns" class="headerlink" title="部署kube-dns(coredns)"></a>部署kube-dns(coredns)</h2><h3 id="准备coredns-v1-3-1镜像"><a href="#准备coredns-v1-3-1镜像" class="headerlink" title="准备coredns-v1.3.1镜像"></a>准备coredns-v1.3.1镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull coredns/coredns:1.3.1</span><br><span class="line">1.3.1: Pulling from coredns/coredns</span><br><span class="line">e0daa8927b68: Pull complete </span><br><span class="line">3928e47de029: Pull complete </span><br><span class="line">Digest: sha256:02382353821b12c21b062c59184e227e001079bb13ebd01f9d3270ba0fcbf1e4</span><br><span class="line">Status: Downloaded newer image for coredns/coredns:1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag eb516548c180 harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">docker push harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/coredns]</span><br><span class="line">c6a5fc8a3f01: Pushed </span><br><span class="line">fb61a074724d: Pushed </span><br><span class="line">v1.3.1: digest: sha256:e077b9680c32be06fc9652d57f64aa54770dd6554eb87e7a00b97cf8e9431fda size: 739</span><br></pre></td></tr></table></figure>

<p>任意一台运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create secret docker-registry harbor --docker-server=harbor.od.com --docker-username=admin --docker-password=Harbor12345 --docker-email=stanley.wang.m@qq.com -n kube-system</span><br></pre></td></tr></table></figure>

<h4 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h4><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/coredns &amp;&amp; cd /data/k8s-yaml/coredns</span><br></pre></td></tr></table></figure>

<div class="tabs" id="coredns"><ul class="nav-tabs"><li class="tab active"><a href="#coredns-1">RBAC</a></li><li class="tab"><a href="#coredns-2">ConfigMap</a></li><li class="tab"><a href="#coredns-3">Deployment</a></li><li class="tab"><a href="#coredns-4">Service</a></li></ul><div class="tab-content"><div class="tab-pane active" id="coredns-1"><p>vi /data/k8s-yaml/coredns/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">      kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">      addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: system:coredns</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - endpoints</span><br><span class="line">  - services</span><br><span class="line">  - pods</span><br><span class="line">  - namespaces</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    rbac.authorization.kubernetes.io/autoupdate: &quot;true&quot;</span><br><span class="line">  labels:</span><br><span class="line">    kubernetes.io/bootstrapping: rbac-defaults</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: system:coredns</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:coredns</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-2"><p>vi /data/k8s-yaml/coredns/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">data:</span><br><span class="line">  Corefile: |</span><br><span class="line">    .:53 &#123;</span><br><span class="line">        errors</span><br><span class="line">        log</span><br><span class="line">        health</span><br><span class="line">        kubernetes cluster.local 192.168.0.0/16</span><br><span class="line">        proxy . /etc/resolv.conf</span><br><span class="line">        cache 30</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-3"><p>vi /data/k8s-yaml/coredns/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: coredns</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: coredns</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: coredns</span><br><span class="line">      containers:</span><br><span class="line">      - name: coredns</span><br><span class="line">        image: harbor.od.com/k8s/coredns:v1.3.1</span><br><span class="line">        args:</span><br><span class="line">        - -conf</span><br><span class="line">        - /etc/coredns/Corefile</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          mountPath: /etc/coredns</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns</span><br><span class="line">          protocol: UDP</span><br><span class="line">        - containerPort: 53</span><br><span class="line">          name: dns-tcp</span><br><span class="line">          protocol: TCP</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /health</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 60</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">          successThreshold: 1</span><br><span class="line">          failureThreshold: 5</span><br><span class="line">      dnsPolicy: Default</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      volumes:</span><br><span class="line">        - name: config-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: coredns</span><br><span class="line">            items:</span><br><span class="line">            - key: Corefile</span><br><span class="line">              path: Corefile</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="coredns-4"><p>vi /data/k8s-yaml/coredns/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: coredns</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    kubernetes.io/name: &quot;CoreDNS&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: coredns</span><br><span class="line">  clusterIP: 192.168.0.2</span><br><span class="line">  ports:</span><br><span class="line">  - name: dns</span><br><span class="line">    port: 53</span><br><span class="line">    protocol: UDP</span><br><span class="line">  - name: dns-tcp</span><br><span class="line">    port: 53</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="依次执行创建"><a href="#依次执行创建" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/coredns" target="_blank" rel="noopener">http://k8s-yaml.od.com/coredns</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点上应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/rbac.yaml</span><br><span class="line">serviceaccount/coredns created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/system:coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/configmap.yaml</span><br><span class="line">configmap/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/deployment.yaml</span><br><span class="line">deployment.extensions/coredns created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/coredns/svc.yaml</span><br><span class="line">service/coredns created</span><br></pre></td></tr></table></figure>

<h3 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl get pods -n kube-system -o wide</span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">coredns-7ccccdf57c-5b9ch   1/1     Running   0          3m4s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 coredns]# kubectl get svc -n kube-system</span><br><span class="line">NAME      TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">coredns   ClusterIP   192.168.0.2   &lt;none&gt;        53/UDP,53/TCP   29s</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# dig -t A nginx-ds.default.svc.cluster.local. @192.168.0.2 +short</span><br><span class="line">192.168.0.3</span><br></pre></td></tr></table></figure>

<h2 id="部署traefik（ingress）"><a href="#部署traefik（ingress）" class="headerlink" title="部署traefik（ingress）"></a>部署traefik（ingress）</h2><h3 id="准备traefik镜像"><a href="#准备traefik镜像" class="headerlink" title="准备traefik镜像"></a>准备traefik镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull traefik:v1.7-alpine</span><br><span class="line">v1.7-alpine: Pulling from library/traefik</span><br><span class="line">bdf0201b3a05: Pull complete </span><br><span class="line">9dfd896cc066: Pull complete </span><br><span class="line">de06b5685128: Pull complete </span><br><span class="line">c4d82a21fa27: Pull complete </span><br><span class="line">Digest: sha256:0531581bde9da0670fc2c7a4e419e1cc38abff74e7ba06410bf2b1b55c70ef15</span><br><span class="line">Status: Downloaded newer image for traefik:v1.7-alpine</span><br><span class="line">[root@hdss7-200 ~]# docker tag 1930b7508541 harbor.od.com/k8s/traefik:v1.7       </span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/traefik:v1.7</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/traefik]</span><br><span class="line">a3e3d574f6ae: Pushed </span><br><span class="line">a7c355c1a104: Pushed </span><br><span class="line">e89059911fc9: Pushed </span><br><span class="line">a464c54f93a9: Mounted from infra/apollo-portal </span><br><span class="line">v1.7: digest: sha256:8f92899f5feb08db600c89d3016145e838fa7ff0d316ee21ecd63d9623643410 size: 1157</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/traefik &amp;&amp; cd /data/k8s-yaml/traefik</span><br></pre></td></tr></table></figure>

<div class="tabs" id="traefik"><ul class="nav-tabs"><li class="tab active"><a href="#traefik-1">RBAC</a></li><li class="tab"><a href="#traefik-2">DaemonSet</a></li><li class="tab"><a href="#traefik-3">Service</a></li><li class="tab"><a href="#traefik-4">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="traefik-1"><p>vi /data/k8s-yaml/traefik/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">rules:</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - &quot;&quot;</span><br><span class="line">    resources:</span><br><span class="line">      - services</span><br><span class="line">      - endpoints</span><br><span class="line">      - secrets</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">  - apiGroups:</span><br><span class="line">      - extensions</span><br><span class="line">    resources:</span><br><span class="line">      - ingresses</span><br><span class="line">    verbs:</span><br><span class="line">      - get</span><br><span class="line">      - list</span><br><span class="line">      - watch</span><br><span class="line">\--\-</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-2"><p>vi /data/k8s-yaml/traefik/daemonset.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-controller</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">spec:</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: traefik-ingress-lb</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: traefik-ingress-controller</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - image: harbor.od.com/k8s/traefik:v1.7</span><br><span class="line">        name: traefik-ingress-lb</span><br><span class="line">        ports:</span><br><span class="line">        - name: http</span><br><span class="line">          containerPort: 80</span><br><span class="line">          hostPort: 81</span><br><span class="line">        - name: admin</span><br><span class="line">          containerPort: 8080</span><br><span class="line">        securityContext:</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">            add:</span><br><span class="line">            - NET_BIND_SERVICE</span><br><span class="line">        args:</span><br><span class="line">        - -\-api</span><br><span class="line">        - -\-kubernetes</span><br><span class="line">        - -\-logLevel=INFO</span><br><span class="line">        - -\-insecureskipverify=true</span><br><span class="line">        - -\-kubernetes.endpoint=https://10.4.7.10:7443</span><br><span class="line">        - -\-accesslog</span><br><span class="line">        - -\-accesslog.filepath=/var/log/traefik_access.log</span><br><span class="line">        - -\-traefiklog</span><br><span class="line">        - -\-traefiklog.filepath=/var/log/traefik.log</span><br><span class="line">        - -\-metrics.prometheus</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-3"><p>vi /data/k8s-yaml/traefik/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-ingress-service</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: traefik-ingress-lb</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 80</span><br><span class="line">      name: web</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      name: admin</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="traefik-4"><p>vi /data/k8s-yaml/traefik/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: traefik-web-ui</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: traefik.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: traefik-ingress-service</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">traefik	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-1"><a href="#依次执行创建-1" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/traefik" target="_blank" rel="noopener">http://k8s-yaml.od.com/traefik</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/rbac.yaml </span><br><span class="line">serviceaccount/traefik-ingress-controller created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/daemonset.yaml </span><br><span class="line">daemonset.extensions/traefik-ingress-controller created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/svc.yaml </span><br><span class="line">service/traefik-ingress-service created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/traefik/ingress.yaml </span><br><span class="line">ingress.extensions/traefik-web-ui created</span><br></pre></td></tr></table></figure>

<h3 id="配置反代"><a href="#配置反代" class="headerlink" title="配置反代"></a>配置反代</h3><p><code>HDSS7-11.host.com</code>和<code>HDSS7-12.host.com</code>两台主机上的nginx均需要配置，这里可以考虑使用saltstack或者ansible进行统一配置管理</p>
<figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream default_backend_traefik &#123;</span><br><span class="line">    server 10.4.7.21:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">    server 10.4.7.22:81    max_fails=3 fail_timeout=10s;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    server_name *.od.com;</span><br><span class="line">  </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">        proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://traefik.od.com" target="_blank" rel="noopener">http://traefik.od.com</a></p>
<h2 id="部署dashboard"><a href="#部署dashboard" class="headerlink" title="部署dashboard"></a>部署dashboard</h2><h3 id="准备dashboard镜像"><a href="#准备dashboard镜像" class="headerlink" title="准备dashboard镜像"></a>准备dashboard镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull k8scn/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">v1.8.3: Pulling from k8scn/kubernetes-dashboard-amd64</span><br><span class="line">a4026007c47e: Pull complete </span><br><span class="line">Digest: sha256:ebc993303f8a42c301592639770bd1944d80c88be8036e2d4d0aa116148264ff</span><br><span class="line">Status: Downloaded newer image for k8scn/kubernetes-dashboard-amd64:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker tag 0c60bcf89900 harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">docker push harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/dashboard]</span><br><span class="line">23ddb8cbb75a: Pushed </span><br><span class="line">v1.8.3: digest: sha256:e76c5fe6886c99873898e4c8c0945261709024c4bea773fc477629455631e472 size: 529</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/k8s-yaml/dashboard &amp;&amp; cd /data/k8s-yaml/dashboard</span><br></pre></td></tr></table></figure>

<div class="tabs" id="dashboard"><ul class="nav-tabs"><li class="tab active"><a href="#dashboard-1">RBAC</a></li><li class="tab"><a href="#dashboard-2">Secret</a></li><li class="tab"><a href="#dashboard-3">ConfigMap</a></li><li class="tab"><a href="#dashboard-4">Service</a></li><li class="tab"><a href="#dashboard-5">Ingress</a></li><li class="tab"><a href="#dashboard-6">Deployment</a></li></ul><div class="tab-content"><div class="tab-pane active" id="dashboard-1"><p>vi /data/k8s-yaml/dashboard/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kubernetes-dashboard-admin</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-2"><p>vi /data/k8s-yaml/dashboard/secret.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-certs</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br><span class="line">\--\-</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-key-holder</span><br><span class="line">  namespace: kube-system</span><br><span class="line">type: Opaque</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-3"><p>vi /data/k8s-yaml/dashboard/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    # Allows editing resource and makes sure it is created first.</span><br><span class="line">    addonmanager.kubernetes.io/mode: EnsureExists</span><br><span class="line">  name: kubernetes-dashboard-settings</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-4"><p>vi /data/k8s-yaml/dashboard/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  ports:</span><br><span class="line">  - port: 443</span><br><span class="line">    targetPort: 8443</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-5"><p>vi /data/k8s-yaml/dashboard/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Ingress</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  annotations:</span><br><span class="line">    kubernetes.io/ingress.class: traefik</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dashboard.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - backend:</span><br><span class="line">          serviceName: kubernetes-dashboard</span><br><span class="line">          servicePort: 443</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dashboard-6"><p>vi /data/k8s-yaml/dashboard/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kubernetes-dashboard</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">    kubernetes.io/cluster-service: &quot;true&quot;</span><br><span class="line">    addonmanager.kubernetes.io/mode: Reconcile</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      k8s-app: kubernetes-dashboard</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        k8s-app: kubernetes-dashboard</span><br><span class="line">      annotations:</span><br><span class="line">        scheduler.alpha.kubernetes.io/critical-pod: &apos;&apos;</span><br><span class="line">    spec:</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      containers:</span><br><span class="line">      - name: kubernetes-dashboard</span><br><span class="line">        image: harbor.od.com/k8s/dashboard:v1.8.3</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 300Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 50m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8443</span><br><span class="line">          protocol: TCP</span><br><span class="line">        args:</span><br><span class="line">          # PLATFORM-SPECIFIC ARGS HERE</span><br><span class="line">          - -\-auto-generate-certificates</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: kubernetes-dashboard-certs</span><br><span class="line">          mountPath: /certs</span><br><span class="line">        - name: tmp-volume</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            scheme: HTTPS</span><br><span class="line">            path: /</span><br><span class="line">            port: 8443</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 30</span><br><span class="line">      volumes:</span><br><span class="line">      - name: kubernetes-dashboard-certs</span><br><span class="line">        secret:</span><br><span class="line">          secretName: kubernetes-dashboard-certs</span><br><span class="line">      - name: tmp-volume</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      serviceAccountName: kubernetes-dashboard-admin</span><br><span class="line">      tolerations:</span><br><span class="line">      - key: &quot;CriticalAddonsOnly&quot;</span><br><span class="line">        operator: &quot;Exists&quot;</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dashboard	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="依次执行创建-2"><a href="#依次执行创建-2" class="headerlink" title="依次执行创建"></a>依次执行创建</h3><p>浏览器打开：<a href="http://k8s-yaml.od.com/dashboard" target="_blank" rel="noopener">http://k8s-yaml.od.com/dashboard</a> 检查资源配置清单文件是否正确创建<br>在任意运算节点应用资源配置清单</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/rbac.yaml </span><br><span class="line">serviceaccount/kubernetes-dashboard created</span><br><span class="line">role.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line">rolebinding.rbac.authorization.k8s.io/kubernetes-dashboard-admin created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/secret.yaml </span><br><span class="line">secret/kubernetes-dashboard-certs created</span><br><span class="line">secret/kubernetes-dashboard-key-holder created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/configmap.yaml </span><br><span class="line">configmap/kubernetes-dashboard-settings created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/svc.yaml </span><br><span class="line">service/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/ingress.yaml </span><br><span class="line">ingress.extensions/kubernetes-dashboard created</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/deployment.yaml </span><br><span class="line">deployment.apps/kubernetes-dashboard created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://dashboard.od.com" target="_blank" rel="noopener">http://dashboard.od.com</a></p>
<h3 id="配置认证"><a href="#配置认证" class="headerlink" title="配置认证"></a>配置认证</h3><ul>
<li>下载新版dashboard</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull hexun/kubernetes-dashboard-amd64:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker tag f9aed6605b81 harbor.od.com/k8s/dashboard:v1.10.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/k8s/dashboard:v1.10.1</span><br></pre></td></tr></table></figure>

<ul>
<li><p>应用新版dashboard</p>
</li>
<li><p>修改nginx配置，走https</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/nginx/conf.d/dashboard.od.com.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl;</span><br><span class="line">    server_name  dashboard.od.com;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;certs/dashboard.od.com.crt&quot;;</span><br><span class="line">    ssl_certificate_key &quot;certs/dashboard.od.com.key&quot;;</span><br><span class="line">    ssl_session_cache shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  10m;</span><br><span class="line">    ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://default_backend_traefik;</span><br><span class="line">	      proxy_set_header Host       $http_host;</span><br><span class="line">        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取token</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdsss7-21 ~]# kubectl describe secret kubernetes-dashboard-admin-token-rhr62 -n kube-system</span><br><span class="line">Name:         kubernetes-dashboard-admin-token-rhr62</span><br><span class="line">Namespace:    kube-system</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: kubernetes-dashboard-admin</span><br><span class="line">              kubernetes.io/service-account.uid: cdd3c552-856d-11e9-ae34-782bcb321c07</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1354 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbi10b2tlbi1yaHI2MiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJrdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImNkZDNjNTUyLTg1NmQtMTFlOS1hZTM0LTc4MmJjYjMyMWMwNyIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTprdWJlcm5ldGVzLWRhc2hib2FyZC1hZG1pbiJ9.72OcJZCm_3I-7QZcEJTRPyIJSxQwSwZfVsB6Bx_RAZRJLOv3-BXy88PclYgxRy2dDqeX6cpjvFPBrmNOGQoxT9oD8_H49pvBnqdCdNuoJbXK7aBIZdkZxATzXd-63zmhHhUBsM3Ybgwy5XxD3vj8VUYfux5c5Mr4TzU_rnGLCj1H5mq_JJ3hNabv0rwil-ZAV-3HLikOMiIRhEK7RdMs1bfXF2yvse4VOabe9xv47TvbEYns97S4OlZvsurmOk0B8dD85OSaREEtqa8n_ND9GrHeeL4CcALqWYJHLrr7vLfndXi1QHDVrUzFKvgkAeYpDVAzGwIWL7rgHwp3sQguGA</span><br></pre></td></tr></table></figure>

<h2 id="部署heapster"><a href="#部署heapster" class="headerlink" title="部署heapster"></a>部署heapster</h2><p><a href="https://github.com/kubernetes-retired/heapster" target="_blank" rel="noopener">heapster官方github地址</a></p>
<h3 id="准备heapster镜像"><a href="#准备heapster镜像" class="headerlink" title="准备heapster镜像"></a>准备heapster镜像</h3><p>运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# docker pull quay.io/bitnami/heapster:1.5.4</span><br><span class="line">1.5.4: Pulling from bitnami/heapster</span><br><span class="line">4018396ca1ba: Pull complete </span><br><span class="line">0e4723f815c4: Pull complete </span><br><span class="line">d8569f30adeb: Pull complete </span><br><span class="line">Digest: sha256:6d891479611ca06a5502bc36e280802cbf9e0426ce4c008dd2919c2294ce0324</span><br><span class="line">Status: Downloaded newer image for quay.io/bitnami/heapster:1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker tag c359b95ad38b harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">[root@hdss7--200 ~]# docker push !$</span><br><span class="line">docker push harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">The push refers to a repository [harbor.od.com/k8s/heapster]</span><br><span class="line">20d37d828804: Pushed </span><br><span class="line">b9b192015e25: Pushed </span><br><span class="line">b76dba5a0109: Pushed </span><br><span class="line">v1.5.4: digest: sha256:1203b49f2b2b07e02e77263bce8bb30563a91e1d7ee7c6742e9d125abcb3abe6 size: 952</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><div class="tabs" id="heapster"><ul class="nav-tabs"><li class="tab active"><a href="#heapster-1">RBAC</a></li><li class="tab"><a href="#heapster-2">Deployment</a></li><li class="tab"><a href="#heapster-3">Service</a></li></ul><div class="tab-content"><div class="tab-pane active" id="heapster-1"><p>vi /data/k8s-yaml/dashboard/heapster/rbac.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">\--\-</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: system:heapster</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="heapster-2"><p>vi /data/k8s-yaml/dashboard/heapster/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: heapster</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: heapster</span><br><span class="line">      containers:</span><br><span class="line">      - name: heapster</span><br><span class="line">        image: harbor.od.com/k8s/heapster:v1.5.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        command:</span><br><span class="line">        - /opt/bitnami/heapster/bin/heapster</span><br><span class="line">        - \--source=kubernetes:https://kubernetes.default</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="heapster-3"><p>vi /data/k8s-yaml/dashboard/heapster/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    task: monitoring</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: &apos;true&apos;</span><br><span class="line">    kubernetes.io/name: Heapster</span><br><span class="line">  name: heapster</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8082</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: heapster</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>任意运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/rbac.yaml </span><br><span class="line">serviceaccount/heapster created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/deployment.yaml </span><br><span class="line">deployment.extensions/heapster created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dashboard/heapster/svc.yaml </span><br><span class="line">service/heapster created</span><br></pre></td></tr></table></figure>

<h3 id="重启dashboard"><a href="#重启dashboard" class="headerlink" title="重启dashboard"></a>重启dashboard</h3><p>浏览器访问：<a href="http://dashboard.od.com" target="_blank" rel="noopener">http://dashboard.od.com</a><br><img src="/images/heapster.png" alt="加入heapster插件的dashboard" title="加入heapster插件的dashboard"></p>
<h3 id="排错专用命令"><a href="#排错专用命令" class="headerlink" title="排错专用命令"></a>排错专用命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for j in `kubectl get ns|sed &apos;1d&apos;|awk &apos;&#123;print $1&#125;&apos;`;do for i in `kubectl get pods -n $j|grep -iv running|sed &apos;1d&apos;|awk &apos;&#123;print $1&#125;&apos;`;do kubectl delete pods $i -n $j --force --grace-period=0;done;done</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档2：实战交付一套dubbo微服务到kubernetes集群/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/18/实验文档2：实战交付一套dubbo微服务到kubernetes集群/" class="post-title-link" itemprop="url">实验文档2：实战交付一套dubbo微服务到kubernetes集群</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-18 21:12:56" itemprop="dateCreated datePublished" datetime="2019-01-18T21:12:56+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes容器云技术专题/" itemprop="url" rel="index"><span itemprop="name">Kubernetes容器云技术专题</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">49k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">45 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h1><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>k8s代理节点1，zk1</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>k8s代理节点2，zk2</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>k8s运算节点1，zk3</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>k8s运算节点2，jenkins</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>k8s运维节点(docker仓库)</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<h1 id="部署zookeeper"><a href="#部署zookeeper" class="headerlink" title="部署zookeeper"></a>部署zookeeper</h1><h2 id="安装jdk1-8（3台zk角色主机）"><a href="#安装jdk1-8（3台zk角色主机）" class="headerlink" title="安装jdk1.8（3台zk角色主机）"></a>安装jdk1.8（3台zk角色主机）</h2><blockquote>
<p>jdk下载地址<br><a href="https://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase6-419409.html" target="_blank" rel="noopener">jdk1.6</a><br><a href="https://www.oracle.com/technetwork/java/javase/downloads/java-archive-downloads-javase7-521261.html" target="_blank" rel="noopener">jdk1.7</a><br><a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">jdk1.8</a></p>
</blockquote>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 src]# ls -l|grep jdk</span><br><span class="line">-rw-r--r-- 1 root root 153530841 Jan 17 17:49 jdk-8u201-linux-x64.tar.gz</span><br><span class="line">[root@hdss7-11 src]# mkdir /usr/java</span><br><span class="line">[root@hdss7-11 src]# tar xf jdk-8u201-linux-x64.tar.gz -C /usr/java</span><br><span class="line">[root@hdss7-11 src]# ln -s /usr/java/jdk1.8.0_201 /usr/java/jdk</span><br><span class="line">[root@hdss7-11 src]# vi /etc/profile</span><br><span class="line">export JAVA_HOME=/usr/java/jdk</span><br><span class="line">export PATH=$JAVA_HOME/bin:$JAVA_HOME/bin:$PATH</span><br><span class="line">export CLASSPATH=$CLASSPATH:$JAVA_HOME/lib:$JAVA_HOME/lib/tools.jar</span><br></pre></td></tr></table></figure>

<h2 id="安装zookeeper（3台zk角色主机）"><a href="#安装zookeeper（3台zk角色主机）" class="headerlink" title="安装zookeeper（3台zk角色主机）"></a>安装zookeeper（3台zk角色主机）</h2><blockquote>
<p>zk下载地址<br><a href="https://archive.apache.org/dist/zookeeper/" target="_blank" rel="noopener">zookeeper</a></p>
</blockquote>
<h3 id="解压、配置"><a href="#解压、配置" class="headerlink" title="解压、配置"></a>解压、配置</h3><figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 src]# ls -l|grep zoo</span><br><span class="line">-rw-r--r-- 1 root root 153530841 Jan 17 18:10 zookeeper-3.4.14.tar.gz</span><br><span class="line">[root@hdss7-11 src]# tar xf /opt/src/zookeeper-3.4.14.tar.gz -C /opt</span><br><span class="line">[root@hdss7-11 opt]# ln -s /opt/zookeeper-3.4.14/ /opt/zookeeper</span><br><span class="line">[root@hdss7-11 opt]# mkdir -pv /data/zookeeper/data /data/zookeeper/logs</span><br><span class="line">[root@hdss7-11 opt]# vi /opt/zookeeper/conf/zoo.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=zk1.od.com:2888:3888</span><br><span class="line">server.2=zk2.od.com:2888:3888</span><br><span class="line">server.3=zk3.od.com:2888:3888</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>各节点zk配置相同。</p>
<h3 id="myid"><a href="#myid" class="headerlink" title="myid"></a>myid</h3><p><code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/zookeeper/data/myid</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1</span><br></pre></td></tr></table></figure>

<p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/zookeeper/data/myid</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2</span><br></pre></td></tr></table></figure>

<p><code>HDSS7-21.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/zookeeper/data/myid</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">3</span><br></pre></td></tr></table></figure>

<h3 id="做dns解析"><a href="#做dns解析" class="headerlink" title="做dns解析"></a>做dns解析</h3><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zk1	60 IN A 10.4.7.11</span><br><span class="line">zk2	60 IN A 10.4.7.12</span><br><span class="line">zk3	60 IN A 10.4.7.21</span><br></pre></td></tr></table></figure>

<h3 id="依次启动"><a href="#依次启动" class="headerlink" title="依次启动"></a>依次启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 opt]# /opt/zookeeper/bin/zkServer.sh start</span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /opt/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br></pre></td></tr></table></figure>

<h1 id="部署jenkins"><a href="#部署jenkins" class="headerlink" title="部署jenkins"></a>部署jenkins</h1><h2 id="准备镜像"><a href="#准备镜像" class="headerlink" title="准备镜像"></a>准备镜像</h2><blockquote>
<p><a href="https://jenkins.io/download/" target="_blank" rel="noopener">jenkins官网</a><br><a href="https://hub.docker.com/r/jenkins/jenkins" target="_blank" rel="noopener">jenkins镜像</a></p>
</blockquote>
<p>在运维主机下载官网上的稳定版（这里下载2.164.1）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]#  docker pull jenkins/jenkins:2.164.1</span><br><span class="line">2.164.1: Pulling from jenkins/jenkins</span><br><span class="line">22dbe790f715: Pull complete </span><br><span class="line">0250231711a0: Pull complete </span><br><span class="line">6fba9447437b: Pull complete </span><br><span class="line">c2b4d327b352: Pull complete </span><br><span class="line">cddb9bb0d37c: Pull complete </span><br><span class="line">b535486c968f: Pull complete </span><br><span class="line">f3e976e6210c: Pull complete </span><br><span class="line">b2c11b10291d: Pull complete </span><br><span class="line">f4c0181e1976: Pull complete </span><br><span class="line">924c8e712392: Pull complete </span><br><span class="line">d13006b7c9dd: Pull complete </span><br><span class="line">fc80aeb92627: Pull complete </span><br><span class="line">36a6e96ba1b5: Pull complete </span><br><span class="line">f50f33dc1d0a: Pull complete </span><br><span class="line">b10642432117: Pull complete </span><br><span class="line">850c260511d8: Pull complete </span><br><span class="line">47f95e65a629: Pull complete </span><br><span class="line">3b33ce546dc6: Pull complete </span><br><span class="line">051c7665e760: Pull complete </span><br><span class="line">fe379aecc538: Pull complete </span><br><span class="line">Digest: sha256:12fd14965de7274b5201653b2bffa62700c5f5f336ec75c945321e2cb70d7af0</span><br><span class="line">Status: Downloaded newer image for jenkins/jenkins:2.164.1</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 ~]# docker tag 256cb12e72d6 harbor.od.com/public/jenkins:v2.164.1</span><br><span class="line">[root@hdss7-200 ~]# docker push harbor.od.com/public/jenkins:v2.164.1</span><br></pre></td></tr></table></figure>

<h2 id="自定义Dockerfile"><a href="#自定义Dockerfile" class="headerlink" title="自定义Dockerfile"></a>自定义Dockerfile</h2><p>在运维主机<code>HDSS7-200.host.com</code>上编辑自定义dockerfile</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/jenkins/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FROM harbor.od.com/public/jenkins:v2.164.1</span><br><span class="line">USER root</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\ </span><br><span class="line">    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line">ADD id_rsa /root/.ssh/id_rsa</span><br><span class="line">ADD config.json /root/.docker/config.json</span><br><span class="line">ADD get-docker.sh /get-docker.sh</span><br><span class="line">RUN echo &quot;    StrictHostKeyChecking no&quot; &gt;&gt; /etc/ssh/ssh_config &amp;&amp;\</span><br><span class="line">    /get-docker.sh</span><br></pre></td></tr></table></figure>

<p>这个Dockerfile里我们主要做了以下几件事</p>
<ul>
<li>设置容器用户为root</li>
<li>设置容器内的时区</li>
<li>将ssh私钥加入（使用git拉代码时要用到，配对的公钥应配置在gitlab中）</li>
<li>加入了登录自建harbor仓库的config文件</li>
<li>修改了ssh客户端的</li>
<li>安装一个docker的客户端</li>
</ul>
<p>生成ssh密钥对：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# ssh-keygen -t rsa -b 2048 -C &quot;stanley.wang.m@qq.com&quot; -N &quot;&quot; -f /root/.ssh/id_rsa</span><br></pre></td></tr></table></figure>

<div class="tabs" id="jenkins-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#jenkins-dockerfile-1">config.json</a></li><li class="tab"><a href="#jenkins-dockerfile-2">get-docker.sh</a></li></ul><div class="tab-content"><div class="tab-pane active" id="jenkins-dockerfile-1"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;auths&quot;: &#123;</span><br><span class="line">        &quot;harbor.od.com&quot;: &#123;</span><br><span class="line">            &quot;auth&quot;: &quot;YWRtaW46SGFyYm9yMTIzNDU=&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="jenkins-dockerfile-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line"># This script is meant for quick &amp; easy install via:</span><br><span class="line">#   $ curl -fsSL get.docker.com -o get-docker.sh</span><br><span class="line">#   $ sh get-docker.sh</span><br><span class="line">#</span><br><span class="line"># For test builds (ie. release candidates):</span><br><span class="line">#   $ curl -fsSL test.docker.com -o test-docker.sh</span><br><span class="line">#   $ sh test-docker.sh</span><br><span class="line">#</span><br><span class="line"># NOTE: Make sure to verify the contents of the script</span><br><span class="line">#       you downloaded matches the contents of install.sh</span><br><span class="line">#       located at https://github.com/docker/docker-install</span><br><span class="line">#       before executing.</span><br><span class="line">#</span><br><span class="line"># Git commit from https://github.com/docker/docker-install when</span><br><span class="line"># the script was uploaded (Should only be modified by upload job):</span><br><span class="line">SCRIPT_COMMIT_SHA=36b78b2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># This value will automatically get changed for:</span><br><span class="line">#   * edge</span><br><span class="line">#   * test</span><br><span class="line">#   * experimental</span><br><span class="line">DEFAULT_CHANNEL_VALUE=&quot;edge&quot;</span><br><span class="line">if [ -z &quot;$CHANNEL&quot; ]; then</span><br><span class="line">    CHANNEL=$DEFAULT_CHANNEL_VALUE</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">DEFAULT_DOWNLOAD_URL=&quot;https://download.docker.com&quot;</span><br><span class="line">if [ -z &quot;$DOWNLOAD_URL&quot; ]; then</span><br><span class="line">    DOWNLOAD_URL=$DEFAULT_DOWNLOAD_URL</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">DEFAULT_REPO_FILE=&quot;docker-ce.repo&quot;</span><br><span class="line">if [ -z &quot;$REPO_FILE&quot; ]; then</span><br><span class="line">    REPO_FILE=&quot;$DEFAULT_REPO_FILE&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">SUPPORT_MAP=&quot;</span><br><span class="line">x86_64-centos-7</span><br><span class="line">x86_64-fedora-26</span><br><span class="line">x86_64-fedora-27</span><br><span class="line">x86_64-fedora-28</span><br><span class="line">x86_64-debian-wheezy</span><br><span class="line">x86_64-debian-jessie</span><br><span class="line">x86_64-debian-stretch</span><br><span class="line">x86_64-debian-buster</span><br><span class="line">x86_64-ubuntu-trusty</span><br><span class="line">x86_64-ubuntu-xenial</span><br><span class="line">x86_64-ubuntu-bionic</span><br><span class="line">x86_64-ubuntu-artful</span><br><span class="line">s390x-ubuntu-xenial</span><br><span class="line">s390x-ubuntu-bionic</span><br><span class="line">s390x-ubuntu-artful</span><br><span class="line">ppc64le-ubuntu-xenial</span><br><span class="line">ppc64le-ubuntu-bionic</span><br><span class="line">ppc64le-ubuntu-artful</span><br><span class="line">aarch64-ubuntu-xenial</span><br><span class="line">aarch64-ubuntu-bionic</span><br><span class="line">aarch64-debian-jessie</span><br><span class="line">aarch64-debian-stretch</span><br><span class="line">aarch64-debian-buster</span><br><span class="line">aarch64-fedora-26</span><br><span class="line">aarch64-fedora-27</span><br><span class="line">aarch64-fedora-28</span><br><span class="line">aarch64-centos-7</span><br><span class="line">armv6l-raspbian-jessie</span><br><span class="line">armv7l-raspbian-jessie</span><br><span class="line">armv6l-raspbian-stretch</span><br><span class="line">armv7l-raspbian-stretch</span><br><span class="line">armv7l-debian-jessie</span><br><span class="line">armv7l-debian-stretch</span><br><span class="line">armv7l-debian-buster</span><br><span class="line">armv7l-ubuntu-trusty</span><br><span class="line">armv7l-ubuntu-xenial</span><br><span class="line">armv7l-ubuntu-bionic</span><br><span class="line">armv7l-ubuntu-artful</span><br><span class="line">&quot;</span><br><span class="line"></span><br><span class="line">mirror=&apos;&apos;</span><br><span class="line">DRY_RUN=$&#123;DRY_RUN:-&#125;</span><br><span class="line">while [ $# -gt 0 ]; do</span><br><span class="line">    case &quot;$1&quot; in</span><br><span class="line">        --mirror)</span><br><span class="line">            mirror=&quot;$2&quot;</span><br><span class="line">            shift</span><br><span class="line">            ;;</span><br><span class="line">        --dry-run)</span><br><span class="line">            DRY_RUN=1</span><br><span class="line">            ;;</span><br><span class="line">        --*)</span><br><span class="line">            echo &quot;Illegal option $1&quot;</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">    shift $(( $# &gt; 0 ? 1 : 0 ))</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">case &quot;$mirror&quot; in</span><br><span class="line">    Aliyun)</span><br><span class="line">        DOWNLOAD_URL=&quot;https://mirrors.aliyun.com/docker-ce&quot;</span><br><span class="line">        ;;</span><br><span class="line">    AzureChinaCloud)</span><br><span class="line">        DOWNLOAD_URL=&quot;https://mirror.azure.cn/docker-ce&quot;</span><br><span class="line">        ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">command_exists() &#123;</span><br><span class="line">    command -v &quot;$@&quot; &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">is_dry_run() &#123;</span><br><span class="line">    if [ -z &quot;$DRY_RUN&quot; ]; then</span><br><span class="line">        return 1</span><br><span class="line">    else</span><br><span class="line">        return 0</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">deprecation_notice() &#123;</span><br><span class="line">    distro=$1</span><br><span class="line">    date=$2</span><br><span class="line">    echo</span><br><span class="line">    echo &quot;DEPRECATION WARNING:&quot;</span><br><span class="line">    echo &quot;    The distribution, $distro, will no longer be supported in this script as of $date.&quot;</span><br><span class="line">    echo &quot;    If you feel this is a mistake please submit an issue at https://github.com/docker/docker-install/issues/new&quot;</span><br><span class="line">    echo</span><br><span class="line">    sleep 10</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">get_distribution() &#123;</span><br><span class="line">    lsb_dist=&quot;&quot;</span><br><span class="line">    # Every system that we officially support has /etc/os-release</span><br><span class="line">    if [ -r /etc/os-release ]; then</span><br><span class="line">        lsb_dist=&quot;$(. /etc/os-release &amp;&amp; echo &quot;$ID&quot;)&quot;</span><br><span class="line">    fi</span><br><span class="line">    # Returning an empty string here should be alright since the</span><br><span class="line">    # case statements don&apos;t act unless you provide an actual value</span><br><span class="line">    echo &quot;$lsb_dist&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add_debian_backport_repo() &#123;</span><br><span class="line">    debian_version=&quot;$1&quot;</span><br><span class="line">    backports=&quot;deb http://ftp.debian.org/debian $debian_version-backports main&quot;</span><br><span class="line">    if ! grep -Fxq &quot;$backports&quot; /etc/apt/sources.list; then</span><br><span class="line">        (set -x; $sh_c &quot;echo \&quot;$backports\&quot; &gt;&gt; /etc/apt/sources.list&quot;)</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo_docker_as_nonroot() &#123;</span><br><span class="line">    if is_dry_run; then</span><br><span class="line">        return</span><br><span class="line">    fi</span><br><span class="line">    if command_exists docker &amp;&amp; [ -e /var/run/docker.sock ]; then</span><br><span class="line">        (</span><br><span class="line">            set -x</span><br><span class="line">            $sh_c &apos;docker version&apos;</span><br><span class="line">        ) || true</span><br><span class="line">    fi</span><br><span class="line">    your_user=your-user</span><br><span class="line">    [ &quot;$user&quot; != &apos;root&apos; ] &amp;&amp; your_user=&quot;$user&quot;</span><br><span class="line">    # intentionally mixed spaces and tabs here -- tabs are stripped by &quot;&lt;&lt;-EOF&quot;, spaces are kept in the output</span><br><span class="line">    echo &quot;If you would like to use Docker as a non-root user, you should now consider&quot;</span><br><span class="line">    echo &quot;adding your user to the \&quot;docker\&quot; group with something like:&quot;</span><br><span class="line">    echo</span><br><span class="line">    echo &quot;  sudo usermod -aG docker $your_user&quot;</span><br><span class="line">    echo</span><br><span class="line">    echo &quot;Remember that you will have to log out and back in for this to take effect!&quot;</span><br><span class="line">    echo</span><br><span class="line">    echo &quot;WARNING: Adding a user to the \&quot;docker\&quot; group will grant the ability to run&quot;</span><br><span class="line">    echo &quot;         containers which can be used to obtain root privileges on the&quot;</span><br><span class="line">    echo &quot;         docker host.&quot;</span><br><span class="line">    echo &quot;         Refer to https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface&quot;</span><br><span class="line">    echo &quot;         for more information.&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Check if this is a forked Linux distro</span><br><span class="line">check_forked() &#123;</span><br><span class="line"></span><br><span class="line">    # Check for lsb_release command existence, it usually exists in forked distros</span><br><span class="line">    if command_exists lsb_release; then</span><br><span class="line">        # Check if the `-u` option is supported</span><br><span class="line">        set +e</span><br><span class="line">        lsb_release -a -u &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        lsb_release_exit_code=$?</span><br><span class="line">        set -e</span><br><span class="line"></span><br><span class="line">        # Check if the command has exited successfully, it means we&apos;re in a forked distro</span><br><span class="line">        if [ &quot;$lsb_release_exit_code&quot; = &quot;0&quot; ]; then</span><br><span class="line">            # Print info about current distro</span><br><span class="line">            cat &lt;&lt;-EOF</span><br><span class="line">            You&apos;re using &apos;$lsb_dist&apos; version &apos;$dist_version&apos;.</span><br><span class="line">            EOF</span><br><span class="line"></span><br><span class="line">            # Get the upstream release info</span><br><span class="line">            lsb_dist=$(lsb_release -a -u 2&gt;&amp;1 | tr &apos;[:upper:]&apos; &apos;[:lower:]&apos; | grep -E &apos;id&apos; | cut -d &apos;:&apos; -f 2 | tr -d &apos;[:space:]&apos;)</span><br><span class="line">            dist_version=$(lsb_release -a -u 2&gt;&amp;1 | tr &apos;[:upper:]&apos; &apos;[:lower:]&apos; | grep -E &apos;codename&apos; | cut -d &apos;:&apos; -f 2 | tr -d &apos;[:space:]&apos;)</span><br><span class="line"></span><br><span class="line">            # Print info about upstream distro</span><br><span class="line">            cat &lt;&lt;-EOF</span><br><span class="line">            Upstream release is &apos;$lsb_dist&apos; version &apos;$dist_version&apos;.</span><br><span class="line">            EOF</span><br><span class="line">        else</span><br><span class="line">            if [ -r /etc/debian_version ] &amp;&amp; [ &quot;$lsb_dist&quot; != &quot;ubuntu&quot; ] &amp;&amp; [ &quot;$lsb_dist&quot; != &quot;raspbian&quot; ]; then</span><br><span class="line">                if [ &quot;$lsb_dist&quot; = &quot;osmc&quot; ]; then</span><br><span class="line">                    # OSMC runs Raspbian</span><br><span class="line">                    lsb_dist=raspbian</span><br><span class="line">                else</span><br><span class="line">                    # We&apos;re Debian and don&apos;t even know it!</span><br><span class="line">                    lsb_dist=debian</span><br><span class="line">                fi</span><br><span class="line">                dist_version=&quot;$(sed &apos;s/\/.*//&apos; /etc/debian_version | sed &apos;s/\..*//&apos;)&quot;</span><br><span class="line">                case &quot;$dist_version&quot; in</span><br><span class="line">                    9)</span><br><span class="line">                        dist_version=&quot;stretch&quot;</span><br><span class="line">                    ;;</span><br><span class="line">                    8|&apos;Kali Linux 2&apos;)</span><br><span class="line">                        dist_version=&quot;jessie&quot;</span><br><span class="line">                    ;;</span><br><span class="line">                    7)</span><br><span class="line">                        dist_version=&quot;wheezy&quot;</span><br><span class="line">                    ;;</span><br><span class="line">                esac</span><br><span class="line">            fi</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">semverParse() &#123;</span><br><span class="line">    major=&quot;$&#123;1%%.*&#125;&quot;</span><br><span class="line">    minor=&quot;$&#123;1#$major.&#125;&quot;</span><br><span class="line">    minor=&quot;$&#123;minor%%.*&#125;&quot;</span><br><span class="line">    patch=&quot;$&#123;1#$major.$minor.&#125;&quot;</span><br><span class="line">    patch=&quot;$&#123;patch%%[-.]*&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ee_notice() &#123;</span><br><span class="line">    echo</span><br><span class="line">    echo</span><br><span class="line">    echo &quot;  WARNING: $1 is now only supported by Docker EE&quot;</span><br><span class="line">    echo &quot;           Check https://store.docker.com for information on Docker EE&quot;</span><br><span class="line">    echo</span><br><span class="line">    echo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">do_install() &#123;</span><br><span class="line">    echo &quot;# Executing docker install script, commit: $SCRIPT_COMMIT_SHA&quot;</span><br><span class="line"></span><br><span class="line">    if command_exists docker; then</span><br><span class="line">        docker_version=&quot;$(docker -v | cut -d &apos; &apos; -f3 | cut -d &apos;,&apos; -f1)&quot;</span><br><span class="line">        MAJOR_W=1</span><br><span class="line">        MINOR_W=10</span><br><span class="line"></span><br><span class="line">        semverParse &quot;$docker_version&quot;</span><br><span class="line"></span><br><span class="line">        shouldWarn=0</span><br><span class="line">        if [ &quot;$major&quot; -lt &quot;$MAJOR_W&quot; ]; then</span><br><span class="line">            shouldWarn=1</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        if [ &quot;$major&quot; -le &quot;$MAJOR_W&quot; ] &amp;&amp; [ &quot;$minor&quot; -lt &quot;$MINOR_W&quot; ]; then</span><br><span class="line">            shouldWarn=1</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">            Warning: the &quot;docker&quot; command appears to already exist on this system.</span><br><span class="line"></span><br><span class="line">            If you already have Docker installed, this script can cause trouble, which is</span><br><span class="line">            why we&apos;re displaying this warning and provide the opportunity to cancel the</span><br><span class="line">            installation.</span><br><span class="line"></span><br><span class="line">            If you installed the current Docker package using this script and are using it</span><br><span class="line">        EOF</span><br><span class="line"></span><br><span class="line">        if [ $shouldWarn -eq 1 ]; then</span><br><span class="line">            cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">            again to update Docker, we urge you to migrate your image store before upgrading</span><br><span class="line">            to v1.10+.</span><br><span class="line"></span><br><span class="line">            You can find instructions for this here:</span><br><span class="line">            https://github.com/docker/docker/wiki/Engine-v1.10.0-content-addressability-migration</span><br><span class="line">            EOF</span><br><span class="line">        else</span><br><span class="line">            cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">            again to update Docker, you can safely ignore this message.</span><br><span class="line">            EOF</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line"></span><br><span class="line">            You may press Ctrl+C now to abort this script.</span><br><span class="line">        EOF</span><br><span class="line">        ( set -x; sleep 20 )</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    user=&quot;$(id -un 2&gt;/dev/null || true)&quot;</span><br><span class="line"></span><br><span class="line">    sh_c=&apos;sh -c&apos;</span><br><span class="line">    if [ &quot;$user&quot; != &apos;root&apos; ]; then</span><br><span class="line">        if command_exists sudo; then</span><br><span class="line">            sh_c=&apos;sudo -E sh -c&apos;</span><br><span class="line">        elif command_exists su; then</span><br><span class="line">            sh_c=&apos;su -c&apos;</span><br><span class="line">        else</span><br><span class="line">            cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line">            Error: this installer needs the ability to run commands as root.</span><br><span class="line">            We are unable to find either &quot;sudo&quot; or &quot;su&quot; available to make this happen.</span><br><span class="line">            EOF</span><br><span class="line">            exit 1</span><br><span class="line">        fi</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    if is_dry_run; then</span><br><span class="line">        sh_c=&quot;echo&quot;</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # perform some very rudimentary platform detection</span><br><span class="line">    lsb_dist=$( get_distribution )</span><br><span class="line">    lsb_dist=&quot;$(echo &quot;$lsb_dist&quot; | tr &apos;[:upper:]&apos; &apos;[:lower:]&apos;)&quot;</span><br><span class="line"></span><br><span class="line">    case &quot;$lsb_dist&quot; in</span><br><span class="line"></span><br><span class="line">        ubuntu)</span><br><span class="line">            if command_exists lsb_release; then</span><br><span class="line">                dist_version=&quot;$(lsb_release --codename | cut -f2)&quot;</span><br><span class="line">            fi</span><br><span class="line">            if [ -z &quot;$dist_version&quot; ] &amp;&amp; [ -r /etc/lsb-release ]; then</span><br><span class="line">                dist_version=&quot;$(. /etc/lsb-release &amp;&amp; echo &quot;$DISTRIB_CODENAME&quot;)&quot;</span><br><span class="line">            fi</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">        debian|raspbian)</span><br><span class="line">            dist_version=&quot;$(sed &apos;s/\/.*//&apos; /etc/debian_version | sed &apos;s/\..*//&apos;)&quot;</span><br><span class="line">            case &quot;$dist_version&quot; in</span><br><span class="line">                9)</span><br><span class="line">                    dist_version=&quot;stretch&quot;</span><br><span class="line">                ;;</span><br><span class="line">                8)</span><br><span class="line">                    dist_version=&quot;jessie&quot;</span><br><span class="line">                ;;</span><br><span class="line">                7)</span><br><span class="line">                    dist_version=&quot;wheezy&quot;</span><br><span class="line">                ;;</span><br><span class="line">            esac</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">        centos)</span><br><span class="line">            if [ -z &quot;$dist_version&quot; ] &amp;&amp; [ -r /etc/os-release ]; then</span><br><span class="line">                dist_version=&quot;$(. /etc/os-release &amp;&amp; echo &quot;$VERSION_ID&quot;)&quot;</span><br><span class="line">            fi</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">        rhel|ol|sles)</span><br><span class="line">            ee_notice &quot;$lsb_dist&quot;</span><br><span class="line">            exit 1</span><br><span class="line">            ;;</span><br><span class="line"></span><br><span class="line">        *)</span><br><span class="line">            if command_exists lsb_release; then</span><br><span class="line">                dist_version=&quot;$(lsb_release --release | cut -f2)&quot;</span><br><span class="line">            fi</span><br><span class="line">            if [ -z &quot;$dist_version&quot; ] &amp;&amp; [ -r /etc/os-release ]; then</span><br><span class="line">                dist_version=&quot;$(. /etc/os-release &amp;&amp; echo &quot;$VERSION_ID&quot;)&quot;</span><br><span class="line">            fi</span><br><span class="line">        ;;</span><br><span class="line"></span><br><span class="line">    esac</span><br><span class="line"></span><br><span class="line">    # Check if this is a forked Linux distro</span><br><span class="line">    check_forked</span><br><span class="line"></span><br><span class="line">    # Check if we actually support this configuration</span><br><span class="line">    if ! echo &quot;$SUPPORT_MAP&quot; | grep &quot;$(uname -m)-$lsb_dist-$dist_version&quot; &gt;/dev/null; then</span><br><span class="line">        cat &gt;&amp;2 &lt;&lt;-&apos;EOF&apos;</span><br><span class="line"></span><br><span class="line">        Either your platform is not easily detectable or is not supported by this</span><br><span class="line">        installer script.</span><br><span class="line">        Please visit the following URL for more detailed installation instructions:</span><br><span class="line"></span><br><span class="line">        https://docs.docker.com/engine/installation/</span><br><span class="line"></span><br><span class="line">        EOF</span><br><span class="line">        exit 1</span><br><span class="line">    fi</span><br><span class="line"></span><br><span class="line">    # Run setup for each distro accordingly</span><br><span class="line">    case &quot;$lsb_dist&quot; in</span><br><span class="line">        ubuntu|debian|raspbian)</span><br><span class="line">            pre_reqs=&quot;apt-transport-https ca-certificates curl&quot;</span><br><span class="line">            if [ &quot;$lsb_dist&quot; = &quot;debian&quot; ]; then</span><br><span class="line">                if [ &quot;$dist_version&quot; = &quot;wheezy&quot; ]; then</span><br><span class="line">                    add_debian_backport_repo &quot;$dist_version&quot;</span><br><span class="line">                fi</span><br><span class="line">                # libseccomp2 does not exist for debian jessie main repos for aarch64</span><br><span class="line">                if [ &quot;$(uname -m)&quot; = &quot;aarch64&quot; ] &amp;&amp; [ &quot;$dist_version&quot; = &quot;jessie&quot; ]; then</span><br><span class="line">                    add_debian_backport_repo &quot;$dist_version&quot;</span><br><span class="line">                fi</span><br><span class="line">            fi</span><br><span class="line"></span><br><span class="line">            # TODO: August 31, 2018 delete from here,</span><br><span class="line">            if [ &quot;$lsb_dist&quot; =  &quot;ubuntu&quot; ] &amp;&amp; [ &quot;$dist_version&quot; = &quot;artful&quot; ]; then</span><br><span class="line">                deprecation_notice &quot;$lsb_dist $dist_version&quot; &quot;August 31, 2018&quot;</span><br><span class="line">            fi</span><br><span class="line">            # TODO: August 31, 2018 delete to here,</span><br><span class="line"></span><br><span class="line">            if ! command -v gpg &gt; /dev/null; then</span><br><span class="line">                pre_reqs=&quot;$pre_reqs gnupg&quot;</span><br><span class="line">            fi</span><br><span class="line">            apt_repo=&quot;deb [arch=$(dpkg --print-architecture)] $DOWNLOAD_URL/linux/$lsb_dist $dist_version $CHANNEL&quot;</span><br><span class="line">            (</span><br><span class="line">                if ! is_dry_run; then</span><br><span class="line">                    set -x</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &apos;apt-get update -qq &gt;/dev/null&apos;</span><br><span class="line">                $sh_c &quot;apt-get install -y -qq $pre_reqs &gt;/dev/null&quot;</span><br><span class="line">                $sh_c &quot;curl -fsSL \&quot;$DOWNLOAD_URL/linux/$lsb_dist/gpg\&quot; | apt-key add -qq - &gt;/dev/null&quot;</span><br><span class="line">                $sh_c &quot;echo \&quot;$apt_repo\&quot; &gt; /etc/apt/sources.list.d/docker.list&quot;</span><br><span class="line">                if [ &quot;$lsb_dist&quot; = &quot;debian&quot; ] &amp;&amp; [ &quot;$dist_version&quot; = &quot;wheezy&quot; ]; then</span><br><span class="line">                    $sh_c &apos;sed -i &quot;/deb-src.*download\.docker/d&quot; /etc/apt/sources.list.d/docker.list&apos;</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &apos;apt-get update -qq &gt;/dev/null&apos;</span><br><span class="line">            )</span><br><span class="line">            pkg_version=&quot;&quot;</span><br><span class="line">            if [ ! -z &quot;$VERSION&quot; ]; then</span><br><span class="line">                if is_dry_run; then</span><br><span class="line">                    echo &quot;# WARNING: VERSION pinning is not supported in DRY_RUN&quot;</span><br><span class="line">                else</span><br><span class="line">                    # Will work for incomplete versions IE (17.12), but may not actually grab the &quot;latest&quot; if in the test channel</span><br><span class="line">                    pkg_pattern=&quot;$(echo &quot;$VERSION&quot; | sed &quot;s/-ce-/~ce~.*/g&quot; | sed &quot;s/-/.*/g&quot;).*-0~$lsb_dist&quot;</span><br><span class="line">                    search_command=&quot;apt-cache madison &apos;docker-ce&apos; | grep &apos;$pkg_pattern&apos; | head -1 | cut -d&apos; &apos; -f 4&quot;</span><br><span class="line">                    pkg_version=&quot;$($sh_c &quot;$search_command&quot;)&quot;</span><br><span class="line">                    echo &quot;INFO: Searching repository for VERSION &apos;$VERSION&apos;&quot;</span><br><span class="line">                    echo &quot;INFO: $search_command&quot;</span><br><span class="line">                    if [ -z &quot;$pkg_version&quot; ]; then</span><br><span class="line">                        echo</span><br><span class="line">                        echo &quot;ERROR: &apos;$VERSION&apos; not found amongst apt-cache madison results&quot;</span><br><span class="line">                        echo</span><br><span class="line">                        exit 1</span><br><span class="line">                    fi</span><br><span class="line">                    pkg_version=&quot;=$pkg_version&quot;</span><br><span class="line">                fi</span><br><span class="line">            fi</span><br><span class="line">            (</span><br><span class="line">                if ! is_dry_run; then</span><br><span class="line">                    set -x</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &quot;apt-get install -y -qq --no-install-recommends docker-ce$pkg_version &gt;/dev/null&quot;</span><br><span class="line">            )</span><br><span class="line">            echo_docker_as_nonroot</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">        centos|fedora)</span><br><span class="line">            yum_repo=&quot;$DOWNLOAD_URL/linux/$lsb_dist/$REPO_FILE&quot;</span><br><span class="line">            if ! curl -Ifs &quot;$yum_repo&quot; &gt; /dev/null; then</span><br><span class="line">                echo &quot;Error: Unable to curl repository file $yum_repo, is it valid?&quot;</span><br><span class="line">                exit 1</span><br><span class="line">            fi</span><br><span class="line">            if [ &quot;$lsb_dist&quot; = &quot;fedora&quot; ]; then</span><br><span class="line">                if [ &quot;$dist_version&quot; -lt &quot;26&quot; ]; then</span><br><span class="line">                    echo &quot;Error: Only Fedora &gt;=26 are supported&quot;</span><br><span class="line">                    exit 1</span><br><span class="line">                fi</span><br><span class="line"></span><br><span class="line">                pkg_manager=&quot;dnf&quot;</span><br><span class="line">                config_manager=&quot;dnf config-manager&quot;</span><br><span class="line">                enable_channel_flag=&quot;--set-enabled&quot;</span><br><span class="line">                pre_reqs=&quot;dnf-plugins-core&quot;</span><br><span class="line">                pkg_suffix=&quot;fc$dist_version&quot;</span><br><span class="line">            else</span><br><span class="line">                pkg_manager=&quot;yum&quot;</span><br><span class="line">                config_manager=&quot;yum-config-manager&quot;</span><br><span class="line">                enable_channel_flag=&quot;--enable&quot;</span><br><span class="line">                pre_reqs=&quot;yum-utils&quot;</span><br><span class="line">                pkg_suffix=&quot;el&quot;</span><br><span class="line">            fi</span><br><span class="line">            (</span><br><span class="line">                if ! is_dry_run; then</span><br><span class="line">                    set -x</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &quot;$pkg_manager install -y -q $pre_reqs&quot;</span><br><span class="line">                $sh_c &quot;$config_manager --add-repo $yum_repo&quot;</span><br><span class="line"></span><br><span class="line">                if [ &quot;$CHANNEL&quot; != &quot;stable&quot; ]; then</span><br><span class="line">                    $sh_c &quot;$config_manager $enable_channel_flag docker-ce-$CHANNEL&quot;</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &quot;$pkg_manager makecache&quot;</span><br><span class="line">            )</span><br><span class="line">            pkg_version=&quot;&quot;</span><br><span class="line">            if [ ! -z &quot;$VERSION&quot; ]; then</span><br><span class="line">                if is_dry_run; then</span><br><span class="line">                    echo &quot;# WARNING: VERSION pinning is not supported in DRY_RUN&quot;</span><br><span class="line">                else</span><br><span class="line">                    pkg_pattern=&quot;$(echo &quot;$VERSION&quot; | sed &quot;s/-ce-/\\\\.ce.*/g&quot; | sed &quot;s/-/.*/g&quot;).*$pkg_suffix&quot;</span><br><span class="line">                    search_command=&quot;$pkg_manager list --showduplicates &apos;docker-ce&apos; | grep &apos;$pkg_pattern&apos; | tail -1 | awk &apos;&#123;print \$2&#125;&apos;&quot;</span><br><span class="line">                    pkg_version=&quot;$($sh_c &quot;$search_command&quot;)&quot;</span><br><span class="line">                    echo &quot;INFO: Searching repository for VERSION &apos;$VERSION&apos;&quot;</span><br><span class="line">                    echo &quot;INFO: $search_command&quot;</span><br><span class="line">                    if [ -z &quot;$pkg_version&quot; ]; then</span><br><span class="line">                        echo</span><br><span class="line">                        echo &quot;ERROR: &apos;$VERSION&apos; not found amongst $pkg_manager list results&quot;</span><br><span class="line">                        echo</span><br><span class="line">                        exit 1</span><br><span class="line">                    fi</span><br><span class="line">                    # Cut out the epoch and prefix with a &apos;-&apos;</span><br><span class="line">                    pkg_version=&quot;-$(echo &quot;$pkg_version&quot; | cut -d&apos;:&apos; -f 2)&quot;</span><br><span class="line">                fi</span><br><span class="line">            fi</span><br><span class="line">            (</span><br><span class="line">                if ! is_dry_run; then</span><br><span class="line">                    set -x</span><br><span class="line">                fi</span><br><span class="line">                $sh_c &quot;$pkg_manager install -y -q docker-ce$pkg_version&quot;</span><br><span class="line">            )</span><br><span class="line">            echo_docker_as_nonroot</span><br><span class="line">            exit 0</span><br><span class="line">            ;;</span><br><span class="line">    esac</span><br><span class="line">    exit 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># wrapped up in a function so that we have some protection against only getting</span><br><span class="line"># half the file during &quot;curl | sh&quot;</span><br><span class="line">do_install</span><br></pre></td></tr></table></figure></div></div></div>

<h2 id="制作自定义镜像"><a href="#制作自定义镜像" class="headerlink" title="制作自定义镜像"></a>制作自定义镜像</h2><figure class="highlight plain"><figcaption><span>/data/dockerfile/jenkins</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 jenkins]# ls -l</span><br><span class="line">total 24</span><br><span class="line">-rw------- 1 root root    98 Jan  17 15:58 config.json</span><br><span class="line">-rw-r--r-- 1 root root   158 Jan  17 15:59 Dockerfile</span><br><span class="line">-rwxr-xr-x 1 root root 13847 Jan  17 15:37 get-docker.sh</span><br><span class="line">-rw------- 1 root root  1679 Jan  17 15:39 id_rsa</span><br><span class="line">[root@hdss7-200 jenkins]# docker build . -t harbor.od.com/infra/jenkins:v2.164.1</span><br><span class="line">Sending build context to Docker daemon 19.46 kB</span><br><span class="line">Step 1 : FROM harbor.od.com/public/jenkins:v2.164.1</span><br><span class="line"> ---&gt; 256cb12e72d6</span><br><span class="line">Step 2 : USER root</span><br><span class="line"> ---&gt; Running in d600e9db8305</span><br><span class="line"> ---&gt; 03687cf21cb3</span><br><span class="line">Removing intermediate container d600e9db8305</span><br><span class="line">Step 3 : RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line"> ---&gt; Running in 3d79b4025e97</span><br><span class="line"> ---&gt; e4790b3bb6d9</span><br><span class="line">Removing intermediate container 3d79b4025e97</span><br><span class="line">Step 4 : ADD id_rsa /root/.ssh/id_rsa</span><br><span class="line"> ---&gt; 39d80713d43c</span><br><span class="line">Removing intermediate container 7b4e66e726dd</span><br><span class="line">Step 5 : ADD config.json /root/.docker/config.json</span><br><span class="line"> ---&gt; a44402fd4bc1</span><br><span class="line">Removing intermediate container f1ae1871d035</span><br><span class="line">Step 6 : ADD get-docker.sh /get-docker.sh</span><br><span class="line"> ---&gt; 189ccca429e4</span><br><span class="line">Removing intermediate container a0ff59237fe5</span><br><span class="line">Step 7 : RUN /get-docker.sh</span><br><span class="line"> ---&gt; Running in 5a7d69c1af45</span><br><span class="line"># Executing docker install script, commit: cfba462</span><br><span class="line">+ sh -c apt-get update -qq &gt;/dev/null</span><br><span class="line">+ sh -c apt-get install -y -qq apt-transport-https ca-certificates curl &gt;/dev/null</span><br><span class="line">debconf: delaying package configuration, since apt-utils is not installed</span><br><span class="line">+ sh -c curl -fsSL &quot;https://download.docker.com/linux/debian/gpg&quot; | apt-key add -qq - &gt;/dev/null</span><br><span class="line">Warning: apt-key output should not be parsed (stdout is not a terminal)</span><br><span class="line">+ sh -c echo &quot;deb [arch=amd64] https://download.docker.com/linux/debian stretch stable&quot; &gt; /etc/apt/sources.list.d/docker.list</span><br><span class="line">+ sh -c apt-get update -qq &gt;/dev/null</span><br><span class="line">+ sh -c apt-get install -y -qq --no-install-recommends docker-ce &gt;/dev/null</span><br><span class="line">debconf: delaying package configuration, since apt-utils is not installed</span><br><span class="line">If you would like to use Docker as a non-root user, you should now consider</span><br><span class="line">adding your user to the &quot;docker&quot; group with something like:</span><br><span class="line"></span><br><span class="line">  sudo usermod -aG docker your-user</span><br><span class="line"></span><br><span class="line">Remember that you will have to log out and back in for this to take effect!</span><br><span class="line"></span><br><span class="line">WARNING: Adding a user to the &quot;docker&quot; group will grant the ability to run</span><br><span class="line">         containers which can be used to obtain root privileges on the</span><br><span class="line">         docker host.</span><br><span class="line">         Refer to https://docs.docker.com/engine/security/security/#docker-daemon-attack-surface</span><br><span class="line">         for more information.</span><br><span class="line"></span><br><span class="line">** DOCKER ENGINE - ENTERPRISE **</span><br><span class="line"></span><br><span class="line">If you’re ready for production workloads, Docker Engine - Enterprise also includes:</span><br><span class="line"></span><br><span class="line">  * SLA-backed technical support</span><br><span class="line">  * Extended lifecycle maintenance policy for patches and hotfixes</span><br><span class="line">  * Access to certified ecosystem content</span><br><span class="line"></span><br><span class="line">** Learn more at https://dockr.ly/engine2 **</span><br><span class="line"></span><br><span class="line">ACTIVATE your own engine to Docker Engine - Enterprise using:</span><br><span class="line"></span><br><span class="line">  sudo docker engine activate</span><br><span class="line"></span><br><span class="line"> ---&gt; 64c74242ee28</span><br><span class="line">Removing intermediate container 5a7d69c1af45</span><br><span class="line">Successfully built 64c74242ee28</span><br><span class="line">[root@hdss7-200 jenkins]# docker push harbor.od.com/infra/jenkins:v2.164.1</span><br></pre></td></tr></table></figure>

<h2 id="准备共享存储"><a href="#准备共享存储" class="headerlink" title="准备共享存储"></a>准备共享存储</h2><p>运维主机，以及所有运算节点上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># yum install nfs-utils -y</span><br></pre></td></tr></table></figure>

<ul>
<li>配置NFS服务</li>
</ul>
<p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/etc/exports</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/nfs-volume 10.4.7.0/24(rw,no_root_squash)</span><br></pre></td></tr></table></figure>

<ul>
<li>启动NFS服务</li>
</ul>
<p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 ~]# mkdir -p /data/nfs-volume</span><br><span class="line">[root@hdss7-200 ~]# systemctl start nfs</span><br><span class="line">[root@hdss7-200 ~]# systemctl enable nfs</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h2><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 k8s-yaml]# mkdir /data/k8s-yaml/jenkins &amp;&amp; mkdir /data/nfs-volume/jenkins_home &amp;&amp; cd /data/k8s-yaml/jenkins</span><br></pre></td></tr></table></figure>

<div class="tabs" id="jenkins-yaml"><ul class="nav-tabs"><li class="tab active"><a href="#jenkins-yaml-1">Deployment</a></li><li class="tab"><a href="#jenkins-yaml-2">Service</a></li><li class="tab"><a href="#jenkins-yaml-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="jenkins-yaml-1"><p>vi deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: jenkins</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: jenkins</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: jenkins </span><br><span class="line">        name: jenkins</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: data</span><br><span class="line">        nfs: </span><br><span class="line">          server: hdss7-200</span><br><span class="line">          path: /data/nfs-volume/jenkins_home</span><br><span class="line">      - name: docker</span><br><span class="line">        hostPath: </span><br><span class="line">          path: /run/docker.sock</span><br><span class="line">          type: &apos;&apos;</span><br><span class="line">      containers:</span><br><span class="line">      - name: jenkins</span><br><span class="line">        image: harbor.od.com/infra/jenkins:v2.164.1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAVA_OPTS</span><br><span class="line">          value: -Xmx512m -Xms512m</span><br><span class="line">        resources:</span><br><span class="line">          limits: </span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">          requests: </span><br><span class="line">            cpu: 500m</span><br><span class="line">            memory: 1Gi</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: /var/jenkins_home</span><br><span class="line">        - name: docker</span><br><span class="line">          mountPath: /run/docker.sock</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="jenkins-yaml-2"><p>vi svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app: jenkins</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="jenkins-yaml-3"><p>vi ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: jenkins</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: jenkins.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: jenkins</span><br><span class="line">          servicePort: 80</span><br></pre></td></tr></table></figure></div></div></div>

<h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>任意一个k8s运算节点上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl create namespace infra</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f  http://k8s-yaml.od.com/jenkins/deployment.yaml</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f  http://k8s-yaml.od.com/jenkins/svc.yaml</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f  http://k8s-yaml.od.com/jenkins/ingress.yaml</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl get pods -n infra|grep jenkins</span><br><span class="line">NAME                                READY     STATUS    RESTARTS   AGE</span><br><span class="line">jenkins-84455f9675-jpkr8            1/1       Running   0          0d</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl get svc -n infra|grep jenkins</span><br><span class="line">NAME           TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE</span><br><span class="line">jenkins        ClusterIP   None             &lt;none&gt;        8080/TCP   0d</span><br><span class="line"></span><br><span class="line">[root@hdss7-21 ~]# kubectl get ingress -n infra|grep jenkins</span><br><span class="line">NAME           HOSTS                          ADDRESS   PORTS     AGE</span><br><span class="line">jenkins        jenkins.od.com                           80        0d</span><br></pre></td></tr></table></figure>

<h2 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h2><p><code>HDSS7-11.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jenkins	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h2 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h2><p><a href="http://jenkins.od.com" target="_blank" rel="noopener">http://jenkins.od.com</a></p>
<h2 id="页面配置jenkins"><a href="#页面配置jenkins" class="headerlink" title="页面配置jenkins"></a>页面配置jenkins</h2><p><img src="/images/jenkins-init.png" alt="jenkins初始化页面" title="jenkins初始化页面"></p>
<h3 id="初始化密码"><a href="#初始化密码" class="headerlink" title="初始化密码"></a>初始化密码</h3><figure class="highlight plain"><figcaption><span>/data/nfs-volume/jenkins_home/secrets/initialAdminPassword</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 secrets]# cat initialAdminPassword </span><br><span class="line">08d17edc125444a28ad6141ffdfd5c69</span><br></pre></td></tr></table></figure>

<h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><p><img src="/images/jenkins-install.png" alt="jenkins安装页面" title="jenkins安装页面"></p>
<h3 id="设置用户"><a href="#设置用户" class="headerlink" title="设置用户"></a>设置用户</h3><p><img src="/images/jenkins-user.png" alt="jenkins设置用户" title="jenkins设置用户"></p>
<h3 id="完成安装"><a href="#完成安装" class="headerlink" title="完成安装"></a>完成安装</h3><p><img src="/images/jenkins-url.png" alt="jenkins完成安装1" title="jenkins完成安装1"><br><img src="/images/jenkins-ready.png" alt="jenkins完成安装2" title="jenkins完成安装2"></p>
<h3 id="使用admin登录"><a href="#使用admin登录" class="headerlink" title="使用admin登录"></a>使用admin登录</h3><p><img src="/images/jenkins-welcome.png" alt="jenkins登录" title="jenkins登录"></p>
<h3 id="安装Blue-Ocean插件"><a href="#安装Blue-Ocean插件" class="headerlink" title="安装Blue Ocean插件"></a>安装Blue Ocean插件</h3><ul>
<li>Manage Jenkins</li>
<li>Manage Plugins</li>
<li>Available</li>
<li>Blue Ocean</li>
</ul>
<h3 id="调整安全选项"><a href="#调整安全选项" class="headerlink" title="调整安全选项"></a>调整安全选项</h3><ul>
<li>Manage Jenkins</li>
<li>Configure Global Security</li>
<li>Allow anonymous read access</li>
</ul>
<h2 id="配置New-job"><a href="#配置New-job" class="headerlink" title="配置New job"></a>配置New job</h2><ul>
<li><p>create new jobs</p>
</li>
<li><p>Enter an item name</p>
<blockquote>
<p>dubbo-demo</p>
</blockquote>
</li>
<li><p>Pipeline -&gt; OK</p>
</li>
<li><p>Discard old builds</p>
<blockquote>
<p>Days to keep builds : 3<br>Max # of builds to keep : 30</p>
</blockquote>
</li>
<li><p>This project is parameterized</p>
</li>
</ul>
<ol>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : app_name<br>Default Value :<br>Description : project name. e.g: dubbo-demo-service</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : image_name<br>Default Value :<br>Description : project docker image name. e.g:  app/dubbo-demo-service</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_repo<br>Default Value :<br>Description : project git repository. e.g: <a href="https://gitee.com/stanleywang/dubbo-demo-service.git" target="_blank" rel="noopener">https://gitee.com/stanleywang/dubbo-demo-service.git</a></p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : git_ver<br>Default Value :<br>Description : git commit id of the project.</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : add_tag<br>Default Value :<br>Description : project docker image tag, date_timestamp recommended. e.g: 190117_1920</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_dir<br>Default Value : ./<br>Description : project maven directory. e.g: ./</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : target_dir<br>Default Value : ./target<br>Description : the relative path of target file such as .jar or .war package. e.g: ./dubbo-server/target</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; String Parameter</p>
<blockquote>
<p>Name : mvn_cmd<br>Default Value : mvn clean package -Dmaven.test.skip=true<br>Description : maven command. e.g: mvn clean package -e -q -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : base_image<br>Default Value : </p>
<ul>
<li>base/jre7:7u80</li>
<li>base/jre8:8u112<br>Description : project base image list in harbor.od.com.</li>
</ul>
</blockquote>
</li>
<li><p>Add Parameter -&gt; Choice Parameter</p>
<blockquote>
<p>Name : maven<br>Default Value : </p>
<ul>
<li>3.6.0-8u181</li>
<li>3.2.5-6u025</li>
<li>2.2.1-6u025<br>Description : different maven edition.</li>
</ul>
</blockquote>
</li>
</ol>
<h2 id="Pipeline-Script"><a href="#Pipeline-Script" class="headerlink" title="Pipeline Script"></a>Pipeline Script</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">  agent any </span><br><span class="line">    stages &#123;</span><br><span class="line">      stage(&apos;pull&apos;) &#123; //get project code from repo </span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;git clone $&#123;params.git_repo&#125; $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; git checkout $&#123;params.git_ver&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&apos;build&apos;) &#123; //exec mvn cmd</span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;  &amp;&amp; /var/jenkins_home/maven-$&#123;params.maven&#125;/bin/$&#123;params.mvn_cmd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&apos;package&apos;) &#123; //move jar file into project_dir</span><br><span class="line">        steps &#123;</span><br><span class="line">          sh &quot;cd $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; cd $&#123;params.target_dir&#125; &amp;&amp; mkdir project_dir &amp;&amp; mv *.jar ./project_dir&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      stage(&apos;image&apos;) &#123; //build image and push to registry</span><br><span class="line">        steps &#123;</span><br><span class="line">          writeFile file: &quot;$&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125;/Dockerfile&quot;, text: &quot;&quot;&quot;FROM harbor.od.com/$&#123;params.base_image&#125;</span><br><span class="line">ADD $&#123;params.target_dir&#125;/project_dir /opt/project_dir&quot;&quot;&quot;</span><br><span class="line">          sh &quot;cd  $&#123;params.app_name&#125;/$&#123;env.BUILD_NUMBER&#125; &amp;&amp; docker build -t harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125; . &amp;&amp; docker push harbor.od.com/$&#123;params.image_name&#125;:$&#123;params.git_ver&#125;_$&#123;params.add_tag&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="最后的准备工作"><a href="#最后的准备工作" class="headerlink" title="最后的准备工作"></a>最后的准备工作</h1><h2 id="检查jenkins容器里的docker客户端"><a href="#检查jenkins容器里的docker客户端" class="headerlink" title="检查jenkins容器里的docker客户端"></a>检查jenkins容器里的docker客户端</h2><p>进入jenkins的docker容器里，检查docker客户端是否可用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# docker exec -ti 52e250789b78 bash</span><br><span class="line">root@52e250789b78:/# docker ps -a</span><br></pre></td></tr></table></figure>

<h2 id="检查jenkins容器里的SSH-key"><a href="#检查jenkins容器里的SSH-key" class="headerlink" title="检查jenkins容器里的SSH key"></a>检查jenkins容器里的SSH key</h2><p>进入jenkins的docker容器里，检查ssh连接git仓库，确认是否能拉到代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 ~]# docker exec -ti 52e250789b78 bash</span><br><span class="line">root@52e250789b78:/# ssh -i /root/.ssh/id_rsa -T git@gitee.com                                                                                              </span><br><span class="line">Hi Anonymous! You&apos;ve successfully authenticated, but GITEE.COM does not provide shell access.</span><br><span class="line">Note: Perhaps the current use is DeployKey.</span><br><span class="line">Note: DeployKey only supports pull/fetch operations</span><br></pre></td></tr></table></figure>

<h2 id="部署maven软件"><a href="#部署maven软件" class="headerlink" title="部署maven软件"></a>部署maven软件</h2><p><a href="http://maven.apache.org/docs/history.html" target="_blank" rel="noopener">maven官方下载地址</a><br>在运维主机<code>HDSS7-200.host.com</code>上二进制部署，这里部署maven-3.6.0版</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-22 src]# ls -l</span><br><span class="line">total 8852</span><br><span class="line">-rw-r--r-- 1 root root 9063587 Jan  17 19:57 apache-maven-3.6.0-bin.tar.gz</span><br><span class="line">[root@hdss7-200 src]# tar xf apache-maven-3.6.0-bin.tar.gz -C /data/nfs-volume/jenkins_home/maven-3.6.0-8u181</span><br><span class="line">[root@hdss7-200 src]# mv /data/nfs-volume/jenkins_home/apache-maven-3.6.0/ /data/nfs-volume/jenkins_home/maven-3.6.0-8u181</span><br><span class="line">[root@hdss7-200 src]# ls -ld /data/nfs-volume/jenkins_home/maven-3.6.0-8u181</span><br><span class="line">drwxr-xr-x 6 root root 99 Jan  17 19:58 /data/nfs-volume/jenkins_home/maven-3.6.0-8u181</span><br></pre></td></tr></table></figure>

<p>设置国内镜像源</p>
<figure class="highlight plain"><figcaption><span>/data/nfs-volume/jenkins_home/maven-3.6.0-8u181/conf/setting.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;mirror&gt;</span><br><span class="line">  &lt;id&gt;alimaven&lt;/id&gt;</span><br><span class="line">  &lt;name&gt;aliyun maven&lt;/name&gt;</span><br><span class="line">  &lt;url&gt;http://maven.aliyun.com/nexus/content/groups/public/&lt;/url&gt;</span><br><span class="line">  &lt;mirrorOf&gt;central&lt;/mirrorOf&gt;        </span><br><span class="line">&lt;/mirror&gt;</span><br></pre></td></tr></table></figure>

<p>其他版本略</p>
<h2 id="制作dubbo微服务的底包镜像"><a href="#制作dubbo微服务的底包镜像" class="headerlink" title="制作dubbo微服务的底包镜像"></a>制作dubbo微服务的底包镜像</h2><p>运维主机<code>HDSS7-200.host.com</code>上</p>
<ol>
<li>自定义Dockerfile</li>
</ol>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/jre8/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">FROM stanleyws/jre8:8u112</span><br><span class="line">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line">ADD config.yml /opt/prom/config.yml</span><br><span class="line">ADD jmx_javaagent-0.3.1.jar /opt/prom/</span><br><span class="line">WORKDIR /opt/project_dir</span><br><span class="line">ADD entrypoint.sh /entrypoint.sh</span><br><span class="line">CMD [&quot;/entrypoint.sh&quot;]</span><br></pre></td></tr></table></figure>

<div class="tabs" id="jre-dockerfile"><ul class="nav-tabs"><li class="tab active"><a href="#jre-dockerfile-1">config.yml</a></li><li class="tab"><a href="#jre-dockerfile-2">jmx_javaagent-0.3.1.jar</a></li><li class="tab"><a href="#jre-dockerfile-3">entrypoint.sh</a></li></ul><div class="tab-content"><div class="tab-pane active" id="jre-dockerfile-1"><p>vi config.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\--\-</span><br><span class="line">rules:</span><br><span class="line">  - pattern: &apos;.*&apos;</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="jre-dockerfile-2"><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.3.1/jmx_prometheus_javaagent-0.3.1.jar -O jmx_javaagent-0.3.1.jar</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="jre-dockerfile-3"><p>vi entrypoint.sh  (不要忘了给执行权限)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">M_OPTS=&quot;-Duser.timezone=Asia/Shanghai -javaagent:/opt/prom/jmx_javaagent-0.3.1.jar=$(hostname -i):$&#123;M_PORT:-&quot;12346&quot;&#125;:/opt/prom/config.yml&quot;</span><br><span class="line">C_OPTS=$&#123;C_OPTS&#125;</span><br><span class="line">JAR_BALL=$&#123;JAR_BALL&#125;</span><br><span class="line">exec java -jar $&#123;M_OPTS&#125; $&#123;C_OPTS&#125; $&#123;JAR_BALL&#125;</span><br></pre></td></tr></table></figure></div></div></div>

<ol start="2">
<li>制作dubbo服务docker底包</li>
</ol>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/jre8</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 jre8]# ls -l</span><br><span class="line">total 372</span><br><span class="line">-rw-r--r-- 1 root root     29 Jan  17 19:09 config.yml</span><br><span class="line">-rw-r--r-- 1 root root    287 Jan  17 19:06 Dockerfile</span><br><span class="line">-rwxr--r-- 1 root root    250 Jan  17 19:11 entrypoint.sh</span><br><span class="line">-rw-r--r-- 1 root root 367417 May 10  2018 jmx_javaagent-0.3.1.jar</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 jre8]# docker build . -t harbor.od.com/base/jre8:8u112</span><br><span class="line">Sending build context to Docker daemon 372.2 kB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5da5ab0b1a48</span><br><span class="line">Step 3 : ADD config.yml /opt/prom/config.yml</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 70d3ebfe88f5</span><br><span class="line">Step 4 : ADD jmx_javaagent-0.3.1.jar /opt/prom/</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 08b38a0684a8</span><br><span class="line">Step 5 : WORKDIR /opt/project_dir</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; f06adf17fb69</span><br><span class="line">Step 6 : ADD entrypoint.sh /entrypoint.sh</span><br><span class="line"> ---&gt; e34f185d5c52</span><br><span class="line">Removing intermediate container ee213576ca0e</span><br><span class="line">Step 7 : CMD /entrypoint.sh</span><br><span class="line"> ---&gt; Running in 655f594bcbe2</span><br><span class="line"> ---&gt; 47852bc0ade9</span><br><span class="line">Removing intermediate container 655f594bcbe2</span><br><span class="line">Successfully built 47852bc0ade9</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 jre8]# docker push harbor.od.com/base/jre8:8u112</span><br><span class="line">The push refers to a repository [harbor.od.com/base/jre8]</span><br><span class="line">0b2b753b122e: Pushed </span><br><span class="line">67e1b844d09c: Pushed </span><br><span class="line">ad4fa4673d87: Pushed </span><br><span class="line">0ef3a1b4ca9f: Pushed </span><br><span class="line">052016a734be: Pushed </span><br><span class="line">0690f10a63a5: Pushed </span><br><span class="line">c843b2cf4e12: Pushed </span><br><span class="line">fddd8887b725: Pushed </span><br><span class="line">42052a19230c: Pushed </span><br><span class="line">8d4d1ab5ff74: Pushed </span><br><span class="line">8u112: digest: sha256:252e3e869039ee6242c39bdfee0809242e83c8c3a06830f1224435935aeded28 size: 2405</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>jre7底包制作类似，这里略</p>
<h1 id="交付dubbo微服务至kubernetes集群"><a href="#交付dubbo微服务至kubernetes集群" class="headerlink" title="交付dubbo微服务至kubernetes集群"></a>交付dubbo微服务至kubernetes集群</h1><h2 id="dubbo服务提供者（dubbo-demo-service）"><a href="#dubbo服务提供者（dubbo-demo-service）" class="headerlink" title="dubbo服务提供者（dubbo-demo-service）"></a>dubbo服务提供者（dubbo-demo-service）</h2><h3 id="通过jenkins进行一次CI"><a href="#通过jenkins进行一次CI" class="headerlink" title="通过jenkins进行一次CI"></a>通过jenkins进行一次CI</h3><p>打开jenkins页面，使用admin登录，准备构建<code>dubbo-demo</code>项目</p>
<p><img src="/images/jenkins-firstbuild.png" alt="jenkins构建" title="jenkins构建"><br>点<code>Build with Parameters</code></p>
<p><img src="/images/jenkins-builddetail.png" alt="jenkins构建详情" title="jenkins构建详情"><br>依次填入/选择：</p>
<ul>
<li><p>app_name</p>
<blockquote>
<p>dubbo-demo-service</p>
</blockquote>
</li>
<li><p>image_name</p>
<blockquote>
<p>app/dubbo-demo-service</p>
</blockquote>
</li>
<li><p>git_repo</p>
<blockquote>
<p><a href="https://gitee.com/stanleywang/dubbo-demo-service.git" target="_blank" rel="noopener">https://gitee.com/stanleywang/dubbo-demo-service.git</a></p>
</blockquote>
</li>
<li><p>git_ver</p>
<blockquote>
<p>master</p>
</blockquote>
</li>
<li><p>add_tag</p>
<blockquote>
<p>190117_1920</p>
</blockquote>
</li>
<li><p>mvn_dir</p>
<blockquote>
<p>/</p>
</blockquote>
</li>
<li><p>target_dir</p>
<blockquote>
<p>./dubbo-server/target</p>
</blockquote>
</li>
<li><p>mvn_cmd</p>
<blockquote>
<p>mvn clean package -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>base_image</p>
<blockquote>
<p>base/jre8:8u112</p>
</blockquote>
</li>
<li><p>maven</p>
<blockquote>
<p>3.6.0-8u181</p>
</blockquote>
</li>
</ul>
<p>点击<code>Build</code>进行构建，等待构建完成。</p>
<p>test $? -eq 0 &amp;&amp; <span class="label success">成功，进行下一步</span> || <span class="label danger">失败，排错直到成功</span></p>
<h3 id="检查harbor仓库内镜像"><a href="#检查harbor仓库内镜像" class="headerlink" title="检查harbor仓库内镜像"></a>检查harbor仓库内镜像</h3><p><img src="/images/harbor-firstci.png" alt="harbor仓库内镜像" title="harbor仓库内镜像"></p>
<h3 id="准备k8s资源配置清单"><a href="#准备k8s资源配置清单" class="headerlink" title="准备k8s资源配置清单"></a>准备k8s资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上，准备资源配置清单：</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml/dubbo-demo-service/deployment.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-service:master_190117_1920</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-demo-service created</span><br></pre></td></tr></table></figure>

<h3 id="检查docker运行情况及zk里的信息"><a href="#检查docker运行情况及zk里的信息" class="headerlink" title="检查docker运行情况及zk里的信息"></a>检查docker运行情况及zk里的信息</h3><figure class="highlight plain"><figcaption><span>/opt/zookeeper/bin/zkCli.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# /opt/zookeeper/bin/zkCli.sh -server localhost</span><br><span class="line">[zk: localhost(CONNECTED) 0] ls /dubbo</span><br><span class="line">[com.od.dubbotest.api.HelloService]</span><br></pre></td></tr></table></figure>

<h2 id="dubbo-monitor工具"><a href="#dubbo-monitor工具" class="headerlink" title="dubbo-monitor工具"></a>dubbo-monitor工具</h2><p><a href="https://github.com/Jeromefromcn/dubbo-monitor.git" target="_blank" rel="noopener">dubbo-monitor源码包</a></p>
<h3 id="准备docker镜像"><a href="#准备docker镜像" class="headerlink" title="准备docker镜像"></a>准备docker镜像</h3><h4 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a>下载源码</h4><p>下载到运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep dubbo-monitor</span><br><span class="line">drwxr-xr-x 4 root root      81 Jan  17 13:58 dubbo-monitor</span><br></pre></td></tr></table></figure>

<h4 id="修改配置"><a href="#修改配置" class="headerlink" title="修改配置"></a>修改配置</h4><figure class="highlight plain"><figcaption><span>/opt/src/dubbo-monitor/dubbo-monitor-simple/conf/dubbo_origin.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dubbo.registry.address=zookeeper://zk1.od.com:2181?backup=zk2.od.com:2181,zk3.od.com:2181</span><br><span class="line">dubbo.protocol.port=20880</span><br><span class="line">dubbo.jetty.port=8080</span><br><span class="line">dubbo.jetty.directory=/dubbo-monitor-simple/monitor</span><br><span class="line">dubbo.statistics.directory=/dubbo-monitor-simple/statistics</span><br><span class="line">dubbo.log4j.file=logs/dubbo-monitor.log</span><br></pre></td></tr></table></figure>

<h4 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h4><ol>
<li><p>准备环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# mkdir /data/dockerfile/dubbo-monitor</span><br><span class="line">[root@hdss7-200 src]# cp -a dubbo-monitor/* /data/dockerfile/dubbo-monitor/</span><br><span class="line">[root@hdss7-200 src]# cd /data/dockerfile/dubbo-monitor/</span><br><span class="line">[root@hdss7-200 dubbo-monitor]# sed -r -i -e &apos;/^nohup/&#123;p;:a;N;$!ba;d&#125;&apos;  ./dubbo-monitor-simple/bin/start.sh &amp;&amp; sed  -r -i -e &quot;s%^nohup(.*)%exec \1%&quot;  ./dubbo-monitor-simple/bin/start.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>准备Dockerfile</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/dubbo-monitor/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FROM jeromefromcn/docker-alpine-java-bash</span><br><span class="line">MAINTAINER Jerome Jiang</span><br><span class="line">COPY dubbo-monitor-simple/ /dubbo-monitor-simple/</span><br><span class="line">CMD /dubbo-monitor-simple/bin/start.sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>build镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 dubbo-monitor]# docker build . -t harbor.od.com/infra/dubbo-monitor:latest</span><br><span class="line">Sending build context to Docker daemon 26.21 MB</span><br><span class="line">Step 1 : FROM harbor.od.com/base/jre7:7u80</span><br><span class="line"> ---&gt; dbba4641da57</span><br><span class="line">Step 2 : MAINTAINER Stanley Wang</span><br><span class="line"> ---&gt; Running in 8851a3c55d4b</span><br><span class="line"> ---&gt; 6266a6f15dc5</span><br><span class="line">Removing intermediate container 8851a3c55d4b</span><br><span class="line">Step 3 : COPY dubbo-monitor-simple/ /opt/dubbo-monitor/</span><br><span class="line"> ---&gt; f4e0a9067c5c</span><br><span class="line">Removing intermediate container f1038ecb1055</span><br><span class="line">Step 4 : WORKDIR /opt/dubbo-monitor</span><br><span class="line"> ---&gt; Running in 4056339d1b5a</span><br><span class="line"> ---&gt; e496e2d3079e</span><br><span class="line">Removing intermediate container 4056339d1b5a</span><br><span class="line">Step 5 : CMD /opt/dubbo-monitor/bin/start.sh</span><br><span class="line"> ---&gt; Running in c33b8fb98326</span><br><span class="line"> ---&gt; 97e40c179bbe</span><br><span class="line">Removing intermediate container c33b8fb98326</span><br><span class="line">Successfully built 97e40c179bbe</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 dubbo-monitor]# docker push harbor.od.com/infra/dubbo-monitor:latest</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/dubbo-monitor]</span><br><span class="line">750135a87545: Pushed </span><br><span class="line">0b2b753b122e: Pushed </span><br><span class="line">5b1f1b5295ff: Pushed </span><br><span class="line">d54f1d9d76d3: Pushed </span><br><span class="line">8d51c20d6553: Pushed </span><br><span class="line">106b765202e9: Pushed </span><br><span class="line">c6698ca565d0: Pushed </span><br><span class="line">50ecb880731d: Pushed </span><br><span class="line">fddd8887b725: Pushed </span><br><span class="line">42052a19230c: Pushed </span><br><span class="line">8d4d1ab5ff74: Pushed </span><br><span class="line">190107_1930: digest: sha256:73007a37a55ecd5fd72bc5b36d2ab0bb639c96b32b7879984d5cdbc759778790 size: 2617</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p>在DNS主机<code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dubbo-monitor IN A 60 10.9.7.10</span><br></pre></td></tr></table></figure>

<h3 id="准备k8s资源配置清单-1"><a href="#准备k8s资源配置清单-1" class="headerlink" title="准备k8s资源配置清单"></a>准备k8s资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上</p>
<div class="tabs" id="dubbo-monitor"><ul class="nav-tabs"><li class="tab active"><a href="#dubbo-monitor-1">Deployment</a></li><li class="tab"><a href="#dubbo-monitor-2">Service</a></li><li class="tab"><a href="#dubbo-monitor-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="dubbo-monitor-1"><p>vi /data/k8s-yaml/dubbo-monitor/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-monitor</span><br><span class="line">        name: dubbo-monitor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-monitor</span><br><span class="line">        image: harbor.od.com/infra/dubbo-monitor:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dubbo-monitor-2"><p>vi /data/k8s-yaml/dubbo-monitor/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-monitor</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dubbo-monitor-3"><p>vi /data/k8s-yaml/dubbo-monitor/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: dubbo-monitor.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: dubbo-monitor</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-monitor created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/svc.yaml</span><br><span class="line">service/dubbo-monitor created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/ingress.yaml</span><br><span class="line">ingress.extensions/dubbo-monitor created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://dubbo-monitor.od.com" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a></p>
<h2 id="dubbo服务消费者（dubbo-demo-consumer）"><a href="#dubbo服务消费者（dubbo-demo-consumer）" class="headerlink" title="dubbo服务消费者（dubbo-demo-consumer）"></a>dubbo服务消费者（dubbo-demo-consumer）</h2><h3 id="通过jenkins进行一次CI-1"><a href="#通过jenkins进行一次CI-1" class="headerlink" title="通过jenkins进行一次CI"></a>通过jenkins进行一次CI</h3><p>打开jenkins页面，使用admin登录，准备构建<code>dubbo-demo</code>项目</p>
<p><img src="/images/jenkins-firstbuild.png" alt="jenkins构建" title="jenkins构建"><br>点<code>Build with Parameters</code></p>
<p><img src="/images/jenkins-builddetail.png" alt="jenkins构建详情" title="jenkins构建详情"><br>依次填入/选择：</p>
<ul>
<li><p>app_name</p>
<blockquote>
<p>dubbo-demo-consumer</p>
</blockquote>
</li>
<li><p>image_name</p>
<blockquote>
<p>app/dubbo-demo-consumer</p>
</blockquote>
</li>
<li><p>git_repo</p>
<blockquote>
<p><a href="mailto:git@gitee.com" target="_blank" rel="noopener">git@gitee.com</a>:stanleywang/dubbo-demo-web.git</p>
</blockquote>
</li>
<li><p>git_ver</p>
<blockquote>
<p>master</p>
</blockquote>
</li>
<li><p>add_tag</p>
<blockquote>
<p>190117_1950</p>
</blockquote>
</li>
<li><p>mvn_dir</p>
<blockquote>
<p>/</p>
</blockquote>
</li>
<li><p>target_dir</p>
<blockquote>
<p>./dubbo-client/target</p>
</blockquote>
</li>
<li><p>mvn_cmd</p>
<blockquote>
<p>mvn clean package -Dmaven.test.skip=true</p>
</blockquote>
</li>
<li><p>base_image</p>
<blockquote>
<p>base/jre8:8u112</p>
</blockquote>
</li>
<li><p>maven</p>
<blockquote>
<p>3.6.0-8u181</p>
</blockquote>
</li>
</ul>
<p>点击<code>Build</code>进行构建，等待构建完成。</p>
<p>test $? -eq 0 &amp;&amp; <span class="label success">成功，进行下一步</span> || <span class="label danger">失败，排错直到成功</span></p>
<h3 id="检查harbor仓库内镜像-1"><a href="#检查harbor仓库内镜像-1" class="headerlink" title="检查harbor仓库内镜像"></a>检查harbor仓库内镜像</h3><p><img src="/images/harbor-secondci.png" alt="harbor仓库内镜像" title="harbor仓库内镜像"></p>
<h3 id="解析域名-2"><a href="#解析域名-2" class="headerlink" title="解析域名"></a>解析域名</h3><p>在DNS主机<code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">demo IN A 60 10.9.7.10</span><br></pre></td></tr></table></figure>

<h3 id="准备k8s资源配置清单-2"><a href="#准备k8s资源配置清单-2" class="headerlink" title="准备k8s资源配置清单"></a>准备k8s资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上，准备资源配置清单</p>
<div class="tabs" id="dubbo-demo-consumer"><ul class="nav-tabs"><li class="tab active"><a href="#dubbo-demo-consumer-1">Deployment</a></li><li class="tab"><a href="#dubbo-demo-consumer-2">Service</a></li><li class="tab"><a href="#dubbo-demo-consumer-3">Ingress</a></li></ul><div class="tab-content"><div class="tab-pane active" id="dubbo-demo-consumer-1"><p>vi /data/k8s-yaml/dubbo-demo-consumer/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-consumer:master_190119_2015</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dubbo-demo-consumer-2"><p>vi /data/k8s-yaml/dubbo-demo-consumer/svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: dubbo-demo-consumer</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dubbo-demo-consumer-3"><p>vi /data/k8s-yaml/dubbo-demo-consumer/ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: demo.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: dubbo-demo-consumer</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-3"><a href="#应用资源配置清单-3" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-demo-consumer created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/svc.yaml</span><br><span class="line">service/dubbo-demo-consumer created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-consumer/ingress.yaml</span><br><span class="line">ingress.extensions/dubbo-demo-consumer created</span><br></pre></td></tr></table></figure>

<h3 id="检查docker运行情况及dubbo-monitor"><a href="#检查docker运行情况及dubbo-monitor" class="headerlink" title="检查docker运行情况及dubbo-monitor"></a>检查docker运行情况及dubbo-monitor</h3><p><a href="http://dubbo-monitor.od.com" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a></p>
<h3 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://demo.od.com/hello?name=wangdao" target="_blank" rel="noopener">http://demo.od.com/hello?name=wangdao</a></p>
<h1 id="实战维护dubbo微服务集群"><a href="#实战维护dubbo微服务集群" class="headerlink" title="实战维护dubbo微服务集群"></a>实战维护dubbo微服务集群</h1><h2 id="更新（rolling-update）"><a href="#更新（rolling-update）" class="headerlink" title="更新（rolling update）"></a>更新（rolling update）</h2><ul>
<li>修改代码提git（发版）</li>
<li>使用jenkins进行CI</li>
<li>修改并应用k8s资源配置清单<blockquote>
<p>或者在k8s的dashboard上直接操作</p>
</blockquote>
</li>
</ul>
<h2 id="扩容（scaling）"><a href="#扩容（scaling）" class="headerlink" title="扩容（scaling）"></a>扩容（scaling）</h2><ul>
<li>k8s的dashboard上直接操作</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2019/01/18/实验文档3：在kubernetes集群里集成Apollo配置中心/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/01/18/实验文档3：在kubernetes集群里集成Apollo配置中心/" class="post-title-link" itemprop="url">实验文档3：在kubernetes集群里集成Apollo配置中心</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-01-18 20:12:56" itemprop="dateCreated datePublished" datetime="2019-01-18T20:12:56+08:00">2019-01-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Kubernetes容器云技术专题/" itemprop="url" rel="index"><span itemprop="name">Kubernetes容器云技术专题</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">44k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">40 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="使用ConfigMap管理应用配置"><a href="#使用ConfigMap管理应用配置" class="headerlink" title="使用ConfigMap管理应用配置"></a>使用ConfigMap管理应用配置</h1><h2 id="拆分环境"><a href="#拆分环境" class="headerlink" title="拆分环境"></a>拆分环境</h2><table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>zk1.od.com(Test环境)</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>zk2.od.com(Prod环境)</td>
<td>10.4.7.12</td>
</tr>
</tbody></table>
<h2 id="重配zookeeper"><a href="#重配zookeeper" class="headerlink" title="重配zookeeper"></a>重配zookeeper</h2><p><code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/zookeeper/conf/zoo.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p><code>HDSS7-12.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/opt/zookeeper/conf/zoo.cfg</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/data/zookeeper/data</span><br><span class="line">dataLogDir=/data/zookeeper/logs</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure>

<p>重启zk(删除数据文件)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# /opt/zookeeper/bin/zkServer.sh restart &amp;&amp; /opt/zookeeper/bin/zkServer.sh status</span><br><span class="line">[root@hdss7-12 ~]# /opt/zookeeper/bin/zkServer.sh restart &amp;&amp; /opt/zookeeper/bin/zkServer.sh status</span><br><span class="line">[root@hdss7-21 ~]# /opt/zookeeper/bin/zkServer.sh stop</span><br></pre></td></tr></table></figure>

<h2 id="准备资源配置清单-dubbo-monitor"><a href="#准备资源配置清单-dubbo-monitor" class="headerlink" title="准备资源配置清单(dubbo-monitor)"></a>准备资源配置清单(dubbo-monitor)</h2><p>在运维主机<code>HDSS7-200.host.com</code>上：</p>
<div class="tabs" id="dubbo-monitor"><ul class="nav-tabs"><li class="tab active"><a href="#dubbo-monitor-1">ConfigMap</a></li><li class="tab"><a href="#dubbo-monitor-2">Deployment</a></li></ul><div class="tab-content"><div class="tab-pane active" id="dubbo-monitor-1"><p>vi /data/k8s-yaml/dubbo-monitor/configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  dubbo.properties: |</span><br><span class="line">    dubbo.container=log4j,spring,registry,jetty</span><br><span class="line">    dubbo.application.name=simple-monitor</span><br><span class="line">    dubbo.application.owner=</span><br><span class="line">    dubbo.registry.address=zookeeper://zk1.od.com:2181</span><br><span class="line">    dubbo.protocol.port=20880</span><br><span class="line">    dubbo.jetty.port=8080</span><br><span class="line">    dubbo.jetty.directory=/dubbo-monitor-simple/monitor</span><br><span class="line">    dubbo.charts.directory=/dubbo-monitor-simple/charts</span><br><span class="line">    dubbo.statistics.directory=/dubbo-monitor-simple/statistics</span><br><span class="line">    dubbo.log4j.file=/dubbo-monitor-simple/logs/dubbo-monitor.log</span><br><span class="line">    dubbo.log4j.level=WARN</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="dubbo-monitor-2"><p>vi /data/k8s-yaml/dubbo-monitor/deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-monitor</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-monitor</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-monitor</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-monitor</span><br><span class="line">        name: dubbo-monitor</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-monitor</span><br><span class="line">        image: harbor.od.com/infra/dubbo-monitor:latest</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: configmap-volume</span><br><span class="line">            mountPath: /dubbo-monitor-simple/conf</span><br><span class="line">      volumes:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          configMap:</span><br><span class="line">            name: dubbo-monitor-cm</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div></div></div>

<h2 id="应用资源配置清单"><a href="#应用资源配置清单" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h2><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/configmap.yaml</span><br><span class="line">configmap/dubbo-monitor-cm created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-monitor/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-monitor configured</span><br></pre></td></tr></table></figure>

<h2 id="重新发版，修改dubbo项目的配置文件"><a href="#重新发版，修改dubbo项目的配置文件" class="headerlink" title="重新发版，修改dubbo项目的配置文件"></a>重新发版，修改dubbo项目的配置文件</h2><h3 id="修改项目源代码"><a href="#修改项目源代码" class="headerlink" title="修改项目源代码"></a>修改项目源代码</h3><ul>
<li><p>duboo-demo-service</p>
<figure class="highlight plain"><figcaption><span>dubbo-server/src/main/java/config.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dubbo.registry=zookeeper://zk1.od.com:2181</span><br><span class="line">dubbo.port=28080</span><br></pre></td></tr></table></figure>
</li>
<li><p>dubbo-demo-web</p>
<figure class="highlight plain"><figcaption><span>dubbo-client/src/main/java/config.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dubbo.registry=zookeeper://zk1.od.com:2181</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="使用Jenkins进行CI"><a href="#使用Jenkins进行CI" class="headerlink" title="使用Jenkins进行CI"></a>使用Jenkins进行CI</h3><p>略</p>
<h3 id="修改-应用资源配置清单"><a href="#修改-应用资源配置清单" class="headerlink" title="修改/应用资源配置清单"></a>修改/应用资源配置清单</h3><p>k8s的dashboard上，修改deployment使用的容器版本，提交应用</p>
<h2 id="验证configmap的配置"><a href="#验证configmap的配置" class="headerlink" title="验证configmap的配置"></a>验证configmap的配置</h2><p>在K8S的dashboard上，修改dubbo-monitor的configmap配置为不同的zk，重启POD，浏览器打开<a href="http://dubbo-monitor.od.com" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a> 观察效果</p>
<h1 id="交付Apollo至Kubernetes集群"><a href="#交付Apollo至Kubernetes集群" class="headerlink" title="交付Apollo至Kubernetes集群"></a>交付Apollo至Kubernetes集群</h1><h2 id="Apollo简介"><a href="#Apollo简介" class="headerlink" title="Apollo简介"></a>Apollo简介</h2><p>Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p>
<h3 id="官方GitHub地址"><a href="#官方GitHub地址" class="headerlink" title="官方GitHub地址"></a>官方GitHub地址</h3><p><a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">Apollo官方地址</a><br><a href="https://github.com/ctripcorp/apollo/releases" target="_blank" rel="noopener">官方release包</a></p>
<h3 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h3><p><img src="/images/apollo.png" alt="apollo基础架构" title="apollo基础架构"></p>
<h3 id="简化模型"><a href="#简化模型" class="headerlink" title="简化模型"></a>简化模型</h3><p><img src="/images/apollo-simple.png" alt="apollo简化架构" title="apollo简化架构"></p>
<h2 id="交付apollo-configservice"><a href="#交付apollo-configservice" class="headerlink" title="交付apollo-configservice"></a>交付apollo-configservice</h2><h3 id="准备软件包"><a href="#准备软件包" class="headerlink" title="准备软件包"></a>准备软件包</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：<br><a href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-configservice-1.3.0-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<figure class="highlight plain"><figcaption><span>/opt/src</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep apollo</span><br><span class="line">-rw-r--r-- 1 root root 52713404 Feb 16 23:29 apollo-configservice-1.3.0-github.zip</span><br><span class="line">[root@hdss7-200 src]# mkdir /data/dockerfile/apollo-configservice &amp;&amp; unzip -o apollo-configservice-1.3.0-github.zip -d /data/dockerfile/apollo-configservice</span><br><span class="line">Archive:  apollo-configservice-1.3.0-github.zip</span><br><span class="line">   creating: /data/dockerfile/apollo-configservice/scripts/</span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/config/application-github.properties  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/scripts/shutdown.sh  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/apollo-configservice-1.3.0-sources.jar  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/scripts/startup.sh  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/config/app.properties  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/apollo-configservice-1.3.0.jar  </span><br><span class="line">  inflating: /data/dockerfile/apollo-configservice/apollo-configservice.conf</span><br></pre></td></tr></table></figure>

<h3 id="执行数据库脚本"><a href="#执行数据库脚本" class="headerlink" title="执行数据库脚本"></a>执行数据库脚本</h3><p>在数据库主机<code>HDSS7-11.host.com</code>上：<br><strong>注意：</strong>MySQL版本应为5.6或以上！</p>
<ul>
<li>更新yum源</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/yum.repos.d/MariaDB.repo</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = https://mirrors.ustc.edu.cn/mariadb/yum/10.1/centos7-amd64/</span><br><span class="line">gpgkey=https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=1</span><br></pre></td></tr></table></figure>

<ul>
<li>导入GPG-KEY</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# rpm --import https://mirrors.ustc.edu.cn/mariadb/yum/RPM-GPG-KEY-MariaDB</span><br></pre></td></tr></table></figure>

<ul>
<li>更新数据库版本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# yum update MariaDB-server -y</span><br></pre></td></tr></table></figure>

<ul>
<li>配置my.cnf</li>
</ul>
<figure class="highlight plain"><figcaption><span>/etc/my.cnf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mysql]</span><br><span class="line">default-character-set = utf8mb4</span><br><span class="line">[mysqld]</span><br><span class="line">character_set_server = utf8mb4</span><br><span class="line">collation_server = utf8mb4_general_ci</span><br><span class="line">init_connect = &quot;SET NAMES &apos;utf8mb4&apos;&quot;</span><br></pre></td></tr></table></figure>

<p><a href="https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/db/migration/configdb/V1.0.0__initialization.sql" target="_blank" rel="noopener">数据库脚本地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# mysql -uroot -p</span><br><span class="line">mysql&gt; create database ApolloConfigDB;</span><br><span class="line">mysql&gt; source ./apolloconfig.sql</span><br></pre></td></tr></table></figure>

<h3 id="数据库用户授权"><a href="#数据库用户授权" class="headerlink" title="数据库用户授权"></a>数据库用户授权</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigDB.* to &quot;apolloconfig&quot;@&quot;10.4.7.%&quot; identified by &quot;123456&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="修改初始数据"><a href="#修改初始数据" class="headerlink" title="修改初始数据"></a>修改初始数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; update ApolloConfigDB.ServerConfig set ServerConfig.Value=&quot;http://config.od.com/eureka&quot; where ServerConfig.Key=&quot;eureka.service.url&quot;;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 1  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from ServerConfig\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">                       Id: 1</span><br><span class="line">                      Key: eureka.service.url</span><br><span class="line">                  Cluster: default</span><br><span class="line">                    Value: http://config.od.com/eureka</span><br><span class="line">                  Comment: Eureka服务Url，多个service以英文逗号分隔</span><br><span class="line">                IsDeleted:  </span><br><span class="line">     DataChange_CreatedBy: default</span><br><span class="line">   DataChange_CreatedTime: 2019-04-10 15:07:34</span><br><span class="line">DataChange_LastModifiedBy: </span><br><span class="line">      DataChange_LastTime: 2019-04-11 16:28:57</span><br></pre></td></tr></table></figure>

<h3 id="制作Docker镜像"><a href="#制作Docker镜像" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：</p>
<ul>
<li>配置数据库连接串</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-configservice</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-configservice]# cat config/application-github.properties</span><br></pre></td></tr></table></figure>

<ul>
<li>更新startup.sh</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-configservice/scripts/startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">SERVICE_NAME=apollo-configservice</span><br><span class="line">## Adjust log dir if necessary</span><br><span class="line">LOG_DIR=/opt/logs/apollo-config-server</span><br><span class="line">## Adjust server port if necessary</span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_CONFIG_SERVICE_NAME=$(hostname -i)</span><br><span class="line">SERVER_URL=&quot;http://$&#123;APOLLO_CONFIG_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;&quot;</span><br><span class="line"></span><br><span class="line">## Adjust memory settings if necessary</span><br><span class="line">#export JAVA_OPTS=&quot;-Xms6144m -Xmx6144m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=4096m -XX:MaxNewSize=4096m -XX:SurvivorRatio=8&quot;</span><br><span class="line"></span><br><span class="line">## Only uncomment the following when you are using server jvm</span><br><span class="line">#export JAVA_OPTS=&quot;$JAVA_OPTS -server -XX:-ReduceInitialCardMarks&quot;</span><br><span class="line"></span><br><span class="line">########### The following is the same for configservice, adminservice, portal ###########</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom&quot;</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/&quot;</span><br><span class="line"></span><br><span class="line"># Find Java</span><br><span class="line">if [[ -n &quot;$JAVA_HOME&quot; ]] &amp;&amp; [[ -x &quot;$JAVA_HOME/bin/java&quot; ]]; then</span><br><span class="line">    javaexe=&quot;$JAVA_HOME/bin/java&quot;</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x &quot;/usr/bin/java&quot; ]];  then</span><br><span class="line">    javaexe=&quot;/usr/bin/java&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Unable to find Java&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ &quot;$javaexe&quot; ]]; then</span><br><span class="line">    version=$(&quot;$javaexe&quot; -version 2&gt;&amp;1 | awk -F &apos;&quot;&apos; &apos;/version/ &#123;print $2&#125;&apos;)</span><br><span class="line">    version=$(echo &quot;$version&quot; | awk -F. &apos;&#123;printf(&quot;%03d%03d&quot;,$1,$2);&#125;&apos;)</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseParNewGC&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf &quot;$(date) ==== Starting ==== \n&quot;</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME&quot;.jar&quot;</span><br><span class="line">./$SERVICE_NAME&quot;.jar&quot; start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo &quot;$(date) Failed to start $SERVICE_NAME.jar, return code: $rc&quot;</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>

<ul>
<li>写Dockerfile</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-configservice/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM stanleyws/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.3.0</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-configservice-$&#123;VERSION&#125;.jar /apollo-configservice/apollo-configservice.jar</span><br><span class="line">ADD config/ /apollo-configservice/config</span><br><span class="line">ADD scripts/ /apollo-configservice/scripts</span><br><span class="line"></span><br><span class="line">CMD [&quot;/apollo-configservice/scripts/startup.sh&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像并推送</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-configservice]# docker build . -t harbor.od.com/infra/apollo-configservice:v1.3.0</span><br><span class="line">Sending build context to Docker daemon 61.91 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : ENV VERSION 1.3.0</span><br><span class="line"> ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line"> ---&gt; Running in 685d51b5adb4</span><br><span class="line"> ---&gt; feb4c0289f04</span><br><span class="line">Removing intermediate container 685d51b5adb4</span><br><span class="line">Step 3 : RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"> ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line"> ---&gt; Running in eaa05073feeb</span><br><span class="line"> ---&gt; a3e3fd61ae35</span><br><span class="line">Removing intermediate container eaa05073feeb</span><br><span class="line">Step 4 : ADD apollo-configservice-$&#123;VERSION&#125;.jar /apollo-configservice/apollo-configservice.jar</span><br><span class="line"> ---&gt; be09a59b83a2</span><br><span class="line">Removing intermediate container ac6b8af3979b</span><br><span class="line">Step 5 : ADD config/ /apollo-configservice/config</span><br><span class="line"> ---&gt; fb64fc0f3194</span><br><span class="line">Removing intermediate container b73c5315ad20</span><br><span class="line">Step 6 : ADD scripts/ /apollo-configservice/scripts</span><br><span class="line"> ---&gt; 96ff3d9b9456</span><br><span class="line">Removing intermediate container 67ba203b3101</span><br><span class="line">Step 7 : CMD /apollo-configservice/scripts/startup.sh</span><br><span class="line"> ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line"> ---&gt; Running in 80bd3f53fefc</span><br><span class="line"> ---&gt; 551ea2ba8de3</span><br><span class="line">Removing intermediate container 80bd3f53fefc</span><br><span class="line">Successfully built 551ea2ba8de3</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 apollo-configservice]# docker push harbor.od.com/infra/apollo-configservice:v1.3.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/apollo-configservice]</span><br><span class="line">25efb9a44683: Pushed </span><br><span class="line">b3572bb46247: Pushed </span><br><span class="line">e7994b936025: Pushed </span><br><span class="line">0ff1d078cbc4: Pushed </span><br><span class="line">ebfb473df5c2: Pushed </span><br><span class="line">aae5c057d1b6: Pushed </span><br><span class="line">dee6aef5c2b6: Pushed </span><br><span class="line">a464c54f93a9: Pushed </span><br><span class="line">v1.3.0: digest: sha256:6a8e4fdda58de0dfba9985ebbf91c4d6f46f5274983d2efa8853b03f4e45fa06 size: 1992</span><br></pre></td></tr></table></figure>

<h3 id="解析域名"><a href="#解析域名" class="headerlink" title="解析域名"></a>解析域名</h3><p>DNS主机<code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql   60 IN A 10.4.7.11</span><br><span class="line">config	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单"><a href="#准备资源配置清单" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>在运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 k8s-yaml]# mkdir /data/k8s-yaml/apollo-configservice &amp;&amp; cd /data/k8s-yaml/apollo-configservice</span><br></pre></td></tr></table></figure>

<div class="tabs" id="apollo-configservice-yaml"><ul class="nav-tabs"><li class="tab active"><a href="#apollo-configservice-yaml-1">Deployment</a></li><li class="tab"><a href="#apollo-configservice-yaml-2">Service</a></li><li class="tab"><a href="#apollo-configservice-yaml-3">Ingress</a></li><li class="tab"><a href="#apollo-configservice-yaml-4">ConfigMap</a></li></ul><div class="tab-content"><div class="tab-pane active" id="apollo-configservice-yaml-1"><p>vi deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-configservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-configservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-configservice </span><br><span class="line">        name: apollo-configservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-configservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-configservice</span><br><span class="line">        image: harbor.od.com/infra/apollo-configservice:v1.3.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-configservice/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-configservice-yaml-2"><p>vi svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: apollo-configservice</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-configservice-yaml-3"><p>vi ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-configservice</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: config.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: apollo-configservice</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-configservice-yaml-4"><p>vi configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-configservice-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config.od.com/eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003171</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-1"><a href="#应用资源配置清单-1" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/configmap.yaml</span><br><span class="line">configmap/apollo-configservice-cm created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/deployment.yaml</span><br><span class="line">deployment.extensions/apollo-configservice created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/svc.yaml</span><br><span class="line">service/apollo-configservice created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-configservice/ingress.yaml</span><br><span class="line">ingress.extensions/apollo-configservice created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://config.od.com" target="_blank" rel="noopener">http://config.od.com</a></p>
<h2 id="交付apollo-adminservice"><a href="#交付apollo-adminservice" class="headerlink" title="交付apollo-adminservice"></a>交付apollo-adminservice</h2><h3 id="准备软件包-1"><a href="#准备软件包-1" class="headerlink" title="准备软件包"></a>准备软件包</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：<br><a href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-adminservice-1.3.0-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep apollo</span><br><span class="line">-rw-r--r-- 1 root root 52713404 Feb 16 08:47 apollo-configservice-1.3.0-github.zip</span><br><span class="line">-rw-r--r-- 1 root root 49418246 Feb 16 09:54 apollo-adminservice-1.3.0-github.zip</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 src]# mkdir /data/dockerfile/apollo-adminservice &amp;&amp; unzip -o apollo-adminservice-1.3.0-github.zip -d /data/dockerfile/apollo-adminservice</span><br></pre></td></tr></table></figure>

<h3 id="制作Docker镜像-1"><a href="#制作Docker镜像-1" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：</p>
<ul>
<li><p>配置数据库连接串</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-adminservice</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-adminservice]# cat config/application-github.properties</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新starup.sh</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-adminservice/scripts/startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">SERVICE_NAME=apollo-adminservice</span><br><span class="line">## Adjust log dir if necessary</span><br><span class="line">LOG_DIR=/opt/logs/apollo-adminservice</span><br><span class="line">## Adjust server port if necessary</span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_ADMIN_SERVICE_NAME=$(hostname -i)</span><br><span class="line"># SERVER_URL=&quot;http://localhost:$&#123;SERVER_PORT&#125;&quot;</span><br><span class="line">SERVER_URL=&quot;http://$&#123;APOLLO_ADMIN_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;&quot;</span><br><span class="line"></span><br><span class="line">## Adjust memory settings if necessary</span><br><span class="line">#export JAVA_OPTS=&quot;-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8&quot;</span><br><span class="line"></span><br><span class="line">## Only uncomment the following when you are using server jvm</span><br><span class="line">#export JAVA_OPTS=&quot;$JAVA_OPTS -server -XX:-ReduceInitialCardMarks&quot;</span><br><span class="line"></span><br><span class="line">########### The following is the same for configservice, adminservice, portal ###########</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom&quot;</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/&quot;</span><br><span class="line"></span><br><span class="line"># Find Java</span><br><span class="line">if [[ -n &quot;$JAVA_HOME&quot; ]] &amp;&amp; [[ -x &quot;$JAVA_HOME/bin/java&quot; ]]; then</span><br><span class="line">    javaexe=&quot;$JAVA_HOME/bin/java&quot;</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x &quot;/usr/bin/java&quot; ]];  then</span><br><span class="line">    javaexe=&quot;/usr/bin/java&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Unable to find Java&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ &quot;$javaexe&quot; ]]; then</span><br><span class="line">    version=$(&quot;$javaexe&quot; -version 2&gt;&amp;1 | awk -F &apos;&quot;&apos; &apos;/version/ &#123;print $2&#125;&apos;)</span><br><span class="line">    version=$(echo &quot;$version&quot; | awk -F. &apos;&#123;printf(&quot;%03d%03d&quot;,$1,$2);&#125;&apos;)</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseParNewGC&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf &quot;$(date) ==== Starting ==== \n&quot;</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME&quot;.jar&quot;</span><br><span class="line">./$SERVICE_NAME&quot;.jar&quot; start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo &quot;$(date) Failed to start $SERVICE_NAME.jar, return code: $rc&quot;</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>写Dockerfile</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-adminservice/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM stanleyws/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.3.0</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-adminservice-$&#123;VERSION&#125;.jar /apollo-adminservice/apollo-adminservice.jar</span><br><span class="line">ADD config/ /apollo-adminservice/config</span><br><span class="line">ADD scripts/ /apollo-adminservice/scripts</span><br><span class="line"></span><br><span class="line">CMD [&quot;/apollo-adminservice/scripts/startup.sh&quot;]</span><br></pre></td></tr></table></figure>
</li>
<li><p>制作镜像并推送</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-adminservice]# docker build . -t harbor.od.com/infra/apollo-adminservice:v1.3.0</span><br><span class="line">Sending build context to Docker daemon 58.31 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : ENV VERSION 1.3.0</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; feb4c0289f04</span><br><span class="line">Step 3 : RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; a3e3fd61ae35</span><br><span class="line">Step 4 : ADD apollo-adminservice-$&#123;VERSION&#125;.jar /apollo-adminservice/apollo-adminservice.jar</span><br><span class="line"> ---&gt; 6a1eb9565777</span><br><span class="line">Removing intermediate container 7196df9af6af</span><br><span class="line">Step 5 : ADD config/ /apollo-adminservice/config</span><br><span class="line"> ---&gt; 9f364b732d46</span><br><span class="line">Removing intermediate container 9b24669c6c78</span><br><span class="line">Step 6 : ADD scripts/ /apollo-adminservice/scripts</span><br><span class="line"> ---&gt; b7bc5517b0fc</span><br><span class="line">Removing intermediate container f3e34e759148</span><br><span class="line">Step 7 : CMD /apollo-adminservice/scripts/startup.sh</span><br><span class="line"> ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line"> ---&gt; Running in 18c6597914b4</span><br><span class="line"> ---&gt; 82145db3ee88</span><br><span class="line">Removing intermediate container 18c6597914b4</span><br><span class="line">Successfully built 82145db3ee88</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 apollo-adminservice]# docker push harbor.od.com/infra/apollo-adminservice:v1.3.0</span><br><span class="line">docker push harbor.od.com/infra/apollo-adminservice:v1.3.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/apollo-adminservice]</span><br><span class="line">19b1ca6c066d: Pushed </span><br><span class="line">8fa6cde49908: Pushed </span><br><span class="line">0b2c9b9226cc: Pushed </span><br><span class="line">ebfb473df5c2: Mounted from infra/apollo-configservice </span><br><span class="line">aae5c057d1b6: Mounted from infra/apollo-configservice </span><br><span class="line">dee6aef5c2b6: Mounted from infra/apollo-configservice </span><br><span class="line">a464c54f93a9: Mounted from infra/apollo-configservice </span><br><span class="line">v1.3.0: digest: sha256:75367caab9bad3d0d281eb3324451a0734e84b6aa3ee860e38ad758d7166a7d1 size: 1785</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="准备资源配置清单-1"><a href="#准备资源配置清单-1" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>在运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 k8s-yaml]# mkdir /data/k8s-yaml/apollo-adminservice &amp;&amp; cd /data/k8s-yaml/apollo-adminservice</span><br></pre></td></tr></table></figure>

<div class="tabs" id="apollo-adminservice-yaml"><ul class="nav-tabs"><li class="tab active"><a href="#apollo-adminservice-yaml-1">Deployment</a></li><li class="tab"><a href="#apollo-adminservice-yaml-2">ConfigMap</a></li></ul><div class="tab-content"><div class="tab-pane active" id="apollo-adminservice-yaml-1"><p>vi deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-adminservice</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-adminservice</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-adminservice </span><br><span class="line">        name: apollo-adminservice</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-adminservice-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-adminservice</span><br><span class="line">        image: harbor.od.com/infra/apollo-adminservice:v1.3.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-adminservice/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-adminservice-yaml-2"><p>vi configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-adminservice-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config.od.com/eureka</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003172</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-2"><a href="#应用资源配置清单-2" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/configmap.yaml</span><br><span class="line">configmap/apollo-adminservice-cm created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-adminservice/deployment.yaml</span><br><span class="line">deployment.extensions/apollo-adminservice created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-1"><a href="#浏览器访问-1" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://config.od.com" target="_blank" rel="noopener">http://config.od.com</a><br><img src="/images/eureka-ready.png" alt="apollo注册中心" title="apollo注册中心"></p>
<h2 id="交付apollo-portal"><a href="#交付apollo-portal" class="headerlink" title="交付apollo-portal"></a>交付apollo-portal</h2><h3 id="准备软件包-2"><a href="#准备软件包-2" class="headerlink" title="准备软件包"></a>准备软件包</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：<br><a href="https://github.com/ctripcorp/apollo/releases/download/v1.3.0/apollo-portal-1.3.0-github.zip" target="_blank" rel="noopener">下载官方release包</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 src]# ls -l|grep apollo</span><br><span class="line">-rw-r--r-- 1 root root 52713404 Feb 16 08:37 apollo-configservice-1.3.0-github.zip</span><br><span class="line">-rw-r--r-- 1 root root 49418246 Feb 16 09:54 apollo-adminservice-1.3.0-github.zip</span><br><span class="line">-rw-r--r-- 1 root root 36459359 Feb 16 10:00 apollo-portal-1.3.0-github.zip</span><br><span class="line"></span><br><span class="line">[root@hdss7-200 src]# mkdir /data/dockerfile/apollo-portal &amp;&amp; unzip -o apollo-portal-1.3.0-github.zip -d /data/dockerfile/apollo-portal</span><br><span class="line">Archive:  apollo-portal-1.3.0-github.zip</span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/scripts/shutdown.sh  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/apollo-portal.conf  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/apollo-portal-1.3.0-sources.jar  </span><br><span class="line">   creating: /data/dockerfile/apollo-portal/config/</span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/config/application-github.properties  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/scripts/startup.sh  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/config/apollo-env.properties  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/config/app.properties  </span><br><span class="line">  inflating: /data/dockerfile/apollo-portal/apollo-portal-1.3.0.jar</span><br></pre></td></tr></table></figure>

<h3 id="执行数据库脚本-1"><a href="#执行数据库脚本-1" class="headerlink" title="执行数据库脚本"></a>执行数据库脚本</h3><p>在数据库主机<code>HDSS7-11.host.com</code>上：<br><a href="https://raw.githubusercontent.com/ctripcorp/apollo/master/scripts/db/migration/portaldb/V1.0.0__initialization.sql" target="_blank" rel="noopener">数据库脚本地址</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# mysql -uroot -p</span><br><span class="line">mysql&gt; create database ApolloPortalDB;</span><br><span class="line">mysql&gt; source ./apolloportal.sql</span><br></pre></td></tr></table></figure>

<h3 id="数据库用户授权-1"><a href="#数据库用户授权-1" class="headerlink" title="数据库用户授权"></a>数据库用户授权</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloPortalDB.* to &quot;apolloportal&quot;@&quot;172.7.%&quot; identified by &quot;123456&quot;;</span><br></pre></td></tr></table></figure>

<h3 id="制作Docker镜像-2"><a href="#制作Docker镜像-2" class="headerlink" title="制作Docker镜像"></a>制作Docker镜像</h3><p>在运维主机<code>HDSS7-200.host.com</code>上：</p>
<ul>
<li><p>配置数据库连接串</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-portal</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-portal]# cat config/application-github.properties</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Portal的meta service</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-portal/config/apollo-env.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dev.meta=http://config.od.com</span><br></pre></td></tr></table></figure>
</li>
<li><p>更新starup.sh</p>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-portal/scripts/startup.sh</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">SERVICE_NAME=apollo-portal</span><br><span class="line">## Adjust log dir if necessary</span><br><span class="line">LOG_DIR=/opt/logs/apollo-portal-server</span><br><span class="line">## Adjust server port if necessary</span><br><span class="line">SERVER_PORT=8080</span><br><span class="line">APOLLO_PORTAL_SERVICE_NAME=$(hostname -i)</span><br><span class="line"># SERVER_URL=&quot;http://localhost:$SERVER_PORT&quot;</span><br><span class="line">SERVER_URL=&quot;http://$&#123;APOLLO_PORTAL_SERVICE_NAME&#125;:$&#123;SERVER_PORT&#125;&quot;</span><br><span class="line"></span><br><span class="line">## Adjust memory settings if necessary</span><br><span class="line">#export JAVA_OPTS=&quot;-Xms2560m -Xmx2560m -Xss256k -XX:MetaspaceSize=128m -XX:MaxMetaspaceSize=384m -XX:NewSize=1536m -XX:MaxNewSize=1536m -XX:SurvivorRatio=8&quot;</span><br><span class="line"></span><br><span class="line">## Only uncomment the following when you are using server jvm</span><br><span class="line">#export JAVA_OPTS=&quot;$JAVA_OPTS -server -XX:-ReduceInitialCardMarks&quot;</span><br><span class="line"></span><br><span class="line">########### The following is the same for configservice, adminservice, portal ###########</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -XX:ParallelGCThreads=4 -XX:MaxTenuringThreshold=9 -XX:+DisableExplicitGC -XX:+ScavengeBeforeFullGC -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+ExplicitGCInvokesConcurrent -XX:+PrintGCDetails -XX:+HeapDumpOnOutOfMemoryError -XX:-OmitStackTraceInFastThrow -Duser.timezone=Asia/Shanghai -Dclient.encoding.override=UTF-8 -Dfile.encoding=UTF-8 -Djava.security.egd=file:/dev/./urandom&quot;</span><br><span class="line">export JAVA_OPTS=&quot;$JAVA_OPTS -Dserver.port=$SERVER_PORT -Dlogging.file=$LOG_DIR/$SERVICE_NAME.log -XX:HeapDumpPath=$LOG_DIR/HeapDumpOnOutOfMemoryError/&quot;</span><br><span class="line"></span><br><span class="line"># Find Java</span><br><span class="line">if [[ -n &quot;$JAVA_HOME&quot; ]] &amp;&amp; [[ -x &quot;$JAVA_HOME/bin/java&quot; ]]; then</span><br><span class="line">    javaexe=&quot;$JAVA_HOME/bin/java&quot;</span><br><span class="line">elif type -p java &gt; /dev/null 2&gt;&amp;1; then</span><br><span class="line">    javaexe=$(type -p java)</span><br><span class="line">elif [[ -x &quot;/usr/bin/java&quot; ]];  then</span><br><span class="line">    javaexe=&quot;/usr/bin/java&quot;</span><br><span class="line">else</span><br><span class="line">    echo &quot;Unable to find Java&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [[ &quot;$javaexe&quot; ]]; then</span><br><span class="line">    version=$(&quot;$javaexe&quot; -version 2&gt;&amp;1 | awk -F &apos;&quot;&apos; &apos;/version/ &#123;print $2&#125;&apos;)</span><br><span class="line">    version=$(echo &quot;$version&quot; | awk -F. &apos;&#123;printf(&quot;%03d%03d&quot;,$1,$2);&#125;&apos;)</span><br><span class="line">    # now version is of format 009003 (9.3.x)</span><br><span class="line">    if [ $version -ge 011000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 010000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    elif [ $version -ge 009000 ]; then</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xlog:gc*:$LOG_DIR/gc.log:time,level,tags -Xlog:safepoint -Xlog:gc+heap=trace&quot;</span><br><span class="line">    else</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseParNewGC&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -Xloggc:$LOG_DIR/gc.log -XX:+PrintGCDetails&quot;</span><br><span class="line">        JAVA_OPTS=&quot;$JAVA_OPTS -XX:+UseConcMarkSweepGC -XX:+UseCMSCompactAtFullCollection -XX:+UseCMSInitiatingOccupancyOnly -XX:CMSInitiatingOccupancyFraction=60 -XX:+CMSClassUnloadingEnabled -XX:+CMSParallelRemarkEnabled -XX:CMSFullGCsBeforeCompaction=9 -XX:+CMSClassUnloadingEnabled  -XX:+PrintGCDateStamps -XX:+PrintGCApplicationConcurrentTime -XX:+PrintHeapAtGC -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=5M&quot;</span><br><span class="line">    fi</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">printf &quot;$(date) ==== Starting ==== \n&quot;</span><br><span class="line"></span><br><span class="line">cd `dirname $0`/..</span><br><span class="line">chmod 755 $SERVICE_NAME&quot;.jar&quot;</span><br><span class="line">./$SERVICE_NAME&quot;.jar&quot; start</span><br><span class="line"></span><br><span class="line">rc=$?;</span><br><span class="line"></span><br><span class="line">if [[ $rc != 0 ]];</span><br><span class="line">then</span><br><span class="line">    echo &quot;$(date) Failed to start $SERVICE_NAME.jar, return code: $rc&quot;</span><br><span class="line">    exit $rc;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">tail -f /dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>写Dockerfile</p>
</li>
</ul>
<figure class="highlight plain"><figcaption><span>/data/dockerfile/apollo-portal/Dockerfile</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM stanleyws/jre8:8u112</span><br><span class="line"></span><br><span class="line">ENV VERSION 1.3.0</span><br><span class="line"></span><br><span class="line">RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;\</span><br><span class="line">    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"></span><br><span class="line">ADD apollo-portal-$&#123;VERSION&#125;.jar /apollo-portal/apollo-portal.jar</span><br><span class="line">ADD config/ /apollo-portal/config</span><br><span class="line">ADD scripts/ /apollo-portal/scripts</span><br><span class="line"></span><br><span class="line">CMD [&quot;/apollo-portal/scripts/startup.sh&quot;]</span><br></pre></td></tr></table></figure>

<ul>
<li>制作镜像并推送</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 apollo-portal]# docker build . -t harbor.od.com/infra/apollo-portal:v1.3.0</span><br><span class="line">Sending build context to Docker daemon 43.35 MB</span><br><span class="line">Step 1 : FROM stanleyws/jre8:8u112</span><br><span class="line"> ---&gt; fa3a085d6ef1</span><br><span class="line">Step 2 : ENV VERSION 1.3.0</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; feb4c0289f04</span><br><span class="line">Step 3 : RUN ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp;    echo &quot;Asia/Shanghai&quot; &gt; /etc/timezone</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; a3e3fd61ae35</span><br><span class="line">Step 4 : ADD apollo-portal-$&#123;VERSION&#125;.jar /apollo-portal/apollo-portal.jar</span><br><span class="line"> ---&gt; cfcf63e8eedc</span><br><span class="line">Removing intermediate container 860b55bd3fc5</span><br><span class="line">Step 5 : ADD config/ /apollo-portal/config</span><br><span class="line"> ---&gt; 3ee780369431</span><br><span class="line">Removing intermediate container 6b67ee4224b5</span><br><span class="line">Step 6 : ADD scripts/ /apollo-portal/scripts</span><br><span class="line"> ---&gt; 42c9aea2e9e3</span><br><span class="line">Removing intermediate container 2dcf8d1bf4cf</span><br><span class="line">Step 7 : CMD /apollo-portal/scripts/startup.sh</span><br><span class="line"> ---&gt; [Warning] IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line"> ---&gt; Running in 9162dab8b63a</span><br><span class="line"> ---&gt; 0c020b79c36f</span><br><span class="line">Removing intermediate container 9162dab8b63a</span><br><span class="line">Successfully built 0c020b79c36f</span><br><span class="line">[root@hdss7-200 apollo-portal]# docker push harbor.od.com/infra/apollo-portal:v1.3.0</span><br><span class="line">docker push harbor.od.com/infra/apollo-portal:v1.3.0</span><br><span class="line">The push refers to a repository [harbor.od.com/infra/apollo-portal]</span><br><span class="line">e7c0e96ded4e: Pushed </span><br><span class="line">0076c5344476: Pushed </span><br><span class="line">3851a45d7440: Pushed </span><br><span class="line">ebfb473df5c2: Mounted from infra/apollo-adminservice </span><br><span class="line">aae5c057d1b6: Mounted from infra/apollo-adminservice </span><br><span class="line">dee6aef5c2b6: Mounted from infra/apollo-adminservice </span><br><span class="line">a464c54f93a9: Mounted from infra/apollo-adminservice </span><br><span class="line">v1.3.0: digest: sha256:1aa30aac8642cceb97c053b7d74632240af08f64c49b65d8729021fef65628a4 size: 1785</span><br></pre></td></tr></table></figure>

<h3 id="解析域名-1"><a href="#解析域名-1" class="headerlink" title="解析域名"></a>解析域名</h3><p>DNS主机<code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">portal	60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h3 id="准备资源配置清单-2"><a href="#准备资源配置清单-2" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>在运维主机<code>HDSS7-200.host.com</code>上</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-200 k8s-yaml]# mkdir /data/k8s-yaml/apollo-portal &amp;&amp; cd /data/k8s-yaml/apollo-portal</span><br></pre></td></tr></table></figure>

<div class="tabs" id="apollo-portal-yaml"><ul class="nav-tabs"><li class="tab active"><a href="#apollo-portal-yaml-1">Deployment</a></li><li class="tab"><a href="#apollo-portal-yaml-2">Service</a></li><li class="tab"><a href="#apollo-portal-yaml-3">Ingress</a></li><li class="tab"><a href="#apollo-portal-yaml-4">ConfigMap</a></li></ul><div class="tab-content"><div class="tab-pane active" id="apollo-portal-yaml-1"><p>vi deployment.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">  labels: </span><br><span class="line">    name: apollo-portal</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: apollo-portal</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: apollo-portal </span><br><span class="line">        name: apollo-portal</span><br><span class="line">    spec:</span><br><span class="line">      volumes:</span><br><span class="line">      - name: configmap-volume</span><br><span class="line">        configMap:</span><br><span class="line">          name: apollo-portal-cm</span><br><span class="line">      containers:</span><br><span class="line">      - name: apollo-portal</span><br><span class="line">        image: harbor.od.com/infra/apollo-portal:v1.3.0</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: configmap-volume</span><br><span class="line">          mountPath: /apollo-portal/config</span><br><span class="line">        terminationMessagePath: /dev/termination-log</span><br><span class="line">        terminationMessagePolicy: File</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-portal-yaml-2"><p>vi svc.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - protocol: TCP</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector: </span><br><span class="line">    app: apollo-portal</span><br><span class="line">  clusterIP: None</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  sessionAffinity: None</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-portal-yaml-3"><p>vi ingress.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kind: Ingress</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata: </span><br><span class="line">  name: apollo-portal</span><br><span class="line">  namespace: infra</span><br><span class="line">spec:</span><br><span class="line">  rules:</span><br><span class="line">  - host: portal.od.com</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - path: /</span><br><span class="line">        backend: </span><br><span class="line">          serviceName: apollo-portal</span><br><span class="line">          servicePort: 8080</span><br></pre></td></tr></table></figure></div><div class="tab-pane" id="apollo-portal-yaml-4"><p>vi configmap.yaml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: apollo-portal-cm</span><br><span class="line">  namespace: infra</span><br><span class="line">data:</span><br><span class="line">  application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloPortalDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloportal</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">  app.properties: |</span><br><span class="line">    appId=100003173</span><br><span class="line">  apollo-env.properties: |</span><br><span class="line">    dev.meta=http://config.od.com</span><br></pre></td></tr></table></figure></div></div></div>

<h3 id="应用资源配置清单-3"><a href="#应用资源配置清单-3" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/configmap.yaml</span><br><span class="line">configmap/apollo-portal-cm created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/deployment.yaml</span><br><span class="line">deployment.extensions/apollo-portal created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/svc.yaml</span><br><span class="line">service/apollo-portal created</span><br><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/apollo-portal/ingress.yaml</span><br><span class="line">ingress.extensions/apollo-portal created</span><br></pre></td></tr></table></figure>

<h3 id="浏览器访问-2"><a href="#浏览器访问-2" class="headerlink" title="浏览器访问"></a>浏览器访问</h3><p><a href="http://portal.od.com" target="_blank" rel="noopener">http://portal.od.com</a></p>
<ul>
<li>用户名：apollo</li>
<li>密码： admin</li>
</ul>
<p><img src="/images/portal-ready.png" alt="apollo-portal" title="apollo-portal"></p>
<h1 id="实战dubbo微服务接入Apollo配置中心"><a href="#实战dubbo微服务接入Apollo配置中心" class="headerlink" title="实战dubbo微服务接入Apollo配置中心"></a>实战dubbo微服务接入Apollo配置中心</h1><h2 id="改造dubbo-demo-service项目"><a href="#改造dubbo-demo-service项目" class="headerlink" title="改造dubbo-demo-service项目"></a>改造dubbo-demo-service项目</h2><h3 id="使用IDE拉取项目（这里使用git-bash作为范例）"><a href="#使用IDE拉取项目（这里使用git-bash作为范例）" class="headerlink" title="使用IDE拉取项目（这里使用git bash作为范例）"></a>使用IDE拉取项目（这里使用git bash作为范例）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git@gitee.com/stanleywang/dubbo-demo-service.git</span><br></pre></td></tr></table></figure>

<h3 id="切到apollo分支"><a href="#切到apollo分支" class="headerlink" title="切到apollo分支"></a>切到apollo分支</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git checkout -b apollo</span><br></pre></td></tr></table></figure>

<h3 id="修改pom-xml"><a href="#修改pom-xml" class="headerlink" title="修改pom.xml"></a>修改pom.xml</h3><ul>
<li>加入apollo客户端jar包的依赖</li>
</ul>
<figure class="highlight plain"><figcaption><span>dubbo-server/pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;com.ctrip.framework.apollo&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;apollo-client&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.1.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改resource段</li>
</ul>
<figure class="highlight plain"><figcaption><span>dubbo-server/pom.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;resource&gt;</span><br><span class="line">  &lt;directory&gt;src/main/resources&lt;/directory&gt;</span><br><span class="line">  &lt;includes&gt;</span><br><span class="line">  &lt;include&gt;**/*&lt;/include&gt;</span><br><span class="line">  &lt;/includes&gt;</span><br><span class="line">  &lt;filtering&gt;false&lt;/filtering&gt;</span><br><span class="line">&lt;/resource&gt;</span><br></pre></td></tr></table></figure>

<h3 id="增加resources目录"><a href="#增加resources目录" class="headerlink" title="增加resources目录"></a>增加resources目录</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir -pv resources/META-INF</span><br><span class="line">mkdir: created directory &apos;resources&apos;</span><br><span class="line">mkdir: created directory &apos;resources/META-INF&apos;</span><br></pre></td></tr></table></figure>

<h3 id="修改config-properties文件"><a href="#修改config-properties文件" class="headerlink" title="修改config.properties文件"></a>修改config.properties文件</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/config.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dubbo.registry=$&#123;dubbo.registry&#125;</span><br><span class="line">dubbo.port=$&#123;dubbo.port&#125;</span><br></pre></td></tr></table></figure>

<h3 id="修改srping-config-xml文件"><a href="#修改srping-config-xml文件" class="headerlink" title="修改srping-config.xml文件"></a>修改srping-config.xml文件</h3><ul>
<li>beans段新增属性</li>
</ul>
<figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xmlns:apollo=&quot;http://www.ctrip.com/schema/apollo&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>xsi:schemaLocation段内新增属性</li>
</ul>
<figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://www.ctrip.com/schema/apollo http://www.ctrip.com/schema/apollo.xsd</span><br></pre></td></tr></table></figure>

<ul>
<li>新增配置项</li>
</ul>
<figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;apollo:config/&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>删除配置项（注释）</li>
</ul>
<figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/spring-config.xml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- &lt;context:property-placeholder location=&quot;classpath:config.properties&quot;/&gt; --&gt;</span><br></pre></td></tr></table></figure>

<h3 id="增加app-properties文件"><a href="#增加app-properties文件" class="headerlink" title="增加app.properties文件"></a>增加app.properties文件</h3><figure class="highlight plain"><figcaption><span>/d/workspace/dubbo-demo-service/dubbo-server/src/main/resources/META-INF/app.properties</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.id=dubbo-demo-service</span><br></pre></td></tr></table></figure>

<h3 id="提交git中心仓库（gitee）"><a href="#提交git中心仓库（gitee）" class="headerlink" title="提交git中心仓库（gitee）"></a>提交git中心仓库（gitee）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git push origin apollo</span><br></pre></td></tr></table></figure>

<h2 id="配置apollo-portal"><a href="#配置apollo-portal" class="headerlink" title="配置apollo-portal"></a>配置apollo-portal</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li><p>部门</p>
<blockquote>
<p>样例部门1（TEST1）</p>
</blockquote>
</li>
<li><p><strong>应用id</strong></p>
<blockquote>
<p>dubbo-demo-service</p>
</blockquote>
</li>
<li><p>应用名称</p>
<blockquote>
<p>dubbo服务提供者</p>
</blockquote>
</li>
<li><p>应用负责人</p>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
</li>
<li><p>项目管理员</p>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
</li>
</ul>
<p><strong>提交</strong></p>
<h3 id="进入配置页面"><a href="#进入配置页面" class="headerlink" title="进入配置页面"></a>进入配置页面</h3><h4 id="新增配置项1"><a href="#新增配置项1" class="headerlink" title="新增配置项1"></a>新增配置项1</h4><ul>
<li><p>Key</p>
<blockquote>
<p>dubbo.registry</p>
</blockquote>
</li>
<li><p>Value</p>
<blockquote>
<p>zookeeper://zk1.od.com:2181</p>
</blockquote>
</li>
<li><p>选择集群</p>
<blockquote>
<p>DEV</p>
</blockquote>
</li>
</ul>
<p><strong>提交</strong></p>
<h4 id="新增配置项2"><a href="#新增配置项2" class="headerlink" title="新增配置项2"></a>新增配置项2</h4><ul>
<li><p>Key</p>
<blockquote>
<p>dubbo.port</p>
</blockquote>
</li>
<li><p>Value</p>
<blockquote>
<p>20880</p>
</blockquote>
</li>
<li><p>选择集群</p>
<blockquote>
<p>DEV</p>
</blockquote>
</li>
</ul>
<p><strong>提交</strong></p>
<h3 id="发布配置"><a href="#发布配置" class="headerlink" title="发布配置"></a>发布配置</h3><p>点击<strong>发布</strong>，配置生效<br><img src="/images/apollo-release.png" alt="apollo-release" title="apollo发布配置"></p>
<h2 id="使用jenkins进行CI"><a href="#使用jenkins进行CI" class="headerlink" title="使用jenkins进行CI"></a>使用jenkins进行CI</h2><p>略（注意记录镜像的tag）</p>
<h2 id="上线新构建的项目"><a href="#上线新构建的项目" class="headerlink" title="上线新构建的项目"></a>上线新构建的项目</h2><h3 id="准备资源配置清单-3"><a href="#准备资源配置清单-3" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml/dubbo-demo-service/deployment.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-service</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-service</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-service</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-service</span><br><span class="line">        name: dubbo-demo-service</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-service</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-service:apollo_190119_1815</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=dev -Dapollo.meta=http://config.od.com</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-server.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>增加了env段配置<br><strong>注意：</strong>docker镜像新版的tag</p>
<h3 id="应用资源配置清单-4"><a href="#应用资源配置清单-4" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-service/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-demo-service configured</span><br></pre></td></tr></table></figure>

<h3 id="观察项目运行情况"><a href="#观察项目运行情况" class="headerlink" title="观察项目运行情况"></a>观察项目运行情况</h3><p><a href="http://dubbo-monitor.od.com" target="_blank" rel="noopener">http://dubbo-monitor.od.com</a></p>
<h2 id="改造dubbo-demo-web"><a href="#改造dubbo-demo-web" class="headerlink" title="改造dubbo-demo-web"></a>改造dubbo-demo-web</h2><p>略</p>
<h2 id="配置apollo-portal-1"><a href="#配置apollo-portal-1" class="headerlink" title="配置apollo-portal"></a>配置apollo-portal</h2><h3 id="创建项目-1"><a href="#创建项目-1" class="headerlink" title="创建项目"></a>创建项目</h3><ul>
<li><p>部门</p>
<blockquote>
<p>样例部门1（TEST1）</p>
</blockquote>
</li>
<li><p><strong>应用id</strong></p>
<blockquote>
<p>dubbo-demo-web</p>
</blockquote>
</li>
<li><p>应用名称</p>
<blockquote>
<p>dubbo服务消费者</p>
</blockquote>
</li>
<li><p>应用负责人</p>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
</li>
<li><p>项目管理员</p>
<blockquote>
<p>apollo|apollo</p>
</blockquote>
</li>
</ul>
<p><strong>提交</strong></p>
<h3 id="进入配置页面-1"><a href="#进入配置页面-1" class="headerlink" title="进入配置页面"></a>进入配置页面</h3><h4 id="新增配置项1-1"><a href="#新增配置项1-1" class="headerlink" title="新增配置项1"></a>新增配置项1</h4><ul>
<li><p>Key</p>
<blockquote>
<p>dubbo.registry</p>
</blockquote>
</li>
<li><p>Value</p>
<blockquote>
<p>zookeeper://zk1.od.com:2181</p>
</blockquote>
</li>
<li><p>选择集群</p>
<blockquote>
<p>DEV</p>
</blockquote>
</li>
</ul>
<p><strong>提交</strong></p>
<h3 id="发布配置-1"><a href="#发布配置-1" class="headerlink" title="发布配置"></a>发布配置</h3><p>点击<strong>发布</strong>，配置生效</p>
<h2 id="使用jenkins进行CI-1"><a href="#使用jenkins进行CI-1" class="headerlink" title="使用jenkins进行CI"></a>使用jenkins进行CI</h2><p>略（注意记录镜像的tag）</p>
<h2 id="上线新构建的项目-1"><a href="#上线新构建的项目-1" class="headerlink" title="上线新构建的项目"></a>上线新构建的项目</h2><h3 id="准备资源配置清单-4"><a href="#准备资源配置清单-4" class="headerlink" title="准备资源配置清单"></a>准备资源配置清单</h3><p>运维主机<code>HDSS7-200.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/data/k8s-yaml/dubbo-demo-consumer/deployment.yaml</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">kind: Deployment</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">metadata:</span><br><span class="line">  name: dubbo-demo-consumer</span><br><span class="line">  namespace: app</span><br><span class="line">  labels: </span><br><span class="line">    name: dubbo-demo-consumer</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels: </span><br><span class="line">      name: dubbo-demo-consumer</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels: </span><br><span class="line">        app: dubbo-demo-consumer</span><br><span class="line">        name: dubbo-demo-consumer</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: dubbo-demo-consumer</span><br><span class="line">        image: harbor.od.com/app/dubbo-demo-consumer:apllo_190120_1815</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 20880</span><br><span class="line">          protocol: TCP</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          protocol: TCP</span><br><span class="line">        env:</span><br><span class="line">        - name: C_OPTS</span><br><span class="line">          value: -Denv=dev -Dapollo.meta=http://config.od.com</span><br><span class="line">        - name: JAR_BALL</span><br><span class="line">          value: dubbo-client.jar</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      terminationGracePeriodSeconds: 30</span><br><span class="line">      securityContext: </span><br><span class="line">        runAsUser: 0</span><br><span class="line">      schedulerName: default-scheduler</span><br><span class="line">  strategy:</span><br><span class="line">    type: RollingUpdate</span><br><span class="line">    rollingUpdate: </span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">      maxSurge: 1</span><br><span class="line">  revisionHistoryLimit: 7</span><br><span class="line">  progressDeadlineSeconds: 600</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong>增加了env段配置<br><strong>注意：</strong>docker镜像新版的tag</p>
<h3 id="应用资源配置清单-5"><a href="#应用资源配置清单-5" class="headerlink" title="应用资源配置清单"></a>应用资源配置清单</h3><p>在任意一台k8s运算节点上执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-21 ~]# kubectl apply -f http://k8s-yaml.od.com/dubbo-demo-web/deployment.yaml</span><br><span class="line">deployment.extensions/dubbo-demo-consumer configured</span><br></pre></td></tr></table></figure>

<h2 id="通过Apollo配置中心动态维护项目的配置"><a href="#通过Apollo配置中心动态维护项目的配置" class="headerlink" title="通过Apollo配置中心动态维护项目的配置"></a>通过Apollo配置中心动态维护项目的配置</h2><p>以dubbo-demo-service项目为例，不用修改代码</p>
<ul>
<li>在<a href="http://portal.od.com" target="_blank" rel="noopener">http://portal.od.com</a> 里修改dubbo.port配置项</li>
<li>重启dubbo-demo-service项目</li>
<li>配置生效</li>
</ul>
<h1 id="实战维护多套dubbo微服务环境"><a href="#实战维护多套dubbo微服务环境" class="headerlink" title="实战维护多套dubbo微服务环境"></a>实战维护多套dubbo微服务环境</h1><h2 id="生产实践"><a href="#生产实践" class="headerlink" title="生产实践"></a>生产实践</h2><ol>
<li>迭代新需求/修复BUG（编码-&gt;提GIT）</li>
<li>测试环境发版，测试（应用通过编译打包发布至TEST命名空间）</li>
<li>测试通过，上线（应用镜像直接发布至PROD命名空间）</li>
</ol>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><ul>
<li>物理架构</li>
</ul>
<table>
<thead>
<tr>
<th>主机名</th>
<th>角色</th>
<th>ip</th>
</tr>
</thead>
<tbody><tr>
<td>HDSS7-11.host.com</td>
<td>zk-test(测试环境Test)</td>
<td>10.4.7.11</td>
</tr>
<tr>
<td>HDSS7-12.host.com</td>
<td>zk-prod(生产环境Prod)</td>
<td>10.4.7.12</td>
</tr>
<tr>
<td>HDSS7-21.host.com</td>
<td>kubernetes运算节点</td>
<td>10.4.7.21</td>
</tr>
<tr>
<td>HDSS7-22.host.com</td>
<td>kubernetes运算节点</td>
<td>10.4.7.22</td>
</tr>
<tr>
<td>HDSS7-200.host.com</td>
<td>运维主机，harbor仓库</td>
<td>10.4.7.200</td>
</tr>
</tbody></table>
<ul>
<li>K8S内系统架构</li>
</ul>
<table>
<thead>
<tr>
<th>环境</th>
<th>命名空间</th>
<th>应用</th>
</tr>
</thead>
<tbody><tr>
<td>测试环境（TEST）</td>
<td>test</td>
<td>apollo-config，apollo-admin</td>
</tr>
<tr>
<td>测试环境（TEST）</td>
<td>test</td>
<td>dubbo-demo-service，dubbo-demo-web</td>
</tr>
<tr>
<td>生产环境（PROD）</td>
<td>prod</td>
<td>apollo-config，apollo-admin</td>
</tr>
<tr>
<td>生产环境（PROD）</td>
<td>prod</td>
<td>dubbo-demo-service，dubbo-demo-web</td>
</tr>
<tr>
<td>ops环境（infra）</td>
<td>infra</td>
<td>jenkins，dubbo-monitor，apollo-portal</td>
</tr>
</tbody></table>
<h2 id="修改-添加域名解析"><a href="#修改-添加域名解析" class="headerlink" title="修改/添加域名解析"></a>修改/添加域名解析</h2><p>DNS主机<code>HDSS7-11.host.com</code>上：</p>
<figure class="highlight plain"><figcaption><span>/var/named/od.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zk-test 60 IN A 10.4.7.11</span><br><span class="line">zk-prod 60 IN A 10.4.7.12</span><br><span class="line">config-test	60 IN A 10.4.7.10</span><br><span class="line">config-prod	60 IN A 10.4.7.10</span><br><span class="line">demo-test 60 IN A 10.4.7.10</span><br><span class="line">demo-prod 60 IN A 10.4.7.10</span><br></pre></td></tr></table></figure>

<h2 id="Apollo的k8s应用配置"><a href="#Apollo的k8s应用配置" class="headerlink" title="Apollo的k8s应用配置"></a>Apollo的k8s应用配置</h2><ul>
<li>删除app命名空间内应用，创建test命名空间，创建prod命名空间</li>
<li>删除infra命名空间内apollo-configservice，apollo-adminservice应用</li>
<li>数据库内删除ApolloConfigDB，创建ApolloConfigTestDB，创建ApolloConfigProdDB</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; drop database ApolloConfigDB;</span><br><span class="line"></span><br><span class="line">mysql&gt; create database ApolloConfigTestDB;</span><br><span class="line">mysql&gt; use ApolloConfigTestDB;</span><br><span class="line">mysql&gt; source ./apolloconfig.sql</span><br><span class="line">mysql&gt; update ApolloConfigTestDB.ServerConfig set ServerConfig.Value=&quot;http://config-test.od.com/eureka&quot; where ServerConfig.Key=&quot;eureka.service.url&quot;;</span><br><span class="line">mysql&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigTestDB.* to &quot;apolloconfig&quot;@&quot;10.4.7.%&quot; identified by &quot;123456&quot;;</span><br><span class="line"></span><br><span class="line">mysql&gt; create database ApolloConfigProdDB;</span><br><span class="line">mysql&gt; use ApolloConfigProdDB;</span><br><span class="line">mysql&gt; source ./apolloconfig.sql</span><br><span class="line">mysql&gt; update ApolloConfigProdDB.ServerConfig set ServerConfig.Value=&quot;http://config-prod.od.com/eureka&quot; where ServerConfig.Key=&quot;eureka.service.url&quot;;</span><br><span class="line">mysql&gt; grant INSERT,DELETE,UPDATE,SELECT on ApolloConfigProdDB.* to &quot;apolloconfig&quot;@&quot;10.4.7.%&quot; identified by &quot;123456&quot;;</span><br></pre></td></tr></table></figure>

<ul>
<li>准备apollo-config，apollo-admin的资源配置清单（各2套）</li>
</ul>
<p><strong>注：</strong>apollo-config/apollo-admin的configmap配置要点</p>
<ul>
<li>Test环境</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigTestDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config-test.od.com/eureka</span><br></pre></td></tr></table></figure>

<ul>
<li>Prod环境</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">application-github.properties: |</span><br><span class="line">    # DataSource</span><br><span class="line">    spring.datasource.url = jdbc:mysql://mysql.od.com:3306/ApolloConfigProdDB?characterEncoding=utf8</span><br><span class="line">    spring.datasource.username = apolloconfig</span><br><span class="line">    spring.datasource.password = 123456</span><br><span class="line">    eureka.service.url = http://config-prod.od.com/eureka</span><br></pre></td></tr></table></figure>

<ul>
<li>依次应用，分别发布在test和prod命名空间</li>
<li>修改apollo-portal的configmap并重启portal</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apollo-env.properties: |</span><br><span class="line">    TEST.meta=http://config-test.od.com</span><br><span class="line">    PROD.meta=http://config-prod.od.com</span><br></pre></td></tr></table></figure>

<h2 id="Apollo的portal配置"><a href="#Apollo的portal配置" class="headerlink" title="Apollo的portal配置"></a>Apollo的portal配置</h2><h3 id="管理员工具"><a href="#管理员工具" class="headerlink" title="管理员工具"></a>管理员工具</h3><p>删除应用、集群、AppNamespace，将已配置应用删除</p>
<h3 id="系统参数"><a href="#系统参数" class="headerlink" title="系统参数"></a>系统参数</h3><ul>
<li><p>Key</p>
<blockquote>
<p>apollo.portal.envs</p>
</blockquote>
</li>
<li><p>Value</p>
<blockquote>
<p>TEST,PROD</p>
</blockquote>
</li>
</ul>
<p><strong>查询</strong></p>
<ul>
<li>Value<blockquote>
<p>TEST,PROD</p>
</blockquote>
</li>
</ul>
<p><strong>保存</strong></p>
<h2 id="新建dubbo-demo-service和dubbo-demo-web项目"><a href="#新建dubbo-demo-service和dubbo-demo-web项目" class="headerlink" title="新建dubbo-demo-service和dubbo-demo-web项目"></a>新建dubbo-demo-service和dubbo-demo-web项目</h2><p>在TEST/PROD环境分别增加配置项并发布</p>
<h2 id="发布dubbo微服务"><a href="#发布dubbo微服务" class="headerlink" title="发布dubbo微服务"></a>发布dubbo微服务</h2><ul>
<li>准备dubbo-demo-service和dubbo-demo-web的资源配置清单（各2套）</li>
<li>依次应用，分别发布至app-test和app-prod命名空间</li>
<li>使用dubbo-monitor查验</li>
</ul>
<h1 id="互联网公司技术部的日常"><a href="#互联网公司技术部的日常" class="headerlink" title="互联网公司技术部的日常"></a>互联网公司技术部的日常</h1><ul>
<li>产品经理整理需求，需求评审，出产品原型</li>
<li>开发同学夜以继日的开发，提测</li>
<li>测试同学使用Jenkins持续集成，并发布至测试环境</li>
<li>验证功能，通过-&gt;待上线or打回-&gt;修改代码</li>
<li>提交发版申请，运维同学将测试后的包发往生产环境</li>
<li>无尽的BUG修复（笑cry）</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2018/12/16/实验文档1：BIND9的安装部署/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/16/实验文档1：BIND9的安装部署/" class="post-title-link" itemprop="url">实验文档1：BIND9的安装部署</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-16 20:29:41" itemprop="dateCreated datePublished" datetime="2018-12-16T20:29:41+08:00">2018-12-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Web-DNS技术/" itemprop="url" rel="index"><span itemprop="name">Web DNS技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">3.1k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">3 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="安装部署BIND9"><a href="#安装部署BIND9" class="headerlink" title="安装部署BIND9"></a>安装部署BIND9</h1><h2 id="操作系统版本和内核版本"><a href="#操作系统版本和内核版本" class="headerlink" title="操作系统版本和内核版本"></a>操作系统版本和内核版本</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#cat /etc/redhat-release </span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">#uname -a</span><br><span class="line">Linux node 3.10.0-862.el7.x86_64 #1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span><br></pre></td></tr></table></figure>

<h2 id="使用yum安装BIND9"><a href="#使用yum安装BIND9" class="headerlink" title="使用yum安装BIND9"></a>使用yum安装BIND9</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#yum install bind</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                                       Arch                          Version                                    Repository                      Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> bind                                          x86_64                        32:9.9.4-73.el7_6                          updates                        1.8 M</span><br></pre></td></tr></table></figure>

<p>安装的版本为<code>9.9.4</code></p>
<h2 id="BIND9主配置文件-etc-named-conf"><a href="#BIND9主配置文件-etc-named-conf" class="headerlink" title="BIND9主配置文件/etc/named.conf"></a>BIND9主配置文件/etc/named.conf</h2><ol>
<li><p>主配置文件的格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">options&#123;</span><br><span class="line">     //全局选项</span><br><span class="line">&#125;</span><br><span class="line">zone　&quot;zone name&quot; &#123;</span><br><span class="line">   //定于区域</span><br><span class="line">&#125;</span><br><span class="line">logging&#123;</span><br><span class="line">    //日志文件</span><br><span class="line">&#125;</span><br><span class="line">include：加载别的文件</span><br></pre></td></tr></table></figure>
</li>
<li><p>主配置文件的配置注意事项</p>
<blockquote>
<ul>
<li>语法严格，分号，空格</li>
<li>文件的权限，属主：root，属组：named，640</li>
</ul>
</blockquote>
</li>
<li><p>主配置文件范例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">	listen-on port 53 &#123; 10.4.7.11; &#125;;</span><br><span class="line">	directory 	&quot;/var/named&quot;;</span><br><span class="line">	dump-file 	&quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">	statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">	memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">	allow-query     &#123; any; &#125;;</span><br><span class="line"></span><br><span class="line">	/* </span><br><span class="line">	 - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.</span><br><span class="line">	 - If you are building a RECURSIVE (caching) DNS server, you need to enable </span><br><span class="line">	   recursion. </span><br><span class="line">	 - If your recursive DNS server has a public IP address, you MUST enable access </span><br><span class="line">	   control to limit queries to your legitimate users. Failing to do so will</span><br><span class="line">	   cause your server to become part of large scale DNS amplification </span><br><span class="line">	   attacks. Implementing BCP38 within your network would greatly</span><br><span class="line">	   reduce such attack surface </span><br><span class="line">	*/</span><br><span class="line">	recursion yes;</span><br><span class="line">	</span><br><span class="line">		dnssec-enable no;</span><br><span class="line">		dnssec-validation no;</span><br><span class="line"></span><br><span class="line">	/* Path to ISC DLV key */</span><br><span class="line">	bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</span><br><span class="line"></span><br><span class="line">	managed-keys-directory &quot;/var/named/dynamic&quot;;</span><br><span class="line"></span><br><span class="line">	pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">	session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        channel default_debug &#123;</span><br><span class="line">                file &quot;data/named.run&quot;;</span><br><span class="line">                severity dynamic;</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">	type hint;</span><br><span class="line">	file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="BIND9服务的启动"><a href="#BIND9服务的启动" class="headerlink" title="BIND9服务的启动"></a>BIND9服务的启动</h2><h3 id="检查配置文件"><a href="#检查配置文件" class="headerlink" title="检查配置文件"></a>检查配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># named-checkconf</span><br></pre></td></tr></table></figure>

<p>没有报错就是正常的</p>
<h3 id="启动BIND9服务"><a href="#启动BIND9服务" class="headerlink" title="启动BIND9服务"></a>启动BIND9服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl start named</span><br></pre></td></tr></table></figure>

<h3 id="检查BIND9服务状态"><a href="#检查BIND9服务状态" class="headerlink" title="检查BIND9服务状态"></a>检查BIND9服务状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># systemctl status named</span><br></pre></td></tr></table></figure>

<p>这样就完成了一个最基本的转发DNS的部署，它可以为我们的内网客户端提供DNS递归查询，例如查询并返回<code>www.baidu.com</code>的解析结果。</p>
<h2 id="验证解析"><a href="#验证解析" class="headerlink" title="验证解析"></a>验证解析</h2><h3 id="配置DNS服务器指向"><a href="#配置DNS服务器指向" class="headerlink" title="配置DNS服务器指向"></a>配置DNS服务器指向</h3><p>在/etc/resole里配置DNS服务器的ip地址为我们部署的主机ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/resolv.conf    </span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">nameserver 10.4.7.11</span><br></pre></td></tr></table></figure>

<h3 id="验证解析-1"><a href="#验证解析-1" class="headerlink" title="验证解析"></a>验证解析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ping baidu.com</span><br><span class="line">PING baidu.com (220.181.57.216) 56(84) bytes of data.</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2018/12/16/实验文档2：自定义正解域/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/16/实验文档2：自定义正解域/" class="post-title-link" itemprop="url">实验文档2：自定义正解域</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-16 18:12:56" itemprop="dateCreated datePublished" datetime="2018-12-16T18:12:56+08:00">2018-12-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Web-DNS技术/" itemprop="url" rel="index"><span itemprop="name">Web DNS技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.9k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="自定义区域配置文件"><a href="#自定义区域配置文件" class="headerlink" title="自定义区域配置文件"></a>自定义区域配置文件</h1><p>自定义区域的配置范例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11;10.4.7.12; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里自定义了一个host.com的主机域，可以放在/etc/named.rfc1912.zones文件中，也可以放置在自定义的文件中，在/etc/named.conf里include进来</p>
<blockquote>
<p>主机域</p>
<ul>
<li>主机域和业务域无关，且建议分开</li>
<li>主机域其实是一个假域，也就是说，主机域其实是不能解析到互联网上的，它只对局域网（内网）提供服务</li>
</ul>
</blockquote>
<h1 id="自定义区域数据库文件"><a href="#自定义区域数据库文件" class="headerlink" title="自定义区域数据库文件"></a>自定义区域数据库文件</h1><ul>
<li>一般而言是文本文件，且只包含<strong>资源记录</strong>、<strong>宏定义</strong>和<strong>注释</strong></li>
<li>需在自定义区域配置文件中指定存放路径，可以绝对路径或相对路径（相对于/var/named目录）</li>
<li>注意文件的属性（属主、属组及权限）</li>
</ul>
<h2 id="配置范例"><a href="#配置范例" class="headerlink" title="配置范例"></a>配置范例</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ORIGIN .</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">host.com			IN SOA	ns1.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121601 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">				NS   ns1.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">ns1                             A    10.4.7.11</span><br></pre></td></tr></table></figure>

<h2 id="资源记录（Resource-Record）"><a href="#资源记录（Resource-Record）" class="headerlink" title="资源记录（Resource Record）"></a>资源记录（Resource Record）</h2><h3 id="资源记录格式"><a href="#资源记录格式" class="headerlink" title="资源记录格式"></a>资源记录格式</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name [ttl(缓存时间)] IN 资源记录类型（RRtype）  Value</span><br></pre></td></tr></table></figure>

<h3 id="常用资源记录类型（RR-type）"><a href="#常用资源记录类型（RR-type）" class="headerlink" title="常用资源记录类型（RR-type）"></a>常用资源记录类型（RR-type）</h3><h4 id="SOA记录"><a href="#SOA记录" class="headerlink" title="SOA记录"></a>SOA记录</h4><p>SOA: 起始授权，只能有一条</p>
<ul>
<li>name:只能是区域名称，通常可以简写为@，例如：od.com.</li>
<li>value:有n个数值，最主要的是主DNS服务器的FQDN，点不可省略</li>
</ul>
<p><strong>注意</strong>：SOA必须是区域数据库文件第一条记录</p>
<blockquote>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@ 600 IN SOA  dns.host.com. 管理员邮箱（dnsadmin.host.com.）（</span><br><span class="line">     序列号(serial number) ;注释内容，十进制数据，不能超过10位，通常使用日期时间戳，例如2018121601</span><br><span class="line">     刷新时间(refresh time) ;即每隔多久到主服务器检查一次</span><br><span class="line">     重试时间(retry time) ;应该小于refresh time</span><br><span class="line">     过期时间(expire time);当辅助DNS服务器无法联系上主DNS服务器时，辅助DNS服务器可以在多长时间内认为其缓存是有效的，并供用户查询。</span><br><span class="line">     netgative answer ttl ;非权威应答的ttl，缓存DNS服务器可以缓存记录多长时间</span><br><span class="line"> ）</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="NS记录"><a href="#NS记录" class="headerlink" title="NS记录"></a>NS记录</h4><p>NS：可以有多条，每一个NS记录，<strong>必须</strong>对应一个A记录</p>
<ul>
<li>name:区域名称，通常可以简写为@</li>
<li>value:DNS服务器的FQDN(可以使用相对名称)<blockquote>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ 600 IN NS ns1</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<h4 id="A记录"><a href="#A记录" class="headerlink" title="A记录"></a>A记录</h4><p>A：只能定义在正向区域数据库文件中（ipv4-&gt;FQDN）</p>
<ul>
<li>name:FQDN（可以使用相对名称)</li>
<li>value:IP<blockquote>
<p>例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">www  600(单位s) IN A 10.4.7.11</span><br><span class="line">www  600(单位s) IN A 10.4.7.12</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<p><strong>注</strong> 可以做轮询</p>
<h4 id="MX记录"><a href="#MX记录" class="headerlink" title="MX记录"></a>MX记录</h4><p>MX:邮件交换记录，可以有多个（用的不多）</p>
<ul>
<li>name:区域名称，用于标识smtp服务器</li>
<li>value:包含优先级和FQDN</li>
<li>优先级:0-99，数字越小，级别越高，<blockquote>
<p>例子：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ 600 IN MX 10 mail</span><br><span class="line">@ 600 IN MX 20 smtp</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="CNAME记录"><a href="#CNAME记录" class="headerlink" title="CNAME记录"></a>CNAME记录</h4><p>CNAME：canonical name，别名（FQDN-&gt;FQDN）</p>
<ul>
<li>name ：FQDN</li>
<li>value :FQDN<blockquote>
<p>例子：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eshop IN CNAME www</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="宏定义"><a href="#宏定义" class="headerlink" title="宏定义"></a>宏定义</h2><ul>
<li>$ORIGIN .</li>
<li>$TTL 60</li>
</ul>
<h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><p>区域数据库文件中使用<code>;</code>（分号）来进行注释</p>
<h1 id="实战正解主机域配置"><a href="#实战正解主机域配置" class="headerlink" title="实战正解主机域配置"></a>实战正解主机域配置</h1><h2 id="在-etc-named-rfc1912-zones文件内最下，添加以下内容"><a href="#在-etc-named-rfc1912-zones文件内最下，添加以下内容" class="headerlink" title="在/etc/named.rfc1912.zones文件内最下，添加以下内容"></a>在/etc/named.rfc1912.zones文件内最下，添加以下内容</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">        type  master;</span><br><span class="line">        file  &quot;host.com.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11;10.4.7.12; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="在-var-named下创建host-com-zone文件，写入以下内容"><a href="#在-var-named下创建host-com-zone文件，写入以下内容" class="headerlink" title="在/var/named下创建host.com.zone文件，写入以下内容"></a>在/var/named下创建host.com.zone文件，写入以下内容</h2><figure class="highlight plain"><figcaption><span>/var/named/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       		IN SOA	dns.host.com. 87527941.qq.com. (</span><br><span class="line">				2018121601 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   dns.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">HDSS7-11 	        A    10.4.7.11</span><br><span class="line">dns      	        A    10.4.7.11</span><br></pre></td></tr></table></figure>

<p>三种配置方式：</p>
<ul>
<li>用宏定义$ORIGIN . 下面用host.com</li>
<li>不用宏定义，下面用@</li>
<li>不用宏定义，下面用host.com.</li>
</ul>
<h2 id="检查配置并生效"><a href="#检查配置并生效" class="headerlink" title="检查配置并生效"></a>检查配置并生效</h2><h3 id="检查自定义区域配置"><a href="#检查自定义区域配置" class="headerlink" title="检查自定义区域配置"></a>检查自定义区域配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#named-checkzone host.com. /var/named/host.com.zone</span><br><span class="line">zone host.com/IN: loaded serial 2018121601</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="检查主配置文件"><a href="#检查主配置文件" class="headerlink" title="检查主配置文件"></a>检查主配置文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#named-checkconf</span><br></pre></td></tr></table></figure>

<h3 id="重启named服务"><a href="#重启named服务" class="headerlink" title="重启named服务"></a>重启named服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#systemctl restart named</span><br></pre></td></tr></table></figure>

<h3 id="检查该正解域是否生效"><a href="#检查该正解域是否生效" class="headerlink" title="检查该正解域是否生效"></a>检查该正解域是否生效</h3><p>配置主机名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># hostnamectl set-hostname hdss7-11.host.com</span><br><span class="line"># logout</span><br></pre></td></tr></table></figure>

<p>开启第二台虚机，配置好DNS后验证解析</p>
<h2 id="维护正解域（增、删、改、查）"><a href="#维护正解域（增、删、改、查）" class="headerlink" title="维护正解域（增、删、改、查）"></a>维护正解域（增、删、改、查）</h2><h3 id="增加一条资源记录"><a href="#增加一条资源记录" class="headerlink" title="增加一条资源记录"></a>增加一条资源记录</h3><figure class="highlight plain"><figcaption><span>/var/named/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       		IN SOA	dns.host.com. 87527941.qq.com. (</span><br><span class="line">				2018121602 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   dns.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">HDSS7-11 	        A    10.4.7.11</span><br><span class="line">HDSS7-12 	        A    10.4.7.12</span><br><span class="line">dns      	        A    10.4.7.11</span><br></pre></td></tr></table></figure>

<p>增加一个HDSS7-12.host.com的A记录解析，并验证</p>
<h3 id="修改一条资源记录"><a href="#修改一条资源记录" class="headerlink" title="修改一条资源记录"></a>修改一条资源记录</h3><p>给<code>10.4.7.12</code>这台主机增加一个辅助ip</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ip addr add 10.4.7.13/24 dev eth0</span><br></pre></td></tr></table></figure>

<p>修改DNS服务器上的区域数据库文件</p>
<figure class="highlight plain"><figcaption><span>/var/named/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       		IN SOA	dns.host.com. 87527941.qq.com. (</span><br><span class="line">				2018121603 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   dns.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">HDSS7-11 	        A    10.4.7.11</span><br><span class="line">HDSS7-12 	        A    10.4.7.13</span><br><span class="line">dns      	        A    10.4.7.11</span><br></pre></td></tr></table></figure>

<p>修改HDSS7-12.host.com的A记录解析，指向新增的辅助ip<code>10.4.7.13</code><br>检查：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ping HDSS7-12.host.com</span><br><span class="line">ING hdss7-12.host.com (10.4.7.13) 56(84) bytes of data.</span><br><span class="line">64 bytes from 10.4.7.13 (10.4.7.13): icmp_seq=1 ttl=64 time=0.318 ms</span><br><span class="line">64 bytes from 10.4.7.13 (10.4.7.13): icmp_seq=2 ttl=64 time=0.206 ms</span><br><span class="line">64 bytes from 10.4.7.13 (10.4.7.13): icmp_seq=3 ttl=64 time=0.391 ms</span><br><span class="line">^C</span><br><span class="line">--- hdss7-12.host.com ping statistics ---</span><br><span class="line">3 packets transmitted, 3 received, 0% packet loss, time 2002ms</span><br><span class="line">rtt min/avg/max/mdev = 0.206/0.305/0.391/0.076 ms</span><br></pre></td></tr></table></figure>

<h3 id="删除一条资源记录"><a href="#删除一条资源记录" class="headerlink" title="删除一条资源记录"></a>删除一条资源记录</h3><figure class="highlight plain"><figcaption><span>/var/named/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@       		IN SOA	ns1.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121604 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS   ns1.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">ns1      	        A    10.4.7.11</span><br><span class="line">HDSS7-11 	        A    10.4.7.11</span><br></pre></td></tr></table></figure>

<p>删除HDSS7-12.host.com的A记录解析，并验证</p>
<h3 id="查询记录"><a href="#查询记录" class="headerlink" title="查询记录"></a>查询记录</h3><p>略</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2018/12/16/实验文档3：自定义反解域/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/16/实验文档3：自定义反解域/" class="post-title-link" itemprop="url">实验文档3：自定义反解域</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-16 16:12:56" itemprop="dateCreated datePublished" datetime="2018-12-16T16:12:56+08:00">2018-12-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Web-DNS技术/" itemprop="url" rel="index"><span itemprop="name">Web DNS技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">2.4k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">2 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="添加反解域的自定义区域配置"><a href="#添加反解域的自定义区域配置" class="headerlink" title="添加反解域的自定义区域配置"></a>添加反解域的自定义区域配置</h1><figure class="highlight plain"><figcaption><span>/etc/named.rfc1912.zones</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;7.4.10.in-addr.arpa&quot; IN &#123;</span><br><span class="line">        type master;</span><br><span class="line">        file &quot;7.4.10.in-addr.arpa.zone&quot;;</span><br><span class="line">        allow-update &#123; 10.4.7.11;10.4.7.12; &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="添加反解域的区域数据库文件"><a href="#添加反解域的区域数据库文件" class="headerlink" title="添加反解域的区域数据库文件"></a>添加反解域的区域数据库文件</h1><figure class="highlight plain"><figcaption><span>/var/named/7.4.10.in-addr.arpa.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@	     		IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121603 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900       ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			    NS   ns1.host.com.</span><br><span class="line">$ORIGIN 7.4.10.in-addr.arpa.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">11			PTR		 HDSS7-11.host.com.</span><br><span class="line">12			PTR		 HDSS7-12.host.com.</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：一个IP只能对应唯一的FQDN反解PTR记录，且应该与正解A记录对应</p>
<h1 id="检查反解域的配置"><a href="#检查反解域的配置" class="headerlink" title="检查反解域的配置"></a>检查反解域的配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# named-checkzone 7.4.10.in-addr.arpa /var/named/7.4.10.in-addr.arpa.zone</span><br><span class="line">zone 7.4.10.in-addr.arpa/IN: loaded serial 2018121603</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h1 id="重启BIND9服务"><a href="#重启BIND9服务" class="headerlink" title="重启BIND9服务"></a>重启BIND9服务</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# systemctl restart named.service</span><br></pre></td></tr></table></figure>

<h1 id="检查解析是否生效"><a href="#检查解析是否生效" class="headerlink" title="检查解析是否生效"></a>检查解析是否生效</h1><ul>
<li><p>方法1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# dig -t PTR 11.7.4.10.in-addr.arpa. @10.4.7.11 +short</span><br><span class="line">HDSS7-11.host.com.</span><br></pre></td></tr></table></figure>
</li>
<li><p>方法2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-11 ~]# dig -x 10.4.7.11 @10.4.7.11 +short</span><br><span class="line">HDSS7-11.host.com.</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h1 id="增删改"><a href="#增删改" class="headerlink" title="增删改"></a>增删改</h1><h2 id="增加一条反解记录"><a href="#增加一条反解记录" class="headerlink" title="增加一条反解记录"></a>增加一条反解记录</h2><figure class="highlight plain"><figcaption><span>/var/named/7.4.10.in-addr.arpa.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@	     		IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121604 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900       ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			    NS   ns1.host.com.</span><br><span class="line">$ORIGIN 7.4.10.in-addr.arpa.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">11			PTR		 HDSS7-11.host.com.</span><br><span class="line">12			PTR		 HDSS7-12.host.com.</span><br><span class="line">13			PTR		 HDSS7-13.host.com.</span><br></pre></td></tr></table></figure>

<h2 id="删除一条反解记录"><a href="#删除一条反解记录" class="headerlink" title="删除一条反解记录"></a>删除一条反解记录</h2><figure class="highlight plain"><figcaption><span>/var/named/7.4.10.in-addr.arpa.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@	     		IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121605 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900       ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			    NS   ns1.host.com.</span><br><span class="line">$ORIGIN 7.4.10.in-addr.arpa.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">11			PTR		 HDSS7-11.host.com.</span><br><span class="line">12			PTR		 HDSS7-12.host.com.</span><br></pre></td></tr></table></figure>

<h2 id="修改一条反解记录"><a href="#修改一条反解记录" class="headerlink" title="修改一条反解记录"></a>修改一条反解记录</h2><figure class="highlight plain"><figcaption><span>/var/named/7.4.10.in-addr.arpa.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">@	     		IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121606 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900       ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			    NS   ns1.host.com.</span><br><span class="line">$ORIGIN 7.4.10.in-addr.arpa.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">11			PTR		 HDSS7-11.host.com.</span><br><span class="line">12			PTR		 HDSS7-13.host.com.</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://StanleyWang-GitHub.github.io/2018/12/16/实验文档4：DNS主辅同步/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Stanley Wang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stanley's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/12/16/实验文档4：DNS主辅同步/" class="post-title-link" itemprop="url">实验文档4：DNS主辅同步</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-16 14:12:56" itemprop="dateCreated datePublished" datetime="2018-12-16T14:12:56+08:00">2018-12-16</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:33:09" itemprop="dateModified" datetime="2020-09-03T16:33:09+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Web-DNS技术/" itemprop="url" rel="index"><span itemprop="name">Web DNS技术</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">4.8k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">4 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<blockquote class="blockquote-center"><p>欢迎加入王导的VIP学习qq群：==&gt;<a href="http://shang.qq.com/wpa/qunwpa?idkey=78869fddc5a661acb0639315eb52997c108de6625df5f0ee2f0372f176a032a6" target="_blank" rel="noopener"><font color="FF7F50">932194668</font></a>&lt;==</p>
</blockquote>
<hr>
<h1 id="DNS主辅同步架构"><a href="#DNS主辅同步架构" class="headerlink" title="DNS主辅同步架构"></a>DNS主辅同步架构</h1><table>
<thead>
<tr>
<th>IP</th>
<th>主机名</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>10.4.7.11</td>
<td>HDSS7-11.host.com</td>
<td>DNS主</td>
</tr>
<tr>
<td>10.4.7.12</td>
<td>HDSS7-12.host.com</td>
<td>DNS辅</td>
</tr>
<tr>
<td><strong>注意</strong>：所有资源记录的增、删、改的操作，均在主DNS上进行，辅助DNS仅提供查询功能</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h1 id="辅助DNS主机上安装部署BIND9"><a href="#辅助DNS主机上安装部署BIND9" class="headerlink" title="辅助DNS主机上安装部署BIND9"></a>辅助DNS主机上安装部署BIND9</h1><h2 id="安装BIND9软件"><a href="#安装BIND9软件" class="headerlink" title="安装BIND9软件"></a>安装BIND9软件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">#yum install bind</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line"> Package                                       Arch                          Version                                    Repository                      Size</span><br><span class="line">=============================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> bind                                          x86_64                        32:9.9.4-73.el7_6                          updates                        1.8 M</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：辅助DNS的BIND9软件版本应小于等于主DNS的BIND9软件版本</p>
<h2 id="修改辅助DNS主配置文件"><a href="#修改辅助DNS主配置文件" class="headerlink" title="修改辅助DNS主配置文件"></a>修改辅助DNS主配置文件</h2><p>修改主配置文件，并加入<code>masterfile-format text;</code></p>
<figure class="highlight plain"><figcaption><span>/etc/named.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">options &#123;</span><br><span class="line">  listen-on port 53 &#123; 10.4.7.12; &#125;;</span><br><span class="line">  directory 	&quot;/var/named&quot;;</span><br><span class="line">  dump-file 	&quot;/var/named/data/cache_dump.db&quot;;</span><br><span class="line">  statistics-file &quot;/var/named/data/named_stats.txt&quot;;</span><br><span class="line">  memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</span><br><span class="line">  allow-query     &#123; any; &#125;;</span><br><span class="line">  masterfile-format text;</span><br><span class="line">  /* </span><br><span class="line">   - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.</span><br><span class="line">   - If you are building a RECURSIVE (caching) DNS server, you need to enable </span><br><span class="line">     recursion. </span><br><span class="line">   - If your recursive DNS server has a public IP address, you MUST enable access </span><br><span class="line">     control to limit queries to your legitimate users. Failing to do so will</span><br><span class="line">     cause your server to become part of large scale DNS amplification </span><br><span class="line">     attacks. Implementing BCP38 within your network would greatly</span><br><span class="line">     reduce such attack surface </span><br><span class="line">  */</span><br><span class="line">  recursion yes;</span><br><span class="line"></span><br><span class="line">  dnssec-enable no;</span><br><span class="line">  dnssec-validation no;</span><br><span class="line"></span><br><span class="line">  /* Path to ISC DLV key */</span><br><span class="line">  bindkeys-file &quot;/etc/named.iscdlv.key&quot;;</span><br><span class="line"></span><br><span class="line">  managed-keys-directory &quot;/var/named/dynamic&quot;;</span><br><span class="line"></span><br><span class="line">  pid-file &quot;/run/named/named.pid&quot;;</span><br><span class="line">  session-keyfile &quot;/run/named/session.key&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">  channel default_debug &#123;</span><br><span class="line">    file &quot;data/named.run&quot;;</span><br><span class="line">    severity dynamic;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zone &quot;.&quot; IN &#123;</span><br><span class="line">  type hint;</span><br><span class="line">  file &quot;named.ca&quot;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">include &quot;/etc/named.rfc1912.zones&quot;;</span><br><span class="line">include &quot;/etc/named.root.key&quot;;</span><br></pre></td></tr></table></figure>

<h1 id="修改主DNS主配置文件"><a href="#修改主DNS主配置文件" class="headerlink" title="修改主DNS主配置文件"></a>修改主DNS主配置文件</h1><h2 id="加入以下配置"><a href="#加入以下配置" class="headerlink" title="加入以下配置"></a>加入以下配置</h2><figure class="highlight plain"><figcaption><span>/etc/named.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">allow-transfer &#123; 10.4.7.12; &#125;;</span><br><span class="line">also-notify &#123; 10.4.7.12; &#125;;</span><br></pre></td></tr></table></figure>

<h2 id="检查配置并重启主DNS"><a href="#检查配置并重启主DNS" class="headerlink" title="检查配置并重启主DNS"></a>检查配置并重启主DNS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># named-checkconf</span><br><span class="line"># systemctl restart named</span><br></pre></td></tr></table></figure>

<h2 id="检查完全区域数据传送"><a href="#检查完全区域数据传送" class="headerlink" title="检查完全区域数据传送"></a>检查完全区域数据传送</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 ~]# dig -t axfr host.com @10.4.7.11</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-73.el7_6 &lt;&lt;&gt;&gt; -t axfr host.com @10.4.7.11</span><br><span class="line">;; global options: +cmd</span><br><span class="line">host.com.		600	IN	SOA	dns.host.com. dnsadmin.host.com. 2018121601 10800 900 604800 86400</span><br><span class="line">host.com.		600	IN	NS	ns1.host.com.</span><br><span class="line">HDSS7-11.host.com.	60	IN	A	10.4.7.11</span><br><span class="line">HDSS7-12.host.com.	60	IN	A	10.4.7.12</span><br><span class="line">ns1.host.com.		60	IN	A	10.4.7.11</span><br><span class="line">host.com.		600	IN	SOA	dns.host.com. dnsadmin.host.com. 2018121601 10800 900 604800 86400</span><br><span class="line">;; Query time: 0 msec</span><br><span class="line">;; SERVER: 10.4.7.11#53(10.4.7.11)</span><br><span class="line">;; WHEN: Sun Dec 16 14:16:01 CST 2018</span><br><span class="line">;; XFR size: 6 records (messages 1, bytes 220)</span><br></pre></td></tr></table></figure>

<h1 id="辅助DNS上创建自定义正解区域配置"><a href="#辅助DNS上创建自定义正解区域配置" class="headerlink" title="辅助DNS上创建自定义正解区域配置"></a>辅助DNS上创建自定义正解区域配置</h1><figure class="highlight plain"><figcaption><span>/etc/named.rfc1912.zones</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">zone &quot;host.com&quot; IN &#123;</span><br><span class="line">  type  slave;</span><br><span class="line">  masters &#123; 10.4.7.11; &#125;;</span><br><span class="line">  file  &quot;slaves/host.com.zone&quot;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="检查配置并启动辅助DNS"><a href="#检查配置并启动辅助DNS" class="headerlink" title="检查配置并启动辅助DNS"></a>检查配置并启动辅助DNS</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># named-checkconf</span><br><span class="line"># systemctl start named</span><br></pre></td></tr></table></figure>

<h2 id="检查同步过来的区域数据库文件"><a href="#检查同步过来的区域数据库文件" class="headerlink" title="检查同步过来的区域数据库文件"></a>检查同步过来的区域数据库文件</h2><figure class="highlight plain"><figcaption><span>/var/named/slaves/host.com.zone</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@hdss7-12 slaves]# ll</span><br><span class="line">-rw-r--r-- 1 named named 392 Feb 10 21:08 host.com.zone</span><br><span class="line">[root@hdss7-12 slaves]# cat host.com.zone </span><br><span class="line">$ORIGIN .</span><br><span class="line">$TTL 600	; 10 minutes</span><br><span class="line">host.com		IN SOA	dns.host.com. dnsadmin.host.com. (</span><br><span class="line">				2018121601 ; serial</span><br><span class="line">				10800      ; refresh (3 hours)</span><br><span class="line">				900        ; retry (15 minutes)</span><br><span class="line">				604800     ; expire (1 week)</span><br><span class="line">				86400      ; minimum (1 day)</span><br><span class="line">				)</span><br><span class="line">			NS	ns1.host.com.</span><br><span class="line">$ORIGIN host.com.</span><br><span class="line">$TTL 60	; 1 minute</span><br><span class="line">HDSS7-11		A	10.4.7.11</span><br><span class="line">HDSS7-12		A	10.4.7.12</span><br><span class="line">ns1			A	10.4.7.11</span><br></pre></td></tr></table></figure>

<h2 id="检查解析是否正确"><a href="#检查解析是否正确" class="headerlink" title="检查解析是否正确"></a>检查解析是否正确</h2><h3 id="使用主DNS查询一个A记录"><a href="#使用主DNS查询一个A记录" class="headerlink" title="使用主DNS查询一个A记录"></a>使用主DNS查询一个A记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dig -t A HDSS7-11.host.com @10.4.7.11 +short</span><br><span class="line">10.4.7.11</span><br></pre></td></tr></table></figure>

<h3 id="使用辅助DNS查询一个A记录"><a href="#使用辅助DNS查询一个A记录" class="headerlink" title="使用辅助DNS查询一个A记录"></a>使用辅助DNS查询一个A记录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># dig -t A HDSS7-11.host.com @10.4.7.12 +short</span><br><span class="line">10.4.7.11</span><br></pre></td></tr></table></figure>

<h1 id="辅助DNS上创建自定义反解区域配置"><a href="#辅助DNS上创建自定义反解区域配置" class="headerlink" title="辅助DNS上创建自定义反解区域配置"></a>辅助DNS上创建自定义反解区域配置</h1><p>略</p>
<h1 id="增加、删除、修改记录，并验证同步"><a href="#增加、删除、修改记录，并验证同步" class="headerlink" title="增加、删除、修改记录，并验证同步"></a>增加、删除、修改记录，并验证同步</h1><p><strong>注意</strong>：一定要手动修改主DNS上SOA记录里的serial值！</p>
<h2 id="增加记录"><a href="#增加记录" class="headerlink" title="增加记录"></a>增加记录</h2><h2 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h2><h2 id="修改记录"><a href="#修改记录" class="headerlink" title="修改记录"></a>修改记录</h2><h1 id="再增加一个od-com的业务域，并验证主辅同步（复习）"><a href="#再增加一个od-com的业务域，并验证主辅同步（复习）" class="headerlink" title="再增加一个od.com的业务域，并验证主辅同步（复习）"></a>再增加一个od.com的业务域，并验证主辅同步（复习）</h1><h2 id="主DNS上增加自定义区域"><a href="#主DNS上增加自定义区域" class="headerlink" title="主DNS上增加自定义区域"></a>主DNS上增加自定义区域</h2><h2 id="主DNS上增加自定义区域数据库文件"><a href="#主DNS上增加自定义区域数据库文件" class="headerlink" title="主DNS上增加自定义区域数据库文件"></a>主DNS上增加自定义区域数据库文件</h2><h2 id="主DNS上增加自定义区域资源记录"><a href="#主DNS上增加自定义区域资源记录" class="headerlink" title="主DNS上增加自定义区域资源记录"></a>主DNS上增加自定义区域资源记录</h2><h2 id="检查配置并重启主DNS服务"><a href="#检查配置并重启主DNS服务" class="headerlink" title="检查配置并重启主DNS服务"></a>检查配置并重启主DNS服务</h2><h2 id="辅助DNS上增加自定义区域"><a href="#辅助DNS上增加自定义区域" class="headerlink" title="辅助DNS上增加自定义区域"></a>辅助DNS上增加自定义区域</h2><h2 id="检查完全区域数据传送-1"><a href="#检查完全区域数据传送-1" class="headerlink" title="检查完全区域数据传送"></a>检查完全区域数据传送</h2><h2 id="检查配置并重启辅助DNS服务"><a href="#检查配置并重启辅助DNS服务" class="headerlink" title="检查配置并重启辅助DNS服务"></a>检查配置并重启辅助DNS服务</h2><h2 id="验证主辅同步"><a href="#验证主辅同步" class="headerlink" title="验证主辅同步"></a>验证主辅同步</h2><h3 id="分别使用主DNS和辅助DNS查询新业务域的A记录"><a href="#分别使用主DNS和辅助DNS查询新业务域的A记录" class="headerlink" title="分别使用主DNS和辅助DNS查询新业务域的A记录"></a>分别使用主DNS和辅助DNS查询新业务域的A记录</h3><h3 id="在主DNS上新增一条A记录，并验证主辅同步"><a href="#在主DNS上新增一条A记录，并验证主辅同步" class="headerlink" title="在主DNS上新增一条A记录，并验证主辅同步"></a>在主DNS上新增一条A记录，并验证主辅同步</h3><h3 id="在主DNS上修改一条A记录，并验证主辅同步"><a href="#在主DNS上修改一条A记录，并验证主辅同步" class="headerlink" title="在主DNS上修改一条A记录，并验证主辅同步"></a>在主DNS上修改一条A记录，并验证主辅同步</h3><h3 id="在主DNS上删除一条A记录，并验证主辅同步"><a href="#在主DNS上删除一条A记录，并验证主辅同步" class="headerlink" title="在主DNS上删除一条A记录，并验证主辅同步"></a>在主DNS上删除一条A记录，并验证主辅同步</h3><h1 id="客户端配置DNS解析高可用"><a href="#客户端配置DNS解析高可用" class="headerlink" title="客户端配置DNS解析高可用"></a>客户端配置DNS解析高可用</h1><p>在客户端主机（以Linux主机为例，Windows和Mac操作系统略）配置主、辅DNS</p>
<figure class="highlight plain"><figcaption><span>/etc/resolv.conf</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#cat /etc/resolv.conf </span><br><span class="line"># Generated by NetworkManager</span><br><span class="line">search host.com od.com</span><br><span class="line">nameserver 10.4.7.11</span><br><span class="line">nameserver 10.4.7.12</span><br></pre></td></tr></table></figure>

<p>这样客户端高可用就配置好了，任意一个DNS服务器宕机也不会影响正常解析</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Stanley Wang">
            
              <p class="site-author-name" itemprop="name">Stanley Wang</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://gitee.com/stanleywang" title="GitHub &rarr; https://gitee.com/stanleywang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:stanley.wang.m@qq.com" title="E-Mail &rarr; mailto:stanley.wang.m@qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Stanley Wang</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">278k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">4:13</span>
  
</div>









        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.0"></script>




  

  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  



  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
      
    
  

  


  

  

  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


</body>
</html>
